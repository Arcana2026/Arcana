<!DOCTYPE html>
<html lang="fr">
<!--
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    ARCANA GAME - Le Sanctuaire du Destin
    √âcosyst√®me D√©centralis√© sur Polygon | Optimis√© Mobile
    Structure: index.html ‚áÑ ArcanaGame.html (connexion bidirectionnelle)
    
    üì° ORACLE M√âT√âO :
    - Condition : Temp√©rature <= -2¬∞C √† Montr√©al-Est (Gel requis)
    - Mode Admin : D√©finir ARCANA_TEST_WALLET avec votre adresse
    - Bypass automatique pour le wallet admin (fonctionne m√™me √† +20¬∞C)
    
    üîë MODE ADMIN :
    Ligne ~1368 : var ARCANA_TEST_WALLET = 'VOTRE_ADRESSE_0x...';
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1b2735">
    <meta name="description" content="Arcana Game - √âcosyst√®me D√©centralis√© sur Polygon">
    <title>Arcana Game - √âcosyst√®me D√©centralis√©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" defer></script>
    <link rel="preconnect" href="https://polygon-rpc.com">
    <link rel="preconnect" href="https://cdn.pixabay.com">
    <link rel="dns-prefetch" href="https://esm.sh">
    <style>
        :root {
            --gold: #d4af37;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(212, 175, 55, 0.3);
            --rune-glow-blue: #49cafa;
            --frost-muted: #adb5bd;
        }
        * {
            font-family: 'Cinzel', serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Cinzel', serif;
            font-weight: 400;
            letter-spacing: 0.15em;
        }
        body {
            perspective: 1000px;
            /* Couloir de pierre en perspective - arri√®re-plan principal */
            background: 
                /* Murs lat√©raux sombres */
                linear-gradient(90deg, 
                    rgba(20, 15, 10, 1) 0%, 
                    rgba(30, 25, 20, 0.9) 10%,
                    transparent 25%,
                    transparent 75%,
                    rgba(30, 25, 20, 0.9) 90%,
                    rgba(20, 15, 10, 1) 100%),
                /* Sol en dalles */
                linear-gradient(180deg,
                    transparent 0%,
                    transparent 50%,
                    rgba(25, 20, 15, 0.8) 70%,
                    rgba(20, 15, 10, 1) 100%),
                /* Fond de pierre sombre */
                radial-gradient(ellipse at 50% 50%, 
                    rgba(40, 35, 30, 1) 0%, 
                    rgba(25, 20, 15, 1) 50%,
                    rgba(15, 10, 5, 1) 100%);
            background-size: 100% 100%;
            background-attachment: fixed;
            color: white;
            font-family: 'Cinzel', serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        /* Texture de pierre sur le body */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                /* Joints de dalles au sol */
                repeating-linear-gradient(90deg,
                    transparent 0,
                    transparent 150px,
                    rgba(0, 0, 0, 0.3) 150px,
                    rgba(0, 0, 0, 0.3) 152px),
                repeating-linear-gradient(0deg,
                    transparent 0,
                    transparent 100px,
                    rgba(0, 0, 0, 0.25) 100px,
                    rgba(0, 0, 0, 0.25) 102px),
                /* Texture granuleuse */
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            opacity: 0.6;
            pointer-events: none;
            z-index: 0;
        }
        #star-container {
            display: none; /* √âtoiles d√©sactiv√©es pour correspondre √† l'interface finale */
        }
        .star {
            display: none;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        /* Glass panels normaux - Fond l√©ger semi-transparent pour les menus */
        .glass-panel {
            font-family: 'Cinzel', serif;
            background: rgba(15, 12, 8, 0.88);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 2px solid rgba(212, 175, 55, 0.5);
            border-radius: 18px;
            box-shadow: 
                0 0 60px rgba(0, 0, 0, 0.9),
                0 0 100px rgba(212, 175, 55, 0.15),
                inset 0 0 40px rgba(0, 0, 0, 0.3);
            padding: 28px;
            margin: 20px;
            width: 90%;
            max-width: 520px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        /* EXCEPTION CRITIQUE: Sanctuaire totalement transparent */
        #level-3-sanctuary.glass-panel,
        #level-3-sanctuary {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 20px !important;
            width: 100vw !important;
            max-width: none !important;
        }
        .glass-panel.glitch {
            /* Glitch border red effect */
            animation: glitch-border 0.12s steps(1) infinite alternate, border-shake 0.17s linear infinite alternate;
            border: 2.5px solid #ff2424 !important;
            box-shadow: 0 0 22px 4px #ff2424, 0 0 2px 2px #d10000 inset;
        }
        @keyframes glitch-border {
            0% { filter: none; }
            25% { filter: contrast(1.3) brightness(1.1) hue-rotate(-12deg); }
            51% { filter: contrast(2.4) brightness(1.2) hue-rotate(10deg); }
            75% { filter: saturate(2) brightness(0.97) grayscale(0.2); }
            100% { filter: none; }
        }
        @keyframes border-shake {
            0%   { box-shadow: 0 0 15px 2px #af2222, 0 0 5px 2px #ff3c3c inset; }
            45%  { box-shadow: -2px 1px 22px 4px #ff2424, 1px -1px 2px 2px #ff7676 inset; }
            51%  { box-shadow: 1px -2px 23px 1px #e71e1e, 0 1px 2.5px 1px #ffe4e4 inset; }
            100% { box-shadow: 0 0 22px 4px #ff2424, 0 0 2px 2px #d10000 inset; }
        }
        header {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 16px 30px;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(180deg, rgba(18, 14, 10, 0.94) 0%, rgba(14, 11, 8, 0.65) 80%, transparent 100%);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            pointer-events: auto;
            gap: 25px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.6);
        }
        /* Logo Arcana - Discret et √©l√©gant √† gauche */
        .logo-arcana {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Cinzel', serif;
            font-size: 0.75em;
            color: rgba(212, 175, 55, 0.8);
            letter-spacing: 0.12em;
            font-weight: 300;
            text-transform: uppercase;
            opacity: 0.85;
            justify-self: start;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .logo-arcana:hover {
            opacity: 1;
            color: var(--gold);
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
        }
        .logo-arcana img {
            height: 45px;
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.5));
            transition: filter 0.3s ease;
        }
        .logo-arcana:hover img {
            filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.8));
        }
        .logo-arcana-title {
            font-family: 'Cinzel', serif !important;
            font-size: 0.75em;
            color: #d4af37 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.12em;
            font-weight: 300;
        }
        /* Titre central avec plaque d√©corative */
        .header-title-plate {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 32px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(212, 175, 55, 0.5);
            border-radius: 18px;
            box-shadow: 
                0 0 35px rgba(0, 0, 0, 0.8),
                inset 0 0 25px rgba(212, 175, 55, 0.06);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            justify-self: center;
        }
        .header-title-main {
            font-family: 'Cinzel', serif;
            font-size: 1em;
            color: var(--gold);
            letter-spacing: 0.2em;
            font-weight: 400;
            text-transform: uppercase;
            margin: 0;
            padding: 0;
            line-height: 1.3;
            text-shadow: 0 0 18px rgba(212, 175, 55, 0.5);
        }
        .header-title-separator {
            width: 80%;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(212, 175, 55, 0.2) 20%, 
                rgba(212, 175, 55, 0.6) 50%, 
                rgba(212, 175, 55, 0.2) 80%, 
                transparent 100%);
            margin: 6px auto 5px;
        }
        .header-title-level {
            font-family: 'Cinzel', serif;
            font-size: 0.65em;
            color: rgba(212, 175, 55, 0.7);
            letter-spacing: 0.3em;
            font-weight: 300;
            text-transform: uppercase;
        }
        /* Boutons navigation - Forme pilule transparente */
        .header-nav-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-self: end;
        }
        .header-btn-pill {
            font-family: 'Cinzel', serif;
            background: transparent;
            color: rgba(212, 175, 55, 0.85);
            border: 1px solid rgba(212, 175, 55, 0.5);
            padding: 7px 18px;
            border-radius: 50px;
            font-size: 0.7em;
            font-weight: 400;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            white-space: nowrap;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .header-btn-pill:hover {
            background: rgba(212, 175, 55, 0.12);
            border-color: rgba(212, 175, 55, 0.9);
            color: rgba(255, 215, 0, 1);
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.4);
            text-shadow: 0 0 12px rgba(212, 175, 55, 0.6);
            transform: translateY(-1px);
        }
        /* Masquer les boutons w3m sauf dans la gate et le wrapper */
        w3m-button {
            display: none !important;
        }
        #gate-connect-wrap w3m-button,
        .wallet-button-wrap w3m-button {
            display: block !important;
        }
        .wallet-button-wrap {
            transform: scale(0.8);
            transform-origin: center;
        }
        #gate-connect-wrap {
            position: fixed !important;
            top: 10px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 100000 !important;
        }
        /* Responsive Header */
        @media (max-width: 1024px) {
            header {
                padding: 15px 20px;
                gap: 15px;
            }
            .header-title-plate {
                padding: 10px 25px;
            }
            .header-title-main {
                font-size: 0.95em;
            }
            .header-btn-pill {
                padding: 7px 16px;
                font-size: 0.7em;
            }
        }
        @media (max-width: 768px) {
            header {
                grid-template-columns: auto 1fr auto;
                padding: 12px 15px;
                gap: 10px;
            }
            .logo-arcana {
                font-size: 0.7em;
            }
            .logo-arcana img {
                height: 40px;
            }
            .header-title-plate {
                padding: 8px 18px;
                border-radius: 14px;
            }
            .header-title-main {
                font-size: 0.7em;
                letter-spacing: 0.15em;
            }
            .header-title-separator {
                margin: 4px auto 3px;
                width: 75%;
            }
            .header-title-level {
                font-size: 0.55em;
            }
            .header-nav-buttons {
                gap: 6px;
            }
            .header-btn-pill {
                padding: 6px 12px;
                font-size: 0.6em;
            }
        }
        @media (max-width: 480px) {
            header {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                padding: 10px;
                gap: 8px;
            }
            .logo-arcana {
                justify-self: center;
                order: 3;
                font-size: 0.65em;
            }
            .header-title-plate {
                order: 1;
                justify-self: center;
                padding: 7px 16px;
            }
            .header-title-main {
                font-size: 0.65em;
                letter-spacing: 0.12em;
            }
            .header-title-separator {
                margin: 3px auto 2px;
                width: 70%;
            }
            .header-title-level {
                font-size: 0.5em;
            }
            .header-nav-buttons {
                order: 2;
                justify-self: center;
                width: 100%;
                justify-content: center;
                gap: 8px;
            }
            .header-btn-pill {
                flex: 1;
                text-align: center;
                padding: 7px 10px;
                font-size: 0.55em;
            }
        }
        .btn-connect {
            font-family: 'Cinzel', serif;
            background: linear-gradient(45deg, #d4af37, #f2d06b);
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            letter-spacing: 0.05em;
        }
        .btn-connect:hover:not([disabled]):not(.disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--gold);
            cursor: pointer;
        }
        .btn-connect[disabled], .btn-connect.disabled {
            background: linear-gradient(45deg, #d4d4d4, #bbbbbb) !important;
            color: #888 !important;
            cursor: not-allowed;
            opacity: 0.68;
        }
        .title-vault {
            display: none; /* Cach√© pour interface √©pur√©e selon image */
        }
        /* Section Oracle (Niveau 2) */
        .oracle-mirror {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.2), transparent);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
            position: relative;
            transition: all 0.5s ease;
        }
        .oracle-mirror.loading {
            border-color: rgba(173, 181, 189, 0.5);
            animation: oracle-pulse 2s ease-in-out infinite;
        }
        @keyframes oracle-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(173, 181, 189, 0.3); }
            50% { box-shadow: 0 0 25px rgba(173, 181, 189, 0.6); }
        }
        .oracle-mirror.frozen {
            border: 3px solid #b9e9ff !important;
            background: radial-gradient(circle, rgba(135, 206, 235, 0.4), transparent) !important;
            box-shadow: 0 0 30px #49cafa, 0 0 10px #ffffff inset !important;
        }
        .oracle-mirror #temp {
            font-size: 2.2em;
            font-weight: 600;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.08em;
        }
        /* Salle 2 (Niveau 2) : transparent pour voir le couloir */
        #level-2-panel {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        #level-2-panel:has(.oracle-mirror.frozen) {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border: 1px solid rgba(185, 233, 255, 0.3);
            box-shadow: none;
            opacity: 1;
        }
        .oracle-temp-warning {
            font-family: 'Cinzel', serif;
            color: var(--frost-muted);
            font-weight: 400;
            font-size: 0.85em;
            text-align: center;
            margin-top: 1em;
            padding: 12px;
            background: rgba(173, 181, 189, 0.08);
            border-radius: 8px;
            border: 1px solid rgba(173, 181, 189, 0.2);
            line-height: 1.6;
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
        }
        .oracle-temp-warning:empty {
            display: none !important;
        }
        #chat-temple {
            display: none; /* Cach√© par d√©faut - s'affiche via la Taverne */
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            font-size: 0.9em;
            font-family: 'Cinzel', serif;
        }
        .input-arcana {
            font-family: 'Cinzel', serif;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(212, 175, 55, 0.5);
            color: var(--gold);
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            box-sizing: border-box;
            font-weight: 400;
            letter-spacing: 0.05em;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .label-gold {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.15em;
            font-weight: 400;
        }
        .class-card {
            cursor: pointer;
            padding: 15px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 15px;
            transition: 0.3s;
            width: 80px;
        }
        .class-card:hover {
            background: rgba(214, 175, 55, 0.2);
            border-color: var(--gold);
            box-shadow: 0 0 15px var(--gold);
            transform: translateY(-5px);
        }
        .class-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        /* Digital Countdown - Cach√© par d√©faut */
        .digital-timer {
            display: none;
        }
        .digital-timer.danger {
            color: #fff0f0;
            background: #b30505DD;
            text-shadow: 0 0 9px #ff2424, 0 0 36px #ff555555;
            border-color: #ff2424aa;
            animation: glitch-border 0.15s steps(1) infinite alternate;
        }
        /* Runes - Cercles dor√©s (r√©duits 20%) */
        .runes-column .rune-btn {
            width: 70px;
            height: 70px;
            margin: 0;
            transform: scale(0.8);
        }
        .rune-btn {
            /* Structure */
            font-family: 'Cinzel', serif;
            font-size: 2em;
            padding: 0;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            
            /* Transparence totale avec bordure dor√©e ultra-fine (lueur) */
            background: transparent !important;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            
            /* Symbole dor√© */
            color: rgba(212, 175, 55, 1);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
            
            /* Interactions */
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            user-select: none;
        }
        
        /* Effet de surbrillance dor√© au survol - reste transparent */
        .rune-btn:hover:not(:disabled) {
            background: transparent !important;
            border-color: rgba(212, 175, 55, 0.9);
            color: rgba(255, 215, 0, 1);
            text-shadow: 
                0 0 25px rgba(255, 215, 0, 1),
                0 0 35px rgba(212, 175, 55, 0.9),
                0 0 45px rgba(212, 175, 55, 0.6);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.7);
            transform: scale(0.9);
        }
        
        /* Animation qu√™te active - Pulse dor√© */
        .rune-btn.quete-active {
            animation: rune-quete-pulse 2.5s ease-in-out infinite;
        }
        @keyframes rune-quete-pulse {
            0%, 100% {
                border-color: rgba(212, 175, 55, 0.25);
                color: rgba(212, 175, 55, 0.9);
                text-shadow: 0 0 8px rgba(212, 175, 55, 0.4);
                box-shadow: none;
            }
            50% {
                border-color: rgba(255, 215, 0, 0.8);
                color: rgba(255, 215, 0, 1);
                text-shadow: 
                    0 0 20px rgba(255, 215, 0, 1),
                    0 0 30px rgba(212, 175, 55, 0.8);
                box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);
                transform: scale(0.84);
            }
        }
        /* Feedback visuel pour les runes avec cercle dor√© */
        .rune-btn.selected,
        .rune-btn.good {
            border-color: rgba(73, 202, 250, 0.9);
            color: rgba(73, 202, 250, 1);
            text-shadow: 
                0 0 20px rgba(73, 202, 250, 1),
                0 0 30px rgba(73, 202, 250, 0.7);
            box-shadow: 0 0 25px rgba(73, 202, 250, 0.5);
            animation: rune-feedback-good 0.6s ease;
        }
        .rune-btn.bad {
            border-color: rgba(255, 68, 68, 0.9);
            color: rgba(255, 68, 68, 1);
            text-shadow: 
                0 0 20px rgba(255, 68, 68, 1),
                0 0 30px rgba(255, 68, 68, 0.7);
            box-shadow: 0 0 25px rgba(255, 68, 68, 0.5);
            animation: rune-feedback-bad 0.4s ease;
        }
        /* Effet dor√© au clic */
        .rune-btn.click-gold {
            filter: drop-shadow(0 0 15px #d4af37) !important;
            transition: filter 0.2s ease;
        }
        @keyframes rune-feedback-good {
            0%, 100% {
                transform: scale(0.8);
            }
            50% {
                transform: scale(0.92);
            }
        }
        @keyframes rune-feedback-bad {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-6px);
            }
            75% {
                transform: translateX(6px);
            }
        }
        /* Progress bar - Cach√©e (√©puration) */
        .alignement-container,
        .alignement-label,
        .alignement-bar-bg,
        .alignement-bar-fill,
        .alignement-percentage {
            display: none;
        }
        /* Salle 3 (Sanctuaire) : pierre ancienne, bordure dor√©e pulsante */
        @keyframes golden-border-pulse {
            0%, 100% { box-shadow: 0 0 12px rgba(212, 175, 55, 0.5); border-color: rgba(212, 175, 55, 0.9); }
            50% { box-shadow: 0 0 22px rgba(212, 175, 55, 0.7); border-color: #d4af37; }
        }
        /* Animation d'entr√©e douce pour le sanctuaire */
        @keyframes sanctuaire-shift-up {
            0% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translateY(-20%) scale(0.85);
                opacity: 0.95;
            }
        }
        @keyframes sanctuaire-shift-down {
            0% {
                transform: translate(-50%, -50%) translateY(-20%) scale(0.85);
                opacity: 0.95;
            }
            100% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }
        #level-3-sanctuary {
            /* Nettoyage complet - Vue d√©gag√©e sur le d√©cor */
            display: grid;
            grid-template-columns: 120px 1fr 120px;
            gap: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            width: 100vw;
            height: 100vh;
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-sizing: border-box;
            transition: opacity 0.5s ease;
            pointer-events: auto;
            padding: 100px 20px 20px 20px;
            overflow: hidden;
            box-shadow: inset 0 0 150px rgba(0, 0, 0, 0.9);
        }
        #level-3-sanctuary.sac-ouvert {
            opacity: 0.6;
        }
        /* Colonnes de runes - Contour ultra-fin, transparence/blur l√©ger */
        .runes-column {
            display: flex !important;
            flex-direction: column !important;
            justify-content: space-evenly !important;
            align-items: center !important;
            gap: 6px;
            min-height: 85vh;
            background: transparent !important;
            border: 1px solid rgba(212, 175, 55, 0.3) !important;
            box-shadow: none !important;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.5));
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 10;
            position: relative;
            padding: 40px 0;
            padding-top: 130px !important;
        }
        .runes-column.left {
            grid-column: 1;
            justify-self: start;
            align-items: flex-start !important;
            padding-left: 35px;
            padding-top: 130px !important;
        }
        .runes-column.right {
            grid-column: 3;
            justify-self: end;
            align-items: flex-end !important;
            padding-right: 35px;
            padding-top: 130px !important;
        }
        /* Forcer la transparence absolue sur tous les enfants des colonnes */
        .runes-column,
        .runes-column * {
            background-color: transparent !important;
            background-image: none !important;
        }
        .runes-column .rune-btn {
            background: transparent !important;
        }
        /* Quand le sac est ouvert - runes restent visibles mais l√©g√®rement att√©nu√©es */
        #level-3-sanctuary.sac-ouvert .rune-btn {
            opacity: 0.7;
        }
        #level-3-sanctuary.sac-ouvert .rune-btn:hover:not(:disabled) {
            opacity: 1;
        }
        @media (max-width: 768px) {
            #level-3-sanctuary {
                grid-template-columns: 95px 1fr 95px;
                padding: 15px 5px;
            }
            .runes-column {
                min-height: 78vh;
                gap: 5px;
                padding-top: 140px !important;
            }
            .runes-column.left {
                padding-left: 15px;
                padding-top: 140px !important;
            }
            .runes-column.right {
                padding-right: 15px;
                padding-top: 140px !important;
            }
            .runes-column .rune-btn {
                width: 58px;
                height: 58px;
                transform: scale(0.8);
            }
            .rune-btn {
                font-size: 1.4em;
                width: 58px;
                height: 58px;
            }
            #btn-sacoche {
                bottom: 20px;
                width: 54px;
                height: 54px;
                font-size: 1.6em;
            }
        }
        @media (max-width: 480px) {
            #level-3-sanctuary {
                grid-template-columns: 75px 1fr 75px;
                padding: 12px 3px;
            }
            .runes-column {
                min-height: 72vh;
                gap: 5px;
                padding-top: 160px !important;
            }
            .runes-column.left {
                padding-left: 12px;
                padding-top: 160px !important;
            }
            .runes-column.right {
                padding-right: 12px;
                padding-top: 160px !important;
            }
            .runes-column .rune-btn {
                width: 50px;
                height: 50px;
                transform: scale(0.8);
            }
            .rune-btn {
                font-size: 1.2em;
                width: 50px;
                height: 50px;
            }
            #btn-sacoche {
                bottom: 18px;
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }
            .btn-back-accueil {
                font-size: 0.65rem;
                padding: 6px 12px;
            }
        }
        /* JACKPOT VICTORY style */
        #victory-jackpot {
            display: none;
            position: fixed;
            z-index: 2000;
            top: 0;left: 0;right:0;bottom:0;
            background:rgba(20, 10, 1, 0.95);
            width:100vw; height:100vh;
            pointer-events: none;
        }
        #victory-jackpot .victory-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -70%);
            color: #ffd900;
            font-size: 2.7em;
            font-family:'Orbitron','VT323',monospace;
            letter-spacing: 0.13em;
            text-align:center;
            text-shadow: 0 0 22px #fff799, 0 0 48px #d4af37, 0 0 128px #ffed80;
            filter: brightness(1.3) drop-shadow(0 0 16px #f2cf5e);
            animation:victoryPopup 1s cubic-bezier(.38,2,0,.97);
        }
        @keyframes victoryPopup {
            0%{opacity:0;transform: translate(-50%,-46%) scale(0.7);}
            85%{opacity:1;transform: translate(-50%,-48%) scale(1.07);}
            100%{opacity:1;transform:translate(-50%,-70%) scale(1);}
        }
        /* Golden Rain Particles - au-dessus des murs de pierre */
        .gold-rain {
            position: absolute;
            pointer-events: none;
            z-index: 2200;
            top:0; left:0;width:100vw;height:100vh;overflow:hidden;
        }
        .gold-drop {
            position: absolute;
            width: 7px; height: 25px;
            border-radius: 7px 7px 9px 9px/13px;
            opacity: 0.98;
            background: linear-gradient(179deg,#fffbe7 4%,#ffe769 33%,#ecd16b 85%,#d4af37 100%);
            filter: blur(0.2px) brightness(1.18);
            box-shadow: 0 0 3px #fffbe7, 0 8px 24px #d4af3799;
            animation: gold-rain-swoosh 1.45s linear forwards;
        }
        @keyframes gold-rain-swoosh {
            0% { transform: translateY(-70px) scaleY(0.5) rotate(-9deg);}
            26%{ opacity: 1;}
            90% { opacity: 0.98;}
            100% { transform: translateY(110vh) scaleY(1.1) rotate(7deg); opacity: 0;}
        }
        /* Nouveaux styles pour le s√©lecteur de token */
        .token-select-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }
        .arcana-token-option {
            color: #FADB1C;
        }

        /* Brume atmosph√©rique - D√©sactiv√©e pour vue d√©gag√©e */
        #arcana-fog {
            display: none;
        }
        #arcana-fog::before,
        #arcana-fog.sanctuary-active,
        #arcana-fog.jackpot-golden {
            display: none;
        }
        @keyframes fog-drift {
            0%, 100% { transform: translateX(0) scaleX(1); }
            50% { transform: translateX(2%) scaleX(1.02); }
        }
        @keyframes fog-sweep {
            0%, 100% { transform: translateX(0); opacity: 0.6; }
            50% { transform: translateX(5%); opacity: 1; }
        }

        /* Mentions l√©gales - Cach√©es pour √©puration */
        .arcana-mention {
            display: none;
        }
        /* √âcran d'attente : compl√®tement transparent */
        #arcana-connect-gate {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: transparent !important;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            pointer-events: auto;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }
        #arcana-connect-gate.hidden { display: none; }
        #arcana-connect-gate:not(.hidden) { display: flex !important; }
        body:has(#arcana-connect-gate:not(.hidden)) { overflow: hidden; height: 100vh; }
        #arcana-connect-gate .gate-message {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.1em;
            background: transparent !important;
            letter-spacing: 0.15em;
            text-align: center;
            margin: 0;
            padding: 0;
            opacity: 1;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
            border: none !important;
            box-shadow: none !important;
        }
        /* Ancien bouton retour - D√©sormais int√©gr√© dans le header */
        .btn-back-accueil {
            display: none;
        }
        /* Contenu jeu : effet de salle (tunnel/temple) */
        #game-container, #arcana-game-content { 
            display: none; 
            opacity: 0;
            background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%), url('https://images.unsplash.com/photo-1605806616949-1e87b487fc2f?q=80&w=2070&auto=format&fit=crop') !important;
            background-size: cover !important;
        }
        #game-container.visible, #arcana-game-content.visible { 
            display: block;
            background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%), url('https://images.unsplash.com/photo-1605806616949-1e87b487fc2f?q=80&w=2070&auto=format&fit=crop') !important;
            background-size: cover !important;
        }
        /* Masquer tous les panels sauf le sanctuaire par d√©faut */
        #class-selection,
        #level-2-panel,
        #arcane-level-panel,
        #arcane-altar-panel {
            display: none !important;
        }
        /* Identification wallet : coin de l'√©cran */
        .wallet-address-badge {
            position: fixed; top: 12px; right: 12px; z-index: 600;
            font-size: 0.7rem; font-family: 'Cinzel', serif; color: var(--gold);
            background: rgba(0,0,0,0.6); padding: 7px 14px; border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.4); letter-spacing: 0.08em;
            font-weight: 400;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        /* Badge Mode Test */
        .test-mode-badge {
            display: none;
        }
        /* Admin trigger - Discret */
        .admin-trigger {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 0.7rem;
            color: rgba(212, 175, 55, 0.3);
            cursor: pointer;
            z-index: 500;
            transition: color 0.3s;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.1em;
        }
        .admin-trigger:hover {
            color: rgba(212, 175, 55, 0.7);
        }
        .admin-stat {
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            margin: 8px 0;
        }
        .admin-close {
            font-family: 'Cinzel', serif;
        }
        @keyframes test-badge-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; box-shadow: 0 0 12px rgba(0, 255, 136, 0.4); }
        }
        /* Alerte Oracle stylis√©e */
        .oracle-network-alert {
            font-family: 'Cinzel', serif;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; 
            background: rgba(20, 15, 10, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(212, 175, 55, 0.6);
            border-radius: 16px; padding: 28px; max-width: 380px; text-align: center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9), 0 0 80px rgba(212, 175, 55, 0.2);
        }
        .oracle-network-alert p { 
            font-family: 'Cinzel', serif;
            color: var(--gold); 
            margin: 0 0 18px 0; 
            line-height: 1.7;
            letter-spacing: 0.05em;
        }
        .oracle-network-alert .btn-connect { margin-top: 12px; }
        /* Transition connexion : fade-out message / fade-in Sanctuaire */
        #arcana-connect-gate.fade-out { opacity: 0; pointer-events: none; }
        #arcana-connect-gate.fade-out .gate-message,
        #arcana-connect-gate.fade-out .gate-connect-wrap { opacity: 0; transform: scale(0.95); }
        #arcana-connect-gate .gate-message,
        #arcana-connect-gate .gate-connect-wrap { transition: opacity 0.6s ease, transform 0.6s ease; }
        @media (max-width: 480px) {
            #arcana-connect-gate .gate-message { font-size: 0.95em; }
        }
        #game-container.fade-in, #arcana-game-content.fade-in { animation: sanctuary-fade-in 1s ease forwards; }
        @keyframes sanctuary-fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        /* Filtre bleu givre √† la connexion */
        body.frost-transition #arcana-fog { opacity: 0.95; filter: blur(35px); }
        body.frost-transition #arcana-fog,
        body.frost-transition #star-container { filter: blur(2px) hue-rotate(-5deg) saturate(0.9); }
        /* Particules de givre */
        #frost-particles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 550; opacity: 0;
            transition: opacity 0.8s ease;
        }
        #frost-particles.active { opacity: 1; }
        .frost-dot {
            position: absolute; width: 2px; height: 2px; background: rgba(220, 240, 255, 0.8);
            border-radius: 50%; animation: frost-fall 4s linear forwards;
        }
        @keyframes frost-fall {
            0% { transform: translateY(-10px) scale(1); opacity: 0.8; }
            100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
        }
        /* === Syst√®me d'obscurit√© et Lumi√®re === */
        #arcane-darkness-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 450;
            background: radial-gradient(circle 120px at var(--cursor-x, 50%) var(--cursor-y, 50%), transparent 0%, transparent 35%, rgba(0,0,0,0.97) 100%);
            transition: background 0.08s ease-out;
        }
        #arcane-darkness-overlay.room-lit-1 { --room1-mask: transparent; }
        #arcane-darkness-overlay.room-lit-2 { --room2-mask: transparent; }
        .arcane-light-object {
            display: none; /* Cach√© pour √©puration */
        }
        /* Inventaire cl√©s - Cach√© (tout passe par la sacoche) */
        #arcane-inventory {
            display: none;
        }
        #arcane-inventory .keys-count { color: var(--gold); font-weight: bold; font-size: 1.2em; }
        #arcane-inventory .keys-label { color: rgba(255,255,255,0.8); font-size: 0.75em; }
        /* Autel des Cl√©s */
        #arcane-altar-panel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
            z-index: 510; background: rgba(0,0,0,0.9); border: 2px solid var(--gold); border-radius: 20px;
            padding: 24px; max-width: 340px; text-align: center;
        }
        .arcane-door { transition: opacity 0.5s, filter 0.5s; }
        .arcane-door.locked { opacity: 0.35; pointer-events: none; filter: grayscale(0.8); }
        /* Brouillard sombre */
        #arcane-dark-fog {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 440;
            background: radial-gradient(ellipse 150% 150% at 50% 50%, transparent 30%, rgba(10,5,20,0.7) 80%, rgba(5,2,15,0.9) 100%);
            opacity: var(--fog-opacity, 0.85); transition: opacity 1.5s ease;
        }
        /* === Syst√®me 100 niveaux === */
        #arcane-level-counter {
            position: fixed; top: 12px; right: 80px; z-index: 610;
            font-family: 'Cinzel', serif;
            font-size: 1.2rem; font-weight: 400;
            color: var(--gold);
            text-shadow: 0 0 15px rgba(212,175,55,0.5);
            letter-spacing: 0.2em;
        }
        .arcane-level-door {
            font-family: 'Cinzel', serif;
            min-width: 100px; padding: 16px 24px; margin: 8px;
            font-size: 0.9em; cursor: pointer; border-radius: 12px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: rgba(0,0,0,0.6); color: var(--gold);
            transition: all 0.3s;
            font-weight: 400;
            letter-spacing: 0.05em;
        }
        .arcane-level-door:hover { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        .arcane-level-door.wrong { border-color: #ff4444; background: rgba(255,68,68,0.2); animation: door-shake 0.4s; }
        .arcane-level-door.vip-trap { opacity: 0.7; box-shadow: 0 0 12px rgba(255,68,68,0.6); border-color: rgba(255,100,100,0.6); }
        .arcane-level-door.vip-shortcut { opacity: 0.85; box-shadow: 0 0 14px rgba(212,175,55,0.7); border-color: rgba(212,175,55,0.8); }
        @keyframes door-shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
        #arcane-level-panel { max-width: 520px; }
        #arcane-doors-container { display: flex; flex-wrap: wrap; justify-content: center; margin: 20px 0; gap: 12px; }
        .arcane-scroll-object { position: absolute; width: 36px; height: 36px; cursor: pointer; z-index: 465;
            font-size: 1.4em; opacity: 0.5; transition: opacity 0.3s; pointer-events: auto;
            filter: drop-shadow(0 0 8px rgba(212,175,55,0.5));
        }
        .arcane-scroll-object:hover { opacity: 1; }
        .arcane-scroll-object.revealed { opacity: 0.3; pointer-events: none; }
        .arcane-corner-clue { position: absolute; width: 32px; height: 32px; cursor: pointer; z-index: 464;
            font-size: 1.2em; opacity: 0.35; transition: opacity 0.3s; pointer-events: auto;
        }
        .arcane-corner-clue:hover { opacity: 1; }
        .arcane-corner-clue.used { opacity: 0.2; pointer-events: none; }
        #arcane-pyramid-map {
            display: none; /* Cach√© pour √©puration */
        }
        .pyramid-row { display: flex; justify-content: center; gap: 2px; margin: 1px 0; font-size: 8px; }
        .pyramid-cell { width: 10px; height: 10px; background: rgba(255,255,255,0.1); border-radius: 2px; color: #666; }
        .pyramid-cell.player { background: var(--gold); color: #000; box-shadow: 0 0 6px var(--gold); }
        #arcane-nav-key-panel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
            z-index: 512; background: rgba(0,0,0,0.92); border: 2px solid var(--gold); border-radius: 16px;
            padding: 20px; text-align: center;
        }
        /* L'√âcho du Sanctuaire ‚Äî Bandeau d√©filant style parchemin */
        #arcane-echo-journal {
            display: none; /* Cach√© pour √©puration */
        }
        #arcane-echo-journal .echo-title { color: var(--gold); font-weight: 700; flex-shrink: 0; margin-right: 16px; letter-spacing: 0.12em; }
        #arcane-echo-ticker { flex: 1; overflow: hidden; white-space: nowrap; }
        #arcane-echo-ticker .echo-scroll { display: inline-block; padding-left: 100%; animation: echo-scroll 30s linear infinite; }
        #arcane-echo-ticker .echo-scroll.paused { animation-play-state: paused; }
        @keyframes echo-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .pyramid-cell.loot { animation: pyramid-loot-blink 1.5s ease-in-out infinite; }
        @keyframes pyramid-loot-blink { 0%,100% { background: rgba(212,175,55,0.4); box-shadow: 0 0 4px var(--gold); } 50% { background: var(--gold); color: #000; box-shadow: 0 0 10px var(--gold); } }
        /* === Grimoire d'Arcana === */
        #grimoire-btn {
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 2000;
            display: none; /* Cach√© par d√©faut pour √©puration */
            width: 56px; height: 56px; border-radius: 12px;
            background: linear-gradient(145deg, #2a2520, #1a1612);
            border: 2px solid rgba(212,175,55,0.6);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(212,175,55,0.2);
            cursor: pointer; font-size: 1.8em; display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        #grimoire-btn:hover { transform: scale(1.08); box-shadow: 0 0 25px rgba(212,175,55,0.5), 0 0 8px var(--gold); }
        #grimoire-panel {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.85);
            z-index: 600; width: 94vw; max-width: 420px; max-height: 90vh;
            background: linear-gradient(180deg, #f4e9d0 0%, #e8dcc4 20%, #dfd0a8 50%, #d4c490 100%);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"),
                linear-gradient(180deg, #f4e9d0 0%, #e8dcc4 20%, #dfd0a8 50%, #d4c490 100%);
            border: 3px solid #b8860b;
            box-shadow: 0 0 30px rgba(184,134,11,0.5), inset 0 1px 0 rgba(255,255,255,0.3), 4px 4px 15px rgba(0,0,0,0.2);
            border-radius: 4px;
            font-family: 'Libre Baskerville', 'Times New Roman', Georgia, serif;
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        #grimoire-panel.grimoire-open {
            opacity: 1; transform: translate(-50%,-50%) scale(1);
            animation: grimoire-book-open 0.5s ease-out forwards;
        }
        @keyframes grimoire-book-open {
            0% { transform: translate(-50%,-50%) scale(0.7); opacity: 0; }
            60% { transform: translate(-50%,-50%) scale(1.02); opacity: 1; }
            100% { transform: translate(-50%,-50%) scale(1); opacity: 1; }
        }
        .grimoire-paper {
            padding: 20px 22px 24px; margin: 12px; margin-right: 18px;
            background: rgba(250,245,230,0.5);
            border: 1px solid rgba(184,134,11,0.3);
            border-radius: 2px;
            color: #3d3525;
            font-size: clamp(0.9rem, 2.8vw, 1.05rem);
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
        }
        .grimoire-tome-title { font-size: clamp(1rem, 3.5vw, 1.25rem); font-weight: 700; color: #5c4a2a; text-align: center; margin-bottom: 16px; letter-spacing: 0.08em; }
        .grimoire-tome-text { margin-bottom: 20px; text-align: justify; }
        .grimoire-unlock-btn { width: 100%; padding: 14px 20px; margin: 16px 0; font-size: clamp(0.85rem, 2.8vw, 1rem);
            background: linear-gradient(180deg, #d4af37 0%, #b8860b 100%); color: #1a1510;
            border: 2px solid #8b6914; border-radius: 8px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .grimoire-unlock-btn:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(212,175,55,0.4); }
        .grimoire-inv-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 18px; }
        .grimoire-inv-item { display: flex; flex-direction: column; align-items: center; padding: 12px 8px;
            background: rgba(255,255,255,0.5); border: 1px solid rgba(184,134,11,0.4);
            border-radius: 8px; font-size: clamp(0.75rem, 2.2vw, 0.9rem); color: #4a3d2a;
        }
        .grimoire-inv-icon { font-size: 1.8em; margin-bottom: 6px; }
        .grimoire-inv-num { font-weight: bold; color: #5c4a2a; }
        .grimoire-close { position: absolute; top: 10px; right: 10px; width: 36px; height: 36px; border: 1px solid rgba(184,134,11,0.5);
            background: rgba(220,200,160,0.4); color: #5c4a2a; border-radius: 6px; cursor: pointer; font-size: 1.3em; z-index: 2;
        }
        .grimoire-close:hover { background: rgba(184,134,11,0.3); }
        
        /* === PAPYRUS ANCIEN - Modal Centr√©e avec fond transparent === */
        #papyrus-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #papyrus-modal.active {
            display: flex;
            opacity: 1;
        }
        .papyrus-scroll {
            position: relative;
            width: 85vw;
            max-width: 650px;
            height: 75vh;
            max-height: 850px;
            /* Fond de parchemin beige/dor√© comme dans l'image */
            background: linear-gradient(180deg, #e8d5b5 0%, #d9c8a8 30%, #c9b898 70%, #b9a888 100%);
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='paper-noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='5' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0.3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paper-noise)' opacity='0.2'/%3E%3C/svg%3E"),
                linear-gradient(180deg, #e8d5b5 0%, #d9c8a8 30%, #c9b898 70%, #b9a888 100%);
            border-left: 35px solid #6b5745;
            border-right: 35px solid #6b5745;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            border-radius: 8px;
            box-shadow: 
                0 0 80px rgba(0, 0, 0, 0.9),
                0 0 120px rgba(0, 0, 0, 0.7),
                inset 0 0 80px rgba(139, 115, 85, 0.25),
                inset 15px 0 40px rgba(0, 0, 0, 0.3),
                inset -15px 0 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transform: scaleY(0);
            transform-origin: top center;
            animation: papyrus-unroll 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            z-index: 10;
        }
        @keyframes papyrus-unroll {
            0% {
                transform: scaleY(0) rotateX(90deg);
                opacity: 0;
            }
            30% {
                opacity: 0.5;
            }
            60% {
                transform: scaleY(1) rotateX(0deg);
                opacity: 1;
            }
            100% {
                transform: scaleY(1) rotateX(0deg);
                opacity: 1;
            }
        }
        @keyframes papyrus-roll-up {
            0% {
                transform: scaleY(1) rotateX(0deg);
                opacity: 1;
            }
            40% {
                transform: scaleY(0.7) rotateX(-15deg);
                opacity: 0.8;
            }
            100% {
                transform: scaleY(0) rotateX(-90deg);
                opacity: 0;
            }
        }
        .papyrus-scroll::before {
            content: '';
            position: absolute;
            top: 0;
            left: -35px;
            width: 35px;
            height: 100%;
            background: linear-gradient(90deg, #5a4735 0%, #6b5745 50%, #5a4735 100%);
            box-shadow: 
                inset -8px 0 15px rgba(0, 0, 0, 0.5),
                inset 0 0 5px rgba(0, 0, 0, 0.3);
            border-radius: 8px 0 0 8px;
        }
        .papyrus-scroll::after {
            content: '';
            position: absolute;
            top: 0;
            right: -35px;
            width: 35px;
            height: 100%;
            background: linear-gradient(90deg, #6b5745 0%, #5a4735 50%, #6b5745 100%);
            box-shadow: 
                inset 8px 0 15px rgba(0, 0, 0, 0.5),
                inset 0 0 5px rgba(0, 0, 0, 0.3);
            border-radius: 0 8px 8px 0;
        }
        .papyrus-content {
            padding: 70px 50px;
            height: 100%;
            overflow-y: auto;
            font-family: 'Cinzel', 'Times New Roman', serif;
            color: #2d1f15;
            position: relative;
            opacity: 0;
            animation: papyrus-text-fade 0.8s ease 0.8s forwards;
        }
        @keyframes papyrus-text-fade {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .papyrus-title {
            font-size: clamp(1.3rem, 3.5vw, 1.8rem);
            font-weight: 400;
            text-align: center;
            margin-bottom: 35px;
            color: #4a3520;
            text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.12em;
            border-bottom: 1px solid rgba(92, 61, 42, 0.25);
            padding-bottom: 20px;
            text-transform: uppercase;
        }
        .papyrus-text {
            font-size: clamp(0.95rem, 2.8vw, 1.1rem);
            line-height: 1.9;
            text-align: left;
            margin-bottom: 20px;
            text-indent: 0;
            font-style: normal;
            /* Effet encre ancienne */
            color: #3d2a1a;
            text-shadow: 
                0.5px 0.5px 1px rgba(92, 61, 42, 0.15);
            filter: contrast(1.05);
            font-weight: 400;
            letter-spacing: 0.02em;
        }
        .papyrus-text-russe {
            font-family: 'Libre Baskerville', 'Times New Roman', serif;
            font-size: clamp(1.3rem, 4vw, 1.8rem);
            text-align: center;
            font-style: italic;
            font-weight: 700;
            letter-spacing: 0.08em;
            color: #4a3520;
            text-shadow: 
                2px 2px 3px rgba(92, 61, 42, 0.4),
                0 0 3px rgba(61, 42, 26, 0.3),
                1px 1px 0 rgba(201, 185, 147, 0.2);
            filter: contrast(1.25) brightness(0.88) sepia(0.2);
            margin: 30px 0;
            padding: 25px 20px;
            background: 
                linear-gradient(135deg, rgba(92, 61, 42, 0.08) 0%, rgba(92, 61, 42, 0.04) 100%),
                repeating-linear-gradient(90deg, transparent 0, transparent 2px, rgba(92, 61, 42, 0.02) 2px, rgba(92, 61, 42, 0.02) 4px);
            border: 2px solid rgba(92, 61, 42, 0.2);
            border-radius: 10px;
            box-shadow: 
                inset 0 2px 5px rgba(92, 61, 42, 0.15),
                0 2px 8px rgba(0, 0, 0, 0.1);
            text-indent: 0;
            position: relative;
        }
        .papyrus-text-russe::before {
            content: '‚ùÑÔ∏è';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5em;
            opacity: 0.6;
        }
        .papyrus-text-russe::after {
            content: '‚ùÑÔ∏è';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5em;
            opacity: 0.6;
        }
        .papyrus-hieroglyph {
            text-align: center;
            font-size: 1.8em;
            margin: 25px 0;
            opacity: 0.7;
            color: #5a4535;
            letter-spacing: 0.3em;
        }
        .papyrus-close-btn {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 35px;
            background: linear-gradient(180deg, #6b5745, #5a4735);
            color: #e8d5b5;
            border: 2px solid #4a3520;
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            font-weight: 400;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }
        .papyrus-close-btn:hover {
            background: linear-gradient(180deg, #7b6755, #6b5745);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.7);
            border-color: #5a4735;
        }
        .papyrus-scroll-bar::-webkit-scrollbar {
            width: 10px;
        }
        .papyrus-scroll-bar::-webkit-scrollbar-track {
            background: rgba(92, 61, 42, 0.2);
        }
        .papyrus-scroll-bar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #8b7355, #6b5745);
            border-radius: 5px;
            border: 2px solid rgba(244, 233, 208, 0.3);
        }
        /* Responsive Papyrus */
        @media (max-width: 768px) {
            .papyrus-scroll {
                width: 95vw;
                height: 80vh;
                border-left-width: 20px;
                border-right-width: 20px;
            }
            .papyrus-content {
                padding: 40px 30px;
            }
            .papyrus-title {
                font-size: 1.3rem;
                margin-bottom: 20px;
            }
            .papyrus-text {
                font-size: 0.95rem;
                line-height: 1.7;
            }
            .papyrus-hieroglyph {
                font-size: 1.5em;
                margin: 20px 0;
            }
        }
        @media (max-width: 480px) {
            .papyrus-scroll {
                border-left-width: 15px;
                border-right-width: 15px;
            }
            .papyrus-content {
                padding: 30px 20px;
            }
            .papyrus-title {
                font-size: 1.1rem;
            }
            .papyrus-text {
                font-size: 0.85rem;
                text-indent: 25px;
            }
            .papyrus-close-btn {
                font-size: 0.8rem;
                padding: 10px 25px;
            }
        }
        
        /* === BOUTON SACOCHE - Centre bas, animation de rebond === */
        @keyframes bounceIn {
            0% { transform: translateX(-50%) rotateX(2deg) scale(0); opacity: 0; }
            60% { transform: translateX(-50%) rotateX(2deg) scale(1.1); opacity: 1; }
            80% { transform: translateX(-50%) rotateX(2deg) scale(0.95); }
            100% { transform: translateX(-50%) rotateX(2deg) scale(1); }
        }
        #btn-sacoche {
            position: fixed !important;
            bottom: 25px !important;
            left: 50% !important;
            transform: translateX(-50%) rotateX(2deg);
            z-index: 9999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: 
                linear-gradient(135deg, 
                    rgba(92, 74, 53, 0.98) 0%, 
                    rgba(74, 61, 47, 1) 50%, 
                    rgba(61, 47, 35, 1) 100%),
                repeating-linear-gradient(90deg, 
                    transparent 0, 
                    transparent 1px, 
                    rgba(0, 0, 0, 0.08) 1px, 
                    rgba(0, 0, 0, 0.08) 2px);
            border: 3px solid rgba(139, 115, 85, 0.9);
            box-shadow: 
                0 8px 35px rgba(0, 0, 0, 0.85),
                inset 0 2px 0 rgba(212, 175, 55, 0.2),
                inset 0 -3px 10px rgba(0, 0, 0, 0.5),
                0 0 25px rgba(139, 115, 85, 0.35);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            transition: all 0.3s ease;
        }
        #btn-sacoche::before {
            content: '';
            position: absolute;
            inset: 6px;
            border: 1px solid rgba(139, 115, 85, 0.3);
            border-radius: 4px;
            pointer-events: none;
        }
        #btn-sacoche::after {
            display: none;
        }
        #btn-sacoche:hover {
            border-color: rgba(212, 175, 55, 1);
            box-shadow: 
                0 10px 35px rgba(0, 0, 0, 0.9),
                0 0 25px rgba(212, 175, 55, 0.5),
                inset 0 2px 0 rgba(212, 175, 55, 0.3);
            transform: translateX(-50%) rotateX(2deg) scale(1.06);
        }
        #btn-sacoche.resonance {
            animation: sac-resonance-pulse 1.5s ease-in-out infinite;
        }
        @keyframes sac-resonance-pulse {
            0%, 100% {
                transform: translateX(-50%) rotateX(2deg) scale(1);
                box-shadow: 0 6px 25px rgba(0, 0, 0, 0.7), inset 0 2px 0 rgba(212, 175, 55, 0.15);
            }
            25% {
                transform: translateX(-50%) rotateX(2deg) scale(1.08);
                box-shadow: 0 0 35px rgba(212, 175, 55, 0.8), 0 0 18px rgba(255, 215, 0, 0.6), inset 0 0 12px rgba(212, 175, 55, 0.4);
            }
            50% {
                transform: translateX(-50%) rotateX(2deg) scale(1.12);
                box-shadow: 0 0 45px rgba(212, 175, 55, 1), 0 0 25px rgba(255, 215, 0, 0.8), inset 0 0 18px rgba(212, 175, 55, 0.6);
            }
            75% {
                transform: translateX(-50%) rotateX(2deg) scale(1.08);
                box-shadow: 0 0 35px rgba(212, 175, 55, 0.8), 0 0 18px rgba(255, 215, 0, 0.6), inset 0 0 12px rgba(212, 175, 55, 0.4);
            }
        }
        #btn-sacoche.resonance::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.3) 0%, transparent 70%);
            animation: sac-resonance-ring 1.5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes sac-resonance-ring {
            0%, 100% {
                transform: scale(1);
                opacity: 0;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
        }
        #btn-sacoche-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #d4af37, #b8860b);
            border-radius: 50%;
            border: 2px solid #000;
            font-size: 0.45em;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: #000;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.8);
            letter-spacing: 0;
        }
        
        /* === OVERLAY DRAWER - Tr√®s subtil pour voir le couloir === */
        #sac-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            z-index: 2400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        #sac-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* === BRUME ANIM√âE === */
        .mist-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/asfalt-dark.png');
            opacity: 0.2;
            filter: blur(8px);
            z-index: 1;
            pointer-events: none;
            animation: drift 60s linear infinite;
        }
        @keyframes drift {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }
        
        /* === DRAWER INVENTAIRE - Glassmorphism (fini glace transparente) === */
        #sac-inventaire {
            font-family: 'Cinzel', serif;
            position: fixed !important;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10000;
            max-height: 70vh;
            background: rgba(10, 10, 15, 0.4) !important;
            backdrop-filter: blur(25px) brightness(0.8) contrast(1.2) !important;
            -webkit-backdrop-filter: blur(25px) brightness(0.8) contrast(1.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9), inset 0 0 10px rgba(212, 175, 55, 0.2) !important;
            padding: 24px 20px 25px;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255, 255, 255, 0.95);
        }
        #sac-inventaire.open {
            transform: translateY(0);
        }
        /* Scrollbar stylis√©e pour l'inventaire */
        #sac-inventaire::-webkit-scrollbar {
            width: 8px;
        }
        #sac-inventaire::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        #sac-inventaire::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.6), rgba(184, 134, 11, 0.6));
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.3);
        }
        #sac-inventaire::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.8), rgba(184, 134, 11, 0.8));
        }
        /* Firefox scrollbar */
        #sac-inventaire {
            scrollbar-width: thin;
            scrollbar-color: rgba(212, 175, 55, 0.6) rgba(0, 0, 0, 0.3);
        }
        #sac-inventaire-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        }
        #sac-inventaire-titre {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.1em;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }
        #sac-btn-fermer {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: rgba(139, 0, 0, 0.3);
            border: 1px solid rgba(255, 68, 68, 0.4);
            color: #ff6b6b;
            font-size: 1.4em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
        }
        #sac-btn-fermer:hover {
            background: rgba(139, 0, 0, 0.5);
            border-color: #ff4444;
            transform: scale(1.08);
        }
        .sac-section {
            margin-bottom: 24px;
        }
        .sac-section-titre {
            font-family: 'Cinzel', serif;
            color: rgba(212, 175, 55, 0.9);
            font-size: 0.85em;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sac-section-titre::before {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(212, 175, 55, 0.3));
        }
        .sac-section-titre::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to left, transparent, rgba(212, 175, 55, 0.3));
        }
        #sac-slots-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        .sac-slot {
            aspect-ratio: 1;
            min-height: 60px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-size: 0.9em;
            color: var(--gold);
            font-weight: bold;
            transition: all 0.25s ease;
            position: relative;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }
        .sac-slot:hover {
            border-color: rgba(212, 175, 55, 0.7);
            background: rgba(212, 175, 55, 0.08);
            transform: translateY(-2px);
        }
        .sac-slot:empty::after {
            content: '‚Äî';
            color: rgba(212, 175, 55, 0.2);
            font-size: 1.2em;
        }
        .sac-slot.filled {
            background: rgba(212, 175, 55, 0.15);
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3), inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .sac-slot.filled::before {
            content: 'üóùÔ∏è';
            font-size: 1.5em;
            margin-bottom: 4px;
        }
        .sac-slot.objet-actif {
            border-color: rgba(212, 175, 55, 1);
            background: rgba(212, 175, 55, 0.2);
            animation: objet-resonance-glow 2s ease-in-out infinite;
        }
        .sac-slot.objet-actif::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 8px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, transparent 70%);
            animation: objet-resonance-aura 2s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        /* === OBJETS DE QU√äTE === */
        #sac-objets-quete {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            min-height: 100px;
        }
        .objet-quete {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(73, 202, 250, 0.4);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.4);
        }
        /* Style sp√©cial pour les papyrus anciens - Rouleau √©gyptien */
        .objet-quete.papyrus-ancien {
            background: linear-gradient(135deg, 
                rgba(233, 221, 196, 0.25) 0%, 
                rgba(217, 201, 163, 0.35) 50%, 
                rgba(201, 185, 147, 0.4) 100%);
            border-color: rgba(139, 115, 85, 0.7);
            border-radius: 8px;
            box-shadow: 
                inset 0 2px 8px rgba(139, 115, 85, 0.4),
                0 4px 15px rgba(139, 115, 85, 0.3),
                inset 0 0 40px rgba(244, 233, 208, 0.1);
            position: relative;
            overflow: visible;
        }
        /* B√¢tons du rouleau (gauche et droite) */
        .objet-quete.papyrus-ancien::before {
            content: '';
            position: absolute;
            top: 5px;
            bottom: 5px;
            left: 8px;
            width: 4px;
            background: linear-gradient(180deg, #6b5745, #4a3d2f, #6b5745);
            border-radius: 2px;
            box-shadow: 
                1px 0 2px rgba(0, 0, 0, 0.3),
                inset 0 0 3px rgba(107, 87, 69, 0.5);
            pointer-events: none;
        }
        .objet-quete.papyrus-ancien::after {
            content: '';
            position: absolute;
            top: 5px;
            bottom: 5px;
            right: 8px;
            width: 4px;
            background: linear-gradient(180deg, #6b5745, #4a3d2f, #6b5745);
            border-radius: 2px;
            box-shadow: 
                -1px 0 2px rgba(0, 0, 0, 0.3),
                inset 0 0 3px rgba(107, 87, 69, 0.5);
            pointer-events: none;
        }
        .objet-quete.papyrus-ancien:hover {
            border-color: rgba(139, 115, 85, 1);
            background: linear-gradient(135deg, 
                rgba(233, 221, 196, 0.4) 0%, 
                rgba(217, 201, 163, 0.5) 50%, 
                rgba(201, 185, 147, 0.55) 100%);
            box-shadow: 
                inset 0 2px 8px rgba(139, 115, 85, 0.5),
                0 0 30px rgba(139, 115, 85, 0.6),
                0 6px 20px rgba(139, 115, 85, 0.4);
            transform: translateY(-4px) scale(1.05) rotateZ(-2deg);
        }
        .objet-quete.papyrus-ancien .objet-quete-nom {
            color: rgba(212, 175, 55, 0.95);
            font-weight: 600;
        }
        .objet-quete:hover {
            border-color: rgba(73, 202, 250, 0.8);
            background: rgba(73, 202, 250, 0.1);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 0 20px rgba(73, 202, 250, 0.3);
        }
        .objet-quete.objet-actif {
            border-color: rgba(212, 175, 55, 1);
            background: rgba(212, 175, 55, 0.2);
            animation: objet-resonance-glow 2s ease-in-out infinite;
            position: relative;
        }
        .objet-quete.objet-actif::before {
            content: '‚ú®';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 1.2em;
            animation: objet-resonance-sparkle 1.5s ease-in-out infinite;
            filter: drop-shadow(0 0 4px rgba(212, 175, 55, 0.8));
        }
        .objet-quete.objet-actif::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 10px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, transparent 70%);
            animation: objet-resonance-aura 2s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes objet-resonance-glow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(212, 175, 55, 0.4), inset 0 0 10px rgba(212, 175, 55, 0.2);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 35px rgba(212, 175, 55, 0.9), 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(212, 175, 55, 0.4);
                transform: scale(1.05);
            }
        }
        @keyframes objet-resonance-sparkle {
            0%, 100% {
                opacity: 0.6;
                transform: rotate(0deg) scale(1);
            }
            50% {
                opacity: 1;
                transform: rotate(180deg) scale(1.2);
            }
        }
        @keyframes objet-resonance-aura {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.3);
            }
        }
        .objet-quete-nom {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.35em;
            font-family: 'Cinzel', serif;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            white-space: nowrap;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #sac-objets-quete-vide {
            grid-column: 1 / -1;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            font-style: italic;
            padding: 20px;
        }
        #sac-alerte-surcharge {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.95);
            color: #fff;
            padding: 6px 16px;
            border-radius: 8px;
            border: 2px solid #ff4444;
            font-family: 'Orbitron', monospace;
            font-size: 0.75em;
            font-weight: bold;
            letter-spacing: 0.05em;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5), 0 4px 12px rgba(0, 0, 0, 0.6);
            animation: sac-alerte-pulse 0.8s ease-in-out infinite;
            display: none;
            white-space: nowrap;
            text-align: center;
        }
        #sac-alerte-surcharge.active {
            display: block;
        }
        @keyframes sac-alerte-pulse {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.85; transform: translateX(-50%) scale(1.03); }
        }
        
        /* Responsive Tablette et Mobile */
        @media (max-width: 768px) {
            /* Sanctuaire - Layout adaptatif */
            #level-3-sanctuary {
                grid-template-columns: 90px 1fr 90px;
                padding: 15px;
                background: transparent !important;
            }
            .runes-column {
                min-height: 80vh;
                gap: 6px;
                padding: 30px 0;
                padding-top: 140px !important;
                background: transparent !important;
            }
            .runes-column.left {
                padding-left: 20px;
                padding-top: 140px !important;
            }
            .runes-column.right {
                padding-right: 20px;
                padding-top: 140px !important;
            }
            .rune-btn {
                width: 55px;
                height: 55px;
                font-size: 1.6em;
                background: transparent !important;
                border-width: 1px;
            }
            /* Sac √† dos */
            #sac-inventaire {
                max-height: 80vh;
                padding: 20px 16px 16px;
            }
            #sac-inventaire-titre {
                font-size: 1em;
            }
            #sac-slots-container {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }
            .sac-slot {
                min-height: 55px;
                font-size: 0.8em;
            }
            #level-3-sanctuary.sac-ouvert {
                opacity: 0.5;
            }
            /* Sacoche */
            #btn-sacoche {
                width: 52px;
                height: 52px;
                font-size: 1.6em;
                bottom: 15px;
            }
        }
        @media (max-width: 480px) {
            #btn-sacoche {
                width: 48px;
                height: 48px;
                font-size: 1.5em;
                bottom: 12px;
            }
            #sac-inventaire {
                padding: 16px 12px 12px;
            }
            #sac-inventaire-titre {
                font-size: 0.95em;
            }
            #sac-slots-container {
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
                padding: 8px;
            }
            .sac-slot {
                min-height: 48px;
                font-size: 0.75em;
                border-width: 1.5px;
            }
            #sac-objets-quete {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
            }
            .sac-section-titre {
                font-size: 0.75em;
            }
        }
        /* --- SANCTUAIRE TRANSPARENT ET DOR√â --- */
        #level-3-sanctuary {
            background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%), 
                        url('https://images.unsplash.com/photo-1605806616949-1e87b487fc2f?q=80&w=2070&auto=format&fit=crop') !important;
            background-size: cover !important;
            display: flex !important;
            justify-content: space-between !important;
        }

        .glass-panel, .rune-column, .rune-container {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
    </style>
    <!-- Google Fonts for digital effect -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=VT323&family=Cinzel:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó -->
    <!-- ‚ïë   GRILLE DES 12 RUNES - AFFICHAGE PRIORITAIRE (CHARGEMENT IMM√âDIAT) ‚ïë -->
    <!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
    <div id="level-3-sanctuary" class="glass-panel" data-room="2">
        <!-- ‚ïê‚ïê‚ïê COLONNE GAUCHE - RUNES 1-6 ‚ïê‚ïê‚ïê -->
        <div class="runes-column left" role="region" aria-label="Runes gauches">
            <button class="rune-btn" data-index="0" data-symbol="‚èÄ" onclick="onRuneClick(0)" aria-label="Rune 1" title="üîç Rune 1 : Le Chercheur">‚èÄ</button>
            <button class="rune-btn" data-index="1" data-symbol="‚èÉ" onclick="onRuneClick(1)" aria-label="Rune 2" title="üîç Rune 2 : Le Chercheur">‚èÉ</button>
            <button class="rune-btn" data-index="2" data-symbol="‚èá" onclick="onRuneClick(2)" aria-label="Rune 3" title="üîç Rune 3 : Le Chercheur">‚èá</button>
            <button class="rune-btn" data-index="3" data-symbol="‚éà" onclick="onRuneClick(3)" aria-label="Rune 4" title="üîç Rune 4 : Le Chercheur">‚éà</button>
            <button class="rune-btn" data-index="4" data-symbol="‚éî" onclick="onRuneClick(4)" aria-label="Rune 5" title="üö™ Rune 5 : Le Verrou">‚éî</button>
            <button class="rune-btn" data-index="5" data-symbol="‚å¨" onclick="onRuneClick(5)" aria-label="Rune 6" title="üö™ Rune 6 : Le Verrou">‚å¨</button>
        </div>

        <!-- ‚ïê‚ïê‚ïê COLONNE DROITE - RUNES 7-12 ‚ïê‚ïê‚ïê -->
        <div class="runes-column right" role="region" aria-label="Runes droites">
            <button class="rune-btn" data-index="6" data-symbol="‚èç" onclick="onRuneClick(6)" aria-label="Rune 7" title="üö™ Rune 7 : Le Verrou">‚èç</button>
            <button class="rune-btn" data-index="7" data-symbol="‚è¶" onclick="onRuneClick(7)" aria-label="Rune 8" title="üö™ Rune 8 : Le Verrou">‚è¶</button>
            <button class="rune-btn" data-index="8" data-symbol="‚ßñ" onclick="onRuneClick(8)" aria-label="Rune 9" title="üìú Rune 9 : L'Atelier">‚ßñ</button>
            <button class="rune-btn" data-index="9" data-symbol="‚ßâ" onclick="onRuneClick(9)" aria-label="Rune 10" title="üìú Rune 10 : L'Atelier">‚ßâ</button>
            <button class="rune-btn" data-index="10" data-symbol="‚®á" onclick="onRuneClick(10)" aria-label="Rune 11" title="üç∫ Rune 11 : La Taverne">‚®á</button>
            <button class="rune-btn" data-index="11" data-symbol="‚©ì" onclick="onRuneClick(11)" aria-label="Rune 12" title="üëÅÔ∏è Rune 12 : L'Oracle">‚©ì</button>
        </div>
    </div>
    <!-- ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
    
    <div id="star-container"></div>
    <div id="arcana-fog" aria-hidden="true"></div>
    <header>
        <!-- Logo Arcana √† gauche -->
        <div class="logo-arcana">
            <img src="logo.png" alt="Arcana" style="height: 45px; margin-right: 10px;">
            <span class="logo-arcana-title">ARCANA</span>
        </div>
        
        <!-- Titre central avec plaque d√©corative -->
        <div class="header-title-plate">
            <h1 class="header-title-main">LE SANCTUAIRE DU DESTIN</h1>
            <div class="header-title-separator"></div>
            <div class="header-title-level">LEVEL <span id="header-level-num">1</span></div>
        </div>
        
        <!-- Boutons de navigation √† droite -->
        <div class="header-nav-buttons">
            <a href="./index.html" class="header-btn-pill">RETOUR AU COFFRE</a>
            <button class="header-btn-pill" id="header-connect-wallet-btn">CONNECT WALLET</button>
        </div>
    </header>

    <div id="frost-particles" aria-hidden="true"></div>
    <div id="arcana-connect-gate">
        <p class="gate-message">Le Sanctuaire attend.<br>Connectez votre wallet pour entrer.</p>
        <div id="gate-connect-wrap" class="gate-connect-wrap" style="display:flex; justify-content:center;">
            <div class="wallet-button-wrap" style="position:relative; z-index:99999 !important; pointer-events:auto !important;">
                <w3m-button></w3m-button>
            </div>
        </div>
    </div>
    <div id="arcane-dark-fog" style="opacity:0; pointer-events:none;"></div>
    <div id="arcane-darkness-overlay" style="opacity:0;"></div>
    <div id="arcane-inventory" style="display:none;">
        <span class="keys-label">Cl√©s</span>
        <span id="arcane-keys-count" class="keys-count">0</span>
        <span class="keys-label" style="margin-left:12px;">Nav</span>
        <span id="arcane-navkeys-count" class="keys-count">0</span>
        <span class="keys-label" style="margin-left:12px;">üõ°Ô∏è</span>
        <span id="arcane-protection-count" class="keys-count">0</span>
    </div>
    <div id="arcane-level-counter" style="display:none;">NIVEAU <span id="arcane-level-num">1</span> / 100</div>
    
    <!-- ‚ïê‚ïê‚ïê CONTENEUR PRINCIPAL DU JEU ‚ïê‚ïê‚ïê -->
    <div id="game-container" class="arcana-game-content">
        <div class="title-vault">THE ARCANA VAULT</div>
        <div id="class-selection" class="glass-panel" style="display:none; text-align:center;">
        <div class="label-gold">Rite d'Engagement / √âtape 1</div>
        <h2 style="letter-spacing: 2px;">CHOISISSEZ VOTRE DESTIN</h2>
        <div style="display: flex; justify-content: space-around; margin-top: 20px;">
            <div class="class-card" onclick="selectClass('Scribe')">
                <div class="class-icon">üìú</div>
                <p>SCRIBE</p>
            </div>
            <div class="class-card" onclick="selectClass('Invocateur')">
                <div class="class-icon">üî•</div>
                <p>INVOCATEUR</p>
            </div>
            <div class="class-card" onclick="selectClass('Gardien')">
                <div class="class-icon">üõ°Ô∏è</div>
                <p>GARDIEN</p>
            </div>
        </div>
        </div>

        <div id="level-2-panel" class="glass-panel" data-room="1">
        <div class="arcane-light-object" id="light-1" onclick="collectLight(1)" style="top:15px;right:20px;" title="Allumer la lumi√®re">üïØÔ∏è</div>
        <div class="label-gold">Guide Poche / Niveau 2</div>
        <div class="oracle-mirror">
            <span id="temp">‚Äì</span>
        </div>
        <div id="oracle-warning-message" class="oracle-temp-warning" style="display:none;"></div>
        <p style="text-align:center; font-size:0.8em; opacity:0.8;">Saisissez le sceau de l'alignement pour le Niveau 3</p>
        <input type="text" id="sealCodeInput" class="input-arcana" placeholder="CODE DE 6 CARACT√àRES">
        <button class="btn-connect arcane-door locked" id="btnSeal" onclick="onSealClick()" style="width:100%; margin-top:15px;">SCELLER LE DESTIN</button>
        <div class="label-gold" style="margin-top:12px;">Autel des Cl√©s</div>
        <button class="btn-connect" onclick="openAltar()" style="width:100%; margin-top:8px; background:linear-gradient(45deg,#5c3d1e,#8b5a2b);">‚öóÔ∏è Miser 1 Cl√© pour 3</button>
        <div class="label-gold" style="margin-top:16px;">Les 100 Niveaux</div>
        <button class="btn-connect" onclick="enterLevelMode()" style="width:100%; margin-top:8px; background:linear-gradient(45deg,#2d1f5c,#4a2d8b);">üé≤ ENTRER AUX 100 NIVEAUX</button>
        <div class="token-select-group">
            <input id="amountInput" type="number" min="0" step="any" class="input-arcana" placeholder="Montant" style="width: 110px;">
            <select id="tokenSelect" class="input-arcana" style="width: 120px; margin-top: 0;">
                <option value="ARCANA" class="arcana-token-option">ARCANA</option>
                <option value="USDT">USDT</option>
                <option value="USDC">USDC</option>
                <option value="MATIC">MATIC</option>
            </select>
        </div>
        <button id="btnDeposit" onclick="payStake()" class="btn-connect" style="width:100%; margin-top:15px; background:linear-gradient(45deg,#0d6b0d,#1a9c1a);">D√âPOSER</button>
        <small style="color:var(--gold); opacity:0.85; display:block; margin-top:7px;">D√©p√¥t possible en ARCANA, USDT, USDC, MATIC sur le r√©seau Polygon.</small>
    </div>

    <div id="chat-temple" class="glass-panel">
        <div class="label-gold">Chat du Temple</div>
        <div style="margin-top:10px; height:80px; overflow-y:auto; border-bottom:1px solid var(--glass-border);">
            <p style="margin:5px 0;"><em>Syst√®me : Les trois classes sont r√©unies.</em></p>
            <p style="margin:5px 0;"><b style="color:var(--gold)">Scribe :</b> J'ai les deux premiers chiffres !</p>
        </div>
        <input type="text" class="input-arcana" style="font-size:0.8em; padding:5px;" placeholder="Message aux initi√©s...">
    </div>

    <span class="admin-trigger" onclick="toggleAdmin()" title="L'≈íil d'Arcana (Ctrl+Shift+A)">üëÅ Admin</span>
    <button id="grimoire-btn" onclick="toggleGrimoire()" title="Grimoire d'Arcana" style="display:none;">üìñ</button>

    <div id="admin-dashboard" class="glass-panel" style="display:none;">
        <button class="admin-close" onclick="hideAdmin()" title="Fermer">√ó</button>
        <div class="label-gold" style="color: rgba(220, 100, 100);">L'≈íIL D'ARCANA</div>
        <h3 style="letter-spacing: 2px; font-size: 1em;">Tableau de bord administrateur</h3>
        <div class="admin-stat"><span class="label-gold">Joueurs Connect√©s :</span> <span id="admin-players">0</span></div>
        <div class="admin-stat"><span class="label-gold">MATIC (natif) :</span> <span id="admin-balance">‚Äî</span></div>
        <div class="admin-stat"><span class="label-gold">ARCANA (jeton) :</span> <span id="admin-arcana-balance">‚Äî</span></div>
        <div class="admin-stat"><span class="label-gold">Statut Oracle (Temp√©rature) :</span> <span id="admin-oracle">‚Äî</span></div>
        <button id="force-open" onclick="forceOpenAdmin()" class="btn-connect" style="width:100%; margin-top:15px; background:linear-gradient(45deg,#8b2222,#c03030);">FORCE OUVERTURE</button>
        <div class="label-gold" style="margin-top:15px;">Message aux Initi√©s</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
            <input type="text" id="broadcast-input" class="input-arcana" placeholder="Message aux Initi√©s" style="flex:1; margin-top:0;">
            <button onclick="emitBroadcast()" class="btn-connect" style="margin-top:0;">√âMETTRE</button>
        </div>
        <div class="label-gold" style="margin-top:15px;">Log en temps r√©el</div>
        <div id="admin-log"></div>
    </div>
    <!-- Panel 100 niveaux : portes al√©atoires -->
    <div id="arcane-level-panel" class="glass-panel" style="display:none; position:relative;">
        <div id="arcane-corner-clues-container" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>
        <div class="label-gold">Salle Niveau <span id="arcane-panel-level-num">1</span></div>
        <p style="color:rgba(255,255,255,0.85); font-size:0.85em; margin:12px 0;">Choisissez une porte. Pi√®ges ou propulseurs ?</p>
        <div id="arcane-doors-container"></div>
        <div id="arcane-scrolls-container" style="position:relative; min-height:50px; margin-top:12px;"></div>
        <button class="btn-connect" onclick="useNavKey()" style="margin-top:12px; font-size:0.85em;">üó∫Ô∏è Cl√© de Navigation (+5 / -5)</button>
    </div>
    <!-- Carte Pyramide -->
    <div id="arcane-pyramid-map">
        <div class="label-gold" style="font-size:0.65em; margin-bottom:4px;">Carte</div>
        <div id="pyramid-grid"></div>
    </div>
    <!-- L'√âcho du Sanctuaire ‚Äî Bandeau d√©filant -->
    <div id="arcane-echo-journal" style="display:none;">
        <div class="echo-title">L'√âCHO DU SANCTUAIRE</div>
        <div id="arcane-echo-ticker"><span class="echo-scroll" id="arcane-echo-scroll"></span></div>
    </div>
    <!-- Panneau Cl√© de Navigation ‚Äî Utiliser une Cl√© -->
    <div id="arcane-nav-key-panel">
        <div class="label-gold">Utiliser une Cl√©</div>
        <p style="margin:12px 0; font-size:0.9em;">Choisissez votre pouvoir :</p>
        <button class="btn-connect" onclick="navKeyPropulsion()" style="margin:4px;">‚¨ÜÔ∏è Propulsion : Saut +1 √† +10</button>
        <button class="btn-connect" onclick="navKeyRappel()" style="margin:4px;">‚¨áÔ∏è Rappel : Ramasser un butin</button>
        <button class="btn-connect" onclick="closeNavKeyPanel()" style="margin-top:12px; background:transparent; border:1px solid #666;">Annuler</button>
    </div>
    <!-- Grimoire d'Arcana (Guide de Poche) -->
    <div id="grimoire-panel">
        <button class="grimoire-close" onclick="closeGrimoire()" title="Fermer">√ó</button>
        <div class="grimoire-paper">
            <h2 class="grimoire-tome-title">Tome I : Le Secret de l'Ascension Interdite</h2>
            <div class="grimoire-tome-text">
                Au fond des couloirs scell√©s de la Pyramide, l√† o√π l'obscurit√© avale les pas des initi√©s, repose un savoir trop ancien pour les mortels. Ce grimoire renferme les runes oubli√©es de l'ascension ‚Äî des chemins que les Sages ont trac√©s √† travers cent portes, cent √©preuves. Celui qui d√©bloque ces pages verra ses cl√©s se multiplier et ses yeux percer le voile des mirages.
            </div>
            <button class="grimoire-unlock-btn" onclick="unlockSavoir2POL()">D√âBLOQUER LE SAVOIR ‚Äî 2 POL</button>
            <div class="label-gold" style="color:#5c4a2a; font-size:0.8em; margin-top:16px;">Inventaire de poche</div>
            <div class="grimoire-inv-grid">
                <div class="grimoire-inv-item">
                    <span class="grimoire-inv-icon">‚¨ÜÔ∏è</span>
                    <span>Cl√©s Propulsion</span>
                    <span id="grimoire-propulsion" class="grimoire-inv-num">0</span>
                </div>
                <div class="grimoire-inv-item">
                    <span class="grimoire-inv-icon">‚¨áÔ∏è</span>
                    <span>Cl√©s Rappel</span>
                    <span id="grimoire-rappel" class="grimoire-inv-num">0</span>
                </div>
                <div class="grimoire-inv-item">
                    <span class="grimoire-inv-icon">üíé</span>
                    <span>Butins R√©cup√©r√©s</span>
                    <span id="grimoire-butins" class="grimoire-inv-num">0</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Autel des Cl√©s : pari 1‚Üí3 -->
    <div id="arcane-altar-panel">
        <div class="label-gold">Autel des Cl√©s</div>
        <p style="color:rgba(255,255,255,0.9); margin:12px 0; font-size:0.9em;">Misez 1 cl√© pour tenter d'en gagner 3.</p>
        <div id="arcane-altar-cards" style="display:flex; gap:12px; justify-content:center; margin:16px 0;">
            <button class="btn-connect" style="width:70px; height:70px; font-size:1.5em;" onclick="pickAltarCard(0)">‚ùì</button>
            <button class="btn-connect" style="width:70px; height:70px; font-size:1.5em;" onclick="pickAltarCard(1)">‚ùì</button>
            <button class="btn-connect" style="width:70px; height:70px; font-size:1.5em;" onclick="pickAltarCard(2)">‚ùì</button>
        </div>
        <p id="arcane-altar-result" style="color:var(--gold); font-weight:bold; min-height:24px;"></p>
        <button class="btn-connect" onclick="closeAltar()" style="margin-top:12px;">Fermer</button>
        </div>
        
        <!-- ‚ïê‚ïê‚ïê VICTOIRE JACKPOT : Pluie d'or ‚ïê‚ïê‚ïê -->
        <div id="victory-jackpot">
            <div class="victory-text">‚ú® JACKPOT D√âVERROUILL√â<br><span style="font-size:0.62em;color:#fff;letter-spacing:0.09em;">Le Destin, scell√© dans l'or √©ternel</span></div>
            <div class="gold-rain"></div>
        </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê FIN CONTENEUR PRINCIPAL (#game-container) ‚ïê‚ïê‚ïê -->
    <!-- ‚ïê‚ïê‚ïê EFFETS SONORES - Chargement optimis√© ‚ïê‚ïê‚ïê -->
    <audio id="heartbeat-audio" preload="metadata" src="https://cdn.pixabay.com/audio/2022/08/20/audio_12c959d8f4.mp3"></audio>
    <audio id="triumph-audio" preload="metadata" src="https://cdn.pixabay.com/audio/2022/01/18/audio_8f0bc6dc2b.mp3"></audio>
    <audio id="ice-crackle-audio" preload="metadata" src="https://assets.mixkit.co/active_storage/sfx/2571-ice-break-2571.mp3"></audio>

    <div class="arcana-mention">Arcana Game - √âcosyst√®me D√©centralis√©</div>

    <!-- ‚ïê‚ïê‚ïê MODAL PAPYRUS ANCIEN ‚ïê‚ïê‚ïê -->
    <div id="papyrus-modal" onclick="fermerPapyrusOverlay(event)">
        <div class="papyrus-scroll" onclick="event.stopPropagation()">
            <div class="papyrus-content papyrus-scroll-bar">
                <div class="papyrus-title" id="papyrus-titre">Papyrus Ancien</div>
                <div class="papyrus-hieroglyph">ìÇÄ ìÜ£ ìÉ≠ ìÖì</div>
                <div class="papyrus-text" id="papyrus-texte">
                    Sous la pierre froide, l√† o√π le givre se d√©pose en silence,
                    un secret mill√©naire attend celui qui sait regarder au-del√† des apparences.
                    Les anciens Gardiens ont scell√© ici un fragment de la Grande Connaissance,
                    √©crit dans une langue que seul le c≈ìur pur peut d√©chiffrer.
                </div>
                <div class="papyrus-hieroglyph">‚ö± ‚ö° ‚öñ</div>
                <div class="papyrus-text" id="papyrus-indice" style="text-align: center; font-weight: bold; font-size: 1.1em; text-indent: 0; color: #8b4513;">
                    ¬´ Le tr√©sor se cache l√† o√π le givre rencontre l'or ¬ª
                </div>
            </div>
            <button class="papyrus-close-btn" onclick="fermerPapyrus()">‚úï ROULER LE PAPYRUS</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê BRUME ANIM√âE - Derri√®re l'inventaire ‚ïê‚ïê‚ïê -->
    <div class="mist-layer" aria-hidden="true"></div>
    <!-- ‚ïê‚ïê‚ïê BOUTON SACOCHE - Flotte au-dessus du sanctuaire ‚ïê‚ïê‚ïê -->
    <button id="btn-sacoche" onclick="toggleSacInventaire()" title="Ouvrir l'inventaire" style="position:fixed;bottom:25px;left:50%;transform:translateX(-50%) rotateX(2deg);z-index:9999;display:block!important;">
        <span style="filter: sepia(0.3) contrast(1.1);">üíº</span>
        <span id="btn-sacoche-badge">0</span>
    </button>

    <!-- ‚ïê‚ïê‚ïê OVERLAY DRAWER ‚ïê‚ïê‚ïê -->
    <div id="sac-overlay" onclick="fermerSacInventaire()"></div>

    <!-- ‚ïê‚ïê‚ïê DRAWER INVENTAIRE ‚ïê‚ïê‚ïê -->
    <div id="sac-inventaire">
        <div id="sac-alerte-surcharge">‚ö†Ô∏è SAC TROP LOURD - RISQUE DE PERTE</div>
        
        <div id="sac-inventaire-header">
            <div id="sac-inventaire-titre">üì¶ Inventaire</div>
            <button id="sac-btn-fermer" onclick="fermerSacInventaire()" title="Fermer">√ó</button>
        </div>

        <!-- Section Cl√©s -->
        <div class="sac-section">
            <div class="sac-section-titre">üóùÔ∏è Cl√©s du Destin</div>
            <div id="sac-slots-container">
                <div class="sac-slot" data-slot="0"></div>
                <div class="sac-slot" data-slot="1"></div>
                <div class="sac-slot" data-slot="2"></div>
                <div class="sac-slot" data-slot="3"></div>
                <div class="sac-slot" data-slot="4"></div>
                <div class="sac-slot" data-slot="5"></div>
                <div class="sac-slot" data-slot="6"></div>
                <div class="sac-slot" data-slot="7"></div>
                <div class="sac-slot" data-slot="8"></div>
                <div class="sac-slot" data-slot="9"></div>
            </div>
        </div>

        <!-- Section Objets de Qu√™te -->
        <div class="sac-section">
            <div class="sac-section-titre">‚ú® Objets de Qu√™te</div>
            <div id="sac-objets-quete">
                <div id="sac-objets-quete-vide">Aucun objet de qu√™te</div>
            </div>
        </div>
    </div>

    <script type="module">
      (async function() {
        let wagmiConfig = null
        try {
          const { createWeb3Modal, defaultWagmiConfig } = await import('https://esm.sh/@web3modal/wagmi@5.1.11')
          const { mainnet, polygon } = await import('https://esm.sh/viem/chains')
          const { watchAccount, getWalletClient } = await import('https://esm.sh/@wagmi/core@2.13.4')
          const projectId = '7004f981f33f063167f1395567798132'
          const metadata = {
            name: 'Arcana',
            description: 'Arcana Game - √âcosyst√®me D√©centralis√© sur Polygon',
            url: 'https://arcana-ezl.pages.dev',
            icons: ['https://arcana-ezl.pages.dev/favicon.ico']
          }
          const chains = [mainnet, polygon]
          wagmiConfig = defaultWagmiConfig({ chains, projectId, metadata })
          createWeb3Modal({
            wagmiConfig,
            projectId,
            chains,
            defaultChain: polygon,
            enableAnalytics: false,
            enableOnramp: false,
            featuredWalletIds: ['c57ca95b47569778a828d19178114f4db188b89b763c899ba0be274e97267d96']
          })
          watchAccount(wagmiConfig, {
            onChange: async (account) => {
              if (account.address && window.arcanaOnW3mConnect) {
                try {
                  const client = await getWalletClient(wagmiConfig)
                  if (!client) return
                  const eip1193 = (typeof client.request === 'function') ? client : (client.transport?.value ?? client.transport ?? client)
                  const prov = new ethers.providers.Web3Provider(eip1193, 'any')
                  const sgn = prov.getSigner()
                  const acc = await sgn.getAddress()
                  window.arcanaOnW3mConnect(prov, sgn, acc)
                } catch (err) { console.warn('wagmi provider:', err) }
              }
            }
          })
        } catch (e) {
          console.warn('Web3Modal wagmi init:', e);
          const { createAppKit } = await import('https://esm.sh/@reown/appkit@1.8.18');
          const { polygon } = await import('https://esm.sh/@reown/appkit@1.8.18/networks');
          const { Ethers5Adapter } = await import('https://esm.sh/@reown/appkit-adapter-ethers5@0.2.6');
          const modal = createAppKit({
            adapters: [new Ethers5Adapter()],
            networks: [polygon],
            defaultNetwork: polygon,
            metadata: {
              name: 'Arcana',
              description: 'Arcana Game - √âcosyst√®me D√©centralis√© sur Polygon',
              url: 'https://arcana-ezl.pages.dev',
              icons: ['https://arcana-ezl.pages.dev/favicon.ico']
            },
            projectId: '7004f981f33f063167f1395567798132',
            features: {
              analytics: false,
              onramp: false,
              email: false,
              socials: [],
              connectMethodsOrder: ['wallet']
            },
            featuredWalletIds: ['c57ca95b47569778a828d19178114f4db188b89b763c899ba0be274e97267d96'],
            themeMode: 'dark',
            themeVariables: { '--w3m-accent': '#d4af37' }
          });
          modal.subscribeProvider(async (state) => {
            if (state.isConnected && state.provider && window.arcanaOnW3mConnect) {
              const prov = new ethers.providers.Web3Provider(state.provider, 'any');
              const sgn = prov.getSigner();
              const acc = await sgn.getAddress();
              window.arcanaOnW3mConnect(prov, sgn, acc);
            } else if (!state.isConnected && window.arcanaOnW3mDisconnect) window.arcanaOnW3mDisconnect();
          });
        }
        if (window.ethereum) {
          window.ethereum.on('accountsChanged', async (accounts) => {
            if (accounts?.[0] && window.arcanaOnW3mConnect) {
              const prov = new ethers.providers.Web3Provider(window.ethereum, 'any');
              const sgn = prov.getSigner();
              const acc = await sgn.getAddress();
              window.arcanaOnW3mConnect(prov, sgn, acc);
            }
          });
          window.ethereum.on('chainChanged', () => location.reload());
        }
      })();
    </script>
</body>

<!-- Lien stylis√© d'ajout de token ARCANA √† MetaMask juste apr√®s le bouton de d√©p√¥t -->
<style>
.arcana-add-metamask-link {
    display: inline-block;
    margin-top: 6px;
    color: #ffd700;
    font-size: 0.92em;
    font-family: inherit;
    cursor: pointer;
    text-decoration: underline dotted;
    transition: color 0.18s;
    background: transparent;
    border: none;
    padding: 0;
}
.arcana-add-metamask-link:hover {
    color: #fff2b8;
    text-decoration: underline;
}
</style>
<script>
    // --- CONFIGURATION OFFICIELLE ARCANA GAME ---
    const ARCANA_PROJECT_ID = "7004f981f33f063167f1395567798132";
    const ARCANA_GAME_CONTRACT = "0xFABF1FcFB7dA0Aa861A61747E1e5a2F2F8E9E337";
    const ADMIN_ADDRESS = ""; // √Ä REMPLIR : adresse 0x... du wallet autoris√© pour Force Ouverture
    const ARCANA_TOKEN_ADDRESS = "0x1990fd46a1ad0344751be45d6779b8c1f827076d";
    const USDT_TOKEN_ADDRESS   = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";
    const USDC_TOKEN_ADDRESS   = "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174";
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üîì VARIABLE DE TEST : Bypass Oracle M√©t√©o
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let bypassOracle = true; // Mettez √† true pour forcer l'acc√®s en d√©veloppement
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Pour MATIC natif, pas besoin d'adresse.
    // Ajouter l'adresse du contrat d'Arcana Game pour la temp√©rature si c'est un autre contrat
    const ARCANA_GAME_ORACLE_ABI = [
        "function currentTemp() view returns (int256)",
        "function updateOracle(int256 _temp) external"
    ];
    // Contrat de sauvegarde progression (mapping address => level). Sauvegarde persistante sur Polygon.
    const ARCANA_PROGRESSION_CONTRACT = ARCANA_GAME_CONTRACT; // ou "0x1...876d" pour reprendre o√π l'on s'est arr√™t√©
    const ARCANA_PROGRESSION_ABI = [
        "function playerLevel(address) view returns (uint256)",
        "function setLevel(uint256 _level) external"
    ];

    // ERC20 ABI minimum pour approve/allowance/transferFrom/balanceOf (lecture+Transfert)
    const ERC20_ABI = [
        "function approve(address,uint256) public returns (bool)",
        "function allowance(address,address) public view returns (uint256)",
        "function balanceOf(address) public view returns (uint256)",
        "function decimals() public view returns (uint8)",
        "function transfer(address,uint256) public returns (bool)"
    ];

    // Polygon chainId
    const POLYGON_CHAIN_ID = "0x89"; // 137

    var provider, signer, account;

    var gameContainer = function() { return document.getElementById('game-container') || document.getElementById('arcana-game-content'); };

    // === Syst√®me d'obscurit√©, Lumi√®re, Cl√©s, Autel ===
    var arcaneKeys = 0;
    var arcaneLitRooms = {}; // roomId -> true
    var arcaneAltarWinIndex = -1;

    function updateArcaneInventory() {
        var el = document.getElementById('arcane-keys-count');
        if (el) el.textContent = arcaneKeys;
        var nav = document.getElementById('arcane-navkeys-count');
        if (nav) nav.textContent = arcaneNavKeys;
        var prot = document.getElementById('arcane-protection-count');
        if (prot) prot.textContent = arcaneProtectionKeys;
        var inv = document.getElementById('arcane-inventory');
        if (inv && gameContainer() && gameContainer().classList.contains('visible')) inv.style.display = 'flex';
        updateGrimoireInventory();
    }
    function updateGrimoireInventory() {
        var el = function(id, val) { var e = document.getElementById(id); if (e) e.textContent = (val !== undefined ? val : 0); };
        el('grimoire-propulsion', arcaneNavKeys);
        el('grimoire-rappel', arcaneNavKeys);
        el('grimoire-butins', arcaneButinsRecuperes + arcaneLootNFTs);
    }
    function toggleGrimoire() {
        var panel = document.getElementById('grimoire-panel');
        if (panel.style.display === 'block') { closeGrimoire(); return; }
        panel.style.display = 'block';
        updateGrimoireInventory();
        requestAnimationFrame(function() { panel.classList.add('grimoire-open'); });
    }
    function closeGrimoire() {
        var panel = document.getElementById('grimoire-panel');
        panel.classList.remove('grimoire-open');
        setTimeout(function() { panel.style.display = 'none'; }, 350);
    }
    async function unlockSavoir2POL() {
        var seller = GRIMOIRE_SELLER_WALLET || (isVipWallet(account) ? account : '');
        if (!seller || seller.length < 40) { addOracleChatMessage('D√©finissez GRIMOIRE_SELLER_WALLET (0x1...876d) pour recevoir les 2 POL.'); return; }
        if (!signer || !account) { addOracleChatMessage('Connectez votre wallet pour d√©bloquer le savoir.'); return; }
        try {
            var wei = ethers.utils.parseEther('2');
            var tx = await signer.sendTransaction({ to: seller, value: wei, gasLimit: 21000 });
            await tx.wait();
            addOracleChatMessage('Le savoir est d√©bloqu√©. 2 POL transmis.');
            echoAddMessage('Un Initi√© a d√©bloqu√© le Tome I.');
        } catch (e) { addOracleChatMessage('Transaction √©chou√©e : ' + (e.message || e)); }
    }
    function grimoireUsePropulsion() {
        closeGrimoire();
        if (arcaneNavKeys < 1) { addOracleChatMessage('Pas de Cl√© de Propulsion.'); return; }
        navKeyPropulsion();
    }
    function grimoireUseRappel() {
        closeGrimoire();
        if (arcaneNavKeys < 1) { addOracleChatMessage('Pas de Cl√© de Rappel.'); return; }
        navKeyRappel();
    }
    function grimoireLightRoom(roomId) {
        if (arcaneKeys < 1) { addOracleChatMessage('Pas assez de cl√©s pour √©clairer.'); return; }
        if (arcaneLitRooms[roomId]) { addOracleChatMessage('Cette salle est d√©j√† √©clair√©e.'); return; }
        arcaneKeys--;
        arcaneLitRooms[roomId] = true;
        updateArcaneDoors();
        updateGrimoireInventory();
        updateArcaneInventory();
        applyLevelDarkness();
        addOracleChatMessage('La Salle ' + roomId + ' est d√©sormais √©clair√©e.');
        echoAddMessage('Un Initi√© a √©clair√© la Salle ' + roomId + '.');
    }
    async function buyBooklet(level) {
        var seller = GRIMOIRE_SELLER_WALLET || (isVipWallet(account) ? account : '');
        if (!seller || seller.length < 40) { addOracleChatMessage('March√© indisponible. D√©finissez GRIMOIRE_SELLER_WALLET avec l\'adresse du vendeur (0x1...876d).'); return; }
        if (!signer || !account) { addOracleChatMessage('Connectez votre wallet pour acheter.'); return; }
        var prices = { 5: 0.01, 15: 0.02, 25: 0.03, 50: 0.05, 100: 0.1 };
        var price = prices[level] || 0.01;
        var wei = ethers.utils.parseEther(price.toString());
        try {
            var tx = await signer.sendTransaction({ to: seller, value: wei, gasLimit: 21000 });
            await tx.wait();
            arcaneLootNFTs++;
            updateGrimoireInventory();
            addOracleChatMessage('Livret du Niveau ' + level + ' achet√© ! +1 NFT de Butin.');
            echoAddMessage('Un Initi√© a acquis le Livret du Niveau ' + level + '.');
            closeGrimoire();
        } catch (e) { addOracleChatMessage('Achat √©chou√© : ' + (e.message || e)); }
    }
    function updateArcaneFog() {
        var lit = Object.keys(arcaneLitRooms).length;
        var fog = document.getElementById('arcane-dark-fog');
        if (fog) fog.style.setProperty('--fog-opacity', Math.max(0, 0.85 - lit * 0.35).toString());
    }
    function updateArcaneDoors() {
        var btnSeal = document.getElementById('btnSeal');
        if (btnSeal) {
            if (arcaneLitRooms[1]) btnSeal.classList.remove('locked'); else btnSeal.classList.add('locked');
        }
    }
    document.addEventListener('mousemove', function(e) {
        var overlay = document.getElementById('arcane-darkness-overlay');
        if (!overlay) return;
        var x = (e.clientX / window.innerWidth * 100).toFixed(2);
        var y = (e.clientY / window.innerHeight * 100).toFixed(2);
        overlay.style.setProperty('--cursor-x', x + '%');
        overlay.style.setProperty('--cursor-y', y + '%');
        var r = 120 + (arcaneLitRooms[1] ? 80 : 0) + (arcaneLitRooms[2] ? 80 : 0);
        var shrink = Math.max(0.08, 0.35 * Math.pow(0.95, arcaneCurrentLevel - 1));
        overlay.style.background = 'radial-gradient(circle ' + r + 'px at ' + x + '% ' + y + '%, transparent 0%, transparent ' + (shrink * 100) + '%, rgba(0,0,0,0.97) 100%)';
    });
    document.addEventListener('touchmove', function(e) {
        if (e.touches && e.touches[0]) {
            var t = e.touches[0];
            var overlay = document.getElementById('arcane-darkness-overlay');
            if (!overlay) return;
            var x = (t.clientX / window.innerWidth * 100).toFixed(2);
            var y = (t.clientY / window.innerHeight * 100).toFixed(2);
            overlay.style.setProperty('--cursor-x', x + '%');
            overlay.style.setProperty('--cursor-y', y + '%');
            var r = 120 + (arcaneLitRooms[1] ? 80 : 0) + (arcaneLitRooms[2] ? 80 : 0);
            var shrink = Math.max(0.08, 0.35 * Math.pow(0.95, arcaneCurrentLevel - 1));
            overlay.style.background = 'radial-gradient(circle ' + r + 'px at ' + x + '% ' + y + '%, transparent 0%, transparent ' + (shrink * 100) + '%, rgba(0,0,0,0.97) 100%)';
        }
    }, { passive: true });
    function collectLight(roomId) {
        if (arcaneLitRooms[roomId]) return;
        var lightEl = document.getElementById('light-' + roomId);
        if (lightEl) { lightEl.classList.add('collected'); }
        arcaneLitRooms[roomId] = true;
        arcaneKeys++;
        updateArcaneInventory();
        updateArcaneFog();
        updateArcaneDoors();
        
        // Ajouter une cl√© num√©rot√©e correspondante dans le sac
        var cleNum = roomId; // Cl√© 1 pour room 1, cl√© 2 pour room 2, etc.
        ajouterCleDansSac(cleNum);
        
        addOracleChatMessage('üîÆ Lumi√®re collect√©e ! Cl√© ' + cleNum + ' ajout√©e √† votre inventaire.');
        
        console.log('%cüîÆ Lumi√®re ' + roomId + ' collect√©e ‚Üí Cl√© ' + cleNum + ' obtenue', 'color:#d4af37;');
    }
    function openAltar() {
        if (arcaneKeys < 1) { addOracleChatMessage('Vous n\'avez pas assez de cl√©s.'); return; }
        arcaneAltarWinIndex = Math.floor(Math.random() * 3);
        document.getElementById('arcane-altar-panel').style.display = 'block';
        document.getElementById('arcane-altar-result').textContent = '';
        var cards = document.querySelectorAll('#arcane-altar-cards button');
        cards.forEach(function(b,i){ b.textContent = '‚ùì'; b.disabled = false; });
    }
    function pickAltarCard(idx) {
        var cards = document.querySelectorAll('#arcane-altar-cards button');
        cards.forEach(function(b){ b.disabled = true; });
        var win = (idx === arcaneAltarWinIndex);
        cards[0].textContent = arcaneAltarWinIndex === 0 ? 'üóùÔ∏è' : '‚úó';
        cards[1].textContent = arcaneAltarWinIndex === 1 ? 'üóùÔ∏è' : '‚úó';
        cards[2].textContent = arcaneAltarWinIndex === 2 ? 'üóùÔ∏è' : '‚úó';
        arcaneKeys--;
        if (win) { arcaneKeys += 3; addOracleChatMessage('Victoire ! +3 Cl√©s.'); }
        else { addOracleChatMessage('Le destin n\'a pas souri.'); }
        updateArcaneInventory();
        document.getElementById('arcane-altar-result').textContent = win ? '‚ú® +3 Cl√©s !' : 'La cl√© est perdue.';
    }
    function closeAltar() {
        document.getElementById('arcane-altar-panel').style.display = 'none';
    }

    // === VIP Bernard : 0x1...876d + Mode Test Oracle ===
    var ARCANA_VIP_WALLET = ''; // Mettez l'adresse compl√®te ou laissez vide
    var ARCANA_TEST_WALLET = ''; // Wallet de test qui bypass l'Oracle (votre adresse compl√®te ici)
    var GRIMOIRE_SELLER_WALLET = ''; // Adresse compl√®te du vendeur (0x1...876d) pour recevoir les ventes de livrets
    
    function isVipWallet(addr) {
        if (!addr) return false;
        var a = (addr + '').toLowerCase();
        return (a.startsWith('0x1') && a.endsWith('876d') && a.length === 42) || (ARCANA_VIP_WALLET && a === ARCANA_VIP_WALLET.toLowerCase());
    }
    
    function isTestWallet(addr) {
        if (!addr) return false;
        var a = (addr + '').toLowerCase();
        return (ARCANA_TEST_WALLET && a === ARCANA_TEST_WALLET.toLowerCase());
    }
    // === Syst√®me 100 niveaux : progression, portes, difficult√©, Web3 ===
    const ARCANA_MAX_LEVEL = 100;
    var arcaneCurrentLevel = 1;
    var arcaneDoorDeltas = [];
    var arcaneDoorRevealed = [];
    var arcaneInLevelMode = false;
    var arcaneNavKeys = 0;
    var arcaneProtectionKeys = 0;
    var arcaneLootLevels = [];
    var arcaneTotalLootSpawned = 0;
    var arcaneLootNFTs = 0;
    var arcaneButinsRecuperes = 0;

    function getDoorDestination(type) {
        if (type === 'trap') return -(1 + Math.floor(Math.random() * 5));
        if (type === 'propeller') return 2 + Math.floor(Math.random() * 7);
        return 1;
    }
    var arcaneEchoQueue = [];
    function echoAddMessage(msg) {
        arcaneEchoQueue.push(msg);
        if (arcaneEchoQueue.length > 20) arcaneEchoQueue.shift();
        var scroll = document.getElementById('arcane-echo-scroll');
        if (scroll) {
            var txt = arcaneEchoQueue.join('  ‚óÜ  ');
            scroll.textContent = txt + (txt ? '  ‚óÜ  ' : '');
            scroll.style.animation = 'none';
            scroll.offsetHeight;
            scroll.style.animation = 'echo-scroll 40s linear infinite';
        }
    }
    function ouvrirPorte(idx) {
        var delta = arcaneDoorDeltas[idx] !== undefined ? arcaneDoorDeltas[idx] : 1;
        var newLevel = Math.max(1, Math.min(ARCANA_MAX_LEVEL, arcaneCurrentLevel + delta));
        var doors = document.querySelectorAll('.arcane-level-door');
        doors.forEach(function(d){ d.disabled = true; });
        if (delta < 0) {
            var lostLevel = arcaneCurrentLevel;
            if (arcaneLootLevels.indexOf(lostLevel) === -1) {
                arcaneLootLevels.push(lostLevel);
                arcaneTotalLootSpawned++;
                echoAddMessage('Un tr√©sor est apparu au Niveau ' + lostLevel + ' !');
            }
            addOracleChatMessage('Pi√®ge ! Retour au niveau ' + newLevel + '.');
        } else {
            if (delta > 1) echoAddMessage('Un Initi√© a saut√© ' + delta + ' niveaux !');
            if (delta > 1) addOracleChatMessage('Propulseur ! Saut au niveau ' + newLevel + ' !');
            else addOracleChatMessage('Niveau ' + newLevel + ' atteint.');
        }
        goToLevel(newLevel);
    }
    function goToLevel(level, fromRappel) {
        var targetLevel = Math.max(1, Math.min(ARCANA_MAX_LEVEL, level));
        var lootLevel = targetLevel;
        if (fromRappel && arcaneLootLevels.indexOf(lootLevel) !== -1) {
            var isMirage = Math.random() < 0.10;
            if (isMirage && arcaneProtectionKeys < 1) {
                targetLevel = Math.max(1, lootLevel - 5);
                echoAddMessage('Le Mirage ! Un pi√®ge vous renvoie 5 niveaux en arri√®re.');
                addOracleChatMessage('Mirage : pi√®ge ! -5 niveaux.');
            } else if (isMirage && arcaneProtectionKeys >= 1) {
                arcaneProtectionKeys--;
                updateArcaneInventory();
                echoAddMessage('Cl√© de Protection : le Mirage est neutralis√©.');
            }
            arcaneLootLevels = arcaneLootLevels.filter(function(l){ return l !== lootLevel; });
            if (!isMirage) { arcaneProtectionKeys++; arcaneButinsRecuperes++; updateArcaneInventory(); }
        }
        arcaneCurrentLevel = targetLevel;
        updateLevelDisplay();
        updatePyramidMap();
        generateLevelDoors();
        if (isVipWallet(account)) {
            console.log('%c[Omniscience] Butin pyramide ‚Äî Total accumul√©: ' + arcaneTotalLootSpawned + ' | Non ramass√©s: ' + arcaneLootLevels.length + ' | Niveaux: ' + (arcaneLootLevels.slice(0).sort(function(a,b){return a-b;}).join(', ') || '‚Äî') + ' | Niveau actuel: ' + arcaneCurrentLevel, 'color:#d4af37; font-weight:bold;');
        }
        spawnScrolls();
        spawnCornerClues();
        saveLevelWeb3(arcaneCurrentLevel);
    }
    function updateLevelDisplay() {
        var num = document.getElementById('arcane-level-num');
        var panelNum = document.getElementById('arcane-panel-level-num');
        var headerNum = document.getElementById('header-level-num');
        if (num) num.textContent = arcaneCurrentLevel;
        if (panelNum) panelNum.textContent = arcaneCurrentLevel;
        if (headerNum) headerNum.textContent = arcaneCurrentLevel;
        applyLevelDarkness();
    }
    function applyLevelDarkness() {
        var overlay = document.getElementById('arcane-darkness-overlay');
        if (overlay) {
            var r = 120 + (arcaneLitRooms[1] ? 80 : 0) + (arcaneLitRooms[2] ? 80 : 0);
            var shrink = Math.max(0.08, 0.35 * Math.pow(0.95, arcaneCurrentLevel - 1));
            overlay.style.background = 'radial-gradient(circle ' + r + 'px at var(--cursor-x, 50%) var(--cursor-y, 50%), transparent 0%, transparent ' + (shrink * 100) + '%, rgba(0,0,0,0.97) 100%)';
        }
    }
    function generateLevelDoors() {
        var count = 2 + Math.floor(Math.random() * 3);
        arcaneDoorDeltas = [];
        arcaneDoorRevealed = [];
        var types = ['normal','normal','trap','propeller'];
        var container = document.getElementById('arcane-doors-container');
        if (!container) return;
        container.innerHTML = '';
        for (var i = 0; i < count; i++) {
            var type = types[Math.floor(Math.random() * types.length)];
            var delta = getDoorDestination(type);
            arcaneDoorDeltas.push(delta);
            arcaneDoorRevealed.push(false);
            var btn = document.createElement('button');
            btn.className = 'arcane-level-door btn-connect' + (isVipWallet(account) ? (delta < 0 ? ' vip-trap' : ' vip-shortcut') : '');
            btn.textContent = 'üö™ Porte ' + (i + 1);
            btn.dataset.index = i;
            btn.dataset.delta = delta;
            btn.onclick = function() { ouvrirPorte(parseInt(this.dataset.index, 10)); };
            container.appendChild(btn);
        }
    }
    function revealDoorWithScroll(doorIdx) {
        if (doorIdx < 0 || doorIdx >= arcaneDoorRevealed.length) return;
        arcaneDoorRevealed[doorIdx] = true;
        var doors = document.querySelectorAll('.arcane-level-door');
        var delta = arcaneDoorDeltas[doorIdx];
        var dest = arcaneCurrentLevel + delta;
        var lbl = delta < 0 ? '‚ñº Niv.' + dest : (delta > 1 ? '‚ñ≤ Niv.' + dest : '‚Üí +1');
        if (doors[doorIdx]) {
            doors[doorIdx].textContent = 'üö™ ' + lbl;
            doors[doorIdx].title = 'Destination : niveau ' + dest;
        }
    }
    function spawnCornerClues() {
        var container = document.getElementById('arcane-corner-clues-container');
        if (!container || !arcaneDoorDeltas.length) return;
        container.innerHTML = '';
        var corners = [
            { pos: 'top:8px;left:8px;', label: 'üîÆ' },
            { pos: 'top:8px;right:8px;left:auto;', label: 'üîÆ' },
            { pos: 'bottom:8px;left:8px;', label: 'üîÆ' },
            { pos: 'bottom:8px;right:8px;left:auto;', label: 'üîÆ' }
        ];
        var n = 1 + Math.floor(Math.random() * 2);
        var used = [];
        for (var c = 0; c < n; c++) {
            var idx = Math.floor(Math.random() * corners.length);
            while (used.indexOf(idx) !== -1) idx = (idx + 1) % corners.length;
            used.push(idx);
            var el = document.createElement('div');
            el.className = 'arcane-corner-clue';
            el.style.cssText = corners[idx].pos + 'position:absolute;';
            el.textContent = corners[idx].label;
            el.title = 'Indice cach√©...';
            el.onclick = (function(clueEl) {
                return function() {
                    if (clueEl.classList.contains('used')) return;
                    var unrevealed = [];
                    for (var i = 0; i < arcaneDoorRevealed.length; i++) { if (!arcaneDoorRevealed[i]) unrevealed.push(i); }
                    if (unrevealed.length === 0) return;
                    var doorIdx = unrevealed[Math.floor(Math.random() * unrevealed.length)];
                    var delta = arcaneDoorDeltas[doorIdx];
                    var typ = delta < 0 ? 'Pi√®ge' : 'Raccourci';
                    var doors = document.querySelectorAll('.arcane-level-door');
                    if (doors[doorIdx]) {
                        var lbl = typ + (delta < 0 ? ' ‚ñº' + (arcaneCurrentLevel + delta) : ' ‚ñ≤');
                        doors[doorIdx].textContent = 'üö™ ' + lbl;
                        doors[doorIdx].title = typ + (delta < 0 ? ' -' + Math.abs(delta) + ' niveaux' : ' vers l\'avant');
                    }
                    arcaneDoorRevealed[doorIdx] = true;
                    clueEl.classList.add('used');
                    echoAddMessage('Indice : La Porte ' + (doorIdx + 1) + ' est un ' + typ + '.');
                    addOracleChatMessage('Indice r√©v√©l√© : Porte ' + (doorIdx + 1) + ' = ' + typ + '.');
                };
            })(el);
            container.appendChild(el);
        }
    }
    function spawnScrolls() {
        var container = document.getElementById('arcane-scrolls-container');
        if (!container) return;
        container.innerHTML = '';
        var n = 1 + Math.floor(Math.random() * 2);
        for (var i = 0; i < n; i++) {
            var s = document.createElement('div');
            s.className = 'arcane-scroll-object';
            s.textContent = 'üìú';
            s.style.left = (15 + Math.random() * 70) + '%';
            s.style.top = (5 + Math.random() * 20) + 'px';
            s.onclick = (function() { return function() {
                if (this.classList.contains('revealed')) return;
                if (arcaneDoorDeltas.length) {
                    var doorIdx = Math.floor(Math.random() * arcaneDoorDeltas.length);
                    var useProbability = Math.random() < 0.5;
                    if (useProbability) {
                        var pct = [20, 30, 40, 50, 60][Math.floor(Math.random() * 5)];
                        var targetLvl = Math.min(ARCANA_MAX_LEVEL, arcaneCurrentLevel + 5 + Math.floor(Math.random() * 45));
                        var msg = 'Parchemin : La Porte ' + (doorIdx+1) + ' a ' + pct + '% de chance d\'√™tre un raccourci vers le Niveau ' + targetLvl + '.';
                        addOracleChatMessage(msg);
                        echoAddMessage(msg);
                        var doors = document.querySelectorAll('.arcane-level-door');
                        if (doors[doorIdx]) doors[doorIdx].title = pct + '% raccourci vers Niv.' + targetLvl;
                    } else {
                        revealDoorWithScroll(doorIdx);
                        addOracleChatMessage('Parchemin : la Porte ' + (doorIdx+1) + ' m√®ne au niveau ' + (arcaneCurrentLevel + arcaneDoorDeltas[doorIdx]) + '. +1 Cl√© Nav.');
                    }
                    this.classList.add('revealed');
                    arcaneNavKeys++;
                    updateArcaneInventory();
                }
            }; })();
            container.appendChild(s);
        }
    }
    function useNavKey() {
        if (arcaneNavKeys < 1) { addOracleChatMessage('Pas de Cl√© de Navigation.'); return; }
        document.getElementById('arcane-nav-key-panel').style.display = 'block';
    }
    function navKeyPropulsion() {
        if (arcaneNavKeys < 1) return;
        arcaneNavKeys--;
        updateArcaneInventory();
        closeNavKeyPanel();
        var jump = 1 + Math.floor(Math.random() * 10);
        goToLevel(arcaneCurrentLevel + jump);
        echoAddMessage('Propulsion activ√©e : saut de ' + jump + ' niveaux !');
        addOracleChatMessage('Propulsion : +' + jump + ' niveaux.');
    }
    function navKeyRappel() {
        if (arcaneNavKeys < 1) return;
        arcaneNavKeys--;
        updateArcaneInventory();
        closeNavKeyPanel();
        var target = 0;
        if (arcaneLootLevels.length > 0) {
            target = arcaneLootLevels[Math.floor(Math.random() * arcaneLootLevels.length)];
        } else {
            target = Math.max(1, arcaneCurrentLevel - (5 + Math.floor(Math.random() * 10)));
        }
        goToLevel(target, true);
        echoAddMessage('Rappel : retour au Niveau ' + target + ' pour ramasser un butin.');
        addOracleChatMessage('Rappel vers le niveau ' + target + '.');
    }
    function closeNavKeyPanel() {
        document.getElementById('arcane-nav-key-panel').style.display = 'none';
    }
    function updatePyramidMap() {
        var grid = document.getElementById('pyramid-grid');
        var map = document.getElementById('arcane-pyramid-map');
        if (!grid || !map) return;
        grid.innerHTML = '';
        var rows = 10;
        var perRow = ARCANA_MAX_LEVEL / rows;
        for (var r = 0; r < rows; r++) {
            var rowDiv = document.createElement('div');
            rowDiv.className = 'pyramid-row';
            var start = Math.floor(r * perRow) + 1;
            var end = Math.min(ARCANA_MAX_LEVEL, Math.floor((r + 1) * perRow));
            for (var l = start; l <= end; l++) {
                var cell = document.createElement('div');
                var isPlayer = l === arcaneCurrentLevel;
                var hasLoot = arcaneLootLevels.indexOf(l) !== -1;
                cell.className = 'pyramid-cell' + (isPlayer ? ' player' : '') + (hasLoot ? ' loot' : '');
                cell.textContent = l;
                rowDiv.appendChild(cell);
            }
            grid.appendChild(rowDiv);
        }
        map.style.display = arcaneInLevelMode ? 'block' : 'none';
    }
    async function loadLevelWeb3() {
        if (!provider || !account) return;
        try {
            var c = new ethers.Contract(ARCANA_PROGRESSION_CONTRACT, ARCANA_PROGRESSION_ABI, provider);
            var lvl = await c.playerLevel(account);
            var n = lvl ? (typeof lvl === 'number' ? lvl : parseInt(lvl.toString(), 10)) : 0;
            if (n > 0 && n <= ARCANA_MAX_LEVEL) arcaneCurrentLevel = n;
        } catch (e) { console.warn('Load level:', e); }
    }
    async function saveLevelWeb3(level) {
        if (!signer || !account) return;
        try {
            var c = new ethers.Contract(ARCANA_PROGRESSION_CONTRACT, ARCANA_PROGRESSION_ABI, signer);
            var tx = await c.setLevel(level);
            await tx.wait();
        } catch (e) { console.warn('Save level:', e); }
    }
    function enterLevelMode() {
        arcaneInLevelMode = true;
        arcaneNavKeys = (arcaneNavKeys || 0) + 1;
        updateArcaneInventory();
        document.getElementById('arcane-level-counter').style.display = 'block';
        document.getElementById('arcane-level-panel').style.display = 'block';
        document.getElementById('arcane-pyramid-map').style.display = 'block';
        var journal = document.getElementById('arcane-echo-journal');
        if (journal) { journal.style.display = 'block'; echoAddMessage('Le Sanctuaire s\'√©veille. Les 100 niveaux vous attendent.'); }
        updateLevelDisplay();
        generateLevelDoors();
        spawnScrolls();
        spawnCornerClues();
        updatePyramidMap();
        if (isVipWallet(account)) {
            console.log('%c[Omniscience] Entr√©e aux 100 niveaux ‚Äî Butin total accumul√©: ' + arcaneTotalLootSpawned + ' | Tr√©sors en attente: ' + arcaneLootLevels.length, 'color:#d4af37; font-weight:bold;');
        }
        if (Math.random() < 0.3) {
            var rumourLvl = 1 + Math.floor(Math.random() * ARCANA_MAX_LEVEL);
            echoAddMessage('Rumeur : un butin a √©t√© signal√© au Niveau ' + rumourLvl + '.');
        }
    }

    function showGameContent() {
        var gate = document.getElementById('arcana-connect-gate');
        var content = gameContainer();
        if (gate) gate.classList.add('hidden');
        if (content) content.classList.add('visible');
    }

    function showOracleNetworkAlert() {
        if (document.getElementById('oracle-network-overlay')) return;
        var overlay = document.createElement('div');
        overlay.id = 'oracle-network-overlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9998;';
        var box = document.createElement('div');
        box.className = 'oracle-network-alert';
        box.innerHTML = '<p>L\'Oracle ne reconna√Æt que le r√©seau Polygon.</p><button class="btn-connect" onclick="switchToPolygon()">Passer sur Polygon</button><br><button class="btn-connect" style="margin-top:8px;background:transparent;border:1px solid #888;color:#888;" onclick="document.getElementById(\'oracle-network-overlay\').remove()">Fermer</button>';
        overlay.appendChild(box);
        document.body.appendChild(overlay);
    }

    async function switchToPolygon() {
        try {
            if (window.ethereum && provider) {
                await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] });
                var overlay = document.getElementById('oracle-network-overlay');
                if (overlay) overlay.remove();
                if (provider && account) {
                    window._arcanaTransitionDone = false;
                    var sgn = provider.getSigner ? provider.getSigner() : null;
                    if (sgn) triggerTransitionToSanctuary(provider, sgn, account);
                }
            }
        } catch (e) {
            if (e.code === 4902) {
                await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x89', chainName: 'Polygon Mainnet', rpcUrls: ['https://polygon-rpc.com'], nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 }, blockExplorerUrls: ['https://polygonscan.com'] }] });
                var ov = document.getElementById('oracle-network-overlay');
                if (ov) ov.remove();
                if (provider && account) {
                    window._arcanaTransitionDone = false;
                    var s = provider.getSigner ? provider.getSigner() : null;
                    if (s) triggerTransitionToSanctuary(provider, s, account);
                }
            }
        }
    }

    function updateWalletAddressDisplay(addr) {
        var existing = document.getElementById('wallet-address-badge');
        if (existing) existing.remove();
        var existingTest = document.getElementById('test-mode-badge');
        if (existingTest) existingTest.remove();
        
        if (!addr || addr.length < 10) return;
        
        var short = addr.slice(0, 6) + '‚Ä¶' + addr.slice(-4);
        var badge = document.createElement('div');
        badge.id = 'wallet-address-badge';
        badge.className = 'wallet-address-badge';
        badge.textContent = short;
        document.body.appendChild(badge);
        
        // Ajouter badge de mode test si applicable
        if (isTestWallet(addr)) {
            var testBadge = document.createElement('div');
            testBadge.id = 'test-mode-badge';
            testBadge.className = 'test-mode-badge';
            testBadge.innerHTML = 'üß™ MODE TEST';
            testBadge.title = 'Oracle Bypass Activ√© : Toutes les fonctions sont d√©bloqu√©es';
            document.body.appendChild(testBadge);
        }
    }

    function hideGameContent() {
        provider = null; signer = null; account = null;
        window._arcanaTransitionDone = false;
        var gate = document.getElementById('arcana-connect-gate');
        var content = gameContainer();
        if (gate) { gate.classList.remove('hidden', 'fade-out'); }
        if (content) { content.classList.remove('visible', 'fade-in'); }
        var frost = document.getElementById('frost-particles');
        if (frost) { frost.classList.remove('active'); frost.innerHTML = ''; }
        document.body.classList.remove('frost-transition');
        var inv = document.getElementById('arcane-inventory');
        if (inv) inv.style.display = 'none';
        var gb = document.getElementById('grimoire-btn');
        if (gb) gb.style.display = 'none';
        var df = document.getElementById('arcane-dark-fog');
        var dl = document.getElementById('arcane-darkness-overlay');
        if (df) df.style.opacity = '0';
        if (dl) dl.style.opacity = '0';
        var ej = document.getElementById('arcane-echo-journal');
        if (ej) ej.style.display = 'none';
        var pm = document.getElementById('arcane-pyramid-map');
        if (pm) pm.style.display = 'none';
        var fog = document.getElementById('arcana-fog');
        if (fog) fog.classList.remove('sanctuary-active');
        var badge = document.getElementById('wallet-address-badge');
        if (badge) badge.remove();
        var overlay = document.getElementById('oracle-network-overlay');
        if (overlay) overlay.remove();
    }

    function addOracleChatMessage(msg) {
        var chatContainer = document.querySelector('#chat-temple div[style*="overflow-y"]') || document.querySelector('#chat-temple > div:nth-child(2)');
        if (chatContainer) {
            var p = document.createElement('p');
            p.style.cssText = 'margin:5px 0; color:var(--gold); font-weight:bold;';
            p.textContent = msg;
            chatContainer.appendChild(p);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }

    function spawnFrostParticles() {
        var container = document.getElementById('frost-particles');
        if (!container) return;
        container.innerHTML = '';
        for (var i = 0; i < 45; i++) {
            var dot = document.createElement('div');
            dot.className = 'frost-dot';
            dot.style.left = (Math.random() * 100) + '%';
            dot.style.animationDelay = (Math.random() * 2) + 's';
            dot.style.animationDuration = (3 + Math.random() * 3) + 's';
            container.appendChild(dot);
        }
        container.classList.add('active');
    }

    async function triggerTransitionToSanctuary(prov, sgn, addr) {
        if (window._arcanaTransitionDone) return;
        provider = prov; signer = sgn; account = addr;
        var chainId = 0;
        try {
            if (prov) {
                var net = await prov.getNetwork();
                chainId = net.chainId;
            }
        } catch (e) { chainId = 0; }
        if (chainId !== 137) {
            showOracleNetworkAlert();
            return;
        }
        window._arcanaTransitionDone = true;
        updateWalletAddressDisplay(addr);
        var shortAddr = addr && addr.length > 10 ? addr.slice(0, 6) + '‚Ä¶' + addr.slice(-4) : (addr || 'Initi√©');
        var gate = document.getElementById('arcana-connect-gate');
        var content = gameContainer();
        if (gate) { gate.classList.add('fade-out'); setTimeout(function(){ gate.classList.add('hidden'); }, 400); }
        document.body.classList.add('frost-transition');
        var fog = document.getElementById('arcana-fog');
        if (fog) fog.classList.add('sanctuary-active');
        spawnFrostParticles();
        addOracleChatMessage(isVipWallet(addr) ? 'Salutations, Bernard. Le Sanctuaire est sous votre contr√¥le.' : 'Bienvenue Bernard. L\'Oracle de Montr√©al analyse votre pr√©sence...');
        addOracleChatMessage('Oracle : Initi√© ' + shortAddr + ' reconnu. Le givre se propage...');
        try {
            var iceAudio = document.getElementById('ice-crackle-audio');
            if (iceAudio) { iceAudio.volume = 0.4; iceAudio.currentTime = 0; iceAudio.play().catch(function(){}); }
        } catch (e) {}
        if (content) {
            content.classList.add('visible', 'fade-in');
            setTimeout(function() { content.classList.remove('fade-in'); }, 1100);
            var inv = document.getElementById('arcane-inventory');
            if (inv) inv.style.display = 'flex';
            var gb = document.getElementById('grimoire-btn');
            if (gb) gb.style.display = 'flex';
            updateArcaneDoors();
            setTimeout(function(){
                var df = document.getElementById('arcane-dark-fog');
                var dl = document.getElementById('arcane-darkness-overlay');
                if (df) df.style.opacity = '1';
                if (dl) dl.style.opacity = '1';
                loadLevelWeb3();
            }, 700);
        }
        setTimeout(function() {
            document.body.classList.remove('frost-transition');
            var frost = document.getElementById('frost-particles');
            if (frost) frost.classList.remove('active');
            
            // Rafra√Æchir l'Oracle avec le contexte du wallet connect√©
            fetchAndDisplayTemperature();
            
            // Log pour wallet de test
            if (isTestWallet(addr)) {
                console.log('%cüß™ Mode Test D√©tect√© : Wallet ' + addr.slice(0,6) + '...' + addr.slice(-4), 'color:#00ff88; font-weight:bold; font-size:1.1em;');
                console.log('%c‚ÑπÔ∏è Oracle Bypass : Toutes les fonctions sont d√©bloqu√©es ind√©pendamment de la temp√©rature', 'color:#00ff88;');
            }
        }, 2500);
    }

    window.arcanaOnW3mConnect = function(prov, sgn, acc) {
        triggerTransitionToSanctuary(prov, sgn, acc);
        var btn = document.querySelector('#web3modal-connect-wrap .btn-connect');
        if (btn) btn.innerText = 'Connect√©';
    };

    window.arcanaOnW3mDisconnect = hideGameContent;

    // ----------------------- TEMP√âRATURE ORACLE -----------------------

    // Remplace ici si le contrat de temp√©rature est un autre ! (Sinon garde ARCANA_GAME_CONTRACT)
    const ARCANA_GAME_ORACLE_CONTRACT = ARCANA_GAME_CONTRACT; 

    // === √âtat de l'Oracle (chargement asynchrone) ===
    var oracleTemperature = null;
    var oracleLoading = true;
    
    async function fetchAndDisplayTemperature() {
        try {
            // Utilise provider public ou connecte au wallet au besoin
            if (!provider) {
                provider = new ethers.providers.Web3Provider(window.ethereum || ethers.getDefaultProvider("https://polygon-rpc.com"), "any");
            }
            const oracle = new ethers.Contract(ARCANA_GAME_ORACLE_CONTRACT, ARCANA_GAME_ORACLE_ABI, provider);

            let tempRaw = await oracle.currentTemp();
            let tempC = (typeof tempRaw === 'number') ? tempRaw : Number(tempRaw.toString());
            oracleTemperature = tempC;
            oracleLoading = false;

            const tempDisplay = document.getElementById('temp');
            const depositBtn = document.getElementById('btnDeposit');
            const warningMsg = document.getElementById('oracle-warning-message');
            const oracleMirror = document.querySelector(".oracle-mirror");
            
            // Mode Test : Bypass pour wallet de test
            var isTestMode = account && isTestWallet(account);

            // Console Log : √âtat de l'Oracle
            console.log('%cüì° Oracle M√©t√©o - √âtat', 'color:#d4af37; font-weight:bold;');
            console.log('   Temp√©rature actuelle:', tempC + '¬∞C');
            console.log('   Bypass activ√©:', bypassOracle);
            console.log('   Wallet de test:', isTestMode);
            console.log('   Acc√®s autoris√©:', (tempC <= -2 || bypassOracle === true || isTestMode));

            // V√©rifier si l'acc√®s est autoris√© (temp <= -2¬∞C OU bypass OU test mode)
            var accessGranted = (tempC <= -2 || bypassOracle === true || isTestMode);

            if (accessGranted) {
                // Affiche la temp√©rature avec indicateur d'acc√®s autoris√©
                tempDisplay.textContent = `${tempC}¬∞C üîì`;
                
                // ‚ïê‚ïê‚ïê ACC√àS AUTORIS√â : Toutes les fonctions sont d√©bloqu√©es ‚ïê‚ïê‚ïê
                if (warningMsg) {
                    warningMsg.innerHTML = '<span style="color:#00ff88;">üîì <strong>Acc√®s Autoris√©</strong> : Gel confirm√© (‚â§ -2¬∞C)</span>';
                    warningMsg.style.display = "block";
                }
                if (depositBtn) {
                    depositBtn.disabled = false;
                    depositBtn.classList.remove("disabled");
                    depositBtn.title = "D√©p√¥t autoris√© - Gel actif";
                }
                // Ajoute le style frozen √† l'oracle miroir
                if (oracleMirror) {
                    oracleMirror.classList.add("frozen");
                }
                
                // Console log de confirmation
                console.log('%cüîì Temp√©rature actuelle: ' + tempC + '¬∞C | Acc√®s autoris√© (‚â§ -2¬∞C)', 'color:#00ff88; font-weight:bold;');
            } else {
                // Acc√®s refus√©
                tempDisplay.textContent = `${tempC}¬∞C üîí`;
                
                if (warningMsg) {
                    warningMsg.innerHTML = '<span style="color:#ff6b6b;">üîí <strong>Sanctuaire en Attente</strong> : Le gel n\'est pas assez profond (> -2¬∞C)</span>';
                    warningMsg.style.display = "block";
                }
                if (depositBtn) {
                    depositBtn.disabled = true;
                    depositBtn.classList.add("disabled");
                    depositBtn.title = "Gel insuffisant - Attendez le froid";
                }
                if (oracleMirror) {
                    oracleMirror.classList.remove("frozen");
                }
                
                console.log('%cüîí Temp√©rature actuelle: ' + tempC + '¬∞C | Acc√®s refus√© (> -2¬∞C)', 'color:#ff6b6b; font-weight:bold;');
            }
        } catch(e) {
            oracleLoading = false;
            console.warn('Oracle fetch error:', e);
            
            // En cas d'erreur ET bypass activ√©, autoriser quand m√™me l'acc√®s
            if (bypassOracle === true) {
                console.log('%cüîì Erreur Oracle d√©tect√©e | Acc√®s forc√© par bypass', 'color:#00ff88; font-weight:bold;');
                const depositBtn = document.getElementById('btnDeposit');
                const oracleMirror = document.querySelector(".oracle-mirror");
                const warningMsg = document.getElementById('oracle-warning-message');
                
                if (depositBtn) {
                    depositBtn.disabled = false;
                    depositBtn.classList.remove("disabled");
                    depositBtn.title = "Bypass Oracle Activ√©";
                }
                if (oracleMirror) {
                    oracleMirror.classList.add("frozen");
                }
                if (warningMsg) {
                    warningMsg.innerHTML = '<span style="color:#00ff88;">üîì <strong>Bypass Oracle Activ√©</strong> : Acc√®s forc√©</span>';
                    warningMsg.style.display = "block";
                }
            } else {
                const tempDisplay = document.getElementById('temp');
                if (tempDisplay) tempDisplay.textContent = "??¬∞C";
                const warningMsg = document.getElementById('oracle-warning-message');
                if (warningMsg) {
                    warningMsg.innerHTML = '‚ö†Ô∏è <strong>Oracle temporairement indisponible</strong><br><small style="font-size:0.85em;opacity:0.75;">Les fonctions seront actives d√®s que l\'Oracle r√©pond.</small>';
                    warningMsg.style.display = "block";
                }
                const depositBtn = document.getElementById('btnDeposit');
                if (depositBtn) {
                    depositBtn.disabled = true;
                    depositBtn.classList.add("disabled");
                    depositBtn.title = "Oracle : Connexion en cours...";
                }
                const oracleMirror = document.querySelector(".oracle-mirror");
                if (oracleMirror) {
                    oracleMirror.classList.remove("frozen");
                }
            }
        }
    }

    // === FONCTION DE S√âCURIT√â : Lance les v√©rifications APR√àS l'affichage ===
    function checkSecurity() {
        console.log('%cüîí V√©rifications de s√©curit√© lanc√©es en arri√®re-plan', 'color:#d4af37; font-weight:bold;');
        
        // Afficher imm√©diatement l'interface avec un placeholder
        var tempDisplay = document.getElementById('temp');
        if (tempDisplay) tempDisplay.textContent = '‚è≥';
        
        var oracleMirror = document.querySelector('.oracle-mirror');
        if (oracleMirror) oracleMirror.classList.add('loading');
        
        var warningMsg = document.getElementById('oracle-warning-message');
        if (warningMsg) {
            warningMsg.innerHTML = '<small style="opacity:0.6;">üì° Oracle en cours de connexion...</small>';
            warningMsg.style.display = "block";
        }
        
        // Lancer l'Oracle en arri√®re-plan (non-bloquant)
        setTimeout(function() {
            fetchAndDisplayTemperature().then(function() {
                var mirror = document.querySelector('.oracle-mirror');
                if (mirror) mirror.classList.remove('loading');
            });
        }, 500);

        // Rafra√Æchissement automatique toutes les 3 minutes
        setInterval(function() {
            fetchAndDisplayTemperature();
        }, 180*1000);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INITIALISATION DE LA PREMI√àRE QU√äTE (RUNE N¬∞1)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function initialiserQueteRune1() {
        // Si la qu√™te n'a pas encore √©t√© compl√©t√©e, faire clignoter la Rune n¬∞1
        if (!runesDecouvertes.rune1PremierClic) {
            var runes = Array.from(document.querySelectorAll('.runes-column .rune-btn'));
            if (runes[0]) {
                runes[0].classList.add('quete-active');
                
                // Message console stylis√©
                console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color:#d4af37; font-weight:bold;');
                console.log('%c‚ïë      üåü QU√äTE ACTIVE : LE PREMIER FRAGMENT       ‚ïë', 'color:#d4af37; font-weight:bold; font-size:1.1em;');
                console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color:#d4af37; font-weight:bold;');
                console.log('%c\n‚ú® La Rune n¬∞1 (‚èÄ) clignote doucement en dor√©...', 'color:#d4af37; font-weight:bold;');
                console.log('%cüí° Cliquez sur cette rune pour d√©couvrir le premier secret !', 'color:#49cafa; font-size:1.05em;');
                console.log('%c\nüîç Indices :', 'color:#888; font-weight:bold;');
                console.log('%c   ‚Üí La rune se trouve dans la colonne de gauche', 'color:#888;');
                console.log('%c   ‚Üí Symbole : ‚èÄ (premi√®re rune en haut)', 'color:#888;');
                console.log('%c   ‚Üí Un papyrus ancien vous attend...', 'color:#888;');
                console.log('%c\nüéÅ R√©compense : Papyrus Ancien avec texte russe mystique', 'color:#00ff88;');
                console.log(' ');
                
                // Message dans le chat Oracle
                setTimeout(function() {
                    addOracleChatMessage('üåü Une qu√™te vous attend... Observez la premi√®re rune qui clignote doucement.');
                }, 2000);
            }
        }
    }
    
    // === CHARGEMENT APR√àS L'AFFICHAGE COMPLET ===
    window.addEventListener('load', function() {
        checkSecurity();
        
        // Initialiser la premi√®re qu√™te apr√®s un court d√©lai
        setTimeout(function() {
            initialiserQueteRune1();
        }, 1000);
        
        // Gestionnaire pour le bouton "CONNECT WALLET" du header
        const headerConnectBtn = document.getElementById('header-connect-wallet-btn');
        if (headerConnectBtn) {
            headerConnectBtn.addEventListener('click', function() {
                // Chercher le bouton w3m natif et simuler un clic
                const w3mButton = document.querySelector('w3m-button');
                if (w3mButton && w3mButton.shadowRoot) {
                    const innerBtn = w3mButton.shadowRoot.querySelector('button');
                    if (innerBtn) {
                        innerBtn.click();
                    }
                }
            });
        }
    });

    // Codes valides pour ouvrir le Sanctuaire (Niveau 3)
    const VALID_SEAL_CODES = ['ARCANA2026'];

    function showStyledAlert(message) {
        // Supprimer toute alerte existante
        var existingOverlay = document.getElementById('arcana-alert-overlay');
        if (existingOverlay) existingOverlay.remove();
        
        const overlay = document.createElement('div');
        overlay.id = 'arcana-alert-overlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);';
        const box = document.createElement('div');
        box.className = 'glass-panel';
        box.style.cssText = 'font-family:"Cinzel",serif;max-width:450px;text-align:center;position:relative;padding:35px;background:rgba(20,15,10,0.95)!important;backdrop-filter:blur(20px)!important;-webkit-backdrop-filter:blur(20px)!important;border:2px solid rgba(212,175,55,0.7)!important;border-radius:15px;box-shadow:0 0 60px rgba(0,0,0,0.9),0 0 100px rgba(212,175,55,0.3)!important;';
        box.innerHTML = '<div style="font-family:inherit;color:var(--gold);margin:0 0 24px 0;font-size:1.05em;line-height:1.8;font-weight:400;letter-spacing:0.05em;">' + message + '</div><button class="btn-connect" onclick="document.getElementById(\'arcana-alert-overlay\').remove()" style="cursor:pointer;width:100%;margin-top:12px;">FERMER</button>';
        overlay.appendChild(box);
        overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
        document.body.appendChild(overlay);
    }

    async function onSealClick() {
        if (!arcaneLitRooms[1]) return;
        const level2Panel = document.getElementById('level-2-panel');
        const codeInput = document.getElementById('sealCodeInput');
        const btnSeal = document.getElementById('btnSeal');

        btnSeal.disabled = true;
        try {
            // Mode Test : Bypass pour wallet de test
            var isTestMode = account && isTestWallet(account);
            
            if (!provider) {
                provider = new ethers.providers.Web3Provider(window.ethereum || ethers.getDefaultProvider("https://polygon-rpc.com"), "any");
            }
            const oracle = new ethers.Contract(ARCANA_GAME_ORACLE_CONTRACT, ARCANA_GAME_ORACLE_ABI, provider);
            const tempRaw = await oracle.currentTemp();
            const tempC = (typeof tempRaw === 'number') ? tempRaw : Number(tempRaw.toString());

            // Console Log : √âtat complet
            console.log('%cüîê V√©rification Oracle pour le Sceau du Sanctuaire', 'color:#d4af37; font-weight:bold;');
            console.log('   Temp√©rature actuelle:', tempC + '¬∞C');
            console.log('   Seuil requis: ‚â§ -2¬∞C');
            console.log('   Bypass Oracle:', bypassOracle);
            console.log('   Wallet de test:', isTestMode);

            // ‚ïê‚ïê‚ïê CONDITION DE FORCE : Temp <= -2 OU bypassOracle OU wallet de test ‚ïê‚ïê‚ïê
            // Seuil r√©aliste : Acc√®s autoris√© uniquement si temp√©rature ‚â§ -2¬∞C
            if (tempC > -2 && bypassOracle !== true && !isTestMode) {
                showStyledAlert('‚ùÑÔ∏è <strong>Oracle M√©t√©o</strong><br><br>Le Sanctuaire attend le gel profond.<br><br>Temp√©rature actuelle : ' + tempC + '¬∞C<br>Seuil requis : ‚â§ -2¬∞C');
                return;
            }
            
            // Message de confirmation si bypass ou mode test
            if ((bypassOracle || isTestMode) && tempC > -2) {
                console.log('%cüîì Temp√©rature actuelle: ' + tempC + '¬∞C | Acc√®s forc√© par bypass/admin', 'color:#00ff88; font-weight:bold; font-size:1.1em;');
            }

            const code = (codeInput.value || '').trim();
            const isValidCode = VALID_SEAL_CODES.some(c => code.toUpperCase() === c.toUpperCase());

            if (!isValidCode) {
                vibratePanel(level2Panel);
                const origBorder = codeInput.style.border;
                codeInput.style.border = '2px solid #ff2424';
                codeInput.style.transition = 'border 0.2s';
                setTimeout(function() {
                    codeInput.style.border = origBorder || '';
                }, 1000);
                return;
            }

            level2Panel.style.transition = 'opacity 0.5s ease';
            level2Panel.style.opacity = '0';
            setTimeout(function() {
                level2Panel.style.display = 'none';
                startFinalLevel();
            }, 500);
        } catch (e) {
            // En cas d'erreur Oracle, si bypass est activ√©, continuer quand m√™me
            if (bypassOracle === true) {
                console.log('%cüîì Erreur Oracle d√©tect√©e | Acc√®s forc√© par bypass', 'color:#00ff88; font-weight:bold;');
                
                const code = (codeInput.value || '').trim();
                const isValidCode = VALID_SEAL_CODES.some(c => code.toUpperCase() === c.toUpperCase());
                
                if (!isValidCode) {
                    vibratePanel(level2Panel);
                    const origBorder = codeInput.style.border;
                    codeInput.style.border = '2px solid #ff2424';
                    codeInput.style.transition = 'border 0.2s';
                    setTimeout(function() {
                        codeInput.style.border = origBorder || '';
                    }, 1000);
                    btnSeal.disabled = false;
                    return;
                }
                
                level2Panel.style.transition = 'opacity 0.5s ease';
                level2Panel.style.opacity = '0';
                setTimeout(function() {
                    level2Panel.style.display = 'none';
                    startFinalLevel();
                }, 500);
            } else {
                showStyledAlert('‚ö†Ô∏è <strong>Erreur Oracle</strong><br><br>Impossible de contacter l\'Oracle m√©t√©o.<br><br>' + (e.message || e));
                btnSeal.disabled = false;
            }
        } finally {
            if (!bypassOracle) btnSeal.disabled = false;
        }
    }

    const ADMIN_SEAL_PASSWORD = 'ARCANA2026';
    function toggleAdmin() {
        const dash = document.getElementById('admin-dashboard');
        if (!dash) return;
        const willShow = (dash.style.display === 'none' || !dash.style.display);
        if (willShow) {
            const input = prompt('Saisissez le Sceau de l\'Administrateur');
            if (input === null) return;
            if ((input || '').trim().toUpperCase() !== ADMIN_SEAL_PASSWORD.toUpperCase()) {
                alert('Acc√®s refus√© par l\'Oracle');
                return;
            }
            dash.style.display = 'block';
            refreshAdminStats();
        } else {
            dash.style.display = 'none';
        }
    }
    function hideAdmin() {
        const dash = document.getElementById('admin-dashboard');
        if (dash) dash.style.display = 'none';
    }
    async function refreshAdminStats() {
        const balanceEl = document.getElementById('admin-balance');
        const arcanaBalanceEl = document.getElementById('admin-arcana-balance');
        const oracleEl = document.getElementById('admin-oracle');
        if (!balanceEl && !arcanaBalanceEl && !oracleEl) return;
        try {
            if (!provider) {
                provider = new ethers.providers.Web3Provider(window.ethereum || ethers.getDefaultProvider("https://polygon-rpc.com"), "any");
            }
            const contractAddr = ARCANA_GAME_CONTRACT;
            if (balanceEl) {
                const maticBalance = await provider.getBalance(contractAddr);
                const maticFormatted = parseFloat(ethers.utils.formatEther(maticBalance)).toFixed(2);
                balanceEl.textContent = maticFormatted + ' MATIC';
            }
            if (arcanaBalanceEl) {
                const arcanaToken = new ethers.Contract(ARCANA_TOKEN_ADDRESS, ERC20_ABI, provider);
                const arcanaBalance = await arcanaToken.balanceOf(contractAddr);
                const arcanaDecimals = await arcanaToken.decimals();
                const arcanaFormatted = parseFloat(ethers.utils.formatUnits(arcanaBalance, arcanaDecimals)).toFixed(2);
                arcanaBalanceEl.textContent = arcanaFormatted + ' ARCANA';
            }
            if (oracleEl) {
                const oracle = new ethers.Contract(ARCANA_GAME_ORACLE_CONTRACT, ARCANA_GAME_ORACLE_ABI, provider);
                const tempRaw = await oracle.currentTemp();
                const tempC = (typeof tempRaw === 'number') ? tempRaw : Number(tempRaw.toString());
                oracleEl.textContent = tempC + '¬∞C';
            }
        } catch (e) {
            if (balanceEl) balanceEl.textContent = 'Erreur';
            if (arcanaBalanceEl) arcanaBalanceEl.textContent = 'Erreur';
            if (oracleEl) oracleEl.textContent = 'Erreur';
        }
    }
    async function forceOpenAdmin() {
        const btn = document.getElementById('force-open');
        const logEl = document.getElementById('admin-log');
        const btnOriginalText = btn ? btn.textContent : 'FORCE OUVERTURE';
        if (btn) { btn.disabled = true; btn.textContent = '‚ùÑÔ∏è GIVRAGE EN COURS...'; }
        try {
            if (!signer) await connectWallet();
            if (!signer) {
                alert('Connexion au wallet requise. Veuillez d√©verrouiller MetaMask et r√©essayer.');
                return;
            }
            account = await signer.getAddress();
            if (ADMIN_ADDRESS && account.toLowerCase() !== ADMIN_ADDRESS.toLowerCase()) {
                alert('Acc√®s refus√©. Seul l\'adresse admin peut effectuer cette action.');
                return;
            }
            const contract = new ethers.Contract(ARCANA_GAME_CONTRACT, ARCANA_GAME_ORACLE_ABI, signer);
            if (logEl) logEl.innerHTML += '<p>‚è≥ Envoi temp√©rature -20¬∞C au contrat...</p>';
            const tx = await contract.updateOracle(-20);
            if (logEl) logEl.innerHTML += '<p>‚è≥ Transaction en cours...</p>';
            await tx.wait();
            if (logEl) logEl.innerHTML += '<p>‚úÖ Oracle forc√© √† -20¬∞C. Le jeu est d√©bloqu√© !</p>';
            refreshAdminStats();
            fetchAndDisplayTemperature();
        } catch (e) {
            if (logEl) logEl.innerHTML += '<p>‚ùå Erreur: ' + (e.message || e) + '</p>';
            alert('Erreur Force Ouverture: ' + (e.message || e));
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = btnOriginalText; }
        }
    }
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && (e.key === 'A' || e.key === 'a')) {
            e.preventDefault();
            toggleAdmin();
        }
    });

    // ===== Wallet connect & Polygon switch
    async function connectWallet() {
        if (!window.ethereum) {
            return;
        }
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        try {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            signer = provider.getSigner();
            if (!signer) throw new Error('Impossible d\'obtenir le signer');
            account = await signer.getAddress();

            // Switch to Polygon if needed
            const chainId = (await provider.getNetwork()).chainId;
            if (chainId !== 137) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: POLYGON_CHAIN_ID }]
                    });
                } catch(switchError) {
                    // If chain isn't added
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: POLYGON_CHAIN_ID,
                                chainName: "Polygon Mainnet",
                                rpcUrls: ["https://polygon-rpc.com"],
                                nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
                                blockExplorerUrls: ["https://polygonscan.com"]
                            }]
                        });
                    } else {
                        throw switchError;
                    }
                }
            }

            // Affichage du compte connect√© + r√©v√©ler le jeu (fallback si Web3Modal √©choue)
            var btn = document.querySelector(".btn-connect, #web3modal-connect-wrap .btn-connect");
            if (btn) btn.innerText = "Connect√©";
            if (window.arcanaOnW3mConnect) window.arcanaOnW3mConnect(provider, signer, account);

        } catch (err) {
            if (err.code === 4001 || (err?.message && err.message.toLowerCase().includes('reject'))) {
                alert("Connexion annul√©e. Veuillez d√©verrouiller MetaMask si n√©cessaire et r√©essayer.");
            } else {
                alert("Impossible de se connecter au wallet : " + (err.message || err));
            }
        }
    }

    // ============ FONCTION DE D√âP√îT MULTI-TOKEN POLYGON ==============
    async function payStake() {
        if (!window.ethereum) {
            showStyledAlert("Connectez votre wallet via le bouton de connexion pour effectuer un d√©p√¥t.");
            return;
        }
        if (!signer || !account) await connectWallet();
        if (!signer) {
            showStyledAlert("Connectez votre wallet pour effectuer un d√©p√¥t.");
            return;
        }

        // R√©cup√©rer valeur/jeton s√©lectionn√©
        const rawAmount = document.getElementById('amountInput').value;
        const tokenSelected = document.getElementById('tokenSelect').value;
        let amount = Number(rawAmount);

        if (isNaN(amount) || amount <= 0) {
            alert("Veuillez saisir un montant valide.");
            return;
        }

        try {
            let tokenAddress = null;
            let isNative = false, decimals = 18;

            // D√©tails par token
            if (tokenSelected === "USDT") {
                tokenAddress = USDT_TOKEN_ADDRESS;
            } else if (tokenSelected === "USDC") {
                tokenAddress = USDC_TOKEN_ADDRESS;
            } else if (tokenSelected === "ARCANA") {
                tokenAddress = ARCANA_TOKEN_ADDRESS;
            } else if (tokenSelected === "MATIC") {
                isNative = true;
            } else {
                throw new Error("Jeton non g√©r√©");
            }

            // Prepare amount in token's decimals
            let parsedAmount = null;
            if (!isNative) {
                const token = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                decimals = await token.decimals();
                parsedAmount = ethers.utils.parseUnits(amount.toString(), decimals);
            } else {
                parsedAmount = ethers.utils.parseEther(amount.toString());
            }

            if (isNative) {
                // ===== D√©p√¥t en MATIC =====
                const tx = await signer.sendTransaction({
                    to: ARCANA_GAME_CONTRACT,
                    value: parsedAmount
                });
                await tx.wait();
                alert("D√©p√¥t de " + amount + " MATIC envoy√©!");
            } else {
                // ===== D√©p√¥t ERC20 =====
                // V√©rifier allowance
                const token = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                const allowance = await token.allowance(account, ARCANA_GAME_CONTRACT);

                if (allowance.lt(parsedAmount)) {
                    // Approval n√©cessaire
                    const tx1 = await token.approve(ARCANA_GAME_CONTRACT, parsedAmount);
                    await tx1.wait();
                }

                // Transf√©rer le montant au contrat
                // (Le smart contract doit supporter receive/transferFrom)
                const tx2 = await token.transfer(ARCANA_GAME_CONTRACT, parsedAmount);
                await tx2.wait();
                alert(`D√©p√¥t de ${amount} ${tokenSelected} envoy√© !`);
            }
        } catch (error) {
            alert("Erreur lors du d√©p√¥t : " + (error.message || error));
        }
    }

    // Ajout ARCANA √† MetaMask
    async function addArcanaToMetaMask() {
        if (!window.ethereum) {
            return;
        }
        try {
            const wasAdded = await window.ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                    type: 'ERC20',
                    options: {
                        address: '0x1990fd46a1ad0344751be45d6779b8c1f827076d',
                        symbol: 'ARCANA',
                        decimals: 18,
                        image: 'URL_DU_LOGO_ICI' // Remplacez par l'URL du logo ARCANA
                    }
                }
            });
            if (wasAdded) {
                // Le token ARCANA a √©t√© ajout√© avec succ√®s
            }
        } catch (error) {
            alert("Erreur lors de l'ajout du token : " + (error.message || error));
        }
    }

    // Ajoute dynamiquement le lien sous le bouton de d√©p√¥t au chargement DOM
    document.addEventListener('DOMContentLoaded', function() {
        // On cherche le bouton de d√©p√¥t (btn-stake ou btn-depot selon ton HTML)
        // Adaptation¬†: on cherche le parent autour du bouton stake ou le select jeton
        let stakeBtn = document.querySelector('.btn-stake, .btn-depot, #stake-btn');
        let tokenSelect = document.getElementById('tokenSelect');
        let referenceNode = null;
        if (stakeBtn) {
            referenceNode = stakeBtn;
        } else if(tokenSelect) {
            // Fallback : on ins√®re pr√®s du select
            referenceNode = tokenSelect;
        }
        if (referenceNode && !document.getElementById('arcana-metamask-link')) {
            let link = document.createElement('button');
            link.type = "button";
            link.className = "arcana-add-metamask-link";
            link.id = "arcana-metamask-link";
            link.tabIndex = 0;
            link.innerHTML = '+ Ajouter le jeton ARCANA √† MetaMask';
            link.onclick = addArcanaToMetaMask;
            // On l'ins√®re juste apr√®s le bouton de stake
            referenceNode.insertAdjacentElement('afterend', link);
        }
        // Ins√©rer le style uniquement si non d√©j√† pr√©sent
        if (!document.getElementById('arcana-metamask-link-style')) {
          var styleEl = document.createElement('style');
          styleEl.id = 'arcana-metamask-link-style';
          styleEl.innerHTML = `
            .arcana-add-metamask-link {
                display: inline-block;
                margin-top: 6px;
                color: #ffd700;
                font-size: 0.92em;
                font-family: inherit;
                cursor: pointer;
                text-decoration: underline dotted;
                transition: color 0.18s;
                background: transparent;
                border: none;
                padding: 0;
            }
            .arcana-add-metamask-link:hover {
                color: #fff2b8;
                text-decoration: underline;
            }
          `;
          document.head.appendChild(styleEl);
        }
    });

    // Fond √©toil√© dynamique : 200 √©toiles avec animation de scintillement
    (function() {
        const container = document.getElementById('star-container');
        const starCount = 200;
        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            const size = Math.random() * 2 + 0.5;
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            const duration = 2 + Math.random() * 3;
            const delay = Math.random() * 5;
            star.style.width = size + 'px';
            star.style.height = size + 'px';
            star.style.left = x + '%';
            star.style.top = y + '%';
            star.style.animation = `twinkle ${duration}s ease-in-out ${delay}s infinite`;
            star.style.opacity = 0.3 + Math.random() * 0.5;
            container.appendChild(star);
        }
    })();

    // -- Suite du code originel inchang√© pour le Sanctuaire & autres panneaux --
    // -------- Sanctuaire du Destin (Level 3) FINAL -----------
    const SANCTUARY_SEQUENCE = [2, 7, 5, 9, 0, 10];
    const runeSound = new Audio('https://www.soundjay.com/buttons/button-16.mp3');
    let sanctuaryProgress = 0;
    let sanctuaryLocked = false;
    let sanctuaryTimerInterval = null;
    let sanctuaryTimeLeft = 15 * 60;
    let heartbeatInterval = null;
    let heartbeatInitialRate = 950;
    let glitchActive = false;
    let oldGlitchPanel = null;

    function playHeartbeat(rateMs) {
        if (!window.arcanaHeartbeatTimer) window.arcanaHeartbeatTimer = null;
        const audio = document.getElementById('heartbeat-audio');
        if(window.arcanaHeartbeatTimer) clearTimeout(window.arcanaHeartbeatTimer);
        function beat() {
            audio.currentTime = 0;
            audio.volume = 0.27;
            audio.play();
            window.arcanaHeartbeatTimer = setTimeout(beat, rateMs);
        }
        beat();
        window.stopHeartbeat = function() {
            if(window.arcanaHeartbeatTimer) clearTimeout(window.arcanaHeartbeatTimer);
            window.arcanaHeartbeatTimer = null;
            audio.pause(); audio.currentTime = 0;
        }
    }
    function setSanctuaryProgress(newStep) {
        sanctuaryProgress = newStep;
        const fill = document.getElementById('alignement-fill');
        const percent = Math.round((sanctuaryProgress/SANCTUARY_SEQUENCE.length)*100);
        fill.style.width = percent+'%';
        document.getElementById('alignement-percent').textContent = percent + "%";
    }
    function broadcastVictory(walletAddress) {
        const addr = (walletAddress || account || 'Un Initi√©').toString();
        const shortAddr = addr.length > 14 ? addr.slice(0, 6) + '‚Ä¶' + addr.slice(-4) : addr;
        const msg = '‚ú® L\'√âLU ' + shortAddr + ' vient de sceller le Destin ! La pluie d\'or tombe sur le Sanctuaire !';
        const chatContainer = document.querySelector('#chat-temple div[style*="overflow-y"]') || document.querySelector('#chat-temple').children[1];
        if (chatContainer) {
            const p = document.createElement('p');
            p.style.cssText = 'margin:5px 0; color:var(--gold); font-weight:bold;';
            p.textContent = msg;
            chatContainer.appendChild(p);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        return msg;
    }
    function triggerVictoryJackpot() {
        const vj = document.getElementById('victory-jackpot');
        vj.style.display = 'block';
        vj.style.pointerEvents = 'auto';
        makeGoldRainParticles();
        try {
            const ta = document.getElementById('triumph-audio');
            if (ta) { ta.currentTime = 0; ta.volume = 0.6; ta.play().catch(()=>{}); }
        } catch(e) {}
        const fog = document.getElementById('arcana-fog');
        if (fog) { fog.classList.add('sanctuary-active'); fog.classList.add('jackpot-golden'); }
        window.setTimeout(()=>{
            const f = document.getElementById('arcana-fog');
            if (f) f.classList.remove('jackpot-golden');
        }, 10000);
        window.setTimeout(()=>{ vj.style.pointerEvents = 'none'; }, 3500);
    }
    function showSanctuarySuccess() {
        document.getElementById('sanctuary-success').style.display = 'block';
        document.getElementById('sanctuary-success').innerText = "JACKPOT D√âVERROUILL√â‚Äâ! Le Destin est r√©v√©l√©...";
        Array.from(document.querySelectorAll('.runes-column .rune-btn')).forEach(b=>b.disabled=true);
        sanctuaryLocked = true;
        stopHeartbeat();
        broadcastVictory(account);
        triggerVictoryJackpot();
    }
    function resetSanctuaryRunes() {
        sanctuaryProgress = 0;
        setSanctuaryProgress(0);
        document.getElementById('sanctuary-success').style.display = 'none';
        Array.from(document.querySelectorAll('#runes-grid .rune-btn')).forEach(btn=>{
            btn.classList.remove('selected','good','bad');
            btn.disabled = false;
        });
        sanctuaryLocked = false;
    }
    function updateSanctuaryTimerDisplay() {
        const t = sanctuaryTimeLeft;
        let mins = Math.floor(t/60), secs = t%60;
        const timerElem = document.getElementById('sanctuary-timer');
        timerElem.textContent = (mins<10?"0":"")+mins+":"+(secs<10?"0":"")+secs;
        if(sanctuaryTimeLeft<=60){
            timerElem.classList.add('danger');
            enableGlitchPanel();
        } else {
            timerElem.classList.remove('danger');
            disableGlitchPanel();
        }
    }
    function enableGlitchPanel() {
        const panel = document.getElementById('level-3-sanctuary');
        if(glitchActive) return;
        panel.classList.add('glitch');
        glitchActive = true;
    }
    function disableGlitchPanel() {
        const panel = document.getElementById('level-3-sanctuary');
        if(glitchActive) {
            panel.classList.remove('glitch');
            glitchActive = false;
        }
    }
    function tickSanctuaryTimer() {
        if (--sanctuaryTimeLeft<0) {
            clearInterval(sanctuaryTimerInterval);
            sanctuaryTimerInterval = null;
            document.getElementById('sanctuary-timer').textContent = "√âCHEC";
            sanctuaryLocked = true;
            stopHeartbeat();
            enableGlitchPanel();
            Array.from(document.querySelectorAll('.runes-column .rune-btn')).forEach(b=>b.disabled=true);
            document.getElementById('sanctuary-success').style.display = 'block';
            document.getElementById('sanctuary-success').innerText = "Temps √©coul√©. Le sceau s'efface...";
            return;
        }
        updateSanctuaryTimerDisplay();
        if(sanctuaryTimeLeft < 120){
            let x = 1 - Math.max(0, (sanctuaryTimeLeft-60)/60);
            let rate = Math.max(310, heartbeatInitialRate - x*650);
            playHeartbeat(rate);
        } else if(sanctuaryTimeLeft < 875 && sanctuaryTimeLeft % 7 === 0) {
            playHeartbeat(heartbeatInitialRate);
        }
        if(sanctuaryTimeLeft>=120){ stopHeartbeat();}
    }
    function startFinalLevel() {
        const fog = document.getElementById('arcana-fog');
        if (fog) fog.classList.add('sanctuary-active');
        resetSanctuaryRunes();
        sanctuaryTimeLeft = 15*60;
        updateSanctuaryTimerDisplay();
        document.getElementById('level-3-sanctuary').style.display = 'block';
        document.getElementById('level-3-sanctuary').style.opacity = '';
        requestAnimationFrame(()=>{
            let el = document.getElementById('level-3-sanctuary');
            el.style.opacity = 0;
            el.style.transform = 'translate(-50%, -46%) scale(0.96)';
            setTimeout(()=>{
                el.style.opacity = 1;
                el.style.transform = 'translate(-50%,-50%) scale(1)';
            }, 10);
        });
        if(sanctuaryTimerInterval) clearInterval(sanctuaryTimerInterval);
        sanctuaryTimerInterval = setInterval(tickSanctuaryTimer, 1000);
        sanctuaryLocked = false;
        disableGlitchPanel();
        stopHeartbeat();
        document.getElementById('victory-jackpot').style.display = "none";
    }
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SYST√àME DE RUNES - Configuration des 12 Runes
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 
    // Runes 1-4 : Les Chercheurs (fouillerZone)
    // Runes 5-8 : Les Verrous (ouvrirPorte)
    // Runes 9-10 : L'Atelier (assemblage papyrus)
    // Rune 11 : La Taverne (chat social)
    // Rune 12 : L'≈íil de l'Oracle (m√©t√©o + jackpot)
    // 
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // √âtat des √©nigmes et d√©couvertes
    var runesDecouvertes = {
        rune1PremierClic: false,
        indicesTrouves: [],
        papyrusCollectes: [],
        portesOuvertes: []
    };

    function onRuneClick(runeId){
        runeSound.currentTime = 0;
        runeSound.volume = 0.5;
        runeSound.play().catch(function(){});
        
        if (sanctuaryLocked) return;
        
        const runes = Array.from(document.querySelectorAll('.runes-column .rune-btn'));
        const btn = runes[runeId];
        if (!btn) return;
        btn.blur();
        
        /* Effet visuel dor√© au clic */
        btn.classList.add('click-gold');
        setTimeout(function(){ btn.classList.remove('click-gold'); }, 350);
        
        // Dispatcher selon le num√©ro de rune
        if (runeId >= 0 && runeId <= 3) {
            // Runes 1-4 : Les Chercheurs
            fouillerZone(runeId);
        } else if (runeId >= 4 && runeId <= 7) {
            // Runes 5-8 : Les Verrous
            ouvrirPorte(runeId);
        } else if (runeId === 8 || runeId === 9) {
            // Runes 9-10 : L'Atelier
            ouvrirAtelierPapyrus();
        } else if (runeId === 10) {
            // Rune 11 : La Taverne
            ouvrirTaverne();
        } else if (runeId === 11) {
            // Rune 12 : L'≈íil de l'Oracle
            afficherOeilOracle();
        }
        
        // Animation de feedback
        btn.classList.add('good');
        setTimeout(function() {
            btn.classList.remove('good');
        }, 450);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RUNES 1-4 : LES CHERCHEURS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function fouillerZone(runeId) {
        console.log('%cüîç Fouille de la zone - Rune ' + (runeId + 1), 'color:#d4af37; font-weight:bold;');
        
        // √âNIGME #1 - Rune 1 (index 0)
        if (runeId === 0 && !runesDecouvertes.rune1PremierClic) {
            runesDecouvertes.rune1PremierClic = true;
            
            // Vibration mobile de 200ms pour la d√©couverte
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            // Retirer l'animation de clignotement de la rune
            var runes = Array.from(document.querySelectorAll('.runes-column .rune-btn'));
            if (runes[0]) {
                runes[0].classList.remove('quete-active');
            }
            
            // Ajouter le premier papyrus ancien (rouleau √©gyptien) au sac
            ajouterObjetQuete('üìú', 'Papyrus Ancien I', 'papyrus_ancien_1');
            runesDecouvertes.papyrusCollectes.push('papyrus_ancien_1');
            
            // Message chat
            addOracleChatMessage('üóø La Rune des Chercheurs r√©v√®le son premier secret...');
            
            // Ouvrir directement le papyrus avec animation de d√©roulement
            setTimeout(function() {
                ouvrirPapyrus('papyrus_ancien_1', 'Papyrus Ancien I');
            }, 500);
            
            console.log('%c‚ú® √ânigme #1 r√©solue : Premier papyrus d√©couvert !', 'color:#00ff88; font-weight:bold;');
            console.log('%cüìú Le papyrus se d√©roule automatiquement...', 'color:#d4af37;');
            
            return;
        }
        
        // V√©rifier si le joueur n'a pas encore trouv√© le premier indice
        if (!runesDecouvertes.rune1PremierClic && runeId === 0) {
            vibrerSac(1);
            addOracleChatMessage('üí° Cette rune semble cacher quelque chose d\'important...');
            return;
        }
        
        // Comportement pour les autres runes chercheurs
        var indices = [
            { id: 'indice_1', texte: 'Une trace de givre m√®ne vers le nord...', icone: '‚ùÑÔ∏è', papyrus: null },
            { id: 'indice_2', texte: 'Des empreintes myst√©rieuses pr√®s du miroir...', icone: 'üë£', papyrus: 'papyrus_ancien_2' },
            { id: 'indice_3', texte: 'Un √©cho lointain r√©sonne dans les profondeurs...', icone: 'üîä', papyrus: 'papyrus_ancien_3' },
            { id: 'indice_4', texte: 'Une lueur dor√©e perce l\'obscurit√©...', icone: '‚ú®', papyrus: null }
        ];
        
        var indice = indices[runeId];
        if (indice && runesDecouvertes.indicesTrouves.indexOf(indice.id) === -1) {
            runesDecouvertes.indicesTrouves.push(indice.id);
            addOracleChatMessage(indice.icone + ' Indice d√©couvert : ' + indice.texte);
            
            // Papyrus sp√©cifique pour cette rune
            if (indice.papyrus) {
                var papyrusNum = indice.papyrus.split('_')[2]; // Extraire le num√©ro
                ajouterObjetQuete('üìú', 'Papyrus Ancien ' + ['I', 'II', 'III'][parseInt(papyrusNum) - 1], indice.papyrus);
                runesDecouvertes.papyrusCollectes.push(indice.papyrus);
                vibrerSac(2);
                addOracleChatMessage('üìú Un nouveau papyrus ancien a √©t√© d√©couvert !');
                
                setTimeout(function() {
                    addOracleChatMessage('üí° Cliquez sur le papyrus dans l\'inventaire pour le d√©rouler.');
                }, 1500);
                
                console.log('%cüìú Papyrus ' + papyrusNum + ' d√©couvert !', 'color:#8b7355; font-weight:bold;');
            } else {
                // Chance de trouver un objet (30%)
                if (Math.random() < 0.3) {
                    var objets = [
                        { icone: 'üóùÔ∏è', nom: 'Cl√© Ancienne', id: 'cle_ancienne_' + Date.now() },
                        { icone: 'üíé', nom: 'Fragment de Cristal', id: 'cristal_' + Date.now() },
                        { icone: 'üîÆ', nom: 'Orbe Mineur', id: 'orbe_mineur_' + Date.now() }
                    ];
                    var objet = objets[Math.floor(Math.random() * objets.length)];
                    ajouterObjetQuete(objet.icone, objet.nom, objet.id);
                    vibrerSac(1);
                }
            }
        } else {
            addOracleChatMessage('üîç Rien de nouveau √† d√©couvrir ici pour le moment...');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RUNES 5-8 : LES VERROUS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function ouvrirPorte(runeId) {
        var porteNum = runeId - 3; // Porte 1-4 pour runes 5-8
        console.log('%cüö™ Tentative d\'ouverture - Porte ' + porteNum, 'color:#49cafa; font-weight:bold;');
        
        // V√©rifier si la porte est d√©j√† ouverte
        if (runesDecouvertes.portesOuvertes.indexOf(porteNum) !== -1) {
            addOracleChatMessage('üö™ Cette porte est d√©j√† ouverte.');
            return;
        }
        
        // Demander une cl√© sp√©cifique (la cl√© doit correspondre au num√©ro de porte)
        var cleRequise = porteNum;
        
        if (sacInventaire.indexOf(cleRequise) !== -1) {
            // Cl√© trouv√©e !
            runesDecouvertes.portesOuvertes.push(porteNum);
            
            showStyledAlert('üîì <strong>Porte ' + porteNum + ' D√©verrouill√©e</strong><br><br>La cl√© ' + cleRequise + ' ouvre le passage !<br><br><em style="color:#00ff88;">Un nouveau chemin s\'ouvre devant vous...</em>');
            
            // Retirer la cl√© du sac
            var index = sacInventaire.indexOf(cleRequise);
            retirerCleDuSac(index);
            
            // R√©compense
            arcaneKeys += 2;
            updateArcaneInventory();
            addOracleChatMessage('üéÅ R√©compense : +2 Cl√©s du Destin');
            
            // Vibration de succ√®s
            vibrerSac(3);
            
            console.log('%cüîì Porte ' + porteNum + ' ouverte avec succ√®s !', 'color:#00ff88; font-weight:bold;');
        } else {
            // Cl√© manquante
            showStyledAlert('üîí <strong>Porte Verrouill√©e</strong><br><br>Cette porte n√©cessite la <strong>Cl√© ' + cleRequise + '</strong><br><br><em style="color:#ff6b6b;">Explorez les Runes des Chercheurs pour trouver des cl√©s...</em>');
            
            addOracleChatMessage('üîí Porte ' + porteNum + ' : Cl√© ' + cleRequise + ' requise.');
            
            // Vibration de refus
            if (navigator.vibrate) {
                navigator.vibrate([100, 100, 100]);
            }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RUNES 9-10 : L'ATELIER DES PAPYRUS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function ouvrirAtelierPapyrus() {
        console.log('%cüìú Ouverture de l\'Atelier des Papyrus Anciens', 'color:#d4af37; font-weight:bold;');
        
        // Compter les papyrus collect√©s
        var nbPapyrus = runesDecouvertes.papyrusCollectes.length;
        
        if (nbPapyrus === 0) {
            showStyledAlert('üìú <strong>L\'Atelier des Papyrus</strong><br><br>Cet atelier permet d\'assembler les fragments de papyrus anciens d√©couverts dans le Sanctuaire.<br><br><em style="color:#49cafa;">Vous n\'avez encore trouv√© aucun fragment...</em><br><br><small style="color:#888;">üí° Explorez les Runes des Chercheurs pour d√©couvrir les papyrus cach√©s.</small>');
            addOracleChatMessage('üìú Atelier : Aucun papyrus √† assembler.');
            return;
        }
        
        // Afficher l'interface d'assemblage
        var message = 'üìú <strong>Atelier d\'Assemblage √âgyptien</strong><br><br>';
        message += '<div style="font-size:1.5em; margin: 15px 0;">ìÇÄ ìÜ£ ìÉ≠</div>';
        message += 'Papyrus anciens collect√©s : <strong>' + nbPapyrus + '</strong>/3<br><br>';
        
        if (nbPapyrus >= 3) {
            message += '<em style="color:#00ff88;">‚ú® Les trois fragments s\'assemblent dans une lumi√®re dor√©e !</em><br><br>';
            message += '<div style="font-size:1.3em; margin: 15px 0; color:#d4af37;">‚ö± ‚ö° ‚öñ</div>';
            message += 'üéÅ <strong>Message R√©v√©l√© :</strong><br><span style="font-size:1.1em; color:#8b4513; font-weight:bold;">"Le tr√©sor se cache l√† o√π le givre rencontre l\'or √©ternel"</span>';
            
            // R√©compense pour assemblage (√©viter les doublons)
            if (!sacObjetsQuete.find(function(obj) { return obj.id === 'livre_secrets'; })) {
                ajouterObjetQuete('üìñ', 'Livre des Secrets', 'livre_secrets');
                vibrerSac(3);
                addOracleChatMessage('üìñ Assemblage r√©ussi : Livre des Secrets obtenu !');
            }
        } else {
            message += '<em style="color:#ff6b6b;">Il vous faut les 3 fragments pour reconstituer le message complet...</em><br><br>';
            message += '<div style="margin: 10px 0;">‚è≥ Fragments manquants : <strong>' + (3 - nbPapyrus) + '</strong></div>';
            message += '<small style="color:#888;">üí° Continuez √† explorer avec les Runes des Chercheurs.</small>';
        }
        
        showStyledAlert(message);
        
        addOracleChatMessage('üìú Atelier ouvert : ' + nbPapyrus + '/3 papyrus disponibles.');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RUNE 11 : LA TAVERNE (Chat Social)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function ouvrirTaverne() {
        console.log('%cüç∫ Ouverture de la Taverne', 'color:#d4af37; font-weight:bold;');
        
        var chatPanel = document.getElementById('chat-temple');
        if (chatPanel) {
            chatPanel.style.display = 'block';
            chatPanel.style.position = 'fixed';
            chatPanel.style.top = '50%';
            chatPanel.style.left = '50%';
            chatPanel.style.transform = 'translate(-50%, -50%)';
            chatPanel.style.zIndex = '2000';
            chatPanel.style.maxWidth = '500px';
            chatPanel.style.width = '90vw';
            
            addOracleChatMessage('üç∫ Bienvenue √† la Taverne ! Partagez vos d√©couvertes avec les autres Initi√©s...');
            
            // Ajouter un bouton de fermeture
            if (!document.getElementById('btn-fermer-taverne')) {
                var btnFermer = document.createElement('button');
                btnFermer.id = 'btn-fermer-taverne';
                btnFermer.className = 'btn-connect';
                btnFermer.textContent = '‚úï Fermer';
                btnFermer.style.marginTop = '10px';
                btnFermer.style.width = '100%';
                btnFermer.onclick = function() {
                    chatPanel.style.display = 'none';
                    chatPanel.style.position = '';
                    chatPanel.style.transform = '';
                    chatPanel.style.zIndex = '';
                };
                chatPanel.appendChild(btnFermer);
            }
        } else {
            showStyledAlert('üç∫ <strong>La Taverne</strong><br><br>Un lieu de rencontre pour les Initi√©s.<br><br><em>Le chat sera bient√¥t disponible...</em>');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RUNE 12 : L'≈íIL DE L'ORACLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function afficherOeilOracle() {
        console.log('%cüëÅÔ∏è L\'≈íil de l\'Oracle s\'ouvre', 'color:#d4af37; font-weight:bold;');
        
        // R√©cup√©rer la temp√©rature actuelle
        var tempActuelle = oracleTemperature !== null ? oracleTemperature + '¬∞C' : 'En chargement...';
        
        var message = 'üëÅÔ∏è <strong>L\'≈íil de l\'Oracle</strong><br><br>';
        message += 'üå°Ô∏è <strong>Temp√©rature √† Montr√©al :</strong> ' + tempActuelle + '<br>';
        message += '‚ùÑÔ∏è <strong>Seuil d\'activation :</strong> ‚â§ -2¬∞C<br><br>';
        
        // Calculer le jackpot potentiel (exemple)
        var jackpotBase = 1000;
        var portesOuvertes = runesDecouvertes.portesOuvertes.length;
        var papyrusCollectes = runesDecouvertes.papyrusCollectes.length;
        var jackpot = jackpotBase + (portesOuvertes * 250) + (papyrusCollectes * 100);
        
        message += 'üí∞ <strong>Jackpot Actuel :</strong><br>';
        message += '<span style="font-size:1.5em; color:#d4af37;">' + jackpot + ' ARCANA</span><br><br>';
        
        message += 'üìä <strong>Progression :</strong><br>';
        message += 'üö™ Portes ouvertes : ' + portesOuvertes + '/4<br>';
        message += 'üìú Papyrus collect√©s : ' + papyrusCollectes + '<br>';
        message += 'üîç Indices trouv√©s : ' + runesDecouvertes.indicesTrouves.length + '<br>';
        
        showStyledAlert(message);
        
        addOracleChatMessage('üëÅÔ∏è L\'Oracle r√©v√®le l\'√©tat du Sanctuaire...');
        
        // Vibration mystique
        vibrerSac(2);
    }

    function vibratePanel(panel){
        panel.style.animation = 'border-shake 0.22s linear 2';
        panel.style.boxShadow = "0 0 28px #ff2424,0 0 9px #ffe7e5 inset";
        setTimeout(()=>{
            panel.style.animation = '';
            panel.style.boxShadow = "";
        }, 410);
    }
    function makeGoldRainParticles() {
        const container = document.querySelector('#victory-jackpot .gold-rain');
        if (!container) return;
        container.innerHTML = '';
        const GoldN = 35+Math.floor(Math.random()*8);
        for(let i=0;i<GoldN;++i){
            let span = document.createElement('span');
            span.className = 'gold-drop';
            span.style.left = (5+Math.random()*90)+'vw';
            span.style.top = (-10-Math.random()*40)+'px';
            let delay = Math.random()*1.25;
            span.style.animationDelay = delay + 's';
            span.style.opacity = 0.8 + Math.random()*0.2;
            span.style.width = (7+Math.random()*5)+'px';
            span.style.height = (21+Math.random()*18)+'px';
            span.style.transform += " rotate("+(Math.random()*12-6)+"deg)";
            container.appendChild(span);
        }
        setTimeout(()=>{container.innerHTML='';}, 4300);
    }
    document.addEventListener('DOMContentLoaded', ()=>{
        document.getElementById('heartbeat-audio').play().then(()=>{document.getElementById('heartbeat-audio').pause();}).catch(()=>{});
    });
    function stopHeartbeat(){
        if(window.arcanaHeartbeatTimer) clearTimeout(window.arcanaHeartbeatTimer);
        window.arcanaHeartbeatTimer = null;
        let a = document.getElementById('heartbeat-audio');
        if(a && !a.paused){ a.pause(); a.currentTime=0;}
    }


    async function updateOracleFromAdmin() {
        try {
            // 1. On r√©cup√®re la temp√©rature r√©elle de Montr√©al via une API
            const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=45.5088&longitude=-73.5878&current_weather=true');
            const data = await response.json();
            const temp = Math.round(data.current_weather.temperature);
            
            alert("Oracle : Temp√©rature d√©tect√©e √† Montr√©al : " + temp + "¬∞C");

            // 2. On envoie cette temp√©rature √† ton contrat Arcana Game
            if (!signer) await connectWallet();
            const contract = new ethers.Contract(ARCANA_GAME_CONTRACT, ["function updateOracle(int256 _temp) external"], signer);

            const tx = await contract.updateOracle(temp);
            document.getElementById('admin-log').innerHTML += `<p>‚è≥ Oracle : Envoi blockchain (${temp}¬∞C)...</p>`;
            
            await tx.wait();
            alert("L'Oracle est synchronis√© ! La temp√©rature est scell√©e dans Polygon.");
            document.getElementById('admin-log').innerHTML += `<p>‚úÖ Oracle √† jour : ${temp}¬∞C</p>`;
            
            // MAJ miroir de glace imm√©diatement
            fetchAndDisplayTemperature();
            
        } catch (error) {
            console.error("Erreur Oracle:", error);
            alert("Erreur de synchronisation : " + error.message);
        }
    }

    // === SCRIPT DE S√âCURIT√â : D√âSACTIV√â - Les runes s'affichent imm√©diatement ===
    // Tout le code de v√©rification Web3 est maintenant dans checkSecurity() qui se lance apr√®s le chargement
    console.log('%c‚úÖ Mode Affichage Imm√©diat : Les runes sont visibles sans v√©rification pr√©alable', 'color:#00ff88; font-weight:bold;');

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SAC √Ä DOS INVENTAIRE - Gestion des Cl√©s et Objets
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var sacInventaire = [];
    var sacObjetsQuete = [];
    var sacAlerteTimeout = null;
    var sacIsOpen = false;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INTERACTION INVENTAIRE ‚Üî SANCTUAIRE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 
    // Quand l'inventaire s'ouvre :
    // 1. Le drawer monte depuis le bas de l'√©cran (transition 0.5s)
    // 2. Le sanctuaire se d√©place vers le haut (-20%) et se r√©duit (85%)
    // 3. L'overlay s'affiche avec transparence (40%) pour voir le sanctuaire
    // 4. Les runes restent CLIQUABLES gr√¢ce au z-index √©lev√©
    // 5. Le fond du drawer est semi-transparent (85-95%) avec blur
    // 
    // Quand l'inventaire se ferme :
    // 1. Le drawer redescend (transition fluide)
    // 2. Le sanctuaire reprend sa position centrale (transition 0.6s)
    // 3. L'overlay dispara√Æt en fondu
    // 4. Toutes les animations sont coordonn√©es pour un effet harmonieux
    // 
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function toggleSacInventaire() {
        if (sacIsOpen) {
            fermerSacInventaire();
        } else {
            ouvrirSacInventaire();
        }
    }

    function ouvrirSacInventaire() {
        var drawer = document.getElementById('sac-inventaire');
        var overlay = document.getElementById('sac-overlay');
        var sanctuaire = document.getElementById('level-3-sanctuary');
        
        drawer.classList.add('open');
        overlay.classList.add('active');
        sacIsOpen = true;
        
        // D√©placer le sanctuaire vers le haut avec animation fluide
        if (sanctuaire) {
            sanctuaire.classList.add('sac-ouvert');
            
            // Petit effet de pulse pour indiquer que c'est toujours interactif
            sanctuaire.style.animation = 'none';
            setTimeout(function() {
                sanctuaire.style.animation = '';
            }, 50);
            
            // Message subtil la premi√®re fois (localStorage)
            if (!localStorage.getItem('arcana_sac_hint_shown')) {
                setTimeout(function() {
                    addOracleChatMessage('üí° Les runes du Sanctuaire restent cliquables m√™me quand l\'inventaire est ouvert.');
                    localStorage.setItem('arcana_sac_hint_shown', 'true');
                }, 800);
            }
        }
        
        // Emp√™cher le scroll du body
        document.body.style.overflow = 'hidden';
        
        console.log('%cüì¶ Inventaire ouvert - Sanctuaire repositionn√© (reste cliquable)', 'color:#d4af37; font-weight:bold;');
    }

    function fermerSacInventaire() {
        var drawer = document.getElementById('sac-inventaire');
        var overlay = document.getElementById('sac-overlay');
        var sanctuaire = document.getElementById('level-3-sanctuary');
        
        drawer.classList.remove('open');
        overlay.classList.remove('active');
        sacIsOpen = false;
        
        // Restaurer la position du sanctuaire
        if (sanctuaire) {
            sanctuaire.classList.remove('sac-ouvert');
        }
        
        // R√©activer le scroll du body
        document.body.style.overflow = 'auto';
        
        console.log('%cüì¶ Inventaire ferm√© - Sanctuaire restaur√©', 'color:#888;');
    }

    function updateSacBadge() {
        var badge = document.getElementById('btn-sacoche-badge');
        var total = sacInventaire.length;
        if (badge) {
            badge.textContent = total;
            badge.style.display = total > 0 ? 'flex' : 'none';
        }
    }

    function ajouterCleDansSac(numero) {
        var slots = document.querySelectorAll('.sac-slot');
        var alerte = document.getElementById('sac-alerte-surcharge');
        
        // V√©rifier si le sac est plein (10 cl√©s maximum)
        if (sacInventaire.length >= 10) {
            // Afficher l'alerte de surcharge
            alerte.classList.add('active');
            
            // Faire vibrer le sac
            var sacContainer = document.getElementById('sac-inventaire');
            sacContainer.style.animation = 'border-shake 0.3s linear 2';
            
            // Log pour debug
            console.log('%c‚ö†Ô∏è SAC PLEIN : Impossible d\'ajouter la cl√© ' + numero, 'color:#ff4444; font-weight:bold;');
            
            // Masquer l'alerte apr√®s 3 secondes
            if (sacAlerteTimeout) clearTimeout(sacAlerteTimeout);
            sacAlerteTimeout = setTimeout(function() {
                alerte.classList.remove('active');
                sacContainer.style.animation = '';
            }, 3000);
            
            return false;
        }
        
        // Ajouter la cl√© dans le premier slot vide
        sacInventaire.push(numero);
        var slotIndex = sacInventaire.length - 1;
        var slot = slots[slotIndex];
        
        if (slot) {
            slot.textContent = numero;
            slot.classList.add('filled');
            
            // Animation d'ajout
            slot.style.transform = 'scale(1.2)';
            slot.style.boxShadow = '0 0 20px rgba(212, 175, 55, 0.8)';
            setTimeout(function() {
                slot.style.transform = '';
                slot.style.boxShadow = '';
            }, 300);
            
            // Log de confirmation
            console.log('%cüóùÔ∏è Cl√© ' + numero + ' ajout√©e au sac (slot ' + (slotIndex + 1) + '/10)', 'color:#d4af37; font-weight:bold;');
            
            // Message dans le chat Oracle
            addOracleChatMessage('Cl√© ' + numero + ' rang√©e dans le sac (' + sacInventaire.length + '/10)');
            
            // Mettre √† jour le badge
            updateSacBadge();
        }
        
        return true;
    }

    function retirerCleDuSac(slotIndex) {
        var slots = document.querySelectorAll('.sac-slot');
        
        if (slotIndex < 0 || slotIndex >= sacInventaire.length) {
            console.warn('Slot invalide:', slotIndex);
            return null;
        }
        
        var cleRetiree = sacInventaire[slotIndex];
        sacInventaire.splice(slotIndex, 1);
        
        // R√©organiser l'affichage
        slots.forEach(function(slot, idx) {
            if (idx < sacInventaire.length) {
                slot.textContent = sacInventaire[idx];
                slot.classList.add('filled');
            } else {
                slot.textContent = '';
                slot.classList.remove('filled');
            }
        });
        
        console.log('%cüóùÔ∏è Cl√© ' + cleRetiree + ' retir√©e du sac', 'color:#888; font-weight:bold;');
        addOracleChatMessage('Cl√© ' + cleRetiree + ' utilis√©e (' + sacInventaire.length + '/10 restantes)');
        
        // Mettre √† jour le badge
        updateSacBadge();
        
        return cleRetiree;
    }

    function viderSac() {
        sacInventaire = [];
        var slots = document.querySelectorAll('.sac-slot');
        slots.forEach(function(slot) {
            slot.textContent = '';
            slot.classList.remove('filled');
        });
        updateSacBadge();
        console.log('%cüóùÔ∏è Sac vid√©', 'color:#888;');
    }

    function obtenirNombreClesDansSac() {
        return sacInventaire.length;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // OBJETS DE QU√äTE - Gestion
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function ajouterObjetQuete(icone, nom, id) {
        // V√©rifier si l'objet existe d√©j√†
        if (sacObjetsQuete.find(function(obj) { return obj.id === id; })) {
            console.warn('Objet de qu√™te d√©j√† pr√©sent:', nom);
            return false;
        }
        
        var objet = {
            id: id || 'objet_' + Date.now(),
            icone: icone,
            nom: nom
        };
        
        sacObjetsQuete.push(objet);
        afficherObjetsQuete();
        updateSacBadge();
        
        console.log('%c‚ú® Objet de qu√™te ajout√©:', 'color:#49cafa; font-weight:bold;', nom);
        addOracleChatMessage('Objet de qu√™te obtenu : ' + nom);
        
        return true;
    }

    function retirerObjetQuete(id) {
        var index = sacObjetsQuete.findIndex(function(obj) { return obj.id === id; });
        if (index === -1) return null;
        
        var objet = sacObjetsQuete[index];
        sacObjetsQuete.splice(index, 1);
        afficherObjetsQuete();
        updateSacBadge();
        
        console.log('%c‚ú® Objet de qu√™te retir√©:', 'color:#888;', objet.nom);
        addOracleChatMessage('Objet de qu√™te utilis√© : ' + objet.nom);
        
        return objet;
    }

    function afficherObjetsQuete() {
        var container = document.getElementById('sac-objets-quete');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (sacObjetsQuete.length === 0) {
            var vide = document.createElement('div');
            vide.id = 'sac-objets-quete-vide';
            vide.textContent = 'Aucun objet de qu√™te';
            container.appendChild(vide);
            return;
        }
        
        sacObjetsQuete.forEach(function(objet) {
            var div = document.createElement('div');
            div.className = 'objet-quete';
            div.dataset.id = objet.id;
            
            // Ajouter classe sp√©ciale pour les papyrus anciens
            if (objet.id && objet.id.startsWith('papyrus_ancien_')) {
                div.classList.add('papyrus-ancien');
            }
            
            div.innerHTML = objet.icone + '<span class="objet-quete-nom">' + objet.nom + '</span>';
            
            // Action au clic selon le type d'objet
            div.onclick = function() {
                console.log('Objet de qu√™te cliqu√©:', objet.nom);
                
                // Si c'est un papyrus ancien, afficher la modal de d√©roulement
                if (objet.id && objet.id.startsWith('papyrus_ancien_')) {
                    ouvrirPapyrus(objet.id, objet.nom);
                } else {
                    // Pour les autres objets, afficher une info simple
                    showStyledAlert('‚ú® <strong>' + objet.nom + '</strong><br><br>Un objet myst√©rieux de votre qu√™te.<br><br><em style="color:#49cafa;">Gardez-le pr√©cieusement...</em>');
                }
            };
            
            container.appendChild(div);
        });
    }

    function viderObjetsQuete() {
        sacObjetsQuete = [];
        afficherObjetsQuete();
        updateSacBadge();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // R√âSONANCE MAGIQUE - Effets Visuels et Haptiques
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 
    // GUIDE D'UTILISATION RAPIDE :
    // 
    // 1. Vibrer le bouton sacoche uniquement :
    //    vibrerSac(intensite);  // intensite: 1=doux, 2=moyen, 3=fort
    // 
    // 2. Activer la r√©sonance d'un objet dans l'inventaire :
    //    activerResonanceObjet(objetId, 'quete');  // ou 'cle' pour une cl√©
    // 
    // 3. D√©clencher une r√©sonance compl√®te (bouton + objet + vibration) :
    //    declencherResonanceMagique(objetId, 'quete', intensite);
    // 
    // 4. V√©rifier si le joueur a l'objet requis et d√©clencher la r√©sonance :
    //    verifierResonanceZone('nom_zone', 'id_objet_requis');
    // 
    // 5. Arr√™ter toute r√©sonance :
    //    arreterResonanceMagique();
    // 
    // EXEMPLE D'INT√âGRATION AVEC UNE PORTE :
    // 
    //    function onRuneClick(runeId) {
    //        // V√©rifier si le joueur s'approche de la bonne rune
    //        if (runeId === SANCTUARY_SEQUENCE[sanctuaryProgress]) {
    //            // D√©clencher une r√©sonance si une cl√© sp√©ciale est dans l'inventaire
    //            if (sacInventaire.indexOf(7) !== -1) {
    //                declencherResonanceMagique(7, 'cle', 2);
    //            }
    //        }
    //    }
    // 
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var sacResonanceActive = false;
    var sacResonanceObjetActif = null;

    function vibrerSac(intensite) {
        intensite = intensite || 1; // Intensit√© par d√©faut : 1
        var btnSacoche = document.getElementById('btn-sacoche');
        
        // Ajouter la classe de r√©sonance
        btnSacoche.classList.add('resonance');
        
        // Vibration haptique si support√©e
        if (navigator.vibrate) {
            // Pattern de vibration selon l'intensit√©
            var pattern;
            switch(Math.floor(intensite)) {
                case 1:
                    pattern = [100, 50, 100]; // Doux
                    break;
                case 2:
                    pattern = [150, 50, 150, 50, 150]; // Moyen
                    break;
                case 3:
                    pattern = [200, 50, 200, 50, 200, 50, 200]; // Fort
                    break;
                default:
                    pattern = [100, 50, 100];
            }
            navigator.vibrate(pattern);
            console.log('%cüì≥ Vibration haptique d√©clench√©e (intensit√©: ' + intensite + ')', 'color:#d4af37;');
        } else {
            console.log('%cüì≥ Vibration haptique non support√©e sur cet appareil', 'color:#888;');
        }
        
        sacResonanceActive = true;
        
        console.log('%c‚ú® R√©sonance magique activ√©e (intensit√©: ' + intensite + ')', 'color:#d4af37; font-weight:bold;');
    }

    function arreterVibrationSac() {
        var btnSacoche = document.getElementById('btn-sacoche');
        btnSacoche.classList.remove('resonance');
        
        // Arr√™ter la vibration haptique
        if (navigator.vibrate) {
            navigator.vibrate(0);
        }
        
        sacResonanceActive = false;
        
        console.log('%c‚ú® R√©sonance magique d√©sactiv√©e', 'color:#888;');
    }

    function activerResonanceObjet(objetId, typeObjet) {
        // typeObjet: 'cle' ou 'quete'
        typeObjet = typeObjet || 'quete';
        
        // Retirer l'ancienne r√©sonance
        if (sacResonanceObjetActif) {
            desactiverResonanceObjet();
        }
        
        var element;
        if (typeObjet === 'cle') {
            // Trouver le slot de cl√©
            var slots = document.querySelectorAll('.sac-slot');
            var index = sacInventaire.indexOf(objetId);
            if (index !== -1 && slots[index]) {
                element = slots[index];
            }
        } else {
            // Trouver l'objet de qu√™te
            element = document.querySelector('.objet-quete[data-id="' + objetId + '"]');
        }
        
        if (element) {
            element.classList.add('objet-actif');
            sacResonanceObjetActif = { id: objetId, type: typeObjet, element: element };
            
            console.log('%c‚ú® Objet en r√©sonance:', 'color:#d4af37; font-weight:bold;', objetId);
            return true;
        }
        
        return false;
    }

    function desactiverResonanceObjet() {
        if (sacResonanceObjetActif && sacResonanceObjetActif.element) {
            sacResonanceObjetActif.element.classList.remove('objet-actif');
            console.log('%c‚ú® R√©sonance d\'objet d√©sactiv√©e:', 'color:#888;', sacResonanceObjetActif.id);
            sacResonanceObjetActif = null;
        }
    }

    function declencherResonanceMagique(objetId, typeObjet, intensite) {
        // Fonction principale pour activer la r√©sonance compl√®te
        intensite = intensite || 1;
        
        // Vibrer le bouton sacoche
        vibrerSac(intensite);
        
        // Activer la r√©sonance de l'objet dans l'inventaire
        var objetTrouve = activerResonanceObjet(objetId, typeObjet);
        
        if (objetTrouve) {
            // Message dans le chat Oracle
            addOracleChatMessage('‚ú® R√©sonance magique d√©tect√©e ! Un objet de votre inventaire r√©agit √† la zone...');
            
            // Auto-d√©sactiver apr√®s 5 secondes
            setTimeout(function() {
                arreterResonanceMagique();
            }, 5000);
            
            return true;
        }
        
        return false;
    }

    function arreterResonanceMagique() {
        arreterVibrationSac();
        desactiverResonanceObjet();
    }

    function verifierResonanceZone(zoneId, objetRequis) {
        // V√©rifier si le joueur poss√®de l'objet requis
        var objetPresent = false;
        var typeObjet = 'quete';
        
        // V√©rifier dans les objets de qu√™te
        var objet = sacObjetsQuete.find(function(obj) { return obj.id === objetRequis; });
        if (objet) {
            objetPresent = true;
            typeObjet = 'quete';
        } else {
            // V√©rifier dans les cl√©s
            var index = sacInventaire.indexOf(objetRequis);
            if (index !== -1) {
                objetPresent = true;
                typeObjet = 'cle';
            }
        }
        
        if (objetPresent) {
            console.log('%cüåü Zone ' + zoneId + ' : Objet requis d√©tect√© (' + objetRequis + ')', 'color:#d4af37; font-weight:bold;');
            declencherResonanceMagique(objetRequis, typeObjet, 2);
            return true;
        } else {
            console.log('%cüîí Zone ' + zoneId + ' : Objet requis manquant (' + objetRequis + ')', 'color:#888;');
            return false;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PAPYRUS ANCIEN - Syst√®me de D√©roulement
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var papyrusTextes = {
        'papyrus_ancien_1': {
            titre: 'Papyrus Ancien I - Le Fragment du Givre',
            hieroglyphes: 'ìÇÄ ìÜ£ ìÉ≠ ìÖì',
            texte: 'Sous la pierre froide, l√† o√π le givre se d√©pose en silence, repose le premier secret des Gardiens de l\'Ancien Temps. Celui qui lit ces mots a franchi le premier seuil.',
            indice: '¬´ –ü–µ—Ä–≤—ã–π —à–∞–≥ –∑–∞–º–µ—Ä–∑ –≤ —Å–Ω–µ–≥—É ¬ª',
            messageRusse: '–ü–µ—Ä–≤—ã–π —à–∞–≥ –∑–∞–º–µ—Ä–∑ –≤ —Å–Ω–µ–≥—É'
        },
        'papyrus_ancien_2': {
            titre: 'Papyrus Ancien II - Le Fragment des Ombres',
            hieroglyphes: 'ìäñ ìã¥ ìå™ ìçØ',
            texte: 'Dans les profondeurs o√π l\'obscurit√© r√®gne et o√π les miroirs refl√®tent plus que la lumi√®re, le deuxi√®me fragment attend. Les √©toiles du Sanctuaire tracent un chemin invisible aux yeux des mortels ordinaires. Seuls ceux qui ont allum√© les flammes sacr√©es pourront d√©chiffrer ce message √©crit dans l\'encre du temps.',
            indice: '¬´ Fragment II : ...SE CACHE... ¬ª'
        },
        'papyrus_ancien_3': {
            titre: 'Papyrus Ancien III - Le Fragment de l\'Aurore',
            hieroglyphes: 'ìé° ìèè ìêç',
            texte: 'Le dernier fragment repose √† la crois√©e des mondes, l√† o√π le givre √©ternel rencontre l\'or qui ne ternit jamais. Trois fragments r√©unis forment la Cl√© Supr√™me. Le tr√©sor n\'est pas un objet mat√©riel, mais la Connaissance Pure des Anciens. Celui qui d√©voile ce secret devient Gardien √† son tour, protecteur du Sanctuaire pour les g√©n√©rations futures.',
            indice: '¬´ Fragment III : ...L√Ä O√ô LE GIVRE RENCONTRE L\'OR √âTERNEL ¬ª'
        }
    };

    function ouvrirPapyrus(papyrusId, papyrusNom) {
        var modal = document.getElementById('papyrus-modal');
        var titre = document.getElementById('papyrus-titre');
        var texte = document.getElementById('papyrus-texte');
        var indice = document.getElementById('papyrus-indice');
        var hieroglyphes = document.querySelectorAll('.papyrus-hieroglyph');
        
        // R√©cup√©rer les donn√©es du papyrus
        var data = papyrusTextes[papyrusId] || {
            titre: papyrusNom || 'Papyrus Ancien',
            hieroglyphes: 'ìÇÄ ìÜ£ ìÉ≠',
            texte: 'Un texte ancien √©crit dans une langue oubli√©e...',
            indice: '¬´ Les secrets se r√©v√®lent aux patients ¬ª'
        };
        
        // Remplir le contenu
        if (titre) titre.textContent = data.titre;
        if (texte) texte.textContent = data.texte;
        
        // Si un message russe est pr√©sent, l'afficher avec un style sp√©cial
        if (data.messageRusse && indice) {
            indice.innerHTML = '<div class="papyrus-text-russe">' + data.messageRusse + '</div>';
            indice.style.textAlign = 'center';
        } else if (indice) {
            indice.textContent = data.indice;
        }
        
        if (hieroglyphes[0]) hieroglyphes[0].textContent = data.hieroglyphes;
        
        // Afficher la modal avec animation
        modal.classList.add('active');
        
        // Son de d√©roulement (optionnel)
        if (navigator.vibrate) {
            navigator.vibrate([50, 30, 50, 30, 100]);
        }
        
        // R√©initialiser l'animation
        var scroll = modal.querySelector('.papyrus-scroll');
        if (scroll) {
            scroll.style.animation = 'none';
            scroll.offsetHeight; // Force reflow
            scroll.style.animation = 'papyrus-unroll 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
        }
        
        console.log('%cüìú Papyrus d√©roul√©:', 'color:#8b7355; font-weight:bold;', data.titre);
        addOracleChatMessage('üìú Vous lisez le ' + data.titre + '...');
    }

    function fermerPapyrus() {
        var modal = document.getElementById('papyrus-modal');
        var scroll = modal.querySelector('.papyrus-scroll');
        
        // Animation de fermeture (enroulement)
        if (scroll) {
            scroll.style.animation = 'papyrus-roll-up 0.6s cubic-bezier(0.6, -0.28, 0.74, 0.05) forwards';
        }
        
        // Masquer la modal apr√®s l'animation
        setTimeout(function() {
            modal.classList.remove('active');
        }, 600);
        
        console.log('%cüìú Papyrus enroul√©', 'color:#888;');
    }

    function fermerPapyrusOverlay(event) {
        // Fermer uniquement si on clique sur l'overlay, pas sur le papyrus
        if (event.target.id === 'papyrus-modal') {
            fermerPapyrus();
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONTR√îLES CLAVIER - Fermer l'inventaire avec √âchap
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (sacIsOpen) {
                fermerSacInventaire();
            }
            // Fermer aussi le papyrus si ouvert
            var papyrusModal = document.getElementById('papyrus-modal');
            if (papyrusModal && papyrusModal.classList.contains('active')) {
                fermerPapyrus();
            }
        }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FONCTIONS DE TEST - Console
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 
    // GUIDE DE TEST DANS LA CONSOLE :
    // 
    // testQueteRune1()             - Test de la premi√®re qu√™te (Rune n¬∞1) (NEW!)
    // testSac()                    - Test complet du sac (cl√©s + objets + alerte surcharge)
    // testObjetsQuete()            - Test des objets de qu√™te uniquement
    // testPapyrus()                - Test papyrus anciens avec d√©roulement
    // testResonance()              - Test des effets de r√©sonance magique
    // testZoneInteractive()        - Test de d√©tection de zone avec objet requis
    // testInteractionSanctuaire()  - Test interaction inventaire ‚Üî sanctuaire
    // testRunesSysteme()           - Test syst√®me des 12 runes
    // testScenarioComplet()        - Sc√©nario complet de qu√™te avec r√©sonances
    // 
    // FONCTIONS RAPIDES :
    // 
    // resonner('cristal_1', 'quete', 2)  - D√©clencher r√©sonance rapide
    // vibrerSac(3)                        - Vibrer le bouton (intensit√© 1-3)
    // ouvrirSacInventaire()              - Ouvrir le drawer
    // fermerSacInventaire()              - Fermer le drawer
    // toggleSacInventaire()              - Ouvrir/fermer le drawer
    // 
    // FONCTIONS RUNES :
    // 
    // fouillerZone(0)                    - Fouiller avec rune 1 (√©nigme)
    // ouvrirPorte(4)                     - Tenter d'ouvrir porte 1
    // ouvrirAtelierPapyrus()             - Ouvrir l'atelier
    // ouvrirTaverne()                    - Ouvrir le chat
    // afficherOeilOracle()               - Afficher m√©t√©o + jackpot
    // 
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.testSac = function() {
        console.log('%c=== TEST DU SAC √Ä DOS ===', 'color:#d4af37; font-size:1.2em; font-weight:bold;');
        viderSac();
        viderObjetsQuete();
        ouvrirSacInventaire();
        
        // Test ajout de cl√©s
        for (var i = 1; i <= 12; i++) {
            setTimeout(function(num) {
                return function() {
                    ajouterCleDansSac(num);
                };
            }(i), i * 400);
        }
        
        // Test ajout d'objets de qu√™te
        setTimeout(function() {
            ajouterObjetQuete('üìú', 'Parchemin Ancien', 'parchemin_1');
        }, 5000);
        setTimeout(function() {
            ajouterObjetQuete('üíé', 'Cristal de Givre', 'cristal_1');
        }, 5500);
        setTimeout(function() {
            ajouterObjetQuete('üîÆ', 'Orbe Mystique', 'orbe_1');
        }, 6000);
    };

    window.testObjetsQuete = function() {
        console.log('%c=== TEST OBJETS DE QU√äTE ===', 'color:#49cafa; font-size:1.2em; font-weight:bold;');
        ouvrirSacInventaire();
        ajouterObjetQuete('üìú', 'Papyrus Ancien I', 'papyrus_ancien_1');
        ajouterObjetQuete('üìú', 'Papyrus Ancien II', 'papyrus_ancien_2');
        ajouterObjetQuete('üíé', 'Cristal de Givre', 'cristal_1');
        ajouterObjetQuete('üîÆ', 'Orbe Mystique', 'orbe_1');
        ajouterObjetQuete('‚öóÔ∏è', 'Fiole Magique', 'fiole_1');
        ajouterObjetQuete('üó°Ô∏è', 'Lame Enchant√©e', 'lame_1');
    };

    window.testPapyrus = function() {
        console.log('%c=== TEST PAPYRUS ANCIEN ===', 'color:#8b7355; font-size:1.3em; font-weight:bold;');
        
        // Ajouter des papyrus de test
        viderSac();
        viderObjetsQuete();
        ajouterObjetQuete('üìú', 'Papyrus Ancien I', 'papyrus_ancien_1');
        ajouterObjetQuete('üìú', 'Papyrus Ancien II', 'papyrus_ancien_2');
        ajouterObjetQuete('üìú', 'Papyrus Ancien III', 'papyrus_ancien_3');
        
        // Ouvrir l'inventaire
        ouvrirSacInventaire();
        
        console.log('%cüìú 3 Papyrus ajout√©s √† l\'inventaire', 'color:#8b7355;');
        console.log('%cüí° Cliquez sur un papyrus dans l\'inventaire pour le d√©rouler !', 'color:#d4af37; font-weight:bold;');
        console.log('%c   ‚Üí Animation de d√©roulement 3D fluide', 'color:#888;');
        console.log('%c   ‚Üí Texte en encre ancienne avec hi√©roglyphes', 'color:#888;');
        console.log('%c   ‚Üí Vibration haptique au d√©roulement', 'color:#888;');
        console.log('%c   ‚Üí Fermer avec √âchap ou le bouton "ROULER"', 'color:#888;');
        
        // Auto-ouvrir le premier papyrus apr√®s 2 secondes
        setTimeout(function() {
            console.log('%c\nüìú Ouverture automatique du Papyrus I...', 'color:#8b7355; font-weight:bold;');
            ouvrirPapyrus('papyrus_ancien_1', 'Papyrus Ancien I');
        }, 2000);
    };

    window.testQueteRune1 = function() {
        console.log('%c=== TEST QU√äTE RUNE N¬∞1 ===', 'color:#00ff88; font-size:1.3em; font-weight:bold;');
        
        // R√©initialiser l'√©tat de la qu√™te
        runesDecouvertes.rune1PremierClic = false;
        viderSac();
        viderObjetsQuete();
        
        // Activer le clignotement de la Rune n¬∞1
        initialiserQueteRune1();
        
        console.log('%c‚ú® La Rune n¬∞1 clignote doucement en dor√©', 'color:#d4af37;');
        console.log('%cüí° Cliquez sur la premi√®re rune (‚èÄ) pour d√©couvrir le papyrus !', 'color:#49cafa; font-weight:bold;');
        console.log('%c   ‚Üí Vibration de 200ms sur mobile', 'color:#888;');
        console.log('%c   ‚Üí Animation de d√©roulement automatique', 'color:#888;');
        console.log('%c   ‚Üí Texte russe : "–ü–µ—Ä–≤—ã–π —à–∞–≥ –∑–∞–º–µ—Ä–∑ –≤ —Å–Ω–µ–≥—É"', 'color:#888;');
        console.log('%c   ‚Üí Papyrus ajout√© dans le sac automatiquement', 'color:#888;');
    };

    window.testResonance = function() {
        console.log('%c=== TEST R√âSONANCE MAGIQUE ===', 'color:#d4af37; font-size:1.2em; font-weight:bold;');
        
        // Ajouter des objets de test
        viderSac();
        viderObjetsQuete();
        ajouterCleDansSac(42);
        ajouterObjetQuete('üíé', 'Cristal de Givre', 'cristal_1');
        ajouterObjetQuete('üîÆ', 'Orbe Mystique', 'orbe_1');
        ajouterObjetQuete('üìú', 'Parchemin Ancien', 'parchemin_1');
        
        // Ouvrir l'inventaire
        ouvrirSacInventaire();
        
        // Test 1 : Vibration simple du bouton
        console.log('%cTest 1: Vibration simple du bouton', 'color:#49cafa;');
        setTimeout(function() {
            vibrerSac(1);
        }, 1000);
        
        // Test 2 : R√©sonance d'un objet de qu√™te
        console.log('%cTest 2: R√©sonance objet de qu√™te (Cristal)', 'color:#49cafa;');
        setTimeout(function() {
            arreterVibrationSac();
            declencherResonanceMagique('cristal_1', 'quete', 2);
        }, 3000);
        
        // Test 3 : Changement d'objet actif
        console.log('%cTest 3: Changement vers Orbe Mystique', 'color:#49cafa;');
        setTimeout(function() {
            arreterResonanceMagique();
            declencherResonanceMagique('orbe_1', 'quete', 1);
        }, 8000);
        
        // Test 4 : R√©sonance d'une cl√©
        console.log('%cTest 4: R√©sonance cl√© num√©ro 42', 'color:#49cafa;');
        setTimeout(function() {
            arreterResonanceMagique();
            declencherResonanceMagique(42, 'cle', 3);
        }, 13000);
        
        // Test 5 : Arr√™t complet
        setTimeout(function() {
            arreterResonanceMagique();
            console.log('%c‚úÖ Test de r√©sonance termin√©', 'color:#00ff88; font-weight:bold;');
        }, 18000);
    };

    window.testZoneInteractive = function() {
        console.log('%c=== TEST ZONE INTERACTIVE ===', 'color:#d4af37; font-size:1.2em; font-weight:bold;');
        
        // Pr√©parer l'inventaire
        viderSac();
        viderObjetsQuete();
        ajouterObjetQuete('üîÆ', 'Orbe Mystique', 'orbe_mystique');
        ajouterObjetQuete('üíé', 'Cristal de Givre', 'cristal_givre');
        ajouterCleDansSac(7);
        
        ouvrirSacInventaire();
        
        // Simuler l'approche d'une zone qui requiert l'Orbe
        console.log('%cüö™ Approche de la Porte du Myst√®re...', 'color:#49cafa;');
        setTimeout(function() {
            var result = verifierResonanceZone('porte_mystere', 'orbe_mystique');
            if (result) {
                console.log('%c‚úÖ La porte reconna√Æt votre objet !', 'color:#00ff88;');
            }
        }, 1500);
        
        // Arr√™t apr√®s 6 secondes
        setTimeout(function() {
            arreterResonanceMagique();
            console.log('%c‚úÖ Test de zone termin√©', 'color:#00ff88; font-weight:bold;');
        }, 7500);
    };

    window.testRunesSysteme = function() {
        console.log('%c=== TEST SYST√àME DES 12 RUNES ===', 'color:#d4af37; font-size:1.3em; font-weight:bold; text-shadow: 0 0 10px rgba(212,175,55,0.5);');
        
        // Pr√©parer le terrain
        viderSac();
        viderObjetsQuete();
        runesDecouvertes = {
            rune1PremierClic: false,
            indicesTrouves: [],
            papyrusCollectes: [],
            portesOuvertes: []
        };
        
        console.log('%c\nüìñ GUIDE DES RUNES :', 'color:#49cafa; font-size:1.1em; font-weight:bold;');
        console.log('%c  Runes 1-4  : Les Chercheurs (fouillerZone)', 'color:#888;');
        console.log('%c  Runes 5-8  : Les Verrous (ouvrirPorte)', 'color:#888;');
        console.log('%c  Runes 9-10 : L\'Atelier (papyrus russes)', 'color:#888;');
        console.log('%c  Rune 11    : La Taverne (chat social)', 'color:#888;');
        console.log('%c  Rune 12    : L\'≈íil de l\'Oracle (m√©t√©o + jackpot)', 'color:#888;');
        
        console.log('%c\nüé¨ SC√âNARIO DE TEST :', 'color:#00ff88; font-weight:bold;');
        
        // √âtape 1 : Cliquer sur la Rune 1 (√ânigme #1)
        setTimeout(function() {
            console.log('%c\n1Ô∏è‚É£ Clic sur Rune 1 (Premi√®re fois) - √ânigme #1', 'color:#d4af37; font-weight:bold;');
            console.log('%c   ‚Üí Devrait afficher le message mystique', 'color:#888;');
            console.log('%c   ‚Üí Devrait ajouter le premier papyrus', 'color:#888;');
            console.log('%c   ‚Üí Devrait vibrer le sac', 'color:#888;');
        }, 500);
        
        // √âtape 2 : Ajouter des cl√©s pour tester les portes
        setTimeout(function() {
            console.log('%c\n2Ô∏è‚É£ Ajout de cl√©s dans le sac', 'color:#d4af37; font-weight:bold;');
            ajouterCleDansSac(1);
            ajouterCleDansSac(2);
            console.log('%c   ‚Üí Cl√©s 1 et 2 ajout√©es', 'color:#00ff88;');
        }, 1500);
        
        // √âtape 3 : Tester une porte (Rune 5 = Porte 1)
        setTimeout(function() {
            console.log('%c\n3Ô∏è‚É£ Vous pouvez maintenant tester :', 'color:#d4af37; font-weight:bold;');
            console.log('%c   ‚Ä¢ Rune 1 (0)  : √ânigme + papyrus', 'color:#49cafa;');
            console.log('%c   ‚Ä¢ Rune 2-4    : Fouiller zones', 'color:#49cafa;');
            console.log('%c   ‚Ä¢ Rune 5 (4)  : Porte 1 (cl√© 1 requise)', 'color:#49cafa;');
            console.log('%c   ‚Ä¢ Rune 6 (5)  : Porte 2 (cl√© 2 requise)', 'color:#49cafa;');
            console.log('%c   ‚Ä¢ Rune 9-10   : Atelier papyrus', 'color:#49cafa;');
            console.log('%c   ‚Ä¢ Rune 11 (10): Taverne', 'color:#49cafa;');
            console.log('%c   ‚Ä¢ Rune 12 (11): ≈íil Oracle', 'color:#49cafa;');
            console.log('%c\nüí° Cliquez sur les runes pour tester leurs fonctions !', 'color:#00ff88; font-size:1.1em; font-weight:bold;');
        }, 2500);
    };

    window.testInteractionSanctuaire = function() {
        console.log('%c=== TEST INTERACTION INVENTAIRE ‚Üî SANCTUAIRE ===', 'color:#d4af37; font-size:1.3em; font-weight:bold;');
        
        // Pr√©parer l'inventaire avec quelques objets
        viderSac();
        viderObjetsQuete();
        ajouterCleDansSac(1);
        ajouterCleDansSac(5);
        ajouterCleDansSac(7);
        ajouterObjetQuete('üíé', 'Cristal', 'cristal_1');
        ajouterObjetQuete('üîÆ', 'Orbe', 'orbe_1');
        
        console.log('%cüì¶ Ouverture de l\'inventaire...', 'color:#49cafa;');
        console.log('%c   ‚Üí Le sanctuaire va se d√©placer vers le haut et se r√©duire', 'color:#888;');
        console.log('%c   ‚Üí Les runes restent CLIQUABLES', 'color:#00ff88; font-weight:bold;');
        ouvrirSacInventaire();
        
        setTimeout(function() {
            console.log('%c‚ú® L\'inventaire est ouvert !', 'color:#d4af37;');
            console.log('%c   ‚Üí Essayez de cliquer sur les runes du sanctuaire', 'color:#49cafa;');
            console.log('%c   ‚Üí Vous pouvez voir le sanctuaire √† travers le fond semi-transparent', 'color:#49cafa;');
        }, 600);
        
        setTimeout(function() {
            console.log('%cüì¶ Fermeture de l\'inventaire...', 'color:#888;');
            console.log('%c   ‚Üí Le sanctuaire reprend sa position centrale', 'color:#888;');
            fermerSacInventaire();
        }, 4000);
        
        setTimeout(function() {
            console.log('%c‚úÖ Test termin√© - Interaction fluide confirm√©e !', 'color:#00ff88; font-size:1.1em; font-weight:bold;');
            console.log('%cüí° Astuce : Appuyez sur √âchap pour fermer l\'inventaire rapidement', 'color:#d4af37;');
        }, 4700);
    };

    window.testScenarioComplet = function() {
        console.log('%c=== SC√âNARIO COMPLET : QU√äTE DU SANCTUAIRE ===', 'color:#d4af37; font-size:1.3em; font-weight:bold; text-shadow: 0 0 10px rgba(212,175,55,0.5);');
        
        // Pr√©parer l'inventaire
        viderSac();
        viderObjetsQuete();
        
        // √âtape 1 : Le joueur re√ßoit des objets
        console.log('%cüì¶ √âtape 1/5 : Collecte d\'objets...', 'color:#49cafa; font-weight:bold;');
        ajouterCleDansSac(1);
        ajouterCleDansSac(5);
        ajouterObjetQuete('üóùÔ∏è', 'Cl√© Antique', 'cle_antique');
        ajouterObjetQuete('üíé', 'Cristal de Givre', 'cristal_givre');
        ajouterObjetQuete('üîÆ', 'Orbe de Vision', 'orbe_vision');
        
        // Ouvrir l'inventaire
        setTimeout(function() {
            ouvrirSacInventaire();
        }, 500);
        
        // √âtape 2 : Approche d'une premi√®re porte (n√©cessite cristal)
        setTimeout(function() {
            console.log('%c‚ùÑÔ∏è √âtape 2/5 : Approche de la Porte de Glace...', 'color:#49cafa; font-weight:bold;');
            enregistrerZoneResonance('porte_glace', 'cristal_givre', function() {
                console.log('%cüéâ La Porte de Glace s\'ouvre !', 'color:#00ff88;');
                retirerObjetQuete('cristal_givre');
            });
            declencherZoneResonance('porte_glace');
        }, 3000);
        
        // √âtape 3 : Le cristal dispara√Æt, r√©sonance s'arr√™te
        setTimeout(function() {
            arreterResonanceMagique();
            console.log('%c‚ú® Le Cristal de Givre se dissout dans un √©clat de lumi√®re...', 'color:#888; font-style:italic;');
        }, 8000);
        
        // √âtape 4 : Nouvelle zone n√©cessitant l'Orbe
        setTimeout(function() {
            console.log('%cüîÆ √âtape 3/5 : Salle des Miroirs...', 'color:#49cafa; font-weight:bold;');
            enregistrerZoneResonance('salle_miroirs', 'orbe_vision', function() {
                console.log('%cüëÅÔ∏è L\'Orbe r√©v√®le le chemin cach√© !', 'color:#00ff88;');
            });
            declencherZoneResonance('salle_miroirs');
        }, 10000);
        
        // √âtape 5 : Arr√™t et nouvelle cl√© d√©couverte
        setTimeout(function() {
            arreterResonanceMagique();
            console.log('%cüóùÔ∏è √âtape 4/5 : Une nouvelle cl√© appara√Æt !', 'color:#49cafa; font-weight:bold;');
            ajouterCleDansSac(13);
        }, 15000);
        
        // √âtape 6 : Porte finale n√©cessitant cl√© 13
        setTimeout(function() {
            console.log('%cüö™ √âtape 5/5 : Porte du Sanctuaire Final...', 'color:#d4af37; font-weight:bold;');
            verifierResonanceRune(12); // Rune 12 n√©cessite cl√© 13
            console.log('%c‚ú® La cl√© 13 vibre intens√©ment !', 'color:#d4af37;');
        }, 17000);
        
        // Fin du sc√©nario
        setTimeout(function() {
            arreterResonanceMagique();
            fermerSacInventaire();
            console.log('%cüéä QU√äTE TERMIN√âE ! Le Sanctuaire s\'ouvre devant vous...', 'color:#00ff88; font-size:1.2em; font-weight:bold; text-shadow: 0 0 20px rgba(0,255,136,0.8);');
        }, 22000);
    };


    // Fonction utilitaire : D√©clencher r√©sonance simple (pour int√©gration facile)
    window.resonner = function(objetId, type, intensite) {
        type = type || 'quete';
        intensite = intensite || 1;
        declencherResonanceMagique(objetId, type, intensite);
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INT√âGRATION ZONES INTERACTIVES - D√©tection de proximit√©
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Exemple d'int√©gration avec les runes du Sanctuaire
    function verifierResonanceRune(runeId) {
        // V√©rifier si une cl√© sp√©ciale peut d√©bloquer cette rune
        var cleSpeciale = runeId + 1; // Exemple : rune 0 n√©cessite cl√© 1
        
        if (sacInventaire.indexOf(cleSpeciale) !== -1) {
            console.log('%cüåü Rune ' + runeId + ' : Cl√© sp√©ciale d√©tect√©e !', 'color:#d4af37;');
            declencherResonanceMagique(cleSpeciale, 'cle', 1);
            return true;
        }
        return false;
    }

    // Exemple d'int√©gration avec les portes des 100 niveaux
    function verifierResonancePorte(doorIndex) {
        // V√©rifier si un objet de qu√™te peut aider √† identifier la bonne porte
        var objetsUtiles = ['orbe_vision', 'cristal_clarte', 'parchemin_sagesse'];
        
        for (var i = 0; i < objetsUtiles.length; i++) {
            var objet = sacObjetsQuete.find(function(obj) { return obj.id === objetsUtiles[i]; });
            if (objet) {
                console.log('%cüîÆ Porte ' + doorIndex + ' : Objet de guidance d√©tect√© !', 'color:#49cafa;');
                declencherResonanceMagique(objet.id, 'quete', 2);
                
                // R√©v√©ler la destination de la porte
                if (typeof revealDoorWithScroll === 'function') {
                    revealDoorWithScroll(doorIndex);
                }
                return true;
            }
        }
        return false;
    }

    // Hook global : Surveiller les √©v√©nements de proximit√©
    var resonanceZonesActives = {};
    
    function enregistrerZoneResonance(zoneId, objetRequis, callback) {
        resonanceZonesActives[zoneId] = {
            objetRequis: objetRequis,
            callback: callback || function() {}
        };
        console.log('%cüìç Zone de r√©sonance enregistr√©e:', 'color:#d4af37;', zoneId);
    }

    function declencherZoneResonance(zoneId) {
        var zone = resonanceZonesActives[zoneId];
        if (!zone) {
            console.warn('Zone de r√©sonance inconnue:', zoneId);
            return false;
        }
        
        var result = verifierResonanceZone(zoneId, zone.objetRequis);
        if (result && zone.callback) {
            zone.callback();
        }
        return result;
    }

    // Exemple d'utilisation avec les runes :
    // Ajoutez ceci dans onRuneClick pour activer la r√©sonance au survol
    /*
    function onRuneClick(runeId) {
        // Code existant...
        
        // Ajouter d√©tection de r√©sonance
        if (verifierResonanceRune(runeId)) {
            addOracleChatMessage('‚ú® Votre cl√© vibre en pr√©sence de cette rune !');
        }
        
        // Reste du code...
    }
    */
</script>
</html>