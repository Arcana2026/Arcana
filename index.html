<!DOCTYPE html>
<html lang="fr">
<head>
    <script>
      if (typeof window !== 'undefined' && window.location.hostname === 'arcana-safe.nft') {
        var p = (window.location.pathname || '/').replace(/^\//, '') || 'index.html';
        window.location.replace('https://arcana-ezl.pages.dev/' + p + (window.location.search ? window.location.search : ''));
      }
    </script>
    <style>html { scroll-behavior: smooth; }</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcana Safe ‚Äî Site officiel arcana-ezl.pages.dev</title>
    <meta name="description" content="Arcana Safe : √©cosyst√®me financier s√©curis√© par le Coffre-Fort Arcana. Site officiel h√©berg√© sur arcana-ezl.pages.dev (arcana-safe.nft).">
    <meta name="keywords" content="Arcana Safe, arcana-safe.nft, arcana-ezl.pages.dev, Web3, pr√©vente, ARCANA, Polygon">
    <meta property="og:title" content="Arcana Safe ‚Äî arcana-ezl.pages.dev">
    <meta property="og:description" content="Domaine Web3 officiel Arcana Safe. √âcosyst√®me s√©curis√© par le Coffre-Fort Arcana.">
    <meta property="og:type" content="website">
    <link rel="canonical" href="https://arcana-ezl.pages.dev">
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ethers.js : charg√© via CDN (√©galement d√©pendance du projet dans package.json) pour connexion MetaMask et Polygon -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background-color: #0a0e1a;
            background-image: linear-gradient(rgba(0,20,40,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(0,20,40,0.3) 1px, transparent 1px);
            background-size: 20px 20px;
            color: #F7E7CE;
            font-family: 'Playfair Display', serif;
            min-height: 100vh;
            margin: 0;
        }

        .navbar {
            background: linear-gradient(to bottom, #0f1629, #0a0e1a);
            border-bottom: 2px solid #D4AF37;
            padding: 0.5rem 2rem;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            height: 110px;
            position: relative;
            z-index: 50;
        }

        .logo-text-arcana {
            font-family: 'Great Vibes', cursive !important;
            font-size: 3.5rem !important;
            background: linear-gradient(to bottom, #fef9e7, #f7e7ce, #d4af37) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            filter: drop-shadow(0 0 8px rgba(247, 231, 206, 0.6)) !important;
            line-height: 1 !important;
            white-space: nowrap !important;
            pointer-events: none;
        }

        .logo-image-center {
            height: 95px;
            width: auto;
            border-radius: 50%;
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.6));
            position: relative;
            z-index: 60;
        }

        .wallet-address {
            font-family: monospace;
            background: rgba(0,0,0,0.4);
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #F7E7CE;
            color: #F7E7CE;
            cursor: pointer !important;
            transition: 0.3s ease;
        }

        .card {
            background: linear-gradient(145deg, #131b2e, #0f1629) !important;
            border: 1px solid #D4AF37 !important;
            box-shadow: 20px 20px 40px rgba(0,0,0,0.5);
            border-radius: 20px;
        }

        .stat-value {
            color: #F7E7CE !important;
            text-shadow: 0 0 20px rgba(247, 231, 206, 0.9);
            font-size: 3.5rem !important;
            font-weight: bold;
        }

        /* --- STYLE BARRE DE PROGRESSION --- */
        .progress-container {
            background: rgba(0,0,0,0.4);
            border: 1px solid #D4AF37;
            border-radius: 50px;
            height: 25px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }
        .progress-bar {
            background: linear-gradient(90deg, #00ffcc, #00d4aa);
            height: 100%;
            width: 2%; 
            transition: width 1s ease-in-out;
            box-shadow: 0 0 20px #00ffcc, 0 0 40px rgba(0, 255, 204, 0.4);
        }
        .presale-counter-live {
            padding: 0.75rem;
            border-radius: 12px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .btn-withdraw {
            background: linear-gradient(135deg, #F7E7CE, #E3D1B4) !important;
            color: #1a0f0a !important;
            border: none !important;
            font-weight: bold;
            letter-spacing: 1px;
            transition: 0.4s;
        }

        .btn-withdraw:hover {
            box-shadow: 0 0 20px #F7E7CE;
            transform: translateY(-2px);
        }

        .traffic-counter {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(247, 231, 206, 0.1);
            opacity: 0.3;
        }

        .livre-blanc-btn {
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.3), 0 4px 20px rgba(0, 255, 204, 0.15);
        }

        .presale-box {
            border: 1px solid #D4AF37;
            border-radius: 16px;
            padding: 1.5rem;
            background: rgba(0,0,0,0.3);
            margin: 1.5rem 0;
        }

        .presale-box input, .presale-box select {
            background: rgba(0,0,0,0.5);
            border: 1px solid #D4AF37;
            color: #F7E7CE;
            border-radius: 8px;
        }

        .presale-box input:focus, .presale-box select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }

        .btn-buy-now {
            background: linear-gradient(135deg, #00ffcc, #00d4aa) !important;
            color: #0a0e1a !important;
            border: none !important;
            font-weight: bold;
            font-size: 1.1rem;
            padding: 1rem 2rem;
            border-radius: 12px;
            width: 100%;
            transition: 0.3s;
            box-shadow: 0 0 25px rgba(0, 255, 204, 0.5), 0 0 50px rgba(0, 255, 204, 0.2);
        }

        .btn-buy-now:hover {
            box-shadow: 0 0 35px rgba(0, 255, 204, 0.7), 0 0 60px rgba(0, 255, 204, 0.3);
            transform: translateY(-2px);
        }

        .btn-buy-now:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-claim {
            background: linear-gradient(135deg, #00ffcc, #00d4aa) !important;
            color: #0a0e1a !important;
            border: none !important;
            font-weight: bold;
            letter-spacing: 1px;
            transition: 0.4s;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.4);
        }

        .btn-claim:hover {
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.6);
            transform: translateY(-2px);
        }

        .btn-claim:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-loading { pointer-events: none; opacity: 0.85; }
        .btn-spinner { display: inline-block; width: 1em; height: 1em; margin-right: 0.5em; vertical-align: -0.15em; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: btn-spin 0.6s linear infinite; }
        @keyframes btn-spin { to { transform: rotate(360deg); } }

        /* ----- Section Casino : titre n√©on, style Arcane, glassmorphism ----- */
        #casino-section .casino-title-neon {
            font-size: clamp(1.5rem, 5vw, 2.25rem);
            font-weight: 800;
            letter-spacing: 0.35em;
            color: #e9d5ff;
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.9), 0 0 20px rgba(139, 92, 246, 0.7), 0 0 40px rgba(124, 58, 237, 0.5);
            animation: neon-flicker 3s ease-in-out infinite;
        }
        @keyframes neon-flicker { 0%, 90%, 100% { opacity: 1; text-shadow: 0 0 10px rgba(167,139,250,0.9), 0 0 20px rgba(139,92,246,0.7), 0 0 40px rgba(124,58,237,0.5); } 93%, 97% { opacity: 0.92; text-shadow: 0 0 8px rgba(167,139,250,0.8), 0 0 16px rgba(139,92,246,0.6); } }
        .slot-machine-wrapper {
            padding: clamp(1rem, 4vw, 1.5rem);
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(88, 28, 135, 0.2) 0%, rgba(30, 27, 75, 0.4) 50%, rgba(30, 58, 138, 0.2) 100%);
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.35), 0 0 100px rgba(59, 130, 246, 0.15), inset 0 0 60px rgba(88, 28, 135, 0.1);
            border: 2px solid rgba(167, 139, 250, 0.5);
            backdrop-filter: blur(12px);
        }
        .slot-machine {
            background: linear-gradient(180deg, rgba(30, 27, 46, 0.85) 0%, rgba(15, 13, 24, 0.95) 100%);
            border-radius: 16px;
            padding: clamp(1rem, 3vw, 1.5rem);
            border: 1px solid rgba(139, 92, 246, 0.4);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
        }
        .slot-reels {
            display: flex;
            justify-content: center;
            gap: clamp(0.35rem, 2vw, 0.75rem);
            flex-wrap: wrap;
        }
        .slot-reel {
            width: clamp(4rem, 18vw, 5.5rem);
            height: clamp(4rem, 18vw, 5.5rem);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            border-radius: 12px;
            border: 2px solid rgba(139, 92, 246, 0.5);
            overflow: hidden;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.2), inset 0 0 20px rgba(0,0,0,0.3);
        }
        .slot-reel.spinning .slot-cell { animation: slot-spin 0.12s linear infinite; }
        @keyframes slot-spin { 0% { transform: translateY(0); opacity: 1; } 50% { transform: translateY(-2px); opacity: 0.85; } 100% { transform: translateY(0); opacity: 1; } }
        .slot-cell {
            font-size: clamp(1.4rem, 4vw, 1.9rem);
            line-height: 1.5;
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-spin-gold {
            background: linear-gradient(135deg, #D4AF37, #B8860B);
            color: #0a0e1a;
            font-weight: 800;
            font-size: clamp(0.95rem, 2.5vw, 1.1rem);
            letter-spacing: 0.2em;
            padding: 0.75rem clamp(1.25rem, 4vw, 2rem);
            border-radius: 12px;
            border: 2px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5), inset 0 1px 0 rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: spin-btn-pulse 1.5s ease-in-out infinite;
        }
        .btn-spin-gold:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 32px rgba(212, 175, 55, 0.75);
        }
        .btn-spin-gold:disabled { opacity: 0.6; cursor: not-allowed; animation: none; }
        @keyframes spin-btn-pulse { 0%, 100% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.5), inset 0 1px 0 rgba(255,255,255,0.3); } 50% { box-shadow: 0 0 28px rgba(212, 175, 55, 0.7), inset 0 1px 0 rgba(255,255,255,0.3); } }
        .btn-approve-slot {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.9), rgba(99, 102, 241, 0.9));
            color: #fff;
            font-weight: 700;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            border: 1px solid rgba(167, 139, 250, 0.6);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-approve-slot:hover:not(:disabled) {
            transform: scale(1.03);
            box-shadow: 0 0 22px rgba(139, 92, 246, 0.5);
        }
        .btn-approve-slot:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Jeu Crash ‚Äî style Stake/MetaWin : fond sombre, n√©on violet */
        .crash-game-wrapper {
            padding: clamp(1rem, 4vw, 1.5rem);
            border-radius: 20px;
            background: #1a1a1a;
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.2), 0 0 80px rgba(168, 85, 247, 0.08), inset 0 0 40px rgba(0,0,0,0.3);
            border: 2px solid rgba(168, 85, 247, 0.6);
            backdrop-filter: blur(12px);
            max-width: 560px;
            margin-left: auto;
            margin-right: auto;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        .crash-game-wrapper:hover {
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.35), 0 0 100px rgba(168, 85, 247, 0.15);
        }
        .crash-game-box {
            background: #1a1a1a;
            border-radius: 16px;
            padding: clamp(1rem, 3vw, 1.5rem);
            border: 1px solid rgba(168, 85, 247, 0.4);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
        }
        .crash-mult-center {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(2.5rem, 6vw, 3.5rem);
            font-weight: 800;
            letter-spacing: 0.05em;
            pointer-events: none;
            z-index: 2;
        }
        .crash-chart-wrap { position: relative; width: 100%; margin-bottom: 0.5rem; }
        #crashCanvas {
            display: block;
            width: 100%;
            height: 220px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(168, 85, 247, 0.4);
        }
        .crash-mult-display {
            font-size: 1.5rem;
            font-weight: 800;
            color: #a78bfa;
            text-shadow: 0 0 20px rgba(167, 139, 250, 0.9);
            letter-spacing: 0.05em;
        }
        .crash-mult-display.crashed { color: #ef4444; text-shadow: 0 0 15px rgba(239, 68, 68, 0.8); }
        .crash-mult-display.won { color: #34d399; text-shadow: 0 0 15px rgba(52, 211, 153, 0.8); }
        .btn-crash-bet {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: #fff;
            font-weight: 800;
            letter-spacing: 0.1em;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: 2px solid rgba(168, 85, 247, 0.7);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-crash-bet:hover:not(:disabled) {
            transform: scale(1.03);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.6);
        }
        .btn-crash-bet.cash-out {
            background: linear-gradient(135deg, #34d399, #10b981);
            border-color: rgba(52, 211, 153, 0.8);
            box-shadow: 0 0 20px rgba(52, 211, 153, 0.5);
            animation: crash-cashout-pulse 0.8s ease-in-out infinite;
        }
        .btn-crash-bet:disabled { opacity: 0.7; cursor: not-allowed; }
        @keyframes crash-cashout-pulse { 0%, 100% { box-shadow: 0 0 20px rgba(52, 211, 153, 0.5); } 50% { box-shadow: 0 0 30px rgba(52, 211, 153, 0.8); } }
        .crash-liquidite-rule { font-size: 0.75rem; color: rgba(196, 181, 255, 0.85); margin-top: 0.5rem; }

        /* Jeu Plinko */
        .plinko-game-wrapper {
            padding: clamp(1rem, 4vw, 1.5rem);
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(124, 45, 18, 0.2) 0%, rgba(234, 88, 12, 0.15) 50%, rgba(67, 20, 7, 0.25) 100%);
            box-shadow: 0 0 50px rgba(234, 88, 12, 0.2), 0 0 100px rgba(234, 88, 12, 0.08), inset 0 0 60px rgba(124, 45, 18, 0.06);
            border: 2px solid rgba(234, 88, 12, 0.5);
            backdrop-filter: blur(12px);
            max-width: 560px;
            margin-left: auto;
            margin-right: auto;
        }
        .plinko-game-box {
            background: linear-gradient(180deg, rgba(30, 27, 46, 0.9) 0%, rgba(15, 13, 24, 0.95) 100%);
            border-radius: 16px;
            padding: clamp(1rem, 3vw, 1.5rem);
            border: 1px solid rgba(234, 88, 12, 0.4);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
        }
        .plinko-board {
            position: relative;
            width: 100%;
            height: 320px;
            background: radial-gradient(ellipse at 50% 0%, rgba(30, 27, 46, 0.95), rgba(15, 13, 24, 0.98));
            border-radius: 12px;
            border: 1px solid rgba(234, 88, 12, 0.3);
            overflow: hidden;
        }
        .plinko-pin {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ea580c, #9a3412);
            box-shadow: 0 0 8px rgba(234, 88, 12, 0.6), inset 0 1px 0 rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
        }
        .plinko-slot {
            position: absolute;
            bottom: 0;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: #0a0e1a;
            border: 1px solid rgba(0,0,0,0.2);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .plinko-slot.mult-05 { background: linear-gradient(180deg, #6b7280, #4b5563); }
        .plinko-slot.mult-1 { background: linear-gradient(180deg, #94a3b8, #64748b); }
        .plinko-slot.mult-2 { background: linear-gradient(180deg, #34d399, #10b981); }
        .plinko-slot.mult-5 { background: linear-gradient(180deg, #fbbf24, #f59e0b); }
        .plinko-slot.mult-10 { background: linear-gradient(180deg, #a78bfa, #8b5cf6); box-shadow: 0 0 12px rgba(139, 92, 246, 0.5); }
        .plinko-ball {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #fef9e7, #D4AF37);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.8), inset 0 2px 0 rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
            transition: left 0.15s ease-out, top 0.2s ease-out;
        }
        .plinko-ball.dropping { transition: left 0.12s ease-out, top 0.18s ease-out; }
        .btn-plinko-drop {
            background: linear-gradient(135deg, #ea580c, #c2410c);
            color: #fff;
            font-weight: 800;
            letter-spacing: 0.08em;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: 2px solid rgba(234, 88, 12, 0.7);
            box-shadow: 0 0 20px rgba(234, 88, 12, 0.4);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-plinko-drop:hover:not(:disabled) {
            transform: scale(1.03);
            box-shadow: 0 0 28px rgba(234, 88, 12, 0.6);
        }
        .btn-plinko-drop:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Jeu Keno ‚Äî style Stake/MetaWin : fond sombre, n√©on violet */
        .keno-game-wrapper {
            padding: clamp(1rem, 4vw, 1.5rem);
            border-radius: 20px;
            background: #1a1a1a;
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.2), 0 0 80px rgba(168, 85, 247, 0.08), inset 0 0 40px rgba(0,0,0,0.3);
            border: 2px solid rgba(168, 85, 247, 0.6);
            backdrop-filter: blur(12px);
            max-width: 640px;
            margin-left: auto;
            margin-right: auto;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        .keno-game-wrapper:hover {
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.35), 0 0 100px rgba(168, 85, 247, 0.15);
        }
        .keno-game-box {
            background: #1a1a1a;
            border-radius: 16px;
            padding: clamp(1rem, 3vw, 1.5rem);
            border: 1px solid rgba(168, 85, 247, 0.4);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
        }
        .keno-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.4rem;
            margin-bottom: 1rem;
        }
        .keno-num {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.95rem;
            border-radius: 10px;
            border: 2px solid rgba(168, 85, 247, 0.4);
            background: #1a1a1a;
            color: #F7E7CE;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .keno-num:hover {
            border-color: rgba(168, 85, 247, 0.8);
            background: rgba(139, 92, 246, 0.2);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }
        .keno-num.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.9), rgba(124, 58, 237, 0.9));
            border-color: #a78bfa;
            color: #fff;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.8), 0 0 40px rgba(168, 85, 247, 0.4);
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        .keno-num.hit {
            animation: keno-hit 0.5s ease;
            box-shadow: 0 0 24px rgba(34, 197, 94, 0.9);
        }
        @keyframes keno-hit { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .keno-draw-area {
            min-height: 72px;
            padding: 0.75rem;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(168, 85, 247, 0.4);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .keno-ball {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
            color: #0a0e1a;
            background: radial-gradient(circle at 35% 35%, #fef9e7, #D4AF37);
            box-shadow: 0 0 14px rgba(212, 175, 55, 0.7), inset 0 2px 0 rgba(255,255,255,0.5);
            animation: keno-ball-drop 0.4s ease-out;
        }
        @keyframes keno-ball-drop {
            0% { transform: translateY(-30px); opacity: 0; }
            70% { transform: translateY(4px); opacity: 1; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .keno-payout-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin-top: 0.75rem;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        .keno-payout-table th, .keno-payout-table td { padding: 0.4rem 0.5rem; text-align: center; }
        .keno-payout-table th { background: rgba(139, 92, 246, 0.25); color: #c4b5fd; font-weight: 700; }
        .keno-payout-table td { background: rgba(26, 26, 26, 0.9); color: #F7E7CE; border-bottom: 1px solid rgba(168, 85, 247, 0.15); }
        .keno-payout-table tr:last-child td { border-bottom: none; }
        .btn-keno-draw {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: #fff;
            font-weight: 800;
            letter-spacing: 0.08em;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: 2px solid rgba(168, 85, 247, 0.7);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-keno-draw:hover:not(:disabled) {
            transform: scale(1.03);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.6);
        }
        .btn-keno-draw:disabled { opacity: 0.7; cursor: not-allowed; }
        .keno-liquidite-rule { font-size: 0.75rem; color: rgba(196, 181, 255, 0.85); margin-top: 0.5rem; }

        .casino-liquidite-mention {
            margin-top: 1rem;
            font-size: 0.8rem;
            color: rgba(196, 181, 255, 0.9);
            letter-spacing: 0.06em;
            text-align: center;
        }

        /* Grille Casino type MetaWin/Stake */
        .casino-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 200px), 1fr));
            gap: 1.25rem;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 480px) { .casino-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 720px) { .casino-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 960px) { .casino-grid { grid-template-columns: repeat(4, 1fr); } }
        .casino-game-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(30, 27, 46, 0.9) 0%, rgba(15, 13, 24, 0.98) 100%);
            border: 1px solid rgba(139, 92, 246, 0.35);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .casino-game-card:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.25), 0 0 30px rgba(139, 92, 246, 0.15);
        }
        .casino-game-card-cover {
            aspect-ratio: 4/3;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            padding: 0.75rem;
        }
        .casino-game-card-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #F7E7CE;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            letter-spacing: 0.03em;
        }
        .casino-game-card-badge {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #a5f3fc;
            background: rgba(6, 182, 212, 0.25);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            border: 1px solid rgba(34, 211, 238, 0.4);
        }
        .casino-game-card-play {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .casino-game-card:hover .casino-game-card-play {
            opacity: 1;
        }
        .casino-game-card-play-btn {
            padding: 0.6rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            color: #0a0e1a;
            background: linear-gradient(135deg, #D4AF37, #B8860B);
            border: 2px solid rgba(255, 215, 0, 0.7);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .casino-game-card-play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 28px rgba(212, 175, 55, 0.7);
        }
        .casino-game-card .p-3 { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 0.5rem; }
        .casino-cover-slots { background: linear-gradient(160deg, #4c1d95 0%, #7c3aed 50%, #2e1065 100%); }
        .casino-cover-crash { background: linear-gradient(160deg, #0f766e 0%, #14b8a6 50%, #134e4a 100%); }
        .casino-cover-plinko { background: linear-gradient(160deg, #7c2d12 0%, #ea580c 50%, #431407 100%); }
        .casino-cover-mines { background: linear-gradient(160deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%); }
        .casino-cover-roulette { background: linear-gradient(160deg, #6b21a8 0%, #a855f7 50%, #581c87 100%); }
        .casino-cover-keno { background: linear-gradient(160deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%); }

        /* Tableau Derniers Paris */
        .recent-bets-wrapper { max-width: 900px; margin-left: auto; margin-right: auto; }
        .recent-bets-table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.3); background: rgba(15, 13, 24, 0.8); }
        .recent-bets-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .recent-bets-table th { text-align: left; padding: 0.75rem 0.5rem; color: #D4AF37; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid rgba(139, 92, 246, 0.4); }
        .recent-bets-table td { padding: 0.6rem 0.5rem; border-bottom: 1px solid rgba(139, 92, 246, 0.15); color: #F7E7CE; }
        .recent-bets-table tbody tr:hover { background: rgba(139, 92, 246, 0.08); }
        .recent-bets-table .bet-win { color: #34d399; font-weight: 600; }
        .recent-bets-table .bet-loss { color: #9ca3af; }
        @media (max-width: 640px) { .recent-bets-table { font-size: 0.7rem; } .recent-bets-table th, .recent-bets-table td { padding: 0.5rem 0.35rem; } }

        .banner-official-domain {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.28) 0%, rgba(184, 134, 11, 0.18) 50%, rgba(212, 175, 55, 0.28) 100%);
            border-bottom: 2px solid rgba(212, 175, 55, 0.6);
            color: #F7E7CE;
            padding: 0.6rem 1.25rem;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.25), inset 0 1px 0 rgba(255,255,255,0.08);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .banner-official-domain .domain { color: #D4AF37; text-decoration: none; border-bottom: 1px solid rgba(212,175,55,0.5); transition: color 0.2s, border-color 0.2s; }
        .banner-official-domain .domain:hover { color: #F7E7CE; border-bottom-color: #D4AF37; }

        .badge-verified-blockchain {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.6rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #D4AF37;
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.6);
            border-radius: 6px;
            white-space: nowrap;
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.2);
        }

        .btn-cta-invest {
            background: linear-gradient(135deg, #D4AF37, #B8860B);
            color: #0a0e1a;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 0.08em;
            padding: 1rem 1.5rem;
            border-radius: 14px;
            text-align: center;
            text-decoration: none;
            border: none;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6), 0 4px 20px rgba(212, 175, 55, 0.3), inset 0 1px 0 rgba(255,255,255,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            animation: cta-glow 2.5s ease-in-out infinite;
        }
        .btn-cta-invest:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.8), 0 6px 24px rgba(212, 175, 55, 0.4);
            color: #0a0e1a;
        }
        @keyframes cta-glow {
            0%, 100% { box-shadow: 0 0 30px rgba(212, 175, 55, 0.6), 0 4px 20px rgba(212, 175, 55, 0.3), inset 0 1px 0 rgba(255,255,255,0.3); }
            50% { box-shadow: 0 0 38px rgba(212, 175, 55, 0.75), 0 4px 24px rgba(212, 175, 55, 0.35), inset 0 1px 0 rgba(255,255,255,0.3); }
        }

        /* --- HEADER MOBILE --- */
        @media (max-width: 768px) {
            .navbar {
                display: flex;
                justify-content: space-around;
                align-items: center;
                padding: 0.5rem 1rem;
                height: auto;
                min-height: 70px;
            }
            .logo-text-arcana {
                font-size: 2rem !important;
                order: 1;
            }
            .navbar .flex {
                order: 2;
            }
            .navbar .wallet-address {
                order: 3;
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            .logo-image-center {
                width: 50px !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body>
    <audio id="successSound" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

    <div class="navbar">
        <div class="logo-text-arcana">Arcana Safe</div>
        <div class="flex justify-center items-center gap-4">
            <a href="https://arcana-ezl.pages.dev/arcade.html" class="text-[#D4AF37] hover:text-[#F7E7CE] text-sm uppercase tracking-wider">Arcade</a>
            <img src="logo.png" alt="Arcana Safe Logo" class="logo-image-center" style="width: 60px; height: auto;">
        </div>
        <button id="connectBtn" class="wallet-address">Connecter Wallet</button>
    </div>

    <div class="banner-official-domain">
        Domaine Web3 Officiel : <a href="https://arcana-ezl.pages.dev" class="domain" rel="noopener">arcana-safe.nft</a> ‚Üí <a href="https://arcana-ezl.pages.dev" class="domain" rel="noopener">arcana-ezl.pages.dev</a> <span class="text-[#D4AF37]/80 text-xs ml-1">(transaction 0x5fda‚Ä¶ confirm√©e)</span>
    </div>

    <div class="container mx-auto px-4 py-16 text-center">
        <button type="button" id="cta-invest" class="btn-cta-invest block w-full max-w-md mx-auto mb-8 border-0 cursor-pointer">
            Investir dans le Coffre-Fort
        </button>
        <div class="max-w-md mx-auto card p-10">
            <h2 id="balanceTitle" class="text-xl mb-4 opacity-80 uppercase tracking-widest">R√©serve du Coffre Arcana Safe</h2>
            <p class="text-xs uppercase tracking-wider text-[#D4AF37]/80 mb-2">Adresse de r√©ception (Polygon)</p>
            <div class="flex items-center justify-center gap-2 mb-2 flex-wrap">
                <code id="receptionAddress" class="text-[#00ffcc]/95 font-mono text-sm px-3 py-2 rounded-lg bg-black/40 border border-[#D4AF37]/50 break-all">0x29D61511C84E332635E296e37bf22Eb4fB514147</code>
                <span class="badge-verified-blockchain" title="Contrat v√©rifi√© sur Polygon">V√©rifi√© sur la Blockchain</span>
                <button type="button" id="copyAddressBtn" class="px-3 py-2 rounded-lg border border-[#D4AF37]/60 text-[#D4AF37] text-xs font-medium hover:bg-[#D4AF37]/20 transition" title="Copier l'adresse">Copier</button>
                <button type="button" id="addArcanaMetaMaskBtn" class="px-3 py-2 rounded-lg border border-[#00ffcc]/60 text-[#00ffcc] text-xs font-medium hover:bg-[#00ffcc]/20 transition" title="Ajouter le token ARCANA dans MetaMask">+ ARCANA dans MetaMask</button>
            </div>
            <p class="text-[#F7E7CE]/60 text-xs mb-4">Les fonds de la pr√©vente sont envoy√©s vers cette adresse. V√©rifiez-la sur Polygonscan.</p>
            <div class="stat-value my-8">
                <p class="mb-1"><span id="balanceDisplayPol">...</span> <span class="text-lg">POL</span></p>
                <p><span id="balanceDisplayArcana">...</span> <span class="text-lg">ARCANA</span></p>
            </div>

            <div class="presale-counter-live mb-2">
                <p class="text-xs uppercase tracking-wider text-[#D4AF37]/90 mb-2">Compteur de pr√©vente en direct ‚Äî arcana-ezl.pages.dev</p>
                <div class="flex justify-between text-sm">
                    <span>Objectif : 100 000 $</span>
                    <span id="progressText">R√©colt√© : 5 $</span>
                </div>
                <p id="remainingTokens" class="text-sm text-[#00ffcc] mb-2">Jetons ARCANA restants : 400 000 000</p>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <p id="presalePercent" class="text-xs text-[#F7E7CE]/60 mt-1">0 % de l'objectif</p>
            </div>

            <div id="zone-investissement">
            <div id="presaleBox" class="presale-box">
                <h3 class="text-sm font-bold uppercase tracking-widest text-[#D4AF37] mb-4">Zone de Vente Arcana Safe</h3>
                <div class="flex gap-2 mb-3">
                    <select id="tokenSelect" class="flex-1 px-4 py-2">
                        <option value="POL">POL</option>
                        <option value="USDT">USDT</option>
                        <option value="USDC">USDC</option>
                    </select>
                    <input type="number" id="amountInput" placeholder="Montant" min="0" step="0.01" class="flex-1 px-4 py-2" />
                </div>
                <p id="receiveText" class="text-[#00ffcc] mb-4 font-medium">Tu recevras : 0 ARCANA</p>
                <button id="buyBtn" class="btn-buy-now">Acheter maintenant</button>
            </div>
            </div>
            
            <div class="flex flex-col gap-4 mt-6">
                <p id="claimHint" class="hidden text-xs text-[#F7E7CE]/60">Le Claim sera disponible lorsque l‚Äôobjectif de 100 000 $ sera atteint.</p>
                <button id="claimBtn" class="btn btn-claim btn-lg w-full">R√©clamer mes jetons Arcana Safe</button>
                <button id="withdrawBtn" class="btn btn-withdraw btn-lg w-full">Effectuer un Retrait</button>

                <div class="collapse collapse-arrow bg-black/40 border border-[#F7E7CE]/20 text-left">
                    <input type="checkbox" /> 
                    <div class="collapse-title text-sm font-bold uppercase tracking-widest text-[#F7E7CE]">
                        üìñ Consulter le Livre Blanc
                    </div>
                    <div class="collapse-content text-sm text-[#F7E7CE]/80 leading-relaxed">
                        <div class="py-4 border-t border-[#F7E7CE]/10 space-y-6">
                            <p class="italic text-[#D4AF37]/90 text-center">¬´ Au c≈ìur des t√©n√®bres, un coffre veille. ¬ª</p>

                            <section>
                                <h4 class="font-bold text-[#F7E7CE] mb-2 uppercase tracking-wider border-b border-[#D4AF37]/40 pb-1">1. Vision</h4>
                                <p>Arcana ne se contente pas d‚Äô√™tre un simple jeton : c‚Äôest la cl√© d‚Äôun <strong class="text-[#D4AF37]">√©cosyst√®me financier s√©curis√©</strong>, prot√©g√© par le <strong class="text-[#D4AF37]">Coffre-Fort Arcana</strong>. Dans un monde o√π la confiance est rare, nous construisons une forteresse num√©rique o√π chaque actif repose sous la garde de protocoles inviolables. La mission est claire : offrir aux d√©tenteurs un sanctuaire de valeur, √† l‚Äôabri des turbulences et des pr√©dations. Le Coffre-Fort Arcana n‚Äôest pas un concept ‚Äî c‚Äôest l‚Äôarchitecture m√™me de cet avenir.</p>
                            </section>

                            <section>
                                <h4 class="font-bold text-[#F7E7CE] mb-2 uppercase tracking-wider border-b border-[#D4AF37]/40 pb-1">2. Tokenomics</h4>
                                <p class="mb-2">L‚Äô√©conomie Arcana est d√©lib√©r√©ment sobre et lisible : <strong class="text-[#D4AF37]">400 000 000</strong> jetons constituent l‚Äôint√©gralit√© de l‚Äôoffre. Aucune inflation cach√©e, aucun plafond mouvant.</p>
                                <ul class="list-disc ml-4 space-y-1">
                                    <li><strong>Offre totale :</strong> 400 000 000 ARCANA</li>
                                    <li><strong>Prix de pr√©vente :</strong> 0,00025 $ par jeton</li>
                                    <li>Les jetons acquis en pr√©vente sont enregistr√©s sur la blockchain et deviennent r√©clamables selon les r√®gles du Coffre.</li>
                                </ul>
                                <p class="mt-2 text-[#D4AF37]/90">Une raret√© assum√©e. Une valeur ancr√©e dans la raret√© et la s√©curit√© du Coffre.</p>
                                <div class="mt-4 pl-2 border-l-2 border-[#D4AF37]/50 space-y-3">
                                    <p class="text-xs uppercase tracking-wider text-[#D4AF37]/80">R√©partition & m√©canismes</p>
                                    <p>L‚Äôint√©gralit√© des jetons en pr√©vente est allou√©e √† l‚Äôobjectif du Coffre (100 000 $). Chaque contribution est convertie au taux fixe de 0,00025 $ / ARCANA. Aucune √©mission secondaire n‚Äôest pr√©vue : l‚Äôoffre est fixe et v√©rifiable on-chain.</p>
                                    <p class="text-xs uppercase tracking-wider text-[#D4AF37]/80">Utilit√© du jeton</p>
                                    <p>ARCANA sert d‚Äôunit√© de compte et de r√©serve de valeur au sein de l‚Äô√©cosyst√®me s√©curis√© par le Coffre. L‚Äôacc√®s aux fonctionnalit√©s futures (staking, gouvernance) pourra √™tre conditionn√© √† la d√©tention du jeton.</p>
                                    <p class="text-xs uppercase tracking-wider text-[#D4AF37]/80">Transparence</p>
                                    <p>Les soldes et les achats sont enregistr√©s sur la blockchain Polygon (contrat <code class="text-[#00ffcc]/90 text-xs">0x29D61511C84E332635E296e37bf22Eb4fB514147</code>). Chaque d√©tenteur peut v√©rifier son allocation √† tout moment.</p>
                                </div>
                            </section>

                            <section>
                                <h4 class="font-bold text-[#F7E7CE] mb-2 uppercase tracking-wider border-b border-[#D4AF37]/40 pb-1">3. S√©curit√©</h4>
                                <p>La protection des d√©tenteurs est au centre du design Arcana. Le <strong class="text-[#D4AF37]">syst√®me de Claim diff√©r√©</strong> garantit que les jetons ne sont pas lib√©r√©s avant que le Coffre n‚Äôait atteint son objectif et que les conditions d‚Äôouverture soient r√©unies.</p>
                                <div class="mt-4 pl-2 border-l-2 border-[#D4AF37]/50 space-y-3">
                                    <p class="text-xs uppercase tracking-wider text-[#D4AF37]/80">Claim diff√©r√©</p>
                                    <p>Les jetons achet√©s en pr√©vente sont cr√©dit√©s on-chain mais ne sont r√©clamables qu‚Äôapr√®s atteinte de l‚Äôobjectif de 100 000 $. Cela √©vite les sorties pr√©matur√©es et aligne les int√©r√™ts de tous les participants jusqu‚Äô√† l‚Äôouverture du Coffre.</p>
                                    <p class="text-xs uppercase tracking-wider text-[#D4AF37]/80">Int√©grit√© des fonds</p>
                                    <p>Les fonds de la pr√©vente sont achemin√©s vers une tr√©sorerie d√©di√©e. Aucun retrait arbitraire n‚Äôest possible sans respect du protocole (signatures, nonces, contrats v√©rifiables).</p>
                                    <p class="text-xs uppercase tracking-wider text-[#D4AF37]/80">Bonnes pratiques</p>
                                    <p>Le site s‚Äôappuie sur le contrat d√©ploy√© sur Polygon ; les achats et r√©clamations passent exclusivement par des transactions sign√©es par l‚Äôutilisateur. Nous recommandons de conserver vos jetons dans un portefeuille dont vous d√©tenez les cl√©s et de v√©rifier l‚Äôadresse du contrat avant toute interaction.</p>
                                </div>
                            </section>

                            <section>
                                <h4 class="font-bold text-[#F7E7CE] mb-2 uppercase tracking-wider border-b border-[#D4AF37]/40 pb-1">4. Roadmap</h4>
                                <ul class="list-disc ml-4 space-y-2">
                                    <li><strong class="text-[#D4AF37]">Phase actuelle ‚Äî La pr√©vente :</strong> collecte des fonds jusqu‚Äô√† l‚Äôobjectif de <strong>100 000 $</strong>. Chaque contribution renforce la r√©serve du Coffre.</li>
                                    <li><strong class="text-[#D4AF37]">Cl√¥ture √† 100 000 $ :</strong> la pr√©vente s‚Äôarr√™te. Le Coffre atteint son seuil et se verrouille sur les montants r√©colt√©s.</li>
                                    <li><strong class="text-[#D4AF37]">Ouverture du Coffre :</strong> les conditions de s√©curit√© √©tant remplies, le Claim est activ√©. Les d√©tenteurs peuvent alors r√©clamer leurs jetons ARCANA selon les r√®gles du protocole.</li>
                                </ul>
                                <p class="mt-2 italic text-[#F7E7CE]/70">Un chemin trac√©. Une porte qui ne s‚Äôouvre qu‚Äôune fois.</p>
                            </section>

                            <p class="text-center text-[#D4AF37]/80 text-xs uppercase tracking-widest pt-2">‚Äî Le Coffre-Fort Arcana ‚Äî</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6 card p-4 border-2 border-[#D4AF37]/60">
                <h3 class="text-sm font-bold uppercase tracking-widest text-[#D4AF37] mb-2">üéÅ Welcome Bonus</h3>
                <p class="text-sm text-[#F7E7CE]/90 mb-1">‚Ä¢ <strong>100%</strong> sur votre premier d√©p√¥t vers le Coffre : <code class="text-[#00ffcc]/90 text-xs">0x29D61511C84E332635E296e37bf22Eb4fB514147</code></p>
                <p class="text-sm text-[#F7E7CE]/90">‚Ä¢ <strong>5 spins gratuits</strong> sur la Roue de la Fortune dans l'Arcade.</p>
                <p class="text-xs text-[#00ffcc]/90 mt-1">100% des profits servent au Buyback d'ARCANA.</p>
                <a href="arcade.html" class="inline-block mt-2 px-4 py-2 rounded-lg bg-[#D4AF37]/20 text-[#D4AF37] border border-[#D4AF37] hover:bg-[#D4AF37]/30 text-sm font-medium">Acc√©der √† l'Arcade</a>
            </div>

            <!-- Section Casino : grille type MetaWin/Stake -->
            <div id="casino-section" class="mb-8 mt-10 px-3 sm:px-4">
                <h2 class="casino-title-neon text-center mb-8">ARCANA CASINO</h2>
                <div class="casino-grid">
                    <article class="casino-game-card">
                        <div class="casino-game-card-cover casino-cover-slots"></div>
                        <div class="p-3">
                            <div>
                                <h3 class="casino-game-card-title">Arcana Slots</h3>
                                <p class="text-xs text-[#F7E7CE]/60 mt-0.5">Machine √† sous</p>
                            </div>
                            <span class="casino-game-card-badge">Provably Fair</span>
                        </div>
                        <div class="casino-game-card-play">
                            <button type="button" class="casino-game-card-play-btn" data-game="slots">Jouer</button>
                        </div>
                    </article>
                    <article class="casino-game-card">
                        <div class="casino-game-card-cover casino-cover-crash"></div>
                        <div class="p-3">
                            <div>
                                <h3 class="casino-game-card-title">Crash</h3>
                                <p class="text-xs text-[#F7E7CE]/60 mt-0.5">Le multiplicateur qui monte</p>
                            </div>
                            <span class="casino-game-card-badge">Provably Fair</span>
                        </div>
                        <div class="casino-game-card-play">
                            <button type="button" class="casino-game-card-play-btn" data-game="crash">Jouer</button>
                        </div>
                    </article>
                    <article class="casino-game-card">
                        <div class="casino-game-card-cover casino-cover-plinko"></div>
                        <div class="p-3">
                            <div>
                                <h3 class="casino-game-card-title">Plinko</h3>
                                <p class="text-xs text-[#F7E7CE]/60 mt-0.5">Les billes qui tombent</p>
                            </div>
                            <span class="casino-game-card-badge">Provably Fair</span>
                        </div>
                        <div class="casino-game-card-play">
                            <button type="button" class="casino-game-card-play-btn" data-game="plinko">Jouer</button>
                        </div>
                    </article>
                    <article class="casino-game-card">
                        <div class="casino-game-card-cover casino-cover-mines"></div>
                        <div class="p-3">
                            <div>
                                <h3 class="casino-game-card-title">Mines</h3>
                                <p class="text-xs text-[#F7E7CE]/60 mt-0.5">Trouver les diamants sans exploser</p>
                            </div>
                            <span class="casino-game-card-badge">Provably Fair</span>
                        </div>
                        <div class="casino-game-card-play">
                            <button type="button" class="casino-game-card-play-btn" data-game="mines">Jouer</button>
                        </div>
                    </article>
                    <article class="casino-game-card">
                        <div class="casino-game-card-cover casino-cover-roulette"></div>
                        <div class="p-3">
                            <div>
                                <h3 class="casino-game-card-title">Roulette Arcane</h3>
                                <p class="text-xs text-[#F7E7CE]/60 mt-0.5">Roulette th√©matique</p>
                            </div>
                            <span class="casino-game-card-badge">Provably Fair</span>
                        </div>
                        <div class="casino-game-card-play">
                            <button type="button" class="casino-game-card-play-btn" data-game="roulette">Jouer</button>
                        </div>
                    </article>
                    <article class="casino-game-card">
                        <div class="casino-game-card-cover casino-cover-keno"></div>
                        <div class="p-3">
                            <div>
                                <h3 class="casino-game-card-title">Keno</h3>
                                <p class="text-xs text-[#F7E7CE]/60 mt-0.5">Choisissez jusqu'√† 10 num√©ros</p>
                            </div>
                            <span class="casino-game-card-badge">Provably Fair</span>
                        </div>
                        <div class="casino-game-card-play">
                            <button type="button" class="casino-game-card-play-btn" data-game="keno">Jouer</button>
                        </div>
                    </article>
                </div>
                <p class="casino-liquidite-mention mt-8">10% des profits sont r√©inject√©s dans la liquidit√© ARCANA.</p>

                <!-- Derniers Paris (Recent Bets) -->
                <div class="recent-bets-wrapper mt-10">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-[#D4AF37] mb-4">Derniers Paris</h3>
                    <div class="recent-bets-table-wrap">
                        <table class="recent-bets-table">
                            <thead>
                                <tr>
                                    <th>Jeu</th>
                                    <th>Joueur</th>
                                    <th>Mise</th>
                                    <th>Multiplicateur</th>
                                    <th>Gain</th>
                                </tr>
                            </thead>
                            <tbody id="recentBetsBody">
                                <!-- Rempli par JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Arcana Slots : machine √† sous (affich√©e quand on clique sur la carte Slots) -->
                <div id="casino-slots-block" class="slot-machine-wrapper mt-10 max-w-lg mx-auto">
                    <div class="slot-machine">
                        <div class="slot-reels" id="slotReels">
                            <div class="slot-reel" data-reel="0">
                                <div class="slot-cell" data-icon="crystal">üíé</div>
                                <div class="slot-cell" data-icon="orb">üîÆ</div>
                                <div class="slot-cell" data-icon="scroll">üìú</div>
                            </div>
                            <div class="slot-reel" data-reel="1">
                                <div class="slot-cell" data-icon="orb">üîÆ</div>
                                <div class="slot-cell" data-icon="dragon">üê≤</div>
                                <div class="slot-cell" data-icon="crystal">üíé</div>
                            </div>
                            <div class="slot-reel" data-reel="2">
                                <div class="slot-cell" data-icon="scroll">üìú</div>
                                <div class="slot-cell" data-icon="crystal">üíé</div>
                                <div class="slot-cell" data-icon="dragon">üê≤</div>
                            </div>
                        </div>
                        <div class="slot-controls mt-6 flex flex-col items-center gap-4">
                            <div class="flex flex-wrap items-center justify-center gap-2">
                                <label class="text-[#F7E7CE]/90 text-sm">Mise (Bet Amount)</label>
                                <input type="number" id="slotStakeInput" min="1" step="1" value="10" class="w-24 px-3 py-2 rounded-lg bg-black/50 border border-[#D4AF37]/50 text-[#F7E7CE] text-center focus:ring-2 focus:ring-[#D4AF37]/50 focus:border-[#D4AF37]/70" placeholder="ARCANA" />
                            </div>
                            <div class="flex flex-wrap justify-center gap-3">
                                <button type="button" id="slotApproveBtn" class="btn-approve-slot">Approve ARCANA</button>
                                <button type="button" id="slotSpinBtn" class="btn-spin-gold">SPIN</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Jeu Crash : graphique dynamique, Mise, Parier / Cash Out, multiplicateur au centre -->
                <div id="casino-crash-block" class="crash-game-wrapper mt-10">
                    <div class="crash-game-box">
                        <h3 class="text-lg font-bold text-[#a78bfa] mb-3 uppercase tracking-wider">Crash</h3>
                        <p class="text-xs text-[#F7E7CE]/80 mb-2">Mises en jetons <strong>ARCANA</strong>. Cliquez sur Cash Out avant le crash.</p>
                        <div class="crash-chart-wrap">
                            <canvas id="crashCanvas" width="520" height="220"></canvas>
                            <div id="crashMultCenter" class="crash-mult-center crash-mult-display" aria-hidden="true">1.00x</div>
                        </div>
                        <div class="mb-2 flex items-center justify-center gap-2">
                            <span class="text-[#F7E7CE]/80 text-sm">Multiplicateur</span>
                            <span id="crashMultDisplay" class="crash-mult-display">1.00x</span>
                        </div>
                        <div class="crash-controls mt-4 flex flex-col sm:flex-row items-center justify-center gap-4">
                            <div class="flex items-center gap-2">
                                <label class="text-[#F7E7CE]/90 text-sm">Mise (ARCANA)</label>
                                <input type="number" id="crashStakeInput" min="1" step="1" value="10" class="w-24 px-3 py-2 rounded-lg bg-black/50 border border-[#a78bfa]/50 text-[#F7E7CE] text-center focus:ring-2 focus:ring-[#a78bfa]/50 focus:border-[#a78bfa]/70" placeholder="ARCANA" />
                            </div>
                            <button type="button" id="crashBetBtn" class="btn-crash-bet">Parier</button>
                        </div>
                        <p id="crashStatus" class="text-sm text-[#F7E7CE]/70 mt-3 text-center min-h-[1.25rem]"></p>
                        <p class="crash-liquidite-rule text-center">10 % des profits du casino sont r√©inject√©s dans la liquidit√© ARCANA.</p>
                    </div>
                </div>

                <!-- Jeu Plinko : pyramide de clous + bille + cases multiplicateurs -->
                <div id="casino-plinko-block" class="plinko-game-wrapper mt-10">
                    <div class="plinko-game-box">
                        <h3 class="text-lg font-bold text-[#ea580c] mb-3 uppercase tracking-wider">Plinko</h3>
                        <p class="text-xs text-[#F7E7CE]/80 mb-2">Solde ARCANA : <span id="plinkoBalanceDisplay">‚Äî</span></p>
                        <div class="plinko-board" id="plinkoBoard">
                            <div id="plinkoPinsContainer"></div>
                            <div id="plinkoSlotsContainer"></div>
                            <div id="plinkoBall" class="plinko-ball" style="left: 50%; top: 24px; display: none;"></div>
                        </div>
                        <div class="plinko-controls mt-5 flex flex-col sm:flex-row items-center justify-center gap-4 flex-wrap">
                            <div class="flex items-center gap-2">
                                <label class="text-[#F7E7CE]/90 text-sm">Mise (ARCANA)</label>
                                <input type="number" id="plinkoStakeInput" min="1" step="1" value="10" class="w-24 px-3 py-2 rounded-lg bg-black/50 border border-[#ea580c]/50 text-[#F7E7CE] text-center focus:ring-2 focus:ring-[#ea580c]/50 focus:border-[#ea580c]/70" />
                            </div>
                            <button type="button" id="plinkoDropBtn" class="btn-plinko-drop">Lancer la bille</button>
                        </div>
                        <p id="plinkoResult" class="text-sm text-[#F7E7CE]/90 mt-3 text-center min-h-[1.25rem] font-medium"></p>
                    </div>
                </div>

                <!-- Jeu Keno : grille 40 num√©ros, jusqu'√† 10 choisis, bouton Tirer -->
                <div id="casino-keno-block" class="keno-game-wrapper mt-10">
                    <div class="keno-game-box">
                        <h3 class="text-lg font-bold text-[#a78bfa] mb-3 uppercase tracking-wider">Keno</h3>
                        <p class="text-xs text-[#F7E7CE]/80 mb-2">Mises en jetons <strong>ARCANA</strong>. Choisissez jusqu'√† 10 num√©ros (1‚Äì40), puis <strong>Tirer</strong>.</p>
                        <div id="kenoGrid" class="keno-grid"></div>
                        <div class="flex flex-wrap items-center justify-center gap-4 mb-3">
                            <div class="flex items-center gap-2">
                                <label class="text-[#F7E7CE]/90 text-sm">Mise (ARCANA)</label>
                                <input type="number" id="kenoStakeInput" min="1" step="1" value="10" class="w-24 px-3 py-2 rounded-lg bg-black/50 border border-[#a78bfa]/50 text-[#F7E7CE] text-center focus:ring-2 focus:ring-[#a78bfa]/50 focus:border-[#a78bfa]/70" />
                            </div>
                            <button type="button" id="kenoDrawBtn" class="btn-keno-draw">Tirer</button>
                        </div>
                        <p class="text-xs text-[#F7E7CE]/70 mb-1">Num√©ros tir√©s :</p>
                        <div id="kenoDrawArea" class="keno-draw-area"></div>
                        <p id="kenoResult" class="text-sm font-medium mt-3 text-center min-h-[1.25rem]"></p>
                        <table class="keno-payout-table">
                            <thead><tr><th>Bons num√©ros</th><th>Multiplicateur</th></tr></thead>
                            <tbody id="kenoPayoutBody"></tbody>
                        </table>
                        <p class="keno-liquidite-rule text-center">10 % des profits du casino sont r√©inject√©s dans la liquidit√© ARCANA.</p>
                    </div>
                </div>
            </div>
            <div class="traffic-counter flex flex-col items-center gap-2">
                <a href="arcade.html" class="text-sm text-[#D4AF37] hover:underline uppercase tracking-widest">üéÆ Arcade ‚Äî 10 jeux</a>
                <p class="text-xs text-[#F7E7CE]/70">100% des profits ‚Üí Buyback ARCANA</p>
                <img src="https://hitwebcounter.com/counter/counter.php?page=ArcanaPremiumClean&style=0006&nbdigits=5&type=page&initCount=0" border="0" />
                <a href="https://arcana-safe.nft/arcana-admin" class="text-xs text-[#F7E7CE]/40 hover:text-[#D4AF37]/70 uppercase tracking-widest">Acc√®s Admin</a>
            </div>
            <footer class="mt-12 pt-8 pb-6 border-t border-[#D4AF37]/30 text-center">
                <p class="text-[#F7E7CE]/80 text-sm mb-1">Besoin d'aide ? Contactez le support Arcana</p>
                <a href="mailto:blockarcana-admin@proton.me" class="text-[#D4AF37] hover:underline font-medium">blockarcana-admin@proton.me</a>
            </footer>
        </div>
    </div>

    <script type="module">
        let provider;
        let signer;
        let userAddress;

        const SITE_URL = "https://arcana-ezl.pages.dev";
        const RENDER_URL = "https://arcana-server.onrender.com";
        const ARCANA_VAULT_ADDRESS = "0x29D61511C84E332635E296e37bf22Eb4fB514147";
        const VAULT_ADDRESS = ARCANA_VAULT_ADDRESS;
        const PRESALE_VAULT = ARCANA_VAULT_ADDRESS;
        const CONTRACT_WITHDRAW = ARCANA_VAULT_ADDRESS;
        const ARCANA_TOKEN_ADDRESS = ARCANA_VAULT_ADDRESS;
        const RECEPTION_ADDRESS = ARCANA_VAULT_ADDRESS;
        const POLYGON_RPC_FALLBACKS = [
            "https://polygon-rpc.com",
            "https://rpc.ankr.com/polygon",
            "https://polygon-bor-rpc.publicnode.com",
            "https://1rpc.io/matic"
        ];
        const POLYGON_CHAIN_ID = 137;
        const ARCANA_TOKEN_ABI = ["function balanceOf(address owner) view returns (uint256)", "function approve(address spender, uint256 amount) returns (bool)"];
        const POL_USD_APPROX = 0.4;

        /* Contrats Casino : une fois ArcanaCrash.sol et ArcanaKeno d√©ploy√©s, remplacer null par les adresses (ex: ARCANA_CRASH_ADDRESS = '0x...'). Les fonctions contractCrashPlaceBet, contractCrashCashOut et contractKenoPlay appelleront alors les contrats via ethers.js. */
        const ARCANA_CRASH_ADDRESS = null;
        const ARCANA_KENO_ADDRESS = null;
        const ARCANA_CRASH_ABI = [
            "function placeBet(uint256 amount) external",
            "function cashOut(uint256 roundId) external",
            "function getCurrentMultiplier() view returns (uint256)",
            "event BetPlaced(address indexed player, uint256 roundId, uint256 amount)",
            "event CashOut(address indexed player, uint256 roundId, uint256 multiplier, uint256 payout)"
        ];
        const ARCANA_KENO_ABI = [
            "function play(uint256 amount, uint8[] calldata selectedNumbers) external",
            "function drawAndSettle(uint256 roundId) external",
            "event KenoPlayed(address indexed player, uint256 roundId, uint256 amount, uint8[] selected)",
            "event KenoSettled(address indexed player, uint256 roundId, uint8[] drawn, uint256 payout)"
        ];
        const USDT_POLYGON = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";
        const USDC_POLYGON = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359";
        const PRICE_PER_ARCANA = 0.00025;
        const ARCANA_PER_USD = 1 / PRICE_PER_ARCANA;
        let hasAutoClaimed = false;

        const abiWithdraw = [
            "function withdraw(uint256 amount, uint256 nonce, bytes memory signature)",
            "function balanceOf(address owner) view returns (uint256)"
        ];

        const abiPresale = [
            "function balanceOf(address owner) view returns (uint256)",
            "function buyWithPOL() payable",
            "function buyWithNative() payable",
            "function buyWithUSDT(uint256 amount)",
            "function buyWithUSDC(uint256 amount)",
            "function buyWithToken(address token, uint256 amount)",
            "function claim()",
            "function setClaimOpen(bool _open)",
            "function claimOpen() view returns (bool)",
            "function arcanaToken() view returns (address)",
            "function totalSold() view returns (uint256)"
        ];

        function setButtonLoading(btnId, loadingText) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.dataset.originalText = btn.innerText;
            btn.classList.add('btn-loading');
            btn.disabled = true;
            btn.innerHTML = '<span class="btn-spinner"></span>' + (loadingText || 'En cours...');
        }
        function restoreButton(btnId, defaultText) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.classList.remove('btn-loading');
            btn.disabled = false;
            btn.innerText = defaultText != null ? defaultText : (btn.dataset.originalText || '');
        }

        /** √âvite le crash "Unexpected end of JSON input" : ne jamais utiliser response.json() sur une r√©ponse vide ou non-JSON. */
        async function safeFetchJson(url, options) {
            let text;
            try {
                const res = await fetch(url, options);
                text = await res.text();
            } catch (e) {
                throw new Error("Impossible de joindre le serveur. V√©rifiez votre connexion.");
            }
            if (!text || text.trim() === "") {
                throw new Error("Le serveur n'a renvoy√© aucune donn√©e. R√©essayez plus tard.");
            }
            try {
                return JSON.parse(text);
            } catch (e) {
                const msg = (e && e.message) || String(e);
                if (/Unexpected end of JSON|JSON|invalid/i.test(msg)) {
                    throw new Error("R√©ponse du serveur invalide (pas du JSON). L'API peut √™tre indisponible.");
                }
                throw new Error("R√©ponse du serveur invalide. R√©essayez plus tard.");
            }
        }

        /** R√©cup√®re en priorit√© sur Polygon Mainnet le solde natif (POL) et le solde du token ARCANA */
        async function getBalance() {
            const address = VAULT_ADDRESS;
            let polFormatted = 0;
            let arcanaFormatted = 0;
            for (const rpcUrl of POLYGON_RPC_FALLBACKS) {
                try {
                    const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
                    const network = await provider.getNetwork();
                    if (Number(network.chainId) !== POLYGON_CHAIN_ID) continue;
                    const polBalance = await provider.getBalance(address);
                    polFormatted = parseFloat(ethers.utils.formatEther(polBalance));
                    const tokenContract = new ethers.Contract(ARCANA_TOKEN_ADDRESS, ARCANA_TOKEN_ABI, provider);
                    const arcanaBalance = await tokenContract.balanceOf(address);
                    arcanaFormatted = parseFloat(ethers.utils.formatUnits(arcanaBalance, 18));
                    break;
                } catch (e) {
                    continue;
                }
            }
            return { pol: polFormatted, arcana: arcanaFormatted };
        }

        async function updateUI() {
            let userClaimableBalance = 0;
            const polEl = document.getElementById('balanceDisplayPol');
            const arcanaEl = document.getElementById('balanceDisplayArcana');

            // 1. Affichage des soldes blockchain (toujours ex√©cut√©, ind√©pendant de l‚ÄôAPI)
            try {
                if (window.ethereum && userAddress) {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const contract = new ethers.Contract(PRESALE_VAULT, abiPresale, provider);
                    const balance = await contract.balanceOf(userAddress);
                    userClaimableBalance = parseFloat(ethers.utils.formatUnits(balance, 18));
                    if (arcanaEl) arcanaEl.innerText = userClaimableBalance.toLocaleString('fr-FR');
                    if (polEl) polEl.innerText = "‚Äî";
                    document.getElementById('balanceTitle').innerText = "Votre Solde Priv√©";
                    window.plinkoDisplayBalance = userClaimableBalance;
                    const plinkoBal = document.getElementById('plinkoBalanceDisplay');
                    if (plinkoBal) plinkoBal.innerText = userClaimableBalance.toLocaleString('fr-FR', { maximumFractionDigits: 0 });
                } else {
                    const vault = await getBalance();
                    if (polEl) polEl.innerText = vault.pol.toLocaleString('fr-FR', { maximumFractionDigits: 2 });
                    if (arcanaEl) arcanaEl.innerText = vault.arcana.toLocaleString('fr-FR', { maximumFractionDigits: 0 });
                    document.getElementById('balanceTitle').innerText = "R√©serve du Coffre Arcana Safe";
                    const plinkoBal = document.getElementById('plinkoBalanceDisplay');
                    if (plinkoBal) plinkoBal.innerText = vault.arcana != null ? vault.arcana.toLocaleString('fr-FR', { maximumFractionDigits: 0 }) : '‚Äî';
                }
            } catch (err) {
                console.warn("Erreur solde blockchain:", err);
                if (polEl) polEl.innerText = "‚Äî";
                if (arcanaEl) arcanaEl.innerText = "‚Äî";
            }

            // 2. Appel /api/presale-status : si le serveur est en veille, le reste du script continue
            try {
                const data = await safeFetchJson(`${RENDER_URL}/api/presale-status`, { cache: 'no-store' });
                const valid = data && typeof data.totalRaised !== 'undefined';
                const totalRaised = valid ? data.totalRaised : 0;
                const target = valid ? data.target : 100000;
                const claimOpen = valid && (data.state === 'SUCCESS' || data.claimOpen === true || totalRaised >= target);
                const percent = Math.max(2, Math.min(100, (totalRaised / target) * 100));

                document.getElementById('progressBar').style.width = percent + "%";
                const progressEl = document.getElementById('progressText');
                if (progressEl) progressEl.innerText = `R√©colt√© : ${totalRaised} $`;
                const ARCANA_SOLD = totalRaised / PRICE_PER_ARCANA;
                const remaining = Math.max(0, Math.floor(400000000 - ARCANA_SOLD));
                document.getElementById('remainingTokens').innerText = `Jetons ARCANA restants : ${remaining.toLocaleString('fr-FR')}`;

                const banner = document.getElementById('coffreOuvertBanner');
                const claimBtn = document.getElementById('claimBtn');
                const claimHint = document.getElementById('claimHint');
                const presaleBox = document.getElementById('presaleBox');
                const buyBtn = document.getElementById('buyBtn');
                const amountInput = document.getElementById('amountInput');

                if (claimOpen) {
                    banner.classList.remove('hidden');
                    claimBtn.disabled = false;
                    if (claimHint) claimHint.classList.add('hidden');
                    presaleBox.classList.add('opacity-60', 'pointer-events-none');
                    if (presaleBox.querySelector('h3')) presaleBox.querySelector('h3').textContent = 'Pr√©vente cl√¥tur√©e ‚Äî Le Coffre est ouvert';
                    if (buyBtn) buyBtn.disabled = true;
                    if (amountInput) amountInput.disabled = true;
                    if (userAddress && userClaimableBalance > 0 && !hasAutoClaimed) {
                        hasAutoClaimed = true;
                        setTimeout(() => claim(), 1500);
                    }
                } else {
                    banner.classList.add('hidden');
                    claimBtn.disabled = true;
                    if (claimHint) claimHint.classList.remove('hidden');
                    presaleBox.classList.remove('opacity-60', 'pointer-events-none');
                    if (presaleBox.querySelector('h3')) presaleBox.querySelector('h3').textContent = 'Zone de Vente';
                    if (buyBtn) buyBtn.disabled = false;
                    if (amountInput) amountInput.disabled = false;
                }
            } catch (e) {
                // Serveur en veille ou r√©ponse non JSON : on n‚Äôinterrompt pas le script, on affiche un message
                console.warn("API presale-status indisponible:", e);
                const progressEl = document.getElementById('progressText');
                if (progressEl) progressEl.innerText = "Serveur en pause";
                document.getElementById('progressBar').style.width = "2%";
                const remainingEl = document.getElementById('remainingTokens');
                if (remainingEl) remainingEl.innerText = "Jetons ARCANA restants : 400 000 000";
                const claimBtn = document.getElementById('claimBtn');
                if (claimBtn) claimBtn.disabled = true;
                const claimHint = document.getElementById('claimHint');
                if (claimHint) claimHint.classList.remove('hidden');
            }
        }

        async function connect() {
            if (!window.ethereum && /Android|iPhone|iPad/i.test(navigator.userAgent)) {
                window.location.href = "https://metamask.app.link/dapp/" + window.location.href.replace(/^https?:\/\//, '');
                return;
            }
            if (window.ethereum) {
                setButtonLoading('connectBtn', 'Connexion...');
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const accounts = await provider.send("eth_requestAccounts", []);
                    userAddress = accounts[0];
                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.classList.remove('btn-loading');
                    connectBtn.disabled = false;
                    connectBtn.innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
                    await updateUI();
                } catch (err) {
                    console.error(err);
                    restoreButton('connectBtn', 'Connecter Wallet');
                    Swal.fire({ icon: 'error', title: 'Connexion √©chou√©e', text: err.message || 'Impossible de connecter le wallet.' });
                }
            } else { Swal.fire({ icon: 'warning', title: 'MetaMask requis', text: 'Veuillez installer MetaMask pour connecter votre wallet.' }); }
        }

        async function withdraw() {
            if (!userAddress) {
                Swal.fire({ icon: 'info', title: 'Connexion requise', text: 'Veuillez connecter votre wallet !' });
                return;
            }
            const ethersLib = window.ethers;
            if (!ethersLib || !ethersLib.utils || !ethersLib.utils.getAddress) {
                Swal.fire({ icon: 'error', title: 'Erreur', text: 'ethers non disponible.' });
                return;
            }
            setButtonLoading('withdrawBtn', 'Retrait en cours...');
            try {
                const safeUserAddress = ethersLib.utils.getAddress(userAddress);
                const safeContractAddress = ethersLib.utils.getAddress(ARCANA_VAULT_ADDRESS);
                const response = await fetch(`${RENDER_URL}/api/sign-withdrawal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: safeUserAddress, amount: "10000" })
                });
                const text = await response.text();
                if (!text || text.trim() === "") throw new Error("Le serveur n'a pas repondu (reponse vide). Verifiez que l'API est accessible.");
                let data;
                try { data = JSON.parse(text); } catch (_) { throw new Error("Reponse serveur invalide (JSON)"); }
                if (!data.success) throw new Error(data.error || "Signature de retrait indisponible");
                const provider = new ethersLib.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const contract = new ethersLib.Contract(safeContractAddress, abiWithdraw, signer);
                const tx = await contract.withdraw(ethersLib.utils.parseUnits(data.amount, 18), data.nonce, data.signature);
                await tx.wait();
                if (document.getElementById('successSound')) document.getElementById('successSound').play();
                await Swal.fire({ icon: 'success', title: 'Retrait effectu√© !', text: 'Vos fonds ont √©t√© envoy√©s.' });
                await updateUI();
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Erreur de retrait', text: err.message || 'Une erreur est survenue.' });
            } finally {
                restoreButton('withdrawBtn', 'Effectuer un Retrait');
            }
        }

        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) returns (bool)",
            "function transfer(address to, uint256 amount) returns (bool)"
        ];

        async function buyNow() {
            if (!window.ethereum) {
                Swal.fire({ icon: 'warning', title: 'MetaMask requis', text: 'Veuillez installer MetaMask !' });
                return;
            }
            if (!userAddress) {
                Swal.fire({ icon: 'info', title: 'Connexion requise', text: 'Veuillez connecter votre wallet !' });
                return;
            }
            const amount = parseFloat(document.getElementById('amountInput').value);
            const token = document.getElementById('tokenSelect').value;
            if (!amount || amount <= 0) {
                Swal.fire({ icon: 'warning', title: 'Montant invalide', text: 'Veuillez entrer un montant valide.' });
                return;
            }

            let provider = new ethers.providers.Web3Provider(window.ethereum);
            let network = await provider.getNetwork();
            if (network.chainId !== POLYGON_CHAIN_ID) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x89' }]
                    });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } catch (e) {
                    Swal.fire({ icon: 'warning', title: 'R√©seau Polygon', text: "Veuillez basculer sur le r√©seau Polygon pour effectuer l'achat." });
                    return;
                }
            }

            const signer = provider.getSigner();
            const amountWei = ethers.utils.parseUnits(amount.toString(), token === "POL" ? 18 : 6);

            setButtonLoading('buyBtn', 'Transaction en cours...');
            try {
                const presaleContract = new ethers.Contract(PRESALE_VAULT, abiPresale, signer);

                if (token === "POL") {
                    let tx;
                    try {
                        tx = await presaleContract.buyWithPOL({ value: amountWei });
                    } catch (e) {
                        tx = await presaleContract.buyWithNative({ value: amountWei });
                    }
                    await tx.wait();
                } else {
                    const tokenAddress = token === "USDT" ? USDT_POLYGON : USDC_POLYGON;
                    const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                    const approveTx = await tokenContract.approve(PRESALE_VAULT, amountWei);
                    await approveTx.wait();
                    let buyTx;
                    try {
                        buyTx = token === "USDT"
                            ? await presaleContract.buyWithUSDT(amountWei)
                            : await presaleContract.buyWithUSDC(amountWei);
                    } catch (e) {
                        buyTx = await presaleContract.buyWithToken(tokenAddress, amountWei);
                    }
                    await buyTx.wait();
                }

                if (document.getElementById('successSound')) document.getElementById('successSound').play();
                await Swal.fire({ icon: 'success', title: 'Achat enregistr√© !', text: 'Les fonds ont √©t√© envoy√©s vers la tr√©sorerie.' });

                const updateRes = await fetch(`${RENDER_URL}/api/presale-update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, address: userAddress })
                });
                const updateText = await updateRes.text();
                const updateData = (updateText && updateText.trim()) ? (function(){ try { return JSON.parse(updateText); } catch(_) { return {}; } })() : {};
                if (updateData.success) {
                    await updateUI();
                }

                document.getElementById('amountInput').value = "";
                updateReceiveText();
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Transaction √©chou√©e', text: err.message || err.reason || 'Une erreur est survenue.' });
            } finally {
                restoreButton('buyBtn', 'Acheter maintenant');
            }
        }

        function updateReceiveText() {
            const amount = parseFloat(document.getElementById('amountInput').value) || 0;
            const arcana = Math.floor(amount * ARCANA_PER_USD);
            document.getElementById('receiveText').innerText = `Tu recevras : ${arcana.toLocaleString('fr-FR')} ARCANA`;
        }

        async function claim() {
            if (!window.ethereum) {
                Swal.fire({ icon: 'warning', title: 'MetaMask requis', text: 'Veuillez installer MetaMask !' });
                return;
            }
            if (!userAddress) {
                Swal.fire({ icon: 'info', title: 'Connexion requise', text: 'Veuillez connecter votre wallet !' });
                return;
            }

            let provider = new ethers.providers.Web3Provider(window.ethereum);
            let network = await provider.getNetwork();
            if (network.chainId !== POLYGON_CHAIN_ID) {
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } catch (e) {
                    Swal.fire({ icon: 'warning', title: 'R√©seau Polygon', text: 'Veuillez basculer sur le r√©seau Polygon.' });
                    return;
                }
            }

            setButtonLoading('claimBtn', 'R√©clamation en cours...');
            try {
                const signer = provider.getSigner();
                const presaleContract = new ethers.Contract(PRESALE_VAULT, abiPresale, signer);
                const tx = await presaleContract.claim();
                await tx.wait();
                if (document.getElementById('successSound')) document.getElementById('successSound').play();
                await Swal.fire({ icon: 'success', title: 'Jetons r√©clam√©s !', text: 'Vos jetons Arcana ont √©t√© r√©clam√©s avec succ√®s.' });
                try { await updateUI(); } catch (e) {
                    console.warn("Rafra√Æchissement apr√®s claim:", e.message);
                    if (document.getElementById('progressText')) document.getElementById('progressText').innerText = "Donn√©es non rafra√Æchies ‚Äî " + (e.message || "r√©essayez");
                }
            } catch (err) {
                const msg = (err && (err.message || err.reason)) || String(err) || "Transaction echouee";
                if (msg.includes("no tokens") || msg.includes("nothing to claim") || msg.includes("revert") || msg.includes("Claim not open")) {
                    Swal.fire({ icon: 'info', title: 'Rien √† r√©clamer', text: "Aucun jeton √† r√©clamer pour le moment. La lib√©ration des fonds n'a pas encore √©t√© activ√©e." });
                } else if (/JSON|Unexpected end|invalide|serveur/i.test(msg)) {
                    Swal.fire({ icon: 'error', title: 'Serveur', text: "Erreur de communication avec le serveur. R√©essayez dans quelques instants." });
                } else {
                    Swal.fire({ icon: 'error', title: 'Erreur', text: msg });
                }
            } finally {
                restoreButton('claimBtn', 'R√©clamer mes jetons Arcana Safe');
            }
        }

        /** Scroll fluide vers la zone d'investissement au clic sur "Investir dans le Coffre-Fort". */
        function investDirect() {
            const zone = document.getElementById('zone-investissement');
            if (zone) {
                zone.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        /* ----- Logique financi√®re : r√©partition des gains ----- */
        const ALLOCATION_ARCADE_BUYBACK = 1;
        const ALLOCATION_CASINO_LP_PERCENT = 10;
        const ALLOCATION_CASINO_VAULT_PERCENT = 90;

        function calculateAllocations(profit, source) {
            if (source === 'arcade') {
                return { buybackArcana: profit };
            }
            if (source === 'casino') {
                const lpPool = (profit * ALLOCATION_CASINO_LP_PERCENT) / 100;
                const vault = (profit * ALLOCATION_CASINO_VAULT_PERCENT) / 100;
                return { lpPool, vault };
            }
            return {};
        }

        /* ----- Casino Slot Machine ----- */
        const SLOT_ICONS = [
            { id: 'crystal', symbol: 'üíé' },
            { id: 'orb', symbol: 'üîÆ' },
            { id: 'scroll', symbol: 'üìú' },
            { id: 'dragon', symbol: 'üê≤' }
        ];
        let slotSpinning = false;
        let slotApproved = false;

        function getRandomIcon() {
            return SLOT_ICONS[Math.floor(Math.random() * SLOT_ICONS.length)];
        }

        function setReelIcons(reelEl, icons) {
            const cells = reelEl.querySelectorAll('.slot-cell');
            cells.forEach((cell, i) => {
                const icon = icons[i] || getRandomIcon();
                cell.setAttribute('data-icon', icon.id);
                cell.textContent = icon.symbol;
            });
        }

        async function spin() {
            if (slotSpinning) return;
            const stakeInput = document.getElementById('slotStakeInput');
            const spinBtn = document.getElementById('slotSpinBtn');
            const stake = parseInt(stakeInput?.value, 10) || 10;
            if (!slotApproved) {
                Swal.fire({ icon: 'warning', title: 'Approve requis', text: 'Cliquez sur "Approve ARCANA" avant de lancer le spin.' });
                return;
            }
            const reelsEl = document.getElementById('slotReels');
            if (!reelsEl) return;
            const reels = reelsEl.querySelectorAll('.slot-reel');
            slotSpinning = true;
            if (spinBtn) { spinBtn.disabled = true; spinBtn.textContent = '...'; }
            reels.forEach(r => r.classList.add('spinning'));

            const duration = 2000;
            const interval = 80;
            const steps = duration / interval;
            let elapsed = 0;
            const tick = () => {
                reels.forEach(reel => {
                    const icons = [getRandomIcon(), getRandomIcon(), getRandomIcon()];
                    setReelIcons(reel, icons);
                });
                elapsed += interval;
                if (elapsed < duration) setTimeout(tick, interval);
                else {
                    reels.forEach(reel => reel.classList.remove('spinning'));
                    const final = [getRandomIcon(), getRandomIcon(), getRandomIcon()];
                    reels.forEach((reel, i) => setReelIcons(reel, [getRandomIcon(), final[i], getRandomIcon()]));
                    slotSpinning = false;
                    if (spinBtn) { spinBtn.disabled = false; spinBtn.textContent = 'SPIN'; }
                    const same = final[0].id === final[1].id && final[1].id === final[2].id;
                    if (same) {
                        Swal.fire({ icon: 'success', title: 'Gagn√© !', text: 'Trois symboles identiques !' });
                    } else {
                        const allocation = calculateAllocations(stake, 'casino');
                        allocateCasinoSpinLoss(allocation.lpPool, allocation.vault);
                    }
                }
            };
            tick();
        }

        function allocateCasinoSpinLoss(lpPoolAmount, vaultAmount) {
            if (lpPoolAmount == null || vaultAmount == null) return;
            const allocation = { lpPool: lpPoolAmount, vault: vaultAmount };
            window.lastCasinoAllocation = allocation;
            if (typeof window.allocateToLpPool === 'function') window.allocateToLpPool(allocation.lpPool);
            if (typeof window.allocateToVault === 'function') window.allocateToVault(allocation.vault);
        }

        /* ----- Jeu Crash ----- */
        const CRASH_MULT_MIN = 1.01;
        const CRASH_MULT_MAX = 10;
        const CRASH_TAU_MS = 4500;
        let crashState = { running: false, startTime: 0, crashPoint: 1, stake: 0, cashedOut: false, cashOutMult: 0, animId: 0, points: [] };

        function getSecureCrashPoint() {
            const buf = new Uint32Array(2);
            crypto.getRandomValues(buf);
            const u = (buf[0] * 0xFFFFFFFF + buf[1]) / (0xFFFFFFFF * 0xFFFFFFFF + 0xFFFFFFFF);
            const u2 = Math.pow(Math.max(1e-10, u), 1.4);
            return CRASH_MULT_MIN + (CRASH_MULT_MAX - CRASH_MULT_MIN) * (1 - u2);
        }

        function drawCrashCurve(canvas, points, isCrashed, currentMult, crashPoint) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            if (!points.length) return;
            const maxMult = Math.max(crashPoint, currentMult, 2);
            const minMult = 1;
            const scaleY = (v) => h - ((v - minMult) / (maxMult - minMult)) * (h - 20) - 10;
            const scaleX = (i) => (i / Math.max(points.length - 1, 1)) * (w - 20) + 10;
            ctx.beginPath();
            ctx.moveTo(scaleX(0), scaleY(points[0]));
            let crashIdx = -1;
            for (let i = 1; i < points.length; i++) {
                if (isCrashed && points[i] >= crashPoint) { crashIdx = i; break; }
                ctx.lineTo(scaleX(i), scaleY(points[i]));
            }
            ctx.strokeStyle = '#a78bfa';
            ctx.lineWidth = 3;
            ctx.shadowColor = 'rgba(167, 139, 250, 0.8)';
            ctx.shadowBlur = 8;
            ctx.stroke();
            ctx.shadowBlur = 0;
            if (isCrashed && crashIdx >= 0) {
                ctx.beginPath();
                ctx.moveTo(scaleX(crashIdx - 1), scaleY(points[crashIdx - 1]));
                for (let i = crashIdx; i < points.length; i++) ctx.lineTo(scaleX(i), scaleY(points[i]));
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 3;
                ctx.shadowColor = 'rgba(239, 68, 68, 0.8)';
                ctx.shadowBlur = 8;
                ctx.stroke();
            }
        }

        function tickCrash() {
            const canvas = document.getElementById('crashCanvas');
            const multEl = document.getElementById('crashMultDisplay');
            const multCenter = document.getElementById('crashMultCenter');
            const statusEl = document.getElementById('crashStatus');
            const btn = document.getElementById('crashBetBtn');
            if (!crashState.running || !canvas || !multEl) return;
            const elapsed = (Date.now() - crashState.startTime) / 1000;
            const mult = 1 + (crashState.crashPoint - 1) * (1 - Math.exp(-elapsed * 1000 / CRASH_TAU_MS));
            crashState.points.push(mult);
            const maxPoints = 400;
            if (crashState.points.length > maxPoints) crashState.points.shift();
            const multText = mult.toFixed(2) + 'x';
            multEl.textContent = multText;
            if (multCenter) { multCenter.textContent = multText; multCenter.classList.remove('crashed', 'won'); }
            multEl.classList.remove('crashed', 'won');
            drawCrashCurve(canvas, crashState.points, false, mult, crashState.crashPoint);

            if (crashState.cashedOut) {
                crashState.running = false;
                const outText = crashState.cashOutMult.toFixed(2) + 'x';
                multEl.textContent = outText;
                multEl.classList.add('won');
                if (multCenter) { multCenter.textContent = outText; multCenter.classList.add('won'); }
                const gain = Math.floor(crashState.stake * crashState.cashOutMult);
                statusEl.textContent = 'Gagn√© ! +' + gain + ' ARCANA';
                if (btn) { btn.textContent = 'Parier'; btn.classList.remove('cash-out'); btn.disabled = false; }
                if (window.crashRecentBets == null) window.crashRecentBets = [];
                window.crashRecentBets.unshift({ game: 'Crash', player: userAddress || '0x...', mise: crashState.stake, multiplier: crashState.cashOutMult.toFixed(2), win: true, gain });
                updateRecentBets();
                return;
            }

            if (mult >= crashState.crashPoint) {
                crashState.running = false;
                crashState.points.push(crashState.crashPoint);
                drawCrashCurve(canvas, crashState.points, true, mult, crashState.crashPoint);
                const crashText = crashState.crashPoint.toFixed(2) + 'x';
                multEl.textContent = crashText;
                multEl.classList.add('crashed');
                if (multCenter) { multCenter.textContent = crashText; multCenter.classList.add('crashed'); }
                statusEl.textContent = 'Crash ! Vous avez perdu ' + crashState.stake + ' ARCANA.';
                if (btn) { btn.textContent = 'Parier'; btn.classList.remove('cash-out'); btn.disabled = false; }
                if (window.crashRecentBets == null) window.crashRecentBets = [];
                window.crashRecentBets.unshift({ game: 'Crash', player: userAddress || '0x...', mise: crashState.stake, multiplier: '0.00', win: false, gain: 0 });
                updateRecentBets();
                return;
            }

            crashState.animId = requestAnimationFrame(tickCrash);
        }

        function startCrashRound() {
            const stakeInput = document.getElementById('crashStakeInput');
            const btn = document.getElementById('crashBetBtn');
            const statusEl = document.getElementById('crashStatus');
            const multEl = document.getElementById('crashMultDisplay');
            const stake = Math.floor(parseFloat(stakeInput?.value, 10) || 0);
            if (stake < 1) {
                Swal.fire({ icon: 'warning', title: 'Mise invalide', text: 'Entrez une mise d\'au moins 1 ARCANA.' });
                return;
            }
            if (crashState.running) return;
            crashState = {
                running: true,
                startTime: Date.now(),
                crashPoint: getSecureCrashPoint(),
                stake,
                cashedOut: false,
                cashOutMult: 0,
                animId: 0,
                points: [1]
            };
            const initMult = '1.00x';
            multEl.textContent = initMult;
            multEl.classList.remove('crashed', 'won');
            const multCenter = document.getElementById('crashMultCenter');
            if (multCenter) { multCenter.textContent = initMult; multCenter.classList.remove('crashed', 'won'); }
            statusEl.textContent = 'La courbe monte‚Ä¶ cliquez sur Cash Out avant le crash !';
            if (btn) { btn.textContent = 'Cash Out'; btn.classList.add('cash-out'); btn.disabled = false; }
            crashState.animId = requestAnimationFrame(tickCrash);
        }

        function cashOutCrash() {
            if (!crashState.running || crashState.cashedOut) return;
            const elapsed = (Date.now() - crashState.startTime) / 1000;
            const mult = 1 + (crashState.crashPoint - 1) * (1 - Math.exp(-elapsed * 1000 / CRASH_TAU_MS));
            if (mult >= crashState.crashPoint) return;
            crashState.cashedOut = true;
            crashState.cashOutMult = mult;
        }

        /* ----- Appels Smart Contract Crash / Keno (ethers.js) ‚Äî actifs une fois les contrats d√©ploy√©s ----- */
        function getCrashContract() {
            if (!ARCANA_CRASH_ADDRESS || !signer) return null;
            try {
                return new ethers.Contract(ARCANA_CRASH_ADDRESS, ARCANA_CRASH_ABI, signer);
            } catch (e) { return null; }
        }
        function getKenoContract() {
            if (!ARCANA_KENO_ADDRESS || !signer) return null;
            try {
                return new ethers.Contract(ARCANA_KENO_ADDRESS, ARCANA_KENO_ABI, signer);
            } catch (e) { return null; }
        }
        async function contractCrashPlaceBet(amountWei) {
            const c = getCrashContract();
            if (!c) return { success: false };
            try {
                const token = new ethers.Contract(ARCANA_TOKEN_ADDRESS, ARCANA_TOKEN_ABI, signer);
                await token.approve(ARCANA_CRASH_ADDRESS, amountWei);
                const tx = await c.placeBet(amountWei);
                await tx.wait();
                const roundId = tx.events?.find(e => e.event === 'BetPlaced')?.args?.roundId;
                return { success: true, roundId: roundId != null ? roundId.toString() : null };
            } catch (e) {
                console.warn('[Arcana] contractCrashPlaceBet:', e);
                return { success: false, error: e.message };
            }
        }
        async function contractCrashCashOut(roundId) {
            const c = getCrashContract();
            if (!c) return { success: false };
            try {
                const tx = await c.cashOut(ethers.BigNumber.from(roundId));
                await tx.wait();
                const payout = tx.events?.find(e => e.event === 'CashOut')?.args?.payout;
                return { success: true, payout: payout ? payout.toString() : null };
            } catch (e) {
                console.warn('[Arcana] contractCrashCashOut:', e);
                return { success: false, error: e.message };
            }
        }
        async function contractKenoPlay(amountWei, selectedNumbers) {
            const c = getKenoContract();
            if (!c) return { success: false };
            try {
                const token = new ethers.Contract(ARCANA_TOKEN_ADDRESS, ARCANA_TOKEN_ABI, signer);
                await token.approve(ARCANA_KENO_ADDRESS, amountWei);
                const tx = await c.play(amountWei, selectedNumbers);
                await tx.wait();
                const roundId = tx.events?.find(e => e.event === 'KenoPlayed')?.args?.roundId;
                return { success: true, roundId: roundId != null ? roundId.toString() : null };
            } catch (e) {
                console.warn('[Arcana] contractKenoPlay:', e);
                return { success: false, error: e.message };
            }
        }

        /* ----- Jeu Plinko ----- */
        const PLINKO_ROWS = 11;
        const PLINKO_MULTIPLIERS = [0.5, 1, 0.5, 2, 1, 5, 10, 5, 1, 2, 0.5, 1];
        let plinkoDropping = false;
        let plinkoPinPositions = [];
        let plinkoSlotPositions = [];

        function getSecurePlinkoBit() {
            const buf = new Uint8Array(1);
            crypto.getRandomValues(buf);
            return (buf[0] & 1) === 1;
        }

        function initPlinkoBoard() {
            const board = document.getElementById('plinkoBoard');
            const pinsContainer = document.getElementById('plinkoPinsContainer');
            const slotsContainer = document.getElementById('plinkoSlotsContainer');
            if (!board || !pinsContainer || !slotsContainer) return;
            const boardRect = () => board.getBoundingClientRect();
            const W = 520;
            const H = 320;
            const slotCount = PLINKO_ROWS + 1;
            plinkoPinPositions = [];
            plinkoSlotPositions = [];
            pinsContainer.innerHTML = '';
            slotsContainer.innerHTML = '';
            const dy = (H - 60) / (PLINKO_ROWS + 1);
            for (let r = 0; r < PLINKO_ROWS; r++) {
                const numPins = r + 1;
                const y = 24 + dy * (r + 0.5);
                for (let c = 0; c < numPins; c++) {
                    const x = (W * (c + 1)) / (numPins + 1);
                    plinkoPinPositions.push({ x, y, row: r, col: c });
                    const pin = document.createElement('div');
                    pin.className = 'plinko-pin';
                    pin.style.left = (100 * x / W) + '%';
                    pin.style.top = (100 * y / H) + '%';
                    pinsContainer.appendChild(pin);
                }
            }
            const slotWidth = W / slotCount;
            for (let k = 0; k < slotCount; k++) {
                const mult = PLINKO_MULTIPLIERS[k];
                const x = slotWidth * (k + 0.5);
                const leftPct = 100 * (slotWidth * k) / W;
                const widthPct = 100 * slotWidth / W;
                plinkoSlotPositions.push({ x, leftPct, widthPct, mult });
                const slot = document.createElement('div');
                slot.className = 'plinko-slot mult-' + (mult === 0.5 ? '05' : String(mult).replace('.', ''));
                slot.style.left = leftPct + '%';
                slot.style.width = widthPct + '%';
                slot.textContent = mult + 'x';
                slotsContainer.appendChild(slot);
            }
        }

        function getPlinkoPath() {
            const path = [{ row: -0.5, col: 0, x: 50, y: 2 }];
            let col = 0;
            const W = 520;
            const H = 320;
            const dy = (H - 60) / (PLINKO_ROWS + 1);
            for (let r = 0; r < PLINKO_ROWS; r++) {
                const goRight = getSecurePlinkoBit();
                if (goRight) col++;
                const numPins = r + 1;
                const y = 24 + dy * (r + 1.5);
                const xPct = (100 * (col + 0.5)) / (r + 2);
                path.push({ row: r, col, x: xPct, y: (100 * y / H) });
            }
            const slotWidth = 100 / (PLINKO_ROWS + 1);
            path.push({ row: PLINKO_ROWS, col, x: slotWidth * (col + 0.5), y: 100 - (36 / H) * 100 / 2 });
            return path;
        }

        function updatePlinkoBalanceDisplay() {
            const el = document.getElementById('plinkoBalanceDisplay');
            if (!el) return;
            const fromUI = typeof userClaimableBalance !== 'undefined' && userAddress ? userClaimableBalance : null;
            const base = window.plinkoDisplayBalance != null ? window.plinkoDisplayBalance : (fromUI != null ? fromUI : null);
            if (base != null) el.textContent = Number(base).toLocaleString('fr-FR', { maximumFractionDigits: 0 });
            else {
                const arcanaEl = document.getElementById('balanceDisplayArcana');
                el.textContent = arcanaEl ? arcanaEl.innerText : '‚Äî';
            }
        }

        async function dropPlinkoBall() {
            const stakeInput = document.getElementById('plinkoStakeInput');
            const btn = document.getElementById('plinkoDropBtn');
            const resultEl = document.getElementById('plinkoResult');
            const ball = document.getElementById('plinkoBall');
            const board = document.getElementById('plinkoBoard');
            if (!board || !ball) return;
            const stake = Math.floor(parseFloat(stakeInput?.value, 10) || 0);
            if (stake < 1) {
                Swal.fire({ icon: 'warning', title: 'Mise invalide', text: 'Entrez une mise d\'au moins 1 ARCANA.' });
                return;
            }
            if (plinkoDropping) return;
            plinkoDropping = true;
            if (btn) btn.disabled = true;
            resultEl.textContent = '';
            const path = getPlinkoPath();
            ball.style.display = 'block';
            ball.classList.add('dropping');
            ball.style.left = path[0].x + '%';
            ball.style.top = path[0].y + '%';
            const step = (i) => {
                if (i >= path.length) {
                    const last = path[path.length - 1];
                    const mult = PLINKO_MULTIPLIERS[last.col];
                    const gain = Math.floor(stake * mult);
                    ball.classList.remove('dropping');
                    plinkoDropping = false;
                    if (btn) btn.disabled = false;
                    resultEl.textContent = mult + 'x ‚Üí ' + (gain >= stake ? 'Gagn√© +' + gain + ' ARCANA' : 'Perdu ' + (stake - gain) + ' ARCANA');
                    resultEl.style.color = gain >= stake ? '#34d399' : '#9ca3af';
                    if (window.plinkoDisplayBalance == null && typeof userClaimableBalance !== 'undefined') window.plinkoDisplayBalance = userClaimableBalance;
                    if (window.plinkoDisplayBalance != null) window.plinkoDisplayBalance = (window.plinkoDisplayBalance || 0) + (gain - stake);
                    updatePlinkoBalanceDisplay();
                    if (window.plinkoRecentBets == null) window.plinkoRecentBets = [];
                    window.plinkoRecentBets.unshift({ game: 'Plinko', player: userAddress || '0x...', mise: stake, multiplier: String(mult), win: gain >= stake, gain: gain >= stake ? gain : 0 });
                    updateRecentBets();
                    return;
                }
                ball.style.left = path[i].x + '%';
                ball.style.top = path[i].y + '%';
                setTimeout(() => step(i + 1), i === 0 ? 80 : 180);
            };
            step(1);
        }

        /* ----- Jeu Keno ----- */
        const KENO_PAYOUT = [0, 0, 1, 2, 5, 15, 50, 100, 250, 400, 500];
        const KENO_MAX_SELECT = 10;
        let kenoDrawing = false;

        function initKenoGrid() {
            const grid = document.getElementById('kenoGrid');
            if (!grid) return;
            grid.innerHTML = '';
            for (let n = 1; n <= 40; n++) {
                const cell = document.createElement('button');
                cell.type = 'button';
                cell.className = 'keno-num';
                cell.dataset.num = String(n);
                cell.textContent = n;
                cell.addEventListener('click', () => {
                    if (kenoDrawing) return;
                    const selected = grid.querySelectorAll('.keno-num.selected');
                    if (cell.classList.contains('selected')) {
                        cell.classList.remove('selected');
                    } else if (selected.length < KENO_MAX_SELECT) {
                        cell.classList.add('selected');
                    }
                });
                grid.appendChild(cell);
            }
        }

        function initKenoPayoutTable() {
            const tbody = document.getElementById('kenoPayoutBody');
            if (!tbody) return;
            tbody.innerHTML = KENO_PAYOUT.map((mult, hits) => '<tr><td>' + hits + '</td><td>x' + mult + '</td></tr>').join('');
        }

        function getSecureKenoDraw() {
            const pool = [];
            for (let i = 1; i <= 40; i++) pool.push(i);
            const buf = new Uint8Array(2);
            for (let i = 39; i >= 30; i--) {
                crypto.getRandomValues(buf);
                const j = i - Math.floor((buf[0] * 256 + buf[1]) % (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            return pool.slice(30, 40).sort((a, b) => a - b);
        }

        async function runKenoDraw() {
            const grid = document.getElementById('kenoGrid');
            const drawArea = document.getElementById('kenoDrawArea');
            const resultEl = document.getElementById('kenoResult');
            const btn = document.getElementById('kenoDrawBtn');
            const stakeInput = document.getElementById('kenoStakeInput');
            if (!grid || !drawArea) return;
            const selected = Array.from(grid.querySelectorAll('.keno-num.selected')).map(el => parseInt(el.dataset.num, 10));
            if (selected.length < 1) {
                Swal.fire({ icon: 'warning', title: 'S√©lection requise', text: 'Choisissez au moins 1 num√©ro (jusqu\'√† 10).' });
                return;
            }
            const stake = Math.floor(parseFloat(stakeInput?.value, 10) || 0);
            if (stake < 1) {
                Swal.fire({ icon: 'warning', title: 'Mise invalide', text: 'Mise d\'au moins 1 ARCANA.' });
                return;
            }
            if (kenoDrawing) return;
            kenoDrawing = true;
            if (btn) btn.disabled = true;
            drawArea.innerHTML = '';
            resultEl.textContent = '';
            grid.querySelectorAll('.keno-num').forEach(cell => { cell.classList.remove('hit'); });
            const drawn = getSecureKenoDraw();
            const selectedSet = new Set(selected);

            for (let i = 0; i < drawn.length; i++) {
                await new Promise(r => setTimeout(r, 350));
                const num = drawn[i];
                const ball = document.createElement('div');
                ball.className = 'keno-ball';
                ball.textContent = num;
                drawArea.appendChild(ball);
                const cell = grid.querySelector('.keno-num[data-num="' + num + '"]');
                if (cell && cell.classList.contains('selected')) cell.classList.add('hit');
            }

            const matches = drawn.filter(n => selectedSet.has(n)).length;
            const mult = KENO_PAYOUT[Math.min(matches, 10)];
            const gain = Math.floor(stake * mult);
            resultEl.textContent = matches + ' bon(s) num√©ro(s) ‚Üí x' + mult + ' = ' + (gain > 0 ? '+' + gain + ' ARCANA' : '0 ARCANA');
            resultEl.style.color = gain > 0 ? '#34d399' : '#9ca3af';

            if (window.plinkoDisplayBalance == null && typeof userClaimableBalance !== 'undefined') window.plinkoDisplayBalance = userClaimableBalance;
            if (window.plinkoDisplayBalance != null) window.plinkoDisplayBalance = (window.plinkoDisplayBalance || 0) + (gain - stake);
            if (document.getElementById('plinkoBalanceDisplay')) updatePlinkoBalanceDisplay();

            if (window.kenoRecentBets == null) window.kenoRecentBets = [];
            window.kenoRecentBets.unshift({ game: 'Keno', player: userAddress || '0x...', mise: stake, multiplier: String(mult), win: gain > 0, gain });
            updateRecentBets();

            kenoDrawing = false;
            if (btn) btn.disabled = false;
        }

        function maskAddress(addr) {
            if (!addr || typeof addr !== 'string') return '0x...???';
            const a = addr.startsWith('0x') ? addr.slice(2) : addr;
            if (a.length < 8) return '0x...' + a.slice(-3);
            return '0x' + a.slice(0, 4) + '...' + a.slice(-3);
        }

        const GAME_NAMES = { slots: 'Arcana Slots', crash: 'Crash', plinko: 'Plinko', mines: 'Mines', roulette: 'Roulette Arcane' };

        function updateRecentBets() {
            const tbody = document.getElementById('recentBetsBody');
            if (!tbody) return;
            const bets = getRecentBets();
            tbody.innerHTML = bets.map(b => {
                const winClass = b.win ? 'bet-win' : 'bet-loss';
                const gainText = b.win ? '+' + b.gain + ' ARCANA' : '-' + b.mise + ' ARCANA';
                const multDisplay = (b.multiplier + '').replace(/x$/i, '') + 'x';
                return '<tr><td>' + b.game + '</td><td class="font-mono text-xs">' + maskAddress(b.player) + '</td><td>' + b.mise + ' ARCANA</td><td>' + multDisplay + '</td><td class="' + winClass + '">' + gainText + '</td></tr>';
            }).join('');
        }

        function getRecentBets() {
            const crashBets = (window.crashRecentBets || []).slice(0, 10);
            const plinkoBets = (window.plinkoRecentBets || []).slice(0, 10);
            const kenoBets = (window.kenoRecentBets || []).slice(0, 10);
            let rest;
            if (typeof window.getRecentBetsFromContract === 'function') {
                try { rest = window.getRecentBetsFromContract(); } catch (e) { rest = getSimulatedRecentBets(); }
            } else rest = getSimulatedRecentBets();
            return [...kenoBets, ...plinkoBets, ...crashBets, ...rest].slice(0, 15);
        }

        function getSimulatedRecentBets() {
            return [
                { game: 'Arcana Slots', player: '0x742d35Cc6634C0532925a3b844Bc9e7595f8b123', mise: 50, multiplier: '2.40x', win: true, gain: 120 },
                { game: 'Crash', player: '0x8Ba1f109551bD432803012645Ac136ddd64DBA72', mise: 100, multiplier: '0.00x', win: false, gain: 0 },
                { game: 'Plinko', player: '0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984', mise: 25, multiplier: '3.00x', win: true, gain: 75 },
                { game: 'Mines', player: '0x29D61511C84E332635E296e37bf22Eb4fB514147', mise: 10, multiplier: '1.50x', win: true, gain: 15 },
                { game: 'Roulette Arcane', player: '0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9', mise: 200, multiplier: '0.00x', win: false, gain: 0 },
                { game: 'Arcana Slots', player: '0xDeF1CA82fb16540756739f5398b8e8f2a5a7a123', mise: 20, multiplier: '5.00x', win: true, gain: 100 },
                { game: 'Crash', player: '0x6B175474E89094C44Da98b954EedeAC495271d0F', mise: 75, multiplier: '1.85x', win: true, gain: 139 },
                { game: 'Plinko', player: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', mise: 15, multiplier: '0.00x', win: false, gain: 0 },
                { game: 'Mines', player: '0xdAC17F958D2ee523a2206206994597C13D831ec7', mise: 30, multiplier: '2.00x', win: true, gain: 60 },
                { game: 'Roulette Arcane', player: '0x9f8F72aA9304c8B593d555F12eF6589cC3A579A2', mise: 40, multiplier: '0.00x', win: false, gain: 0 }
            ];
        }

        async function approveArcanaSlot() {
            if (!window.ethereum || !userAddress) {
                Swal.fire({ icon: 'info', title: 'Connexion requise', text: 'Connectez votre wallet pour approuver.' });
                return;
            }
            const stakeInput = document.getElementById('slotStakeInput');
            const amount = (parseInt(stakeInput?.value, 10) || 10) * 1e18;
            const approveBtn = document.getElementById('slotApproveBtn');
            if (!approveBtn) return;
            approveBtn.disabled = true;
            approveBtn.textContent = 'Approve...';
            try {
                const ethersLib = window.ethers;
                if (!ethersLib) throw new Error('ethers non charg√©');
                const provider = new ethersLib.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const tokenContract = new ethersLib.Contract(ARCANA_TOKEN_ADDRESS, ['function approve(address spender, uint256 amount) returns (bool)'], signer);
                const tx = await tokenContract.approve(PRESALE_VAULT, ethersLib.BigNumber.from(amount.toString()));
                await tx.wait();
                slotApproved = true;
                Swal.fire({ icon: 'success', title: 'Approuv√©', text: 'Vous pouvez lancer le spin.' });
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Erreur', text: e.message || 'Approve √©chou√©.' });
            } finally {
                approveBtn.disabled = false;
                approveBtn.textContent = 'Approve ARCANA';
            }
        }

        window.addEventListener('load', () => {
            if (typeof window === 'undefined') {
                console.error("[Arcana] window non disponible");
                return;
            }
            if (!window.ethers) {
                console.error("[Arcana] ethers non charg√© ‚Äî v√©rifiez que le script CDN ethers est pr√©sent avant ce script");
                return;
            }
            if (!window.ethers.providers || !window.ethers.utils) {
                console.error("[Arcana] ethers incomplet (providers ou utils manquant)");
                return;
            }

            try {
                const connectBtn = document.getElementById('connectBtn');
                const withdrawBtn = document.getElementById('withdrawBtn');
                const claimBtn = document.getElementById('claimBtn');
                const buyBtn = document.getElementById('buyBtn');
                const ctaInvest = document.getElementById('cta-invest');
                const copyAddressBtn = document.getElementById('copyAddressBtn');
                const amountInput = document.getElementById('amountInput');
                const tokenSelect = document.getElementById('tokenSelect');
                if (!connectBtn || !withdrawBtn) {
                    console.error("[Arcana] √âl√©ments DOM manquants (connectBtn ou withdrawBtn)");
                    return;
                }
                connectBtn.onclick = connect;
                withdrawBtn.onclick = withdraw;
                if (claimBtn) claimBtn.onclick = claim;
                if (buyBtn) buyBtn.onclick = buyNow;
                if (ctaInvest) ctaInvest.onclick = investDirect;
                const slotSpinBtn = document.getElementById('slotSpinBtn');
                const slotApproveBtn = document.getElementById('slotApproveBtn');
                if (slotSpinBtn) slotSpinBtn.onclick = spin;
                if (slotApproveBtn) slotApproveBtn.onclick = approveArcanaSlot;
                document.getElementById('casino-section')?.addEventListener('click', (e) => {
                    const btn = e.target.closest('.casino-game-card-play-btn');
                    if (!btn) return;
                    const game = btn.getAttribute('data-game');
                    if (game === 'slots') {
                        document.getElementById('casino-slots-block')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (game === 'crash') {
                        document.getElementById('casino-crash-block')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (game === 'plinko') {
                        document.getElementById('casino-plinko-block')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (game === 'keno') {
                        document.getElementById('casino-keno-block')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        if (window.Swal) Swal.fire({ icon: 'info', title: 'Bient√¥t disponible', text: 'Ce jeu sera disponible prochainement.' });
                    }
                });
                const crashBetBtn = document.getElementById('crashBetBtn');
                if (crashBetBtn) {
                    crashBetBtn.addEventListener('click', () => {
                        if (crashState.running) cashOutCrash();
                        else startCrashRound();
                    });
                }
                initPlinkoBoard();
                const plinkoDropBtn = document.getElementById('plinkoDropBtn');
                if (plinkoDropBtn) plinkoDropBtn.addEventListener('click', dropPlinkoBall);
                updatePlinkoBalanceDisplay();
                initKenoGrid();
                initKenoPayoutTable();
                const kenoDrawBtn = document.getElementById('kenoDrawBtn');
                if (kenoDrawBtn) kenoDrawBtn.addEventListener('click', runKenoDraw);
                if (copyAddressBtn) {
                    copyAddressBtn.onclick = () => {
                        const addr = document.getElementById('receptionAddress').textContent;
                        navigator.clipboard.writeText(addr).then(() => { copyAddressBtn.textContent = 'Copi√© !'; setTimeout(() => { copyAddressBtn.textContent = 'Copier'; }, 2000); }).catch(() => Swal.fire({ icon: 'info', title: 'Copie', text: 'Copiez manuellement : ' + addr }));
                    };
                }
                const addArcanaBtn = document.getElementById('addArcanaMetaMaskBtn');
                if (addArcanaBtn) {
                    addArcanaBtn.onclick = async () => {
                        if (!window.ethereum) {
                            Swal.fire({ icon: 'warning', title: 'MetaMask requis', text: 'Installez MetaMask pour ajouter le token.' });
                            return;
                        }
                        try {
                            const added = await window.ethereum.request({
                                method: 'wallet_watchAsset',
                                params: {
                                    type: 'ERC20',
                                    options: {
                                        address: ARCANA_TOKEN_ADDRESS,
                                        symbol: 'ARCANA',
                                        decimals: 18
                                    }
                                }
                            });
                            if (added) {
                                Swal.fire({ icon: 'success', title: 'Token ajout√©', text: 'ARCANA a √©t√© ajout√© √† votre wallet MetaMask.' });
                            }
                        } catch (e) {
                            Swal.fire({ icon: 'error', title: 'Erreur', text: e.message || 'Impossible d\'ajouter le token.' });
                        }
                    };
                }
                if (amountInput) {
                    amountInput.addEventListener('input', updateReceiveText);
                    amountInput.addEventListener('keyup', updateReceiveText);
                }
                if (tokenSelect) tokenSelect.addEventListener('change', updateReceiveText);
            } catch (e) {
                console.error("[Arcana] Erreur lors de la connexion des boutons:", e);
                return;
            }

            updateUI().catch(e => console.error("[Arcana] Erreur updateUI au chargement:", e));
            setInterval(() => { updateUI().catch(e => console.warn("[Arcana] updateUI interval:", e)); }, 8000);
            updateRecentBets();

            fetch(RENDER_URL + "/api/presale-status", { cache: 'no-store' }).then(r => r.text()).then(() => {}).catch(e => console.error("[Arcana] API presale-status inaccessible (serveur en veille?):", e.message));

            console.log("Syst√®me Arcana pr√™t");
        });
    </script>
</body>
</html>