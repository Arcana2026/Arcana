<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcana - Banque NumÃ©rique</title>
    <style>
        :root { --gold: #d4af37; --dark: #1a1a1a; --white: #ffffff; }
        body { background-color: var(--dark); color: var(--white); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 50px; }
        .container { border: 2px solid var(--gold); padding: 30px; border-radius: 20px; display: inline-block; background: rgba(255, 255, 255, 0.05); box-shadow: 0 0 20px rgba(212, 175, 55, 0.2); }
        h1 { color: var(--gold); font-size: 3em; margin-bottom: 10px; }
        .balance-box { margin: 20px 0; padding: 15px; border-bottom: 1px solid var(--gold); }
        .amount { font-size: 2.5em; color: var(--gold); font-weight: bold; }
        button { background: var(--gold); color: var(--dark); border: none; padding: 15px 30px; font-size: 1.2em; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 10px; transition: transform 0.2s; }
        button:hover { transform: scale(1.05); background: #f1c40f; }
        .status { color: #888; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ARCANA</h1>
        <p>Le Coffre-fort NumÃ©rique</p>

        <div class="balance-box">
            <p>RÃ‰SERVE TOTALE DU COFFRE</p>
            <div class="amount"><span id="vaultBalance">900 000 000</span></div>
            <p>ARCANA</p>
        </div>

        <div class="balance-box">
            <p>VOTRE PORTEFEUILLE</p>
            <div class="amount" style="font-size: 1.5em;"><span id="userBalance">0</span> ARC</div>
        </div>

        <button id="connectBtn">ðŸ”— CONNECTER METAMASK</button><br>
        <button id="withdrawBtn" style="display:none;">ðŸ¥‚ CHAMPAGNE (RETRAIT 10k)</button>

        <p class="status" id="walletAddr">Non connectÃ©</p>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>

    <script>
        // CONFIGURATION
        const contractAddress = "0x29D8898950882798e36e65B150A6c7a723821141";
        const contractABI = [
            "function withdraw(uint256 amount, uint256 nonce, bytes memory signature)",
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        let userAddress;
        let provider;
        let signer;

        // FONCTION DE CONNEXION
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    document.getElementById('walletAddr').innerText = "ConnectÃ© : " + userAddress;
                    document.getElementById('connectBtn').style.display = 'none';
                    document.getElementById('withdrawBtn').style.display = 'inline-block';
                    
                    updateBalances();
                } catch (err) {
                    console.error(err);
                    alert("Erreur de connexion");
                }
            } else {
                alert("Veuillez installer MetaMask !");
            }
        }

        // MISE Ã€ JOUR DES SOLDES (900M et Utilisateur)
        async function updateBalances() {
            const contract = new ethers.Contract(contractAddress, contractABI, provider);
            try {
                // On lit le solde du contrat lui-mÃªme
                const vBal = await contract.balanceOf(contractAddress);
                document.getElementById('vaultBalance').innerText = Number(ethers.utils.formatUnits(vBal, 18)).toLocaleString();

                // On lit le solde de l'utilisateur
                const uBal = await contract.balanceOf(userAddress);
                document.getElementById('userBalance').innerText = Number(ethers.utils.formatUnits(uBal, 18)).toLocaleString();
            } catch (err) {
                console.error("Erreur de lecture :", err);
            }
        }

        // FONCTION DE RETRAIT (COMMUNICATION AVEC CUBA)
        async function withdrawTokens() {
            try {
                // 1. Appel au serveur Node.js (Cuba)
                const response = await fetch('http://localhost:3000/api/sign-withdrawal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        address: userAddress, 
                        amount: "10000" 
                    })
                });
                
                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                // 2. Envoi de la signature Ã  la Blockchain
                const contract = new ethers.Contract(contractAddress, contractABI, signer);
                const tx = await contract.withdraw(
                    ethers.utils.parseUnits(data.amount, 18), 
                    data.nonce, 
                    data.signature
                );

                alert("ðŸš€ Sabrage en cours... Patientez !");
                await tx.wait(); // Attente de la validation Polygon

                alert("ðŸ¥‚ CHAMPAGNE ! 10 000 ARCANA livrÃ©s !");
                updateBalances();
            } catch (err) {
                console.error(err);
                alert("Erreur : " + (err.data?.message || err.message));
            }
        }

        // Ã‰vÃ©nements
        document.getElementById('connectBtn').addEventListener('click', connectWallet);
        document.getElementById('withdrawBtn').addEventListener('click', withdrawTokens);
    </script>
</body>
</html>