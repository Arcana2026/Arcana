<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCANA ‚Äî The Vault</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #D4AF37; --gold-glow: rgba(212, 175, 55, 0.4); --bg-dark: #05070a; }
        body {
            background-color: var(--bg-dark); color: #F7E7CE; font-family: 'Inter', sans-serif; margin: 0;
            background-image: radial-gradient(circle at 50% 50%, #0a111a 0%, #05070a 100%);
        }
        .font-prestige { font-family: 'Cinzel', serif; }

        /* Interface Vault Premium */
        .glass-vault {
            background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(212, 175, 55, 0.25); border-radius: 40px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.7), inset 0 0 30px rgba(212, 175, 55, 0.05);
        }

        .btn-prestige {
            background: linear-gradient(135deg, #D4AF37, #B8860B); color: #000; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px; transition: all 0.4s ease;
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.2); border: none;
        }

        .btn-prestige:hover { transform: translateY(-3px); box-shadow: 0 15px 30px var(--gold-glow); }

        /* Effets interactifs : .btn-connect et .rune-btn */
        .btn-connect, .rune-btn {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .btn-connect:hover:not([disabled]):not(.disabled),
        .rune-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--gold);
            cursor: pointer;
        }
        .btn-connect:active:not([disabled]):not(.disabled),
        .rune-btn:active:not(:disabled) {
            transform: scale(0.95);
        }
        /* Shimmer cyclique sur le bouton .btn-connect principal */
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        .btn-connect {
            position: relative;
            overflow: hidden;
        }
        .btn-connect::after {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 0;
            width: 40%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent);
            animation: shimmer 3s ease-in-out infinite;
            pointer-events: none;
        }

        /* Barre de Progression N√©on */
        .progress-track { background: rgba(255, 255, 255, 0.05); height: 12px; border-radius: 50px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .progress-fill { background: linear-gradient(90deg, #00ffcc, #00d4aa); box-shadow: 0 0 20px rgba(0, 255, 204, 0.6); transition: width 1.5s ease-in-out; }

        /* Livre Blanc D√©roulant Transparent */
        .whitepaper-dropdown {
            background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 15px; overflow-y: auto; transition: all 0.5s ease;
            max-height: 0; opacity: 0; backdrop-filter: blur(10px);
        }
        .whitepaper-dropdown.open { max-height: 400px; opacity: 1; padding: 25px; margin-top: 20px; }

        /* Guide Poche (Widget Flottant) */
        #guide-poche { position: fixed; bottom: 30px; right: 30px; z-index: 1000; }
        .pouch-window { position: absolute; bottom: 85px; right: 0; width: 280px; display: none; padding: 25px; }
        .pouch-window.active { display: block; animation: slideUp 0.4s ease; }
        
        .trust-icon-box {
            background: rgba(0, 0, 0, 0.4); border: 1px solid var(--gold); width: 70px; height: 70px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;
            box-shadow: 0 0 15px var(--gold-glow); font-size: 24px;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Ic√¥ne d'entr√©e Sanctuaire ‚Äî fix√©e en bas, style rune lumineuse, large pour mobile */
        .btn-sanctuary {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: min(320px, 90vw);
            width: max-content;
            padding: 1rem 2.5rem;
            min-height: 52px;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--gold);
            background: radial-gradient(ellipse at center, rgba(73, 202, 250, 0.15), rgba(5, 7, 10, 0.95));
            border: 2px solid var(--gold);
            border-radius: 50px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 0 25px rgba(73, 202, 250, 0.4), 0 8px 32px rgba(0, 0, 0, 0.6);
            animation: float-gentle 3s ease-in-out infinite;
        }
        .btn-sanctuary:hover {
            border-color: #49cafa;
            box-shadow: 0 0 40px rgba(73, 202, 250, 0.7), 0 0 70px rgba(73, 202, 250, 0.3), 0 8px 32px rgba(0, 0, 0, 0.5);
            color: #7dc8ff;
            transform: translateX(-50%) scale(1.05);
        }
        @keyframes float-gentle {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-6px); }
        }
    </style>
</head>
<body>

    <nav class="p-6 md:p-10 flex justify-between items-center max-w-7xl mx-auto">
        <div class="flex items-center gap-4">
            <img src="logo.png" class="w-12 h-12 md:w-16 md:h-16" style="filter: drop-shadow(0 0 10px var(--gold-glow));" alt="Arcana">
            <h1 class="font-prestige text-2xl md:text-3xl tracking-widest text-white">ARCANA <span class="text-[#D4AF37]">SAFE</span></h1>
        </div>
        <button id="connectWallet" onclick="connect()" class="btn-prestige px-8 py-2 rounded-full text-xs">
            CONNECT WALLET
        </button>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <a href="arcanagame.html" class="btn-sanctuary">ENTRER DANS LE SANCTUAIRE</a>
        <div class="glass-vault max-w-4xl mx-auto p-10 md:p-16 text-center">
            <h2 class="font-prestige text-4xl md:text-5xl mb-4 text-white tracking-[0.2em]">THE ARCANA VAULT</h2>
            <p class="text-gray-400 italic text-lg mb-12">Secure your financial future.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
                <div><div class="trust-icon-box">üõ°Ô∏è</div><p class="text-[9px] uppercase font-bold text-[#D4AF37]">Smart Contract Audited</p></div>
                <div><div class="trust-icon-box">üîç</div><p class="text-[9px] uppercase font-bold text-[#D4AF37]">Arcana Audit Verified</p></div>
                <div><div class="trust-icon-box">üîí</div><p class="text-[9px] uppercase font-bold text-[#D4AF37]">Liquidity Locked</p></div>
            </div>

            <div class="max-w-xl mx-auto mb-16">
                <div class="flex justify-between text-[10px] uppercase mb-3 opacity-70">
                    <span>Objectif : 1 200 000 $</span><span id="raisedAmt">Raised: 12,450 $</span>
                </div>
                <div class="progress-track"><div id="progressBar" class="progress-fill h-full" style="width: 1.04%"></div></div>
            </div>

            <div class="max-w-md mx-auto">
                <h3 class="font-prestige text-xs mb-6 tracking-widest text-[#D4AF37]">OFFICIAL ARCANA SALE</h3>
                <div class="flex gap-2 mb-4">
                    <select id="tokenSelect" class="bg-black/60 border border-white/10 p-4 rounded-xl text-xs uppercase text-white outline-none">
                        <option value="POL">POL</option>
                        <option value="USDT">USDT</option>
                        <option value="USDC">USDC</option>
                    </select>
                    <input type="text" id="amountInput" placeholder="AMOUNT ($)" class="flex-1 bg-black/60 border border-white/10 p-4 rounded-xl text-center text-white text-lg outline-none" inputmode="decimal" pattern="[0-9.]*" autocomplete="off">
                </div>
                <div id="estimationBox" class="mb-5 text-xs text-[#D4AF37] font-bold text-center tracking-wider select-none">Estimation : 0 ARCANA</div>
                <button onclick="buyNow()" class="btn-prestige w-full py-5 rounded-2xl text-xl">PURCHASE ARCANA</button>
                
                <button onclick="toggleWhitepaper()" class="mt-8 text-[#D4AF37] text-[10px] font-bold uppercase tracking-widest hover:underline">üìñ CONSULTER LE LIVRE BLANC</button>
                <div id="whitepaperBox" class="whitepaper-dropdown text-left text-[11px] leading-relaxed text-gray-300">
                    <!-- Le whitepaper complet est inject√© dynamiquement -->
                </div>
            </div>
            <script>
                // Taux fixe: prix par ARCANA
                const ARCANA_PRICE_USD = 0.0026;
                // Prix POL (sera mis √† jour dynamiquement)
                let pricePOL = 0.45;
                let lastPolPriceFetch = 0;
                let isFetchingPOL = false;

                // Fonction qui r√©cup√®re dynamiquement le prix POL via CoinGecko et MAJ le calculateur
                async function fetchPOLPrice() {
                    if (isFetchingPOL) return;
                    isFetchingPOL = true;
                    try {
                        // API CoinGecko pour POL
                        const response = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=polygon-ecosystem-token&vs_currencies=usd");
                        const data = await response.json();
                        const pol = parseFloat((data["polygon-ecosystem-token"]||{}).usd);
                        // fallback si la r√©ponse est mauvaise ou NaN
                        pricePOL = isNaN(pol) || pol === 0 ? 0.45 : pol;
                    } catch (e) {
                        pricePOL = 0.45;
                    }
                    lastPolPriceFetch = Date.now();
                    isFetchingPOL = false;
                    updateEstimation();
                }

                // Nettoyage du champ pour autoriser uniquement chiffres et point d√©cimal unique (FR ou US)
                function extractCleanAmount(val) {
                    if (!val) return '';
                    let clean = val.replace(/,/g, '.').replace(/[^0-9.]/g, '');
                    // Retirer les points multiples apr√®s le premier
                    let dotCount = (clean.match(/\./g) || []).length;
                    if (dotCount > 1) {
                        let first = clean.indexOf('.');
                        clean = clean.slice(0, first + 1) + clean.slice(first + 1).replace(/\./g, '');
                    }
                    return clean;
                }

                function updateEstimation() {
                    const inputElem = document.getElementById('amountInput');
                    let inputRaw = inputElem.value;

                    // Nettoyage imm√©diat du champ si besoin (pour que "500 pommes" --> "500")
                    const cleaned = extractCleanAmount(inputRaw);
                    if (inputRaw !== cleaned) {
                        // On ne d√©clenche le caret/cursor reset que si modifi√©
                        inputElem.value = cleaned;
                        inputRaw = cleaned;
                    }

                    // Si le champ est vide ou le r√©sultat n'est pas un nombre positif
                    if (!inputRaw || isNaN(Number(inputRaw)) || Number(inputRaw) <= 0) {
                        document.getElementById('estimationBox').textContent = "Estimation : 0 ARCANA";
                        return;
                    }
                    const amount = Number(inputRaw);

                    const tokenSelected = document.getElementById('tokenSelect').value;
                    let tokenPrice = 1.00;
                    if (tokenSelected === "POL") {
                        tokenPrice = pricePOL;
                    }

                    // Formule¬†: (Montant net * Prix du jeton) / 0.0026
                    let estimation = (amount * tokenPrice) / ARCANA_PRICE_USD;
                    document.getElementById('estimationBox').textContent =
                        `Estimation : ${estimation.toLocaleString(undefined, {maximumFractionDigits:0})} ARCANA`;
                }

                document.getElementById('amountInput').addEventListener('input', updateEstimation);
                document.getElementById('tokenSelect').addEventListener('change', function() {
                    // Quand l'utilisateur s√©lectionne POL, on refait un fetch si >5min ou si jamais fetch
                    if (document.getElementById('tokenSelect').value === "POL") {
                        const now = Date.now();
                        if (now - lastPolPriceFetch > 1000 * 60 * 5 || !lastPolPriceFetch) {
                            fetchPOLPrice();
                        } else {
                            updateEstimation();
                        }
                    } else {
                        updateEstimation();
                    }
                });

                // --------- Progression Bar -----------
                const amountRaisedUsd = 12450; // <-- √Ä modifier dynamiquement en prod
                const hardcapUsd = 1200000; // Objectif final
                const progressPct = Math.min((amountRaisedUsd / hardcapUsd) * 100, 100);
                document.addEventListener('DOMContentLoaded', function () {
                    document.getElementById('progressBar').style.width = progressPct.toFixed(2) + '%';
                    document.getElementById('raisedAmt').textContent = 'Raised: ' + amountRaisedUsd.toLocaleString('en-US', {maximumFractionDigits:0}) + ' $';
                    // Au mounting initial si POL s√©lectionn√© on fetch direct + update
                    if (document.getElementById('tokenSelect').value === "POL") {
                        fetchPOLPrice();
                    } else {
                        updateEstimation();
                    }
                });
            </script>
    <div id="guide-poche">
        <div id="pouchWindow" class="glass-vault pouch-window">
            <h4 class="font-prestige text-[10px] text-[#D4AF37] mb-6 tracking-widest">GUIDE POCHE</h4>
            <div class="space-y-4">
                <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-[9px] opacity-60 uppercase">Wallet:</span><span id="pouchAddr" class="text-[9px] font-mono">Not Connected</span></div>
                <div class="text-[9px] opacity-60 uppercase mb-2 tracking-widest">Dashboard</div>
                <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-[9px] opacity-60 uppercase">Solde ARCANA:</span><span id="pouchArcana" class="font-bold text-[#D4AF37]">0</span></div>
                <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-[9px] opacity-60 uppercase">Profits (~$):</span><span id="pouchProfits" class="font-bold text-green-400">0</span></div>
                <div class="flex justify-between border-b border-white/5 pb-2"><span class="text-[9px] opacity-60 uppercase">USDC:</span><span id="pouchUsdc" class="font-bold text-white">0</span></div>
                <div class="flex justify-between"><span class="text-[9px] opacity-60 uppercase">POL (Gas):</span><span id="pouchPol" class="font-bold text-white">0</span></div>
                <div class="flex justify-between"><span class="text-[9px] opacity-60 uppercase">POL ($):</span><span id="pouchPolUsd" class="font-bold text-green-400">0</span></div>
            </div>
            <button onclick="retirerVault()" class="mt-4 w-full py-2 btn-prestige text-[9px] rounded-lg uppercase font-bold">üèß Fonction Retrait</button>
            <button onclick="location.reload()" class="mt-2 w-full py-2 border border-red-500/20 text-red-500 text-[9px] rounded-lg uppercase font-bold hover:bg-red-500/10 transition">Disconnect</button>
        </div>
        <div onclick="togglePouch()" class="w-16 h-16 bg-gradient-to-br from-[#D4AF37] to-[#B8860B] rounded-2xl flex items-center justify-center cursor-pointer shadow-2xl hover:scale-110 transition border border-white/20">
            <img src="logo.png" class="w-10 h-10 rounded-full" alt="Vault">
        </div>
    </div>

    <script>
        const PROJECT_ID = "8893d93707736e4f3586071930777991"; 
        const VAULT_ADDRESS = "0x29D61511C84E332635E296e37bf22Eb4fB514147";
        
        // Adresses officielles sur le r√©seau Polygon
        const TOKEN_ADDRESSES = {
            "USDT": "0xc2132D05D31c914a87C6611C10748AEb04B58e8F",
            "USDC": "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174"
        };

        // Interface minimale pour interagir avec les jetons (ERC20)
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function allowance(address owner, address spender) public view returns (uint256)",
            "function balanceOf(address account) public view returns (uint256)"
        ];

        // ABI du Vault ArcanaPresaleVault (0x29D6...5147)
        const VAULT_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function claim()",
            "function claimOpen() view returns (bool)",
            "function withdraw()"
        ];

        let provider, signer, account;

        async function connect() {
            // D√©tection robuste du wallet (PC & mobile)
            const getProvider = () => {
                if (window.ethereum) return window.ethereum;
                if (window.web3 && typeof window.web3.currentProvider !== 'undefined') return window.web3.currentProvider;
                return null;
            };

            let providerOrigin = getProvider();

            if (!providerOrigin && typeof window.addEventListener === 'function') {
                providerOrigin = await new Promise((resolve) => {
                    const check = () => {
                        const p = getProvider();
                        if (p) { resolve(p); return; }
                        setTimeout(() => resolve(getProvider()), 500);
                    };
                    check();
                });
            }

            if (providerOrigin) {
                try {
                    provider = new ethers.providers.Web3Provider(providerOrigin);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    account = await signer.getAddress();

                    const shortAddr = account.slice(0, 6) + "..." + account.slice(-4);
                    document.getElementById('connectWallet').innerText = shortAddr;
                    document.getElementById('pouchAddr').innerText = shortAddr;

                    updateBalances();
                    Swal.fire({ title: 'Vault Connect√©', icon: 'success', background: '#05070a', color: '#D4AF37' });
                } catch (e) {
                    console.error("Acc√®s refus√©", e);
                    Swal.fire({
                        title: 'Connexion refus√©e',
                        text: e.code === 4001 ? 'Vous avez annul√© la connexion.' : 'V√©rifiez que votre wallet est d√©verrouill√©.',
                        icon: 'warning',
                        background: '#05070a', color: '#D4AF37'
                    });
                }
            } else {
                Swal.fire({
                    title: 'Wallet introuvable',
                    text: 'Installez MetaMask ou un wallet Web3 compatible (Brave, Trust, etc.) sur votre ordinateur.',
                    icon: 'warning',
                    confirmButtonText: 'Installer MetaMask',
                    background: '#05070a', color: '#D4AF37'
                }).then((res) => {
                    if (res.isConfirmed) window.open('https://metamask.io/download/', '_blank');
                });
            }
        }

        // Obtenir le prix du POL (Mainnet) en USD via CoinGecko (CORS OK)
        async function getPOLPriceUsd() {
            try {
                const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=polygon-ecosystem-token&vs_currencies=usd");
                const data = await r.json();
                return parseFloat((data["polygon-ecosystem-token"]||{}).usd) || 0;
            } catch(e) {
                return 0;
            }
        }

        async function updateBalances() {
            if (!account) return;
            try {
                const polBalBN = await provider.getBalance(account);
                const polBal = parseFloat(ethers.utils.formatEther(polBalBN));
                document.getElementById('pouchPol').innerText = polBal.toFixed(3);

                // Conversion en $
                const polPrice = await getPOLPriceUsd();
                const displayPol = Math.abs(polBal - 39.874) < 0.001 ? 39.874 : polBal;
                const polUsd = polPrice * displayPol;
                document.getElementById('pouchPolUsd').innerText = polUsd ? polUsd.toLocaleString('en-US', {maximumFractionDigits:2}) : "0";

                // USDC sur Polygon (6 d√©cimales)
                const usdcContract = new ethers.Contract(TOKEN_ADDRESSES.USDC, ERC20_ABI, provider);
                const usdcBal = await usdcContract.balanceOf(account);
                document.getElementById('pouchUsdc').innerText = parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2);

                // Dashboard ‚Äî Solde ARCANA (claimable) et Profits depuis le vault 0x29D6...5147
                const vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, provider);
                const arcanaBal = await vaultContract.balanceOf(account);
                const arcanaFormatted = parseFloat(ethers.utils.formatEther(arcanaBal));
                document.getElementById('pouchArcana').innerText = arcanaFormatted.toLocaleString('fr-FR', { maximumFractionDigits: 2 });
                // Profits estim√©s = solde * prix (0.0026 $)
                const profitsUsd = arcanaFormatted * 0.0026;
                document.getElementById('pouchProfits').innerText = profitsUsd.toLocaleString('en-US', {maximumFractionDigits:2});
            } catch (e) { console.error(e); }
        }

        async function retirerVault() {
            if (!account) return connect();
            try {
                const vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);
                Swal.fire({ title: 'Retrait en cours...', text: 'Confirmez dans MetaMask', didOpen: () => Swal.showLoading() });
                const tx = await vaultContract.withdraw();
                await tx.wait();
                Swal.fire({ title: 'Retrait effectu√© !', text: 'La fonction withdraw() a bien √©t√© appel√©e sur le contrat 0x29D61511C84E332635E296e37bf22Eb4fB514147.', icon: 'success', background: '#05070a', color: '#D4AF37' });
                updateBalances();
            } catch (error) {
                console.error(error);
                Swal.fire({
                    title: 'Erreur',
                    text: error.message || 'Le retrait a √©chou√©. V√©rifiez le gas ou l\'√©ligibilit√©.',
                    icon: 'error',
                    background: '#05070a', color: '#D4AF37'
                });
            }
        }

        async function claimWithdraw() {
            if (!account) return connect();
            try {
                const vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);
                const isOpen = await vaultContract.claimOpen();
                if (!isOpen) {
                    return Swal.fire({
                        title: 'Claim ferm√©',
                        text: 'Le retrait ARCANA n\'est pas encore ouvert. Attendez l\'ouverture officielle.',
                        icon: 'info',
                        background: '#05070a', color: '#D4AF37'
                    });
                }
                const balance = await vaultContract.balanceOf(account);
                if (balance.isZero()) {
                    return Swal.fire({
                        title: 'Rien √† retirer',
                        text: 'Votre solde ARCANA claimable est de 0.',
                        icon: 'warning',
                        background: '#05070a', color: '#D4AF37'
                    });
                }
                Swal.fire({ title: 'Retrait en cours...', text: 'Confirmez dans MetaMask', didOpen: () => Swal.showLoading() });
                const tx = await vaultContract.claim();
                await tx.wait();
                Swal.fire({ title: 'Retrait r√©ussi !', text: 'Vos ARCANA ont √©t√© transf√©r√©s dans votre wallet.', icon: 'success', background: '#05070a', color: '#D4AF37' });
                updateBalances();
            } catch (error) {
                console.error(error);
                Swal.fire({
                    title: 'Erreur',
                    text: error.message || 'Le retrait a √©chou√©. V√©rifiez le gas.',
                    icon: 'error',
                    background: '#05070a', color: '#D4AF37'
                });
            }
        }

        async function buyNow() {
            if (!account) return connect();

            const rawAmount = document.getElementById('amountInput').value;
            // Utilise extractCleanAmount pour garantir le format c√¥t√© achat aussi
            const amount = Number(extractCleanAmount(rawAmount));
            const tokenSelected = document.getElementById('tokenSelect').value;

            if (isNaN(amount) || amount <= 0) {
                return Swal.fire('Montant invalide', 'Veuillez entrer un montant valide sup√©rieur √† 0.', 'warning');
            }

            try {
                // Conversion montant $ ‚Üí token natif (simplifi√© illustration)
                let decimals = 18;
                let amountToSend = amount;
                let tokenAddr = null;

                if (tokenSelected === "USDT" || tokenSelected === "USDC") {
                    decimals = 6;
                    tokenAddr = TOKEN_ADDRESSES[tokenSelected];
                }

                const amountWei = ethers.utils.parseUnits(amountToSend.toString(), decimals);

                if (tokenSelected === "POL") {
                    const tx = await signer.sendTransaction({
                        to: VAULT_ADDRESS,
                        value: amountWei
                    });
                    await tx.wait();
                    Swal.fire('Succ√®s !', `Achat de POL pour ${amount} $ effectu√©.`, 'success');
                }
                else {
                    // ACHAT AVEC USDT/USDC
                    const tokenContract = new ethers.Contract(tokenAddr, ERC20_ABI, signer);

                    Swal.fire({ title: 'V√©rification...', text: 'Autorisation du contrat en cours', didOpen: () => Swal.showLoading() });

                    const currentAllowance = await tokenContract.allowance(account, VAULT_ADDRESS);
                    if (currentAllowance.lt(amountWei)) {
                        const approveTx = await tokenContract.approve(VAULT_ADDRESS, amountWei);
                        await approveTx.wait();
                    }

                    Swal.fire({ title: 'Achat en cours...', text: `Envoi de ${tokenSelected} vers le Vault`, didOpen: () => Swal.showLoading() });

                    // Appeler la fonction d'achat (nom √† ajuster selon contrat: buyWithToken(address,uint256))
                    const vaultContract = new ethers.Contract(VAULT_ADDRESS, ["function buyWithToken(address token, uint256 amount) public"], signer);
                    const purchaseTx = await vaultContract.buyWithToken(tokenAddr, amountWei);
                    await purchaseTx.wait();

                    Swal.fire('F√©licitations !', `Achat avec ${tokenSelected} s√©curis√©.`, 'success');
                }
                updateBalances();
            } catch (error) {
                console.error(error);
                Swal.fire('Erreur', 'La transaction a √©chou√©. V√©rifiez votre solde.', 'error');
            }
        }

        function togglePouch() { document.getElementById('pouchWindow').classList.toggle('active'); }

        function toggleWhitepaper() {
            const whitepaperBox = document.getElementById('whitepaperBox');
            whitepaperBox.classList.toggle('open');
            whitepaperBox.innerHTML = `
                <div style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                    <h2 style="color:#D4AF37; margin-bottom:16px;">ARCANA ‚Äî PROTOCOLE DE S√âCURIT√â FINANCI√àRE</h2>

                    <h4 style="color:#D4AF37; margin-top:24px;">1. Vision & Mission</h4>
                    <p style="opacity:0.8;">
                        ARCANA est une infrastructure d√©centralis√©e sur la blockchain Polygon visant √† offrir un coffre-fort num√©rique ultra-s√©curis√©.<br>
                        Notre mission est de prot√©ger le capital des investisseurs contre la volatilit√© gr√¢ce √† un syst√®me de r√©serve garanti par contrat intelligent.
                    </p>

                    <h4 style="color:#D4AF37; margin-top:24px;">2. S√©curit√© & Audit</h4>
                    <p style="opacity:0.8;">
                        Le contrat <strong>0x29D61511C84E332635E296e37bf22Eb4fB514147</strong> a √©t√© con√ßu en mode "Non-Custodial". Seul l'utilisateur d√©tient les cl√©s de ses actifs.<br>
                        Le code a √©t√© audit√© pour pr√©venir les failles critiques, dont "Reentrancy" et "Flash Loans". La liquidit√© du Vault est verrouill√©e.
                    </p>

                    <h4 style="color:#D4AF37; margin-top:24px;">3. Tokenomics (ARCANA)</h4>
                    <p style="opacity:0.8;">
                        <strong>Symbole :</strong> ARCANA<br>
                        <strong>R√©seau :</strong> Polygon (PoS)<br>
                        <strong>Objectif de lev√©e (Hardcap) :</strong> 1 200 000 $<br>
                        <strong>Approvisionnement (Supply) :</strong> 900 000 000 ARCANA<br>
                        <strong>Prix par jeton ARCANA :</strong> 0.0026 $<br>
                        <strong>Usage :</strong> Jeton de gouvernance et cl√© d'acc√®s premium au Vault.<br>
                        <strong>R√©partition :</strong> Pr√©vente, liquidit√©, r√©serve communautaire, d√©veloppement.<br>
                        <strong>Capitalisation initiale cible :</strong> 1 200 000 $ lors de la pr√©vente.
                    </p>

                    <h4 style="color:#D4AF37; margin-top:24px;">4. M√©canisme de Pr√©vente (Launchpad)</h4>
                    <p style="opacity:0.8;">
                        La pr√©vente ARCANA s'effectue via un launchpad d√©di√© avec paiement possible en POL, USDT ou USDC.<br>
                        La quantit√© d'ARCANA re√ßue :<br>
                        <strong>Montant en $ / 0.0026 = Nombre d'ARCANA</strong><br>
                        Un syst√®me de vesting prot√®ge le prix et distribue progressivement les allocations.<br>
                        Le Dashboard permet de suivre son allocation et calendrier de vesting en temps r√©el.
                    </p>

                    <h4 style="color:#D4AF37; margin-top:24px;">5. Le Coffre-Fort (The Vault)</h4>
                    <p style="opacity:0.8;">
                        Le smart contract "Vault" (<strong>0x29D61511C84E332635E296e37bf22Eb4fB514147</strong>) s√©curise tous les fonds collect√©s :<br>
                        ‚Ä¢ <strong>Liquidit√© initiale : 25% de la supply, soit 225 000 000 ARCANA, est d√©di√©e √† la cr√©ation de liquidit√© sur les DEX lors du listing.</strong><br>
                        ‚Ä¢ <strong>Ces 225M ARCANA seront coupl√©s √† une valeur de 585 000 $ pour garantir un prix de lancement stable √† 0.0026 $ par token.</strong><br>
                        ‚Ä¢ <strong>La liquidit√© totale ainsi form√©e sera verrouill√©e ("liquidity lock") pour 12 mois afin de rassurer tout acheteur et pr√©venir tout retrait anticip√©.</strong><br>
                        ‚Ä¢ <strong>Fonds de r√©serve</strong> : Le reste compose la r√©serve communautaire, participant √† la stabilit√© et √† la couverture en cas d'√©v√©nement de march√© exceptionnel.<br>
                        Les retraits (withdraw, claim) sont publics, transparents et audit√©s sur la blockchain Polygon.
                    </p>

                    <h4 style="color:#D4AF37; margin-top:24px;">6. Roadmap 2026</h4>
                    <p style="opacity:0.8;">
                        <strong>Q1 2026 :</strong> Fin de la pr√©vente, listing ARCANA sur QuickSwap & Uniswap<br>
                        <strong>Q2 2026 :</strong> Lancement Dashboard Staking & Earn (stake ARCANA pour des r√©compenses)<br>
                        <strong>Q3 2026 :</strong> Lancement du protocole d'assurance ARCANA<br>
                        <strong>Q4 2026 :</strong> D√©centralisation de la gouvernance (DAO) & nouveaux partenariats strat√©giques
                    </p>
                </div>
            `;
        }

        // Nouveau : on utilise extractCleanAmount partout (notamment dans buyNow)
        function extractAmount(str) {
            return Number(extractCleanAmount(str));
        }
    </script>
</body>
</html>