<!DOCTYPE html>
<html lang="fr">
<!--
═══════════════════════════════════════════════════════════════
    ARCANA GAME - Le Sanctuaire du Destin
    Écosystème Décentralisé sur Polygon | Optimisé Mobile
    Structure: index.html → arcanagame.html (connexion bidirectionnelle)
    
    🌡 ORACLE MÉTÉO :
    - Condition : Température <= -2°C à Montréal-Est (Gel requis)
    - Mode Admin : Définir ARCANA_TEST_WALLET avec votre adresse
    - Bypass automatique pour le wallet admin (fonctionne même à +20°C)
    
    🔧 MODE ADMIN :
    Ligne ~1368 : var ARCANA_TEST_WALLET = 'VOTRE_ADRESSE_0x...';
═══════════════════════════════════════════════════════════════
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1b2735">
    <meta name="description" content="Arcana Game - Écosystème Décentralisé sur Polygon">
    <title>Arcana Game - Écosystème Décentralisé</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" defer></script>
    <link rel="preconnect" href="https://polygon-rpc.com">
    <link rel="preconnect" href="https://cdn.pixabay.com">
    <link rel="dns-prefetch" href="https://esm.sh">
    <style>
        :root {
            --gold: #d4af37;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(212, 175, 55, 0.3);
            --rune-glow-blue: #49cafa;
            --frost-muted: #adb5bd;
        }
        * {
            font-family: 'Cinzel', serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Cinzel', serif;
            font-weight: 400;
            letter-spacing: 0.15em;
        }
        body {
            perspective: 1000px;
            /* Couloir de pierre en perspective - arrière-plan principal */
            background: 
                /* Murs latéraux sombres */
                linear-gradient(90deg, 
                    rgba(20, 15, 10, 1) 0%, 
                    rgba(30, 25, 20, 0.9) 10%,
                    transparent 25%,
                    transparent 75%,
                    rgba(30, 25, 20, 0.9) 90%,
                    rgba(20, 15, 10, 1) 100%),
                /* Sol en dalles */
                linear-gradient(180deg,
                    transparent 0%,
                    transparent 50%,
                    rgba(25, 20, 15, 0.8) 70%,
                    rgba(20, 15, 10, 1) 100%),
                /* Fond de pierre sombre */
                radial-gradient(ellipse at 50% 50%, 
                    rgba(40, 35, 30, 1) 0%, 
                    rgba(25, 20, 15, 1) 50%,
                    rgba(15, 10, 5, 1) 100%);
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white;
            font-family: 'Cinzel', serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        /* Texture de pierre sur le body */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                /* Joints de dalles au sol */
                repeating-linear-gradient(90deg,
                    transparent 0,
                    transparent 150px,
                    rgba(0, 0, 0, 0.3) 150px,
                    rgba(0, 0, 0, 0.3) 152px),
                repeating-linear-gradient(0deg,
                    transparent 0,
                    transparent 100px,
                    rgba(0, 0, 0, 0.25) 100px,
                    rgba(0, 0, 0, 0.25) 102px),
                /* Texture granuleuse */
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            opacity: 0.6;
            pointer-events: none;
            z-index: 0;
        }

        #brick-wall-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: block;
            overflow: hidden;
            pointer-events: auto;
        }

        #brick-wall-overlay.hidden {
            display: none;
        }

        .brick-panel {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50vw;
            transition: transform 900ms cubic-bezier(0.2, 0.85, 0.2, 1);
            background:
                radial-gradient(120% 140% at 50% 30%, rgba(255,255,255,0.08), rgba(255,255,255,0) 55%),
                linear-gradient(180deg, rgba(10, 7, 5, 0.92), rgba(28, 20, 14, 0.92)),
                repeating-linear-gradient(0deg,
                    rgba(0,0,0,0) 0px,
                    rgba(0,0,0,0) 56px,
                    rgba(0,0,0,0.35) 56px,
                    rgba(0,0,0,0.35) 58px),
                repeating-linear-gradient(90deg,
                    rgba(0,0,0,0) 0px,
                    rgba(0,0,0,0) 92px,
                    rgba(0,0,0,0.25) 92px,
                    rgba(0,0,0,0.25) 94px);
            box-shadow:
                inset 0 0 120px rgba(0,0,0,0.75),
                inset 0 0 30px rgba(212,175,55,0.08);
        }

        body.corridor-entrance-bg {
            background-image:
                url('couloir-coffre.webp'),
                linear-gradient(90deg,
                    rgba(20, 15, 10, 1) 0%,
                    rgba(30, 25, 20, 0.9) 10%,
                    transparent 25%,
                    transparent 75%,
                    rgba(30, 25, 20, 0.9) 90%,
                    rgba(20, 15, 10, 1) 100%),
                linear-gradient(180deg,
                    transparent 0%,
                    transparent 50%,
                    rgba(25, 20, 15, 0.8) 70%,
                    rgba(20, 15, 10, 1) 100%),
                radial-gradient(ellipse at 50% 50%,
                    rgba(40, 35, 30, 1) 0%,
                    rgba(25, 20, 15, 1) 50%,
                    rgba(15, 10, 5, 1) 100%);
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .brick-panel.left {
            left: 0;
            transform: translateX(0);
            border-right: 1px solid rgba(73, 202, 250, 0.18);
        }

        .brick-panel.right {
            right: 0;
            transform: translateX(0);
            border-left: 1px solid rgba(73, 202, 250, 0.18);
        }

        #brick-wall-overlay.open .brick-panel.left {
            transform: translateX(-100%);
        }

        #brick-wall-overlay.open .brick-panel.right {
            transform: translateX(100%);
        }

        #entrance-chest {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: min(340px, 72vw);
            height: min(260px, 56vw);
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 0;
            transition: opacity 700ms ease, transform 250ms ease;
            opacity: 1;
            z-index: 2;
            -webkit-tap-highlight-color: transparent;
        }

        #entrance-chest:active {
            transform: translate(-50%, -50%) scale(0.98);
        }

        #brick-wall-overlay.open #entrance-chest {
            opacity: 0;
            pointer-events: none;
        }

        .holo-chest {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 18px;
            background:
                radial-gradient(90% 100% at 50% 40%, rgba(73, 202, 250, 0.35), rgba(73, 202, 250, 0.08) 55%, rgba(0,0,0,0) 70%),
                linear-gradient(145deg, rgba(25, 45, 55, 0.9), rgba(8, 12, 18, 0.92));
            border: 1px solid rgba(73, 202, 250, 0.85);
            box-shadow:
                0 0 40px rgba(73, 202, 250, 0.28),
                0 0 22px rgba(73, 202, 250, 0.18),
                inset 0 0 24px rgba(255,255,255,0.06);
            overflow: hidden;
        }

        .holo-chest::before {
            content: '';
            position: absolute;
            inset: -40%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
            transform: rotate(12deg) translateX(-60%);
            animation: entranceShimmer 3.2s ease-in-out infinite;
            pointer-events: none;
        }

        .holo-chest::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 10%;
            width: 6px;
            height: 70%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, rgba(73,202,250,0), rgba(73,202,250,0.95), rgba(73,202,250,0));
            filter: drop-shadow(0 0 16px rgba(73,202,250,0.85));
            opacity: 0.85;
            pointer-events: none;
        }

        .holo-chest-title {
            position: absolute;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            width: calc(100% - 36px);
            text-align: center;
            font-size: 14px;
            letter-spacing: 0.16em;
            color: rgba(245, 252, 255, 0.98);
            text-shadow: 0 0 18px rgba(73, 202, 250, 0.32);
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(73, 202, 250, 0.45);
            background: rgba(0, 0, 0, 0.25);
            box-shadow: 0 0 20px rgba(73, 202, 250, 0.18);
        }

        .holo-chest-subtitle {
            position: absolute;
            left: 50%;
            bottom: 64px;
            transform: translateX(-50%);
            width: calc(100% - 36px);
            text-align: center;
            font-size: 12px;
            letter-spacing: 0.09em;
            color: rgba(212,175,55,0.9);
            opacity: 0.95;
            text-shadow: 0 0 14px rgba(0, 242, 255, 0.12);
        }

        @keyframes entranceShimmer {
            0% { transform: rotate(12deg) translateX(-80%); opacity: 0.0; }
            20% { opacity: 0.85; }
            50% { opacity: 0.35; }
            100% { transform: rotate(12deg) translateX(85%); opacity: 0.0; }
        }
        #star-container {
            display: none; /* Étoiles désactivées pour correspondre à l'interface finale */
        }
        .star {
            display: none;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        /* Glass panels normaux - Fond léger semi-transparent pour les menus */
        .glass-panel {
            font-family: 'Cinzel', serif;
            background: rgba(15, 12, 8, 0.88);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 0.5px solid rgba(212, 175, 55, 0.5);
            border-radius: 18px;
            box-shadow: 
                0 0 60px rgba(0, 0, 0, 0.9),
                0 0 100px rgba(212, 175, 55, 0.15),
                inset 0 0 40px rgba(0, 0, 0, 0.3);
            padding: 28px;
            margin: 20px;
            width: 90%;
            max-width: 520px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        /* EXCEPTION CRITIQUE: Sanctuaire totalement transparent */
        #level-3-sanctuary.glass-panel,
        #level-3-sanctuary {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 20px !important;
            width: 100% !important;
            max-width: 100vw !important;
            box-sizing: border-box !important;
        }
        .glass-panel.glitch {
            /* Glitch border red effect */
            animation: glitch-border 0.12s steps(1) infinite alternate, border-shake 0.17s linear infinite alternate;
            border: 2.5px solid #ff2424 !important;
            box-shadow: 0 0 22px 4px #ff2424, 0 0 2px 2px #d10000 inset;
        }
        @keyframes glitch-border {
            0% { filter: none; }
            25% { filter: contrast(1.3) brightness(1.1) hue-rotate(-12deg); }
            51% { filter: contrast(2.4) brightness(1.2) hue-rotate(10deg); }
            75% { filter: saturate(2) brightness(0.97) grayscale(0.2); }
            100% { filter: none; }
        }
        @keyframes border-shake {
            0%   { box-shadow: 0 0 15px 2px #af2222, 0 0 5px 2px #ff3c3c inset; }
            45%  { box-shadow: -2px 1px 22px 4px #ff2424, 1px -1px 2px 2px #ff7676 inset; }
            51%  { box-shadow: 1px -2px 23px 1px #e71e1e, 0 1px 2.5px 1px #ffe4e4 inset; }
            100% { box-shadow: 0 0 22px 4px #ff2424, 0 0 2px 2px #d10000 inset; }
        }
        header {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 16px 30px;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(180deg, rgba(18, 14, 10, 0.94) 0%, rgba(14, 11, 8, 0.65) 80%, transparent 100%);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            pointer-events: auto;
            gap: 25px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.6);
        }
        /* Logo Arcana - Discret et élégant à gauche */
        .logo-arcana {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Cinzel', serif;
            font-size: 0.75em;
            color: rgba(212, 175, 55, 0.8);
            letter-spacing: 0.12em;
            font-weight: 300;
            text-transform: uppercase;
            opacity: 0.85;
            justify-self: start;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .logo-arcana:hover {
            opacity: 1;
            color: var(--gold);
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
        }
        .logo-arcana img {
            height: 45px;
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.5));
            transition: filter 0.3s ease;
        }
        .logo-arcana:hover img {
            filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.8));
        }
        .logo-arcana-title {
            font-family: 'Cinzel', serif !important;
            font-size: 0.75em;
            color: #d4af37 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.12em;
            font-weight: 300;
        }
        /* Titre central avec plaque décorative */
        .header-title-plate {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 32px;
            background: rgba(0, 0, 0, 0.25);
            border: 0.5px solid rgba(212, 175, 55, 0.5);
            border-radius: 18px;
            box-shadow: 
                0 0 35px rgba(0, 0, 0, 0.8),
                inset 0 0 25px rgba(212, 175, 55, 0.06);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            justify-self: center;
        }
        .header-title-main {
            font-family: 'Cinzel', serif;
            font-size: 1em;
            color: var(--gold);
            letter-spacing: 0.2em;
            font-weight: 400;
            text-transform: uppercase;
            margin: 0;
            padding: 0;
            line-height: 1.3;
            text-shadow: 0 0 18px rgba(212, 175, 55, 0.5);
        }
        .header-title-separator {
            width: 80%;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(212, 175, 55, 0.2) 20%, 
                rgba(212, 175, 55, 0.6) 50%, 
                rgba(212, 175, 55, 0.2) 80%, 
                transparent 100%);
            margin: 6px auto 5px;
        }
        .header-title-level {
            font-family: 'Cinzel', serif;
            font-size: 0.65em;
            color: rgba(212, 175, 55, 0.7);
            letter-spacing: 0.3em;
            font-weight: 300;
            text-transform: uppercase;
        }
        /* Boutons navigation - Forme pilule transparente */
        .header-nav-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-self: end;
        }
        .header-btn-pill {
            font-family: 'Cinzel', serif;
            background: transparent;
            color: rgba(212, 175, 55, 0.85);
            border: 0.5px solid rgba(212, 175, 55, 0.5);
            padding: 7px 18px;
            border-radius: 50px;
            font-size: 0.7em;
            font-weight: 400;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            white-space: nowrap;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .header-btn-pill:hover {
            background: rgba(212, 175, 55, 0.12);
            border-color: rgba(212, 175, 55, 0.9);
            color: rgba(255, 215, 0, 1);
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.4);
            text-shadow: 0 0 12px rgba(212, 175, 55, 0.6);
            transform: translateY(-1px);
        }
        /* Masquer le bouton bleu flottant w3m au centre - seul le bouton doré du header reste */
        w3m-button, #arcana-connect-gate button, #arcana-connect-gate w3m-button {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        /* Responsive Header */
        @media (max-width: 1024px) {
            header {
                padding: 15px 20px;
                gap: 15px;
            }
            .header-title-plate {
                padding: 10px 25px;
            }
            .header-title-main {
                font-size: 0.95em;
            }
            .header-btn-pill {
                padding: 7px 16px;
                font-size: 0.7em;
            }
        }
        @media (max-width: 768px) {
            header {
                grid-template-columns: auto 1fr auto;
                padding: 12px 15px;
                gap: 10px;
            }
            .logo-arcana {
                font-size: 0.7em;
            }
            .logo-arcana img {
                height: 40px;
            }
            .header-title-plate {
                padding: 8px 18px;
                border-radius: 14px;
            }
            .header-title-main {
                font-size: 0.85em;
                letter-spacing: 0.15em;
            }
            .header-nav-buttons {
                gap: 8px;
            }
            .header-btn-pill {
                padding: 6px 12px;
                font-size: 0.65em;
            }
        }
        @media (max-width: 480px) {
            header {
                grid-template-columns: 1fr;
                justify-items: center;
                gap: 12px;
                padding: 15px 10px;
            }
            .header-nav-buttons {
                order: 3;
            }
            .header-title-plate {
                order: 1;
            }
            .logo-arcana {
                order: 2;
            }
        }
        .btn-connect {
            font-family: 'Cinzel', serif;
            background: linear-gradient(45deg, #d4af37, #f2d06b);
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            letter-spacing: 0.05em;
        }
        .btn-connect:hover:not([disabled]):not(.disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--gold);
            cursor: pointer;
        }
        .btn-connect[disabled], .btn-connect.disabled {
            background: linear-gradient(45deg, #d4d4d4, #bbbbbb) !important;
            color: #888 !important;
            cursor: not-allowed;
            opacity: 0.68;
        }
        .title-vault {
            display: none; /* Caché pour interface épurée selon image */
        }
        /* Section Oracle (Niveau 2) */
        .oracle-mirror {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 0.5px solid var(--gold);
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.2), transparent);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
            position: relative;
            transition: all 0.5s ease;
        }
        .oracle-mirror.loading {
            border-color: rgba(173, 181, 189, 0.5);
            animation: oracle-pulse 2s ease-in-out infinite;
        }
        @keyframes oracle-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(173, 181, 189, 0.3); }
            50% { box-shadow: 0 0 25px rgba(173, 181, 189, 0.6); }
        }
        .oracle-mirror.frozen {
            border: 3px solid #b9e9ff !important;
            background: radial-gradient(circle, rgba(135, 206, 235, 0.4), transparent) !important;
            box-shadow: 0 0 30px #49cafa, 0 0 10px #ffffff inset !important;
        }
        .oracle-mirror #temp {
            font-size: 2.2em;
            font-weight: 600;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.08em;
        }
        /* Salle 2 (Niveau 2) : transparent pour voir le couloir */
        #level-2-panel {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        #level-2-panel:has(.oracle-mirror.frozen) {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border: 1px solid rgba(185, 233, 255, 0.3);
            box-shadow: none;
            opacity: 1;
        }
        .oracle-temp-warning {
            font-family: 'Cinzel', serif;
            color: var(--frost-muted);
            font-weight: 400;
            font-size: 0.85em;
            text-align: center;
            margin-top: 1em;
            padding: 12px;
            background: rgba(173, 181, 189, 0.08);
            border-radius: 8px;
            border: 1px solid rgba(173, 181, 189, 0.2);
            line-height: 1.6;
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
        }
        .oracle-temp-warning:empty {
            display: none !important;
        }
        #chat-temple {
            display: none; /* Caché par défaut - s'affiche via la Taverne */
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            font-size: 0.9em;
            font-family: 'Cinzel', serif;
        }
        .input-arcana {
            font-family: 'Cinzel', serif;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border: 0.5px solid rgba(212, 175, 55, 0.5);
            color: var(--gold);
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            box-sizing: border-box;
            font-weight: 400;
            letter-spacing: 0.05em;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .label-gold {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.15em;
            font-weight: 400;
        }
        .class-card {
            cursor: pointer;
            padding: 15px;
            border: 0.5px solid rgba(212, 175, 55, 0.2);
            border-radius: 15px;
            transition: 0.3s;
            width: 80px;
        }
        .class-card:hover {
            background: rgba(214, 175, 55, 0.2);
            border-color: var(--gold);
            box-shadow: 0 0 15px var(--gold);
            transform: translateY(-5px);
        }
        .class-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        /* Digital Countdown - Caché par défaut */
        .digital-timer {
            display: none;
        }
        .digital-timer.danger {
            color: #fff0f0;
            background: #b30505DD;
            text-shadow: 0 0 9px #ff2424, 0 0 36px #ff555555;
            border-color: #ff2424aa;
            animation: glitch-border 0.15s steps(1) infinite alternate;
        }
        /* Runes - Cercles dorés (réduits 20%) */
        .runes-column .rune-btn {
            width: 70px;
            height: 70px;
            margin: 0;
            transform: scale(0.8);
        }
        .rune-btn {
            /* Structure */
            font-family: 'Cinzel', serif;
            font-size: 2em;
            padding: 0;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            
            /* Transparence totale avec bordure dorée ultra-fine */
            background: transparent !important;
            border: 0.5px solid rgba(212, 175, 55, 0.2);
            border-radius: 50%;
            
            /* Symbole doré */
            color: rgba(212, 175, 55, 1);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
            
            /* Interactions */
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            user-select: none;
        }
        
        /* Effet de surbrillance doré au survol - reste transparent */
        .rune-btn:hover:not(:disabled) {
            background: transparent !important;
            border-color: rgba(212, 175, 55, 0.9);
            color: rgba(255, 215, 0, 1);
            text-shadow: 
                0 0 25px rgba(255, 215, 0, 1),
                0 0 35px rgba(212, 175, 55, 0.9),
                0 0 45px rgba(212, 175, 55, 0.6);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.7);
            transform: scale(0.9);
        }
        
        /* Animation quête active - Pulse doré */
        .rune-btn.quete-active {
            animation: rune-quete-pulse 2.5s ease-in-out infinite;
        }
        @keyframes rune-quete-pulse {
            0%, 100% {
                border-color: rgba(212, 175, 55, 0.25);
                color: rgba(212, 175, 55, 0.9);
                text-shadow: 0 0 8px rgba(212, 175, 55, 0.4);
                box-shadow: none;
            }
            50% {
                border-color: rgba(255, 215, 0, 0.8);
                color: rgba(255, 215, 0, 1);
                text-shadow: 
                    0 0 20px rgba(255, 215, 0, 1),
                    0 0 30px rgba(212, 175, 55, 0.8);
                box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);
                transform: scale(0.84);
            }
        }
        /* Feedback visuel pour les runes avec cercle doré */
        .rune-btn.selected,
        .rune-btn.good {
            border-color: rgba(73, 202, 250, 0.9);
            color: rgba(73, 202, 250, 1);
            text-shadow: 
                0 0 20px rgba(73, 202, 250, 1),
                0 0 30px rgba(73, 202, 250, 0.7);
            box-shadow: 0 0 25px rgba(73, 202, 250, 0.5);
            animation: rune-feedback-good 0.6s ease;
        }
        .rune-btn.bad {
            border-color: rgba(255, 68, 68, 0.9);
            color: rgba(255, 68, 68, 1);
            text-shadow: 
                0 0 20px rgba(255, 68, 68, 1),
                0 0 30px rgba(255, 68, 68, 0.7);
            box-shadow: 0 0 25px rgba(255, 68, 68, 0.5);
            animation: rune-feedback-bad 0.4s ease;
        }
        /* Effet doré au clic */
        .rune-btn.click-gold {
            filter: drop-shadow(0 0 15px #d4af37) !important;
            transition: filter 0.2s ease;
        }
        @keyframes rune-feedback-good {
            0%, 100% {
                transform: scale(0.8);
            }
            50% {
                transform: scale(0.92);
            }
        }
        @keyframes rune-feedback-bad {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-6px);
            }
            75% {
                transform: translateX(6px);
            }
        }
        /* Progress bar - Cachée (épuration) */
        .alignement-container,
        .alignement-label,
        .alignement-bar-bg,
        .alignement-bar-fill,
        .alignement-percentage {
            display: none;
        }
        /* Salle 3 (Sanctuaire) : pierre ancienne, bordure dorée pulsante */
        @keyframes golden-border-pulse {
            0%, 100% { box-shadow: 0 0 12px rgba(212, 175, 55, 0.5); border-color: rgba(212, 175, 55, 0.9); }
            50% { box-shadow: 0 0 22px rgba(212, 175, 55, 0.7); border-color: #d4af37; }
        }
        /* Animation d'entrée douce pour le sanctuaire */
        @keyframes sanctuaire-shift-up {
            0% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translateY(-20%) scale(0.85);
                opacity: 0.95;
            }
        }
        @keyframes sanctuaire-shift-down {
            0% {
                transform: translate(-50%, -50%) translateY(-20%) scale(0.85);
                opacity: 0.95;
            }
            100% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }
        #level-3-sanctuary {
            /* Nettoyage complet - Vue dégagée sur le décor */
            display: grid;
            grid-template-columns: 120px 1fr 120px;
            gap: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            width: 100vw;
            height: 100vh;
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-sizing: border-box;
            transition: opacity 0.5s ease;
            pointer-events: auto;
            padding: 100px 20px 20px 20px;
            overflow: hidden;
            box-shadow: inset 0 0 150px rgba(0, 0, 0, 0.9);
        }
        #level-3-sanctuary.sac-ouvert {
            opacity: 0.6;
        }
        /* Colonnes de runes - Contour ultra-fin, transparence totale */
        .runes-column {
            display: flex !important;
            flex-direction: column !important;
            justify-content: space-evenly !important;
            align-items: center !important;
            gap: 6px;
            min-height: 85vh;
            background: transparent !important;
            border: 0.5px solid rgba(212, 175, 55, 0.2) !important;
            box-shadow: none !important;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.5));
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            z-index: 10;
            position: relative;
            padding: 40px 0;
            padding-top: 130px !important;
        }
        .runes-column.left {
            grid-column: 1;
            justify-self: start;
            align-items: flex-start !important;
            padding-left: 35px;
            padding-top: 130px !important;
        }
        .runes-column.right {
            grid-column: 3;
            justify-self: end;
            align-items: flex-end !important;
            padding-right: 35px;
            padding-top: 130px !important;
        }
        /* Forcer la transparence absolue sur tous les enfants des colonnes */
        .runes-column,
        .runes-column * {
            background-color: transparent !important;
            background-image: none !important;
        }
        .runes-column .rune-btn {
            background: transparent !important;
        }
        /* Quand le sac est ouvert - runes restent visibles mais légèrement atténuées */
        #level-3-sanctuary.sac-ouvert .rune-btn {
            opacity: 0.7;
        }
        #level-3-sanctuary.sac-ouvert .rune-btn:hover:not(:disabled) {
            opacity: 1;
        }
        @media (max-width: 768px) {
            #level-3-sanctuary {
                grid-template-columns: 95px 1fr 95px;
                padding: 15px 5px;
            }
            .runes-column {
                min-height: 78vh;
                gap: 5px;
                padding-top: 140px !important;
            }
            .runes-column.left {
                padding-left: 15px;
                padding-top: 140px !important;
            }
            .runes-column.right {
                padding-right: 15px;
                padding-top: 140px !important;
            }
            .runes-column .rune-btn {
                width: 58px;
                height: 58px;
                transform: scale(0.8);
            }
            .rune-btn {
                font-size: 1.4em;
                width: 58px;
                height: 58px;
            }
            #btn-sacoche {
                bottom: 20px;
                width: 54px;
                height: 54px;
                font-size: 1.6em;
            }
        }
        @media (max-width: 480px) {
            #level-3-sanctuary {
                grid-template-columns: 75px 1fr 75px;
                padding: 12px 3px;
            }
            .runes-column {
                min-height: 72vh;
                gap: 5px;
                padding-top: 160px !important;
            }
            .runes-column.left {
                padding-left: 12px;
                padding-top: 160px !important;
            }
            .runes-column.right {
                padding-right: 12px;
                padding-top: 160px !important;
            }
            .runes-column .rune-btn {
                width: 50px;
                height: 50px;
                transform: scale(0.8);
            }
            .rune-btn {
                font-size: 1.2em;
                width: 50px;
                height: 50px;
            }
            #btn-sacoche {
                bottom: 18px;
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }
            .btn-back-accueil {
                font-size: 0.65rem;
                padding: 6px 12px;
            }
        }
        /* JACKPOT VICTORY style */
        #victory-jackpot {
            display: none;
            position: fixed;
            z-index: 2000;
            top: 0;left: 0;right:0;bottom:0;
            background:rgba(20, 10, 1, 0.95);
            width:100vw; height:100vh;
            pointer-events: none;
        }
        #victory-jackpot .victory-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -70%);
            color: #ffd900;
            font-size: 2.7em;
            font-family:'Orbitron','VT323',monospace;
            letter-spacing: 0.13em;
            text-align:center;
            text-shadow: 0 0 22px #fff799, 0 0 48px #d4af37, 0 0 128px #ffed80;
            filter: brightness(1.3) drop-shadow(0 0 16px #f2cf5e);
            animation:victoryPopup 1s cubic-bezier(.38,2,0,.97);
        }
        @keyframes victoryPopup {
            0%{opacity:0;transform: translate(-50%,-46%) scale(0.7);}
            85%{opacity:1;transform: translate(-50%,-48%) scale(1.07);}
            100%{opacity:1;transform:translate(-50%,-70%) scale(1);}
        }
        /* Golden Rain Particles - au-dessus des murs de pierre */
        .gold-rain {
            position: absolute;
            pointer-events: none;
            z-index: 2200;
            top:0; left:0;width:100vw;height:100vh;overflow:hidden;
        }
        .gold-drop {
            position: absolute;
            width: 7px; height: 25px;
            border-radius: 7px 7px 9px 9px/13px;
            opacity: 0.98;
            background: linear-gradient(179deg,#fffbe7 4%,#ffe769 33%,#ecd16b 85%,#d4af37 100%);
            filter: blur(0.2px) brightness(1.18);
            box-shadow: 0 0 3px #fffbe7, 0 8px 24px #d4af3799;
            animation: gold-rain-swoosh 1.45s linear forwards;
        }
        @keyframes gold-rain-swoosh {
            0% { transform: translateY(-70px) scaleY(0.5) rotate(-9deg);}
            26%{ opacity: 1;}
            90% { opacity: 0.98;}
            100% { transform: translateY(110vh) scaleY(1.1) rotate(7deg); opacity: 0;}
        }
        /* Nouveaux styles pour le sélecteur de token */
        .token-select-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }
        .arcana-token-option {
            color: #FADB1C;
        }

        /* Brume atmosphérique - Désactivée pour vue dégagée */
        #arcana-fog {
            display: none;
        }
        #arcana-fog::before,
        #arcana-fog.sanctuary-active,
        #arcana-fog.jackpot-golden {
            display: none;
        }
        @keyframes fog-drift {
            0%, 100% { transform: translateX(0) scaleX(1); }
            50% { transform: translateX(2%) scaleX(1.02); }
        }
        @keyframes fog-sweep {
            0%, 100% { transform: translateX(0); opacity: 0.6; }
            50% { transform: translateX(5%); opacity: 1; }
        }

        /* Mentions légales - Cachées pour épuration */
        .arcana-mention {
            display: none;
        }
        /* Écran d'attente : transparent, ne couvre pas le header (CONNECT WALLET reste cliquable) */
        #arcana-connect-gate {
            position: fixed;
            top: 72px; left: 0; right: 0; bottom: 0;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99;
            pointer-events: auto;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }
        #arcana-connect-gate.hidden { display: none !important; pointer-events: none !important; visibility: hidden !important; }
        #arcana-connect-gate:not(.hidden) { display: flex !important; }
        body:has(#arcana-connect-gate:not(.hidden)) { overflow: hidden; height: 100vh; }
        #arcana-connect-gate .gate-message {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.1em;
            background: transparent !important;
            letter-spacing: 0.15em;
            text-align: center;
            margin: 0;
            padding: 0;
            opacity: 1;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
            border: none !important;
            box-shadow: none !important;
        }
        /* Ancien bouton retour - Désormais intégré dans le header */
        .btn-back-accueil {
            display: none;
        }
        /* Contenu jeu : effet de salle (tunnel/temple) */
        #game-container, #arcana-game-content { 
            display: none; 
            opacity: 0;
            background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%), url('https://images.unsplash.com/photo-1605806616949-1e87b487fc2f?q=80&w=2070&auto=format&fit=crop') !important;
            background-size: cover !important;
        }
        #game-container.visible, #arcana-game-content.visible { 
            display: block;
            background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%), url('https://images.unsplash.com/photo-1605806616949-1e87b487fc2f?q=80&w=2070&auto=format&fit=crop') !important;
            background-size: cover !important;
        }
        /* Masquer tous les panels sauf le sanctuaire par défaut */
        #class-selection,
        #level-2-panel,
        #arcane-level-panel,
        #arcane-altar-panel {
            display: none !important;
        }
        /* Identification wallet : coin de l'écran */
        .wallet-address-badge {
            position: fixed; top: 12px; right: 12px; z-index: 600;
            font-size: 0.7rem; font-family: 'Cinzel', serif; color: var(--gold);
            background: rgba(0,0,0,0.6); padding: 7px 14px; border-radius: 8px;
            border: 0.5px solid rgba(212, 175, 55, 0.4); letter-spacing: 0.08em;
            font-weight: 400;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        /* Badge Mode Test */
        .test-mode-badge {
            display: none;
        }
        /* Admin trigger - Discret */
        .admin-trigger {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 0.7rem;
            color: rgba(212, 175, 55, 0.3);
            cursor: pointer;
            z-index: 500;
            transition: color 0.3s;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.1em;
        }
        .admin-trigger:hover {
            color: rgba(212, 175, 55, 0.7);
        }
        .admin-stat {
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            margin: 8px 0;
        }
        .admin-close {
            font-family: 'Cinzel', serif;
        }
        @keyframes test-badge-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; box-shadow: 0 0 12px rgba(0, 255, 136, 0.4); }
        }
        /* Alerte Oracle stylisée */
        .oracle-network-alert {
            font-family: 'Cinzel', serif;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; 
            background: rgba(20, 15, 10, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 0.5px solid rgba(212, 175, 55, 0.6);
            border-radius: 16px; padding: 28px; max-width: 380px; text-align: center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9), 0 0 80px rgba(212, 175, 55, 0.2);
        }
        .oracle-network-alert p { 
            font-family: 'Cinzel', serif;
            color: var(--gold); 
            margin: 0 0 18px 0; 
            line-height: 1.7;
            letter-spacing: 0.05em;
        }
        .oracle-network-alert .btn-connect { margin-top: 12px; }
        /* Transition connexion : fade-out message / fade-in Sanctuaire */
        #arcana-connect-gate.fade-out { opacity: 0; pointer-events: none; }
        #arcana-connect-gate.fade-out .gate-message { opacity: 0; transform: scale(0.95); }
        #arcana-connect-gate .gate-message { transition: opacity 0.6s ease, transform 0.6s ease; }
        @media (max-width: 480px) {
            #arcana-connect-gate .gate-message { font-size: 0.95em; }
        }
        #game-container.fade-in, #arcana-game-content.fade-in { animation: sanctuary-fade-in 1s ease forwards; }
        @keyframes sanctuary-fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        /* Filtre bleu givre à la connexion */
        body.frost-transition #arcana-fog { opacity: 0.95; filter: blur(35px); }
        body.frost-transition #arcana-fog,
        body.frost-transition #star-container { filter: blur(2px) hue-rotate(-5deg) saturate(0.9); }
        /* Particules de givre */
        #frost-particles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 550; opacity: 0;
            transition: opacity 0.8s ease;
        }
        #frost-particles.active { opacity: 1; }
        .frost-dot {
            position: absolute; width: 2px; height: 2px; background: rgba(220, 240, 255, 0.8);
            border-radius: 50%; animation: frost-fall 4s linear forwards;
        }
        @keyframes frost-fall {
            0% { transform: translateY(-10px) scale(1); opacity: 0.8; }
            100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
        }
        /* === Système d'obscurité et Lumière === */
        #arcane-darkness-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 450;
            background: radial-gradient(circle 120px at var(--cursor-x, 50%) var(--cursor-y, 50%), transparent 0%, transparent 35%, rgba(0,0,0,0.97) 100%);
            transition: background 0.08s ease-out;
        }
        #arcane-darkness-overlay.room-lit-1 { --room1-mask: transparent; }
        #arcane-darkness-overlay.room-lit-2 { --room2-mask: transparent; }
        .arcane-light-object {
            display: none; /* Caché pour épuration */
        }
        /* Inventaire clés - Caché (tout passe par la sacoche) */
        #arcane-inventory {
            display: none;
        }
        #arcane-inventory .keys-count { color: var(--gold); font-weight: bold; font-size: 1.2em; }
        #arcane-inventory .keys-label { color: rgba(255,255,255,0.8); font-size: 0.75em; }
        /* Autel des Clés */
        #arcane-altar-panel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
            z-index: 510; background: rgba(0,0,0,0.9); border: 2px solid var(--gold); border-radius: 20px;
            padding: 24px; max-width: 340px; text-align: center;
        }
        .arcane-door { transition: opacity 0.5s, filter 0.5s; }
        .arcane-door.locked { opacity: 0.35; pointer-events: none; filter: grayscale(0.8); }
        /* Brouillard sombre */
        #arcane-dark-fog {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 440;
            background: radial-gradient(ellipse 150% 150% at 50% 50%, transparent 30%, rgba(10,5,20,0.7) 80%, rgba(5,2,15,0.9) 100%);
            opacity: var(--fog-opacity, 0.85); transition: opacity 1.5s ease;
        }
        /* === Système 100 niveaux === */
        #arcane-level-counter {
            position: fixed; top: 12px; right: 80px; z-index: 610;
            font-family: 'Cinzel', serif;
            font-size: 1.2rem; font-weight: 400;
            color: var(--gold);
            text-shadow: 0 0 15px rgba(212,175,55,0.5);
            letter-spacing: 0.2em;
        }
        .arcane-level-door {
            font-family: 'Cinzel', serif;
            min-width: 100px; padding: 16px 24px; margin: 8px;
            font-size: 0.9em; cursor: pointer; border-radius: 12px;
            border: 0.5px solid rgba(212, 175, 55, 0.3);
            background: rgba(0,0,0,0.6); color: var(--gold);
            transition: all 0.3s;
            font-weight: 400;
            letter-spacing: 0.05em;
        }
        .arcane-level-door:hover { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        .arcane-level-door.wrong { border-color: #ff4444; background: rgba(255,68,68,0.2); animation: door-shake 0.4s; }
        .arcane-level-door.vip-trap { opacity: 0.7; box-shadow: 0 0 12px rgba(255,68,68,0.6); border-color: rgba(255,100,100,0.6); }
        .arcane-level-door.vip-shortcut { opacity: 0.85; box-shadow: 0 0 14px rgba(212,175,55,0.7); border-color: rgba(212,175,55,0.8); }
        @keyframes door-shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
        #arcane-level-panel { max-width: 520px; }
        #arcane-doors-container { display: flex; flex-wrap: wrap; justify-content: center; margin: 20px 0; gap: 12px; }
        .arcane-scroll-object { position: absolute; width: 36px; height: 36px; cursor: pointer; z-index: 465;
            font-size: 1.4em; opacity: 0.5; transition: opacity 0.3s; pointer-events: auto;
            filter: drop-shadow(0 0 8px rgba(212,175,55,0.5));
        }
        .arcane-scroll-object:hover { opacity: 1; }
        .arcane-scroll-object.revealed { opacity: 0.3; pointer-events: none; }
        .arcane-corner-clue { position: absolute; width: 32px; height: 32px; cursor: pointer; z-index: 464;
            font-size: 1.2em; opacity: 0.35; transition: opacity 0.3s; pointer-events: auto;
        }
        .arcane-corner-clue:hover { opacity: 1; }
        .arcane-corner-clue.used { opacity: 0.2; pointer-events: none; }
        #arcane-pyramid-map {
            display: none; /* Caché pour épuration */
        }
        .pyramid-row { display: flex; justify-content: center; gap: 2px; margin: 1px 0; font-size: 8px; }
        .pyramid-cell { width: 10px; height: 10px; background: rgba(255,255,255,0.1); border-radius: 2px; color: #666; }
        .pyramid-cell.player { background: var(--gold); color: #000; box-shadow: 0 0 6px var(--gold); }
        #arcane-nav-key-panel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
            z-index: 512; background: rgba(0,0,0,0.92); border: 2px solid var(--gold); border-radius: 16px;
            padding: 20px; text-align: center;
        }
        /* L'Écho du Sanctuaire — Bandeau défilant style parchemin */
        #arcane-echo-journal {
            display: none; /* Caché pour épuration */
        }
        #arcane-echo-journal .echo-title { color: var(--gold); font-weight: 700; flex-shrink: 0; margin-right: 16px; letter-spacing: 0.12em; }
        #arcane-echo-ticker { flex: 1; overflow: hidden; white-space: nowrap; }
        #arcane-echo-ticker .echo-scroll { display: inline-block; padding-left: 100%; animation: echo-scroll 30s linear infinite; }
        #arcane-echo-ticker .echo-scroll.paused { animation-play-state: paused; }
        @keyframes echo-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .pyramid-cell.loot { animation: pyramid-loot-blink 1.5s ease-in-out infinite; }
        @keyframes pyramid-loot-blink { 0%,100% { background: rgba(212,175,55,0.4); box-shadow: 0 0 4px var(--gold); } 50% { background: var(--gold); color: #000; box-shadow: 0 0 10px var(--gold); } }
        /* === Grimoire d'Arcana === */
        #grimoire-btn {
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 2000;
            display: none; /* Caché par défaut pour épuration */
            width: 56px; height: 56px; border-radius: 12px;
            background: linear-gradient(145deg, #2a2520, #1a1612);
            border: 0.5px solid rgba(212,175,55,0.6);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(212,175,55,0.2);
            cursor: pointer; font-size: 1.8em; display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        #grimoire-btn:hover { transform: scale(1.08); box-shadow: 0 0 25px rgba(212,175,55,0.5), 0 0 8px var(--gold); }
        #grimoire-panel {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.85);
            z-index: 600; width: 94vw; max-width: 420px; max-height: 90vh;
            background: linear-gradient(180deg, #f4e9d0 0%, #e8dcc4 20%, #dfd0a8 50%, #d4c490 100%);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"),
                linear-gradient(180deg, #f4e9d0 0%, #e8dcc4 20%, #dfd0a8 50%, #d4c490 100%);
            border: 3px solid #b8860b;
            box-shadow: 0 0 30px rgba(184,134,11,0.5), inset 0 1px 0 rgba(255,255,255,0.3), 4px 4px 15px rgba(0,0,0,0.2);
            border-radius: 4px;
            font-family: 'Libre Baskerville', 'Times New Roman', Georgia, serif;
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        #grimoire-panel.grimoire-open {
            opacity: 1; transform: translate(-50%,-50%) scale(1);
            animation: grimoire-book-open 0.5s ease-out forwards;
        }
        @keyframes grimoire-book-open {
            0% { transform: translate(-50%,-50%) scale(0.7); opacity: 0; }
            60% { transform: translate(-50%,-50%) scale(1.02); opacity: 1; }
            100% { transform: translate(-50%,-50%) scale(1); opacity: 1; }
        }
        .grimoire-paper {
            padding: 20px 22px 24px; margin: 12px; margin-right: 18px;
            background: rgba(250,245,230,0.5);
            border: 1px solid rgba(184,134,11,0.3);
            border-radius: 2px;
            color: #3d3525;
            font-size: clamp(0.9rem, 2.8vw, 1.05rem);
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
        }
        .grimoire-tome-title { font-size: clamp(1rem, 3.5vw, 1.25rem); font-weight: 700; color: #5c4a2a; text-align: center; margin-bottom: 16px; letter-spacing: 0.08em; }
        .grimoire-tome-text { margin-bottom: 20px; text-align: justify; }
        .grimoire-unlock-btn { width: 100%; padding: 14px 20px; margin: 16px 0; font-size: clamp(0.85rem, 2.8vw, 1rem);
            background: linear-gradient(180deg, #d4af37 0%, #b8860b 100%); color: #1a1510;
            border: 2px solid #8b6914; border-radius: 8px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .grimoire-unlock-btn:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(212,175,55,0.4); }
        .grimoire-inv-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 18px; }
        .grimoire-inv-item { display: flex; flex-direction: column; align-items: center; padding: 12px 8px;
            background: rgba(255,255,255,0.5); border: 1px solid rgba(184,134,11,0.4);
            border-radius: 8px; font-size: clamp(0.75rem, 2.2vw, 0.9rem); color: #4a3d2a;
        }
        .grimoire-inv-icon { font-size: 1.8em; margin-bottom: 6px; }
        .grimoire-inv-num { font-weight: bold; color: #5c4a2a; }
        .grimoire-close { position: absolute; top: 10px; right: 10px; width: 36px; height: 36px; border: 1px solid rgba(184,134,11,0.5);
            background: rgba(220,200,160,0.4); color: #5c4a2a; border-radius: 6px; cursor: pointer; font-size: 1.3em; z-index: 2;
        }
        .grimoire-close:hover { background: rgba(184,134,11,0.3); }
        
        /* === PAPYRUS ANCIEN - Modal Centrée avec fond transparent === */
        #papyrus-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #papyrus-modal.active {
            display: flex;
            opacity: 1;
        }
        .papyrus-scroll {
            position: relative;
            width: 85vw;
            max-width: 650px;
            height: 75vh;
            max-height: 850px;
            /* Fond de parchemin beige/doré comme dans l'image */
            background: linear-gradient(180deg, #e8d5b5 0%, #d9c8a8 30%, #c9b898 70%, #b9a888 100%);
            background-image: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='paper-noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='5' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0.3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paper-noise)' opacity='0.2'/%3E%3C/svg%3E"),
                linear-gradient(180deg, #e8d5b5 0%, #d9c8a8 30%, #c9b898 70%, #b9a888 100%);
            border-left: 35px solid #6b5745;
            border-right: 35px solid #6b5745;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            border-radius: 8px;
            box-shadow: 
                0 0 80px rgba(0, 0, 0, 0.9),
                0 0 120px rgba(0, 0, 0, 0.7),
                inset 0 0 80px rgba(139, 115, 85, 0.25),
                inset 15px 0 40px rgba(0, 0, 0, 0.3),
                inset -15px 0 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transform: scaleY(0);
            transform-origin: top center;
            animation: papyrus-unroll 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            z-index: 10;
        }
        @keyframes papyrus-unroll {
            0% {
                transform: scaleY(0) rotateX(90deg);
                opacity: 0;
            }
            30% {
                opacity: 0.5;
            }
            60% {
                transform: scaleY(1) rotateX(0deg);
                opacity: 1;
            }
            100% {
                transform: scaleY(1) rotateX(0deg);
                opacity: 1;
            }
        }
        @keyframes papyrus-roll-up {
            0% {
                transform: scaleY(1) rotateX(0deg);
                opacity: 1;
            }
            40% {
                transform: scaleY(0.7) rotateX(-15deg);
                opacity: 0.8;
            }
            100% {
                transform: scaleY(0) rotateX(-90deg);
                opacity: 0;
            }
        }
        .papyrus-scroll::before {
            content: '';
            position: absolute;
            top: 0;
            left: -35px;
            width: 35px;
            height: 100%;
            background: linear-gradient(90deg, #5a4735 0%, #6b5745 50%, #5a4735 100%);
            box-shadow: 
                inset -8px 0 15px rgba(0, 0, 0, 0.5),
                inset 0 0 5px rgba(0, 0, 0, 0.3);
            border-radius: 8px 0 0 8px;
        }
        .papyrus-scroll::after {
            content: '';
            position: absolute;
            top: 0;
            right: -35px;
            width: 35px;
            height: 100%;
            background: linear-gradient(90deg, #6b5745 0%, #5a4735 50%, #6b5745 100%);
            box-shadow: 
                inset 8px 0 15px rgba(0, 0, 0, 0.5),
                inset 0 0 5px rgba(0, 0, 0, 0.3);
            border-radius: 0 8px 8px 0;
        }
        .papyrus-content {
            padding: 70px 50px;
            height: 100%;
            overflow-y: auto;
            font-family: 'Cinzel', 'Times New Roman', serif;
            color: #2d1f15;
            position: relative;
            opacity: 0;
            animation: papyrus-text-fade 0.8s ease 0.8s forwards;
        }
        @keyframes papyrus-text-fade {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .papyrus-title {
            font-size: clamp(1.3rem, 3.5vw, 1.8rem);
            font-weight: 400;
            text-align: center;
            margin-bottom: 35px;
            color: #4a3520;
            text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.12em;
            border-bottom: 1px solid rgba(92, 61, 42, 0.25);
            padding-bottom: 20px;
            text-transform: uppercase;
        }
        .papyrus-text {
            font-size: clamp(0.95rem, 2.8vw, 1.1rem);
            line-height: 1.9;
            text-align: left;
            margin-bottom: 20px;
            text-indent: 0;
            font-style: normal;
            /* Effet encre ancienne */
            color: #3d2a1a;
            text-shadow: 
                0.5px 0.5px 1px rgba(92, 61, 42, 0.15);
            filter: contrast(1.05);
            font-weight: 400;
            letter-spacing: 0.02em;
        }
        .papyrus-text-russe {
            font-family: 'Libre Baskerville', 'Times New Roman', serif;
            font-size: clamp(1.3rem, 4vw, 1.8rem);
            text-align: center;
            font-style: italic;
            font-weight: 700;
            letter-spacing: 0.08em;
            color: #4a3520;
            text-shadow: 
                2px 2px 3px rgba(92, 61, 42, 0.4),
                0 0 3px rgba(61, 42, 26, 0.3),
                1px 1px 0 rgba(201, 185, 147, 0.2);
            filter: contrast(1.25) brightness(0.88) sepia(0.2);
            margin: 30px 0;
            padding: 25px 20px;
            background: 
                linear-gradient(135deg, rgba(92, 61, 42, 0.08) 0%, rgba(92, 61, 42, 0.04) 100%),
                repeating-linear-gradient(90deg, transparent 0, transparent 2px, rgba(92, 61, 42, 0.02) 2px, rgba(92, 61, 42, 0.02) 4px);
            border: 2px solid rgba(92, 61, 42, 0.2);
            border-radius: 10px;
            box-shadow: 
                inset 0 2px 5px rgba(92, 61, 42, 0.15),
                0 2px 8px rgba(0, 0, 0, 0.1);
            text-indent: 0;
            position: relative;
        }
        .papyrus-text-russe::before {
            content: '✦';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5em;
            opacity: 0.6;
        }
        .papyrus-text-russe::after {
            content: '✦';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5em;
            opacity: 0.6;
        }
        .papyrus-hieroglyph {
            text-align: center;
            font-size: 1.8em;
            margin: 25px 0;
            opacity: 0.7;
            color: #5a4535;
            letter-spacing: 0.3em;
        }
        .papyrus-close-btn {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 35px;
            background: linear-gradient(180deg, #6b5745, #5a4735);
            color: #e8d5b5;
            border: 2px solid #4a3520;
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            font-weight: 400;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }
        .papyrus-close-btn:hover {
            background: linear-gradient(180deg, #7b6755, #6b5745);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.7);
            border-color: #5a4735;
        }
        .papyrus-scroll-bar::-webkit-scrollbar {
            width: 10px;
        }
        .papyrus-scroll-bar::-webkit-scrollbar-track {
            background: rgba(92, 61, 42, 0.2);
        }
        .papyrus-scroll-bar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #8b7355, #6b5745);
            border-radius: 5px;
            border: 2px solid rgba(244, 233, 208, 0.3);
        }
        /* Responsive Papyrus */
        @media (max-width: 768px) {
            .papyrus-scroll {
                width: 95vw;
                height: 80vh;
                border-left-width: 20px;
                border-right-width: 20px;
            }
            .papyrus-content {
                padding: 40px 30px;
            }
            .papyrus-title {
                font-size: 1.3rem;
                margin-bottom: 20px;
            }
            .papyrus-text {
                font-size: 0.95rem;
                line-height: 1.7;
            }
            .papyrus-hieroglyph {
                font-size: 1.5em;
                margin: 20px 0;
            }
        }
        @media (max-width: 480px) {
            .papyrus-scroll {
                border-left-width: 15px;
                border-right-width: 15px;
            }
            .papyrus-content {
                padding: 30px 20px;
            }
            .papyrus-title {
                font-size: 1.1rem;
            }
            .papyrus-text {
                font-size: 0.85rem;
                text-indent: 25px;
            }
            .papyrus-close-btn {
                font-size: 0.8rem;
                padding: 10px 25px;
            }
        }
        
        /* === BOUTON SACOCHE - Centre bas, animation de rebond === */
        @keyframes bounceIn {
            0% { transform: translateX(-50%) rotateX(2deg) scale(0); opacity: 0; }
            60% { transform: translateX(-50%) rotateX(2deg) scale(1.1); opacity: 1; }
            80% { transform: translateX(-50%) rotateX(2deg) scale(0.95); }
            100% { transform: translateX(-50%) rotateX(2deg) scale(1); }
        }
        #btn-sacoche {
            position: fixed !important;
            bottom: 25px !important;
            left: 50% !important;
            transform: translateX(-50%) rotateX(2deg);
            z-index: 9999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: 
                linear-gradient(135deg, 
                    rgba(92, 74, 53, 0.98) 0%, 
                    rgba(74, 61, 47, 1) 50%, 
                    rgba(61, 47, 35, 1) 100%),
                repeating-linear-gradient(90deg, 
                    transparent 0, 
                    transparent 1px, 
                    rgba(0, 0, 0, 0.08) 1px, 
                    rgba(0, 0, 0, 0.08) 2px);
            border: 3px solid rgba(139, 115, 85, 0.9);
            box-shadow: 
                0 8px 35px rgba(0, 0, 0, 0.85),
                inset 0 2px 0 rgba(212, 175, 55, 0.2),
                inset 0 -3px 10px rgba(0, 0, 0, 0.5),
                0 0 25px rgba(139, 115, 85, 0.35);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            transition: all 0.3s ease;
        }
        #btn-sacoche::before {
            content: '';
            position: absolute;
            inset: 6px;
            border: 1px solid rgba(139, 115, 85, 0.3);
            border-radius: 4px;
            pointer-events: none;
        }
        #btn-sacoche::after {
            display: none;
        }
        #btn-sacoche:hover {
            border-color: rgba(212, 175, 55, 1);
            box-shadow: 
                0 10px 35px rgba(0, 0, 0, 0.9),
                0 0 25px rgba(212, 175, 55, 0.5),
                inset 0 2px 0 rgba(212, 175, 55, 0.3);
            transform: translateX(-50%) rotateX(2deg) scale(1.06);
        }
        #btn-sacoche.resonance {
            animation: sac-resonance-pulse 1.5s ease-in-out infinite;
        }
        @keyframes sac-resonance-pulse {
            0%, 100% {
                transform: translateX(-50%) rotateX(2deg) scale(1);
                box-shadow: 0 6px 25px rgba(0, 0, 0, 0.7), inset 0 2px 0 rgba(212, 175, 55, 0.15);
            }
            25% {
                transform: translateX(-50%) rotateX(2deg) scale(1.08);
                box-shadow: 0 0 35px rgba(212, 175, 55, 0.8), 0 0 18px rgba(255, 215, 0, 0.6), inset 0 0 12px rgba(212, 175, 55, 0.4);
            }
            50% {
                transform: translateX(-50%) rotateX(2deg) scale(1.12);
                box-shadow: 0 0 45px rgba(212, 175, 55, 1), 0 0 25px rgba(255, 215, 0, 0.8), inset 0 0 18px rgba(212, 175, 55, 0.6);
            }
            75% {
                transform: translateX(-50%) rotateX(2deg) scale(1.08);
                box-shadow: 0 0 35px rgba(212, 175, 55, 0.8), 0 0 18px rgba(255, 215, 0, 0.6), inset 0 0 12px rgba(212, 175, 55, 0.4);
            }
        }
        #btn-sacoche.resonance::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.3) 0%, transparent 70%);
            animation: sac-resonance-ring 1.5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes sac-resonance-ring {
            0%, 100% {
                transform: scale(1);
                opacity: 0;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
        }
        #btn-sacoche-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #d4af37, #b8860b);
            border-radius: 50%;
            border: 2px solid #000;
            font-size: 0.45em;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: #000;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.8);
            letter-spacing: 0;
        }
        
        /* === OVERLAY DRAWER - Très subtil pour voir le couloir === */
        #sac-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            z-index: 2400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        #sac-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* === BRUME ANIMÉE === */
        .mist-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/asfalt-dark.png');
            opacity: 0.2;
            filter: blur(8px);
            z-index: 1;
            pointer-events: none;
            animation: drift 60s linear infinite;
        }
        @keyframes drift {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }
        
        /* === DRAWER INVENTAIRE - Glassmorphism (fini glace transparente) === */
        #sac-inventaire {
            font-family: 'Cinzel', serif;
            position: fixed !important;
            top: 50%;
            left: 50%;
            z-index: 10000;
            width: min(920px, calc(100vw - 28px));
            max-height: min(78vh, 720px);
            background: rgba(255, 255, 255, 0.10) !important;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(0, 242, 255, 0.65);
            border-radius: 18px;
            box-shadow:
                0 0 0 1px rgba(0, 242, 255, 0.18) inset,
                0 0 26px rgba(0, 242, 255, 0.38),
                0 0 70px rgba(0, 242, 255, 0.16),
                0 30px 80px rgba(0, 0, 0, 0.85);
            padding: 16px 16px 14px;
            overflow-y: auto;
            transform: translate(-50%, -50%) scale(0.98);
            opacity: 0;
            pointer-events: none;
            transition: opacity 220ms ease, transform 220ms ease;
            color: rgba(245, 252, 255, 0.96);
        }
        #sac-inventaire.open {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }
        /* Scrollbar stylisée pour l'inventaire */
        #sac-inventaire::-webkit-scrollbar {
            width: 8px;
        }
        #sac-inventaire::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        #sac-inventaire::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.6), rgba(184, 134, 11, 0.6));
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.3);
        }
        #sac-inventaire::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.8), rgba(184, 134, 11, 0.8));
        }
        /* Firefox scrollbar */
        #sac-inventaire {
            scrollbar-width: thin;
            scrollbar-color: rgba(212, 175, 55, 0.6) rgba(0, 0, 0, 0.3);
        }
        #sac-inventaire-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.18);
        }
        #sac-inventaire-titre {
            font-family: 'Cinzel', serif;
            color: rgba(245, 252, 255, 0.92);
            font-size: 0.95em;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            font-weight: 300;
            text-shadow: 0 0 16px rgba(0, 242, 255, 0.18);
        }

        .sac-balances {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .sac-balance-card {
            background: rgba(0, 0, 0, 0.22);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 12px;
            padding: 10px 10px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: inset 0 0 18px rgba(255,255,255,0.04);
        }

        .sac-balance-label {
            font-size: 0.70em;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.78);
            font-weight: 200;
        }

        .sac-balance-value {
            margin-top: 6px;
            font-family: 'Orbitron', monospace;
            font-size: 1.05em;
            color: rgba(245, 252, 255, 0.98);
            text-shadow: 0 0 18px rgba(73, 202, 250, 0.22);
            font-weight: 700;
        }

        .sac-body {
            display: grid;
            grid-template-columns: 1.05fr 0.95fr;
            gap: 12px;
        }

        .sac-panel {
            background: rgba(0, 0, 0, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 14px;
            padding: 12px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .sac-panel-title {
            font-family: 'Cinzel', serif;
            color: rgba(245, 252, 255, 0.92);
            font-size: 0.86em;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            font-weight: 300;
            margin-bottom: 10px;
            opacity: 0.95;
        }
        #sac-btn-fermer {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.22);
            color: rgba(245, 252, 255, 0.92);
            font-size: 1.4em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 180ms ease, transform 180ms ease, background 180ms ease, border-color 180ms ease;
            opacity: 0.85;
        }
        #sac-btn-fermer:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(73, 202, 250, 0.55);
            transform: scale(1.06);
        }
        .sac-section {
            margin-bottom: 24px;
        }
        .sac-section-titre {
            font-family: 'Cinzel', serif;
            color: rgba(212, 175, 55, 0.9);
            font-size: 0.85em;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sac-section-titre::before {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(212, 175, 55, 0.3));
        }
        .sac-section-titre::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to left, transparent, rgba(212, 175, 55, 0.3));
        }
        #sac-slots-container {
            --hex: 78px;
            display: grid;
            grid-template-columns: repeat(4, var(--hex));
            justify-content: center;
            gap: 10px 12px;
            padding: 8px;
            background: transparent;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }
        .sac-slot {
            width: var(--hex);
            height: calc(var(--hex) * 0.92);
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(245, 252, 255, 0.48);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-size: 0.9em;
            color: rgba(245, 252, 255, 0.94);
            font-weight: bold;
            transition: all 0.25s ease;
            position: relative;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            clip-path: polygon(25% 6%, 75% 6%, 100% 50%, 75% 94%, 25% 94%, 0% 50%);
            --slot-x: 0px;
            transform: translateX(var(--slot-x));
        }

        #sac-slots-container .sac-slot:nth-child(4n+1),
        #sac-slots-container .sac-slot:nth-child(4n+2) {
            --slot-x: calc(var(--hex) * 0.24);
        }

        #sac-slots-container .sac-slot:nth-child(8n+1),
        #sac-slots-container .sac-slot:nth-child(8n+2) {
            --slot-x: 0px;
        }
        .sac-slot:hover {
            border-color: rgba(212, 175, 55, 0.7);
            background: rgba(212, 175, 55, 0.08);
            transform: translateX(var(--slot-x)) translateY(-2px);
        }
        .sac-slot:empty::after {
            content: '—';
            color: rgba(245, 252, 255, 0.35);
            font-size: 1.2em;
        }
        .sac-slot.filled {
            background: rgba(0, 242, 255, 0.10);
            border-color: rgba(0, 242, 255, 0.75);
            box-shadow: 0 0 22px rgba(0, 242, 255, 0.25), inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .sac-slot.filled::before {
            content: '🔑';
            font-size: 1.5em;
            margin-bottom: 4px;
        }
        .sac-slot.objet-actif {
            border-color: rgba(212, 175, 55, 1);
            background: rgba(212, 175, 55, 0.2);
            animation: objet-resonance-glow 2s ease-in-out infinite;
        }
        .sac-slot.objet-actif::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 8px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, transparent 70%);
            animation: objet-resonance-aura 2s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        /* === OBJETS DE QUÊTE === */
        #sac-objets-quete {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 14px 12px;
            background:
                linear-gradient(135deg, rgba(244, 233, 208, 0.16) 0%, rgba(201, 185, 147, 0.10) 100%),
                repeating-linear-gradient(90deg, transparent 0, transparent 2px, rgba(92, 61, 42, 0.04) 2px, rgba(92, 61, 42, 0.04) 4px);
            border-radius: 14px;
            border: 1px solid rgba(201, 185, 147, 0.18);
            min-height: 120px;
        }

        .sac-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .sac-action-btn {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            font-weight: 700;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.22);
            background: rgba(0, 0, 0, 0.25);
            color: rgba(245, 252, 255, 0.96);
            transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease;
        }

        .sac-action-btn:hover {
            transform: translateY(-1px);
        }

        .sac-action-withdraw {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.92), rgba(184, 134, 11, 0.92));
            color: rgba(0,0,0,0.92);
            border-color: rgba(255,255,255,0.22);
            box-shadow: 0 0 18px rgba(212,175,55,0.22);
        }

        .sac-action-disconnect {
            background: linear-gradient(135deg, rgba(255, 66, 66, 0.9), rgba(160, 22, 22, 0.92));
            color: rgba(255,255,255,0.96);
            border-color: rgba(255,255,255,0.22);
            box-shadow: 0 0 18px rgba(255,66,66,0.18);
        }

        @media (max-width: 820px) {
            .sac-body {
                grid-template-columns: 1fr;
            }
            #sac-slots-container {
                --hex: 70px;
            }
        }
        .objet-quete {
            background: rgba(0, 0, 0, 0.28);
            border: 1px solid rgba(73, 202, 250, 0.35);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            padding: 10px 10px;
            font-size: 1.35em;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .objet-quete-nom {
            font-size: 12px;
            line-height: 1.25;
            letter-spacing: 0.06em;
            color: rgba(255,255,255,0.88);
        }

        #sac-objets-quete-vide {
            color: rgba(92, 61, 42, 0.9);
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            opacity: 0.8;
            padding: 8px 6px;
        }
        /* Style spécial pour les papyrus anciens - Rouleau égyptien */
        .objet-quete.papyrus-ancien {
            background: linear-gradient(135deg, 
                rgba(233, 221, 196, 0.25) 0%, 
                rgba(217, 201, 163, 0.35) 50%, 
                rgba(201, 185, 147, 0.4) 100%);
            border-color: rgba(139, 115, 85, 0.7);
            border-radius: 8px;
            box-shadow: 
                inset 0 2px 8px rgba(139, 115, 85, 0.4),
                0 4px 15px rgba(139, 115, 85, 0.3),
                inset 0 0 40px rgba(244, 233, 208, 0.1);
            position: relative;
            overflow: visible;
        }
        /* Bâtons du rouleau (gauche et droite) */
        .objet-quete.papyrus-ancien::before {
            content: '';
            position: absolute;
            top: 5px;
            bottom: 5px;
            left: 8px;
            width: 4px;
            background: linear-gradient(180deg, #6b5745, #4a3d2f, #6b5745);
            border-radius: 2px;
            box-shadow: 
                1px 0 2px rgba(0, 0, 0, 0.3),
                inset 0 0 3px rgba(107, 87, 69, 0.5);
            pointer-events: none;
        }
        .objet-quete.papyrus-ancien::after {
            content: '';
            position: absolute;
            top: 5px;
            bottom: 5px;
            right: 8px;
            width: 4px;
            background: linear-gradient(180deg, #6b5745, #4a3d2f, #6b5745);
            border-radius: 2px;
            box-shadow: 
                -1px 0 2px rgba(0, 0, 0, 0.3),
                inset 0 0 3px rgba(107, 87, 69, 0.5);
            pointer-events: none;
        }
        .objet-quete.papyrus-ancien:hover {
            border-color: rgba(139, 115, 85, 1);
            background: linear-gradient(135deg, 
                rgba(233, 221, 196, 0.4) 0%, 
                rgba(217, 201, 163, 0.5) 50%, 
                rgba(201, 185, 147, 0.55) 100%);
            box-shadow: 
                inset 0 2px 8px rgba(139, 115, 85, 0.5),
                0 0 30px rgba(139, 115, 85, 0.6),
                0 6px 20px rgba(139, 115, 85, 0.4);
            transform: translateY(-4px) scale(1.05) rotateZ(-2deg);
        }
        .objet-quete.papyrus-ancien .objet-quete-nom {
            color: rgba(212, 175, 55, 0.95);
            font-weight: 600;
        }
        .objet-quete:hover {
            border-color: rgba(73, 202, 250, 0.8);
            background: rgba(73, 202, 250, 0.1);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 0 20px rgba(73, 202, 250, 0.3);
        }
        .objet-quete.objet-actif {
            border-color: rgba(212, 175, 55, 1);
            background: rgba(212, 175, 55, 0.2);
            animation: objet-resonance-glow 2s ease-in-out infinite;
            position: relative;
        }
        .objet-quete.objet-actif::before {
            content: '✨';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 1.2em;
            animation: objet-resonance-sparkle 1.5s ease-in-out infinite;
            filter: drop-shadow(0 0 4px rgba(212, 175, 55, 0.8));
        }
        .objet-quete.objet-actif::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 10px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, transparent 70%);
            animation: objet-resonance-aura 2s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes objet-resonance-glow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(212, 175, 55, 0.4), inset 0 0 10px rgba(212, 175, 55, 0.2);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 35px rgba(212, 175, 55, 0.9), 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(212, 175, 55, 0.4);
                transform: scale(1.05);
            }
        }
        @keyframes objet-resonance-sparkle {
            0%, 100% {
                opacity: 0.6;
                transform: rotate(0deg) scale(1);
            }
            50% {
                opacity: 1;
                transform: rotate(180deg) scale(1.2);
            }
        }
        @keyframes objet-resonance-aura {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.3);
            }
        }
        .objet-quete-nom {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.35em;
            font-family: 'Cinzel', serif;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            white-space: nowrap;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #sac-objets-quete-vide {
            grid-column: 1 / -1;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            font-style: italic;
            padding: 20px;
        }
        #sac-alerte-surcharge {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.95);
            color: #fff;
            padding: 6px 16px;
            border-radius: 8px;
            border: 2px solid #ff4444;
            font-family: 'Orbitron', monospace;
            font-size: 0.75em;
            font-weight: bold;
            letter-spacing: 0.05em;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5), 0 4px 12px rgba(0, 0, 0, 0.6);
            animation: sac-alerte-pulse 0.8s ease-in-out infinite;
            display: none;
            white-space: nowrap;
            text-align: center;
        }
        #sac-alerte-surcharge.active {
            display: block;
        }
        @keyframes sac-alerte-pulse {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.85; transform: translateX(-50%) scale(1.03); }
        }
        
        /* Responsive Tablette et Mobile */
        @media (max-width: 768px) {
            /* Sanctuaire - Layout adaptatif */
            #level-3-sanctuary {
                grid-template-columns: 90px 1fr 90px;
                padding: 15px;
                background: transparent !important;
            }
            .runes-column {
                min-height: 80vh;
                gap: 6px;
                padding: 30px 0;
                padding-top: 140px !important;
                background: transparent !important;
            }
            .runes-column.left {
                padding-left: 20px;
                padding-top: 140px !important;
            }
            .runes-column.right {
                padding-right: 20px;
                padding-top: 140px !important;
            }
            .rune-btn {
                width: 55px;
                height: 55px;
                font-size: 1.6em;
                background: transparent !important;
                border-width: 1px;
            }
            /* Sac à dos */
            #sac-inventaire {
                max-height: 80vh;
                padding: 20px 16px 16px;
            }
            #sac-inventaire-titre {
                font-size: 1em;
            }
            #sac-slots-container {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }
            .sac-slot {
                min-height: 55px;
                font-size: 0.8em;
            }
            #level-3-sanctuary.sac-ouvert {
                opacity: 0.5;
            }
            /* Sacoche */
            #btn-sacoche {
                width: 52px;
                height: 52px;
                font-size: 1.6em;
                bottom: 15px;
            }
        }
        @media (max-width: 480px) {
            #btn-sacoche {
                width: 48px;
                height: 48px;
                font-size: 1.5em;
                bottom: 12px;
            }
            #sac-inventaire {
                padding: 16px 12px 12px;
            }
            #sac-inventaire-titre {
                font-size: 0.95em;
            }
            #sac-slots-container {
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
                padding: 8px;
            }
            .sac-slot {
                min-height: 48px;
                font-size: 0.75em;
                border-width: 1.5px;
            }
            #sac-objets-quete {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
            }
            .sac-section-titre {
                font-size: 0.75em;
            }
        }
        /* --- SANCTUAIRE TRANSPARENT ET DORÉ --- */
        #level-3-sanctuary {
            background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%), 
                        url('https://images.unsplash.com/photo-1605806616949-1e87b487fc2f?q=80&w=2070&auto=format&fit=crop') !important;
            background-size: cover !important;
            display: flex !important;
            justify-content: space-between !important;
        }

        .glass-panel, .rune-column, .rune-container {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        /* Bordures unifiées 0.5px pour tous les panneaux */
        .glass-panel:not(.glitch):not(#level-3-sanctuary), #class-selection, #level-2-panel, #arcane-level-panel, #arcane-altar-panel,
        .oracle-network-alert, .papyrus-scroll, #grimoire-panel, .header-title-plate, .header-btn-pill {
            border: 0.5px solid var(--glass-border) !important;
        }
    </style>
    <!-- Google Fonts for digital effect -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=VT323&family=Cinzel:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <div id="brick-wall-overlay" aria-hidden="false">
        <div class="brick-panel left"></div>
        <div class="brick-panel right"></div>
        <button id="entrance-chest" type="button" aria-label="Entrer dans le Sanctuaire">
            <div class="holo-chest">
                <div class="holo-chest-subtitle">L'Oracle vous attend...</div>
                <div class="holo-chest-title">ENTRER DANS LE SANCTUAIRE</div>
            </div>
        </button>
    </div>

    <script>
        (function () {
            const STORAGE_KEY = 'arcana_brick_wall_open';
            const overlay = document.getElementById('brick-wall-overlay');
            const chest = document.getElementById('entrance-chest');
            const leftPanel = overlay ? overlay.querySelector('.brick-panel.left') : null;
            const rightPanel = overlay ? overlay.querySelector('.brick-panel.right') : null;

            if (!overlay || !chest) return;

            const setOpen = (open) => {
                if (open) {
                    try { document.body.classList.add('corridor-entrance-bg'); } catch (e) {}
                    overlay.classList.add('open');
                    var done = 0;
                    var finish = function() {
                        done++;
                        if (done < 2) return;
                        try {
                            overlay.classList.add('hidden');
                            overlay.setAttribute('aria-hidden', 'true');
                        } catch (e) {}
                        try { if (leftPanel) leftPanel.remove(); } catch (e) {}
                        try { if (rightPanel) rightPanel.remove(); } catch (e) {}
                        try { overlay.remove(); } catch (e) {}
                    };

                    if (leftPanel) leftPanel.addEventListener('transitionend', function(e) {
                        if (e && e.propertyName !== 'transform') return;
                        finish();
                    }, { once: true });
                    if (rightPanel) rightPanel.addEventListener('transitionend', function(e) {
                        if (e && e.propertyName !== 'transform') return;
                        finish();
                    }, { once: true });

                    window.setTimeout(function() {
                        finish();
                        finish();
                    }, 1400);
                } else {
                    overlay.classList.remove('hidden');
                    overlay.classList.remove('open');
                    overlay.setAttribute('aria-hidden', 'false');
                }
            };

            try {
                if (localStorage.getItem(STORAGE_KEY) === '1') {
                    setOpen(true);
                }
            } catch (e) {}

            chest.addEventListener('click', function () {
                setOpen(true);
                try { localStorage.setItem(STORAGE_KEY, '1'); } catch (e) {}
            });
        })();
    </script>

    <!-- ╔═══════════════════════════════════════════════════════════════════╗ -->
    <!-- ║   GRILLE DES 12 RUNES - AFFICHAGE PRIORITAIRE (CHARGEMENT IMMÉDIAT) ║ -->
    <!-- ╚═══════════════════════════════════════════════════════════════════╝ -->
    <div id="level-3-sanctuary" class="glass-panel" data-room="2">
        <!-- ═══ COLONNE GAUCHE - RUNES 1-6 ═══ -->
        <div class="runes-column left" role="region" aria-label="Runes gauches">
            <button class="rune-btn" data-index="0" data-symbol="⏀" onclick="onRuneClick(0)" aria-label="Rune 1" title="🔍 Rune 1 : Le Chercheur">⏀</button>
            <button class="rune-btn" data-index="1" data-symbol="⏃" onclick="onRuneClick(1)" aria-label="Rune 2" title="🔍 Rune 2 : Le Chercheur">⏃</button>
            <button class="rune-btn" data-index="2" data-symbol="⏇" onclick="onRuneClick(2)" aria-label="Rune 3" title="🔍 Rune 3 : Le Chercheur">⏇</button>
            <button class="rune-btn" data-index="3" data-symbol="⎈" onclick="onRuneClick(3)" aria-label="Rune 4" title="🔍 Rune 4 : Le Chercheur">⎈</button>
            <button class="rune-btn" data-index="4" data-symbol="⏍" onclick="onRuneClick(4)" aria-label="Rune 5" title="🔒 Rune 5 : Le Verrou">⏍</button>
            <button class="rune-btn" data-index="5" data-symbol="⏎" onclick="onRuneClick(5)" aria-label="Rune 6" title="🔒 Rune 6 : Le Verrou">⏎</button>
        </div>

        <!-- ═══ COLONNE DROITE - RUNES 7-12 ═══ -->
        <div class="runes-column right" role="region" aria-label="Runes droites">
            <button class="rune-btn" data-index="6" data-symbol="⏏" onclick="onRuneClick(6)" aria-label="Rune 7" title="🔒 Rune 7 : Le Verrou">⏏</button>
            <button class="rune-btn" data-index="7" data-symbol="⏐" onclick="onRuneClick(7)" aria-label="Rune 8" title="🔒 Rune 8 : Le Verrou">⏐</button>
            <button class="rune-btn" data-index="8" data-symbol="⏑" onclick="onRuneClick(8)" aria-label="Rune 9" title="🔨 Rune 9 : L'Atelier">⏑</button>
            <button class="rune-btn" data-index="9" data-symbol="⏒" onclick="onRuneClick(9)" aria-label="Rune 10" title="🔨 Rune 10 : L'Atelier">⏒</button>
            <button class="rune-btn" data-index="10" data-symbol="⏓" onclick="onRuneClick(10)" aria-label="Rune 11" title="🍺 Rune 11 : La Taverne">⏓</button>
            <button class="rune-btn" data-index="11" data-symbol="⏔" onclick="onRuneClick(11)" aria-label="Rune 12" title="🔮 Rune 12 : L'Oracle">⏔</button>
        </div>
    </div>
    <!-- ╚═══════════════════════════════════════════════════════════════════╝ -->
    
    <div id="star-container"></div>
    <div id="arcana-fog" aria-hidden="true"></div>
    <header>
        <!-- Logo Arcana à gauche -->
        <div class="logo-arcana">
            <img src="logo.png" alt="Arcana" style="height: 45px; margin-right: 10px;">
            <span class="logo-arcana-title">ARCANA</span>
        </div>
        
        <!-- Titre central avec plaque décorative -->
        <div class="header-title-plate">
            <h1 class="header-title-main">LE SANCTUAIRE DU DESTIN</h1>
            <div class="header-title-separator"></div>
            <div class="header-title-level">LEVEL <span id="header-level-num">1</span></div>
        </div>
        
        <!-- Boutons de navigation à droite -->
        <div class="header-nav-buttons">
            <a href="./index.html" class="header-btn-pill">RETOUR AU COFFRE</a>
            <button class="header-btn-pill" id="header-connect-wallet-btn">CONNECT WALLET</button>
        </div>
    </header>

    <div id="frost-particles" aria-hidden="true"></div>
    <div id="arcana-connect-gate">
    </div>
    <div id="arcane-dark-fog" style="opacity:0; pointer-events:none;"></div>
    <div id="arcane-darkness-overlay" style="opacity:0;"></div>
    <div id="arcane-inventory" style="display:none;">
        <span class="keys-label">Clés</span>
        <span id="arcane-keys-count" class="keys-count">0</span>
        <span class="keys-label" style="margin-left:12px;">Nav</span>
        <span id="arcane-navkeys-count" class="keys-count">0</span>
        <span class="keys-label" style="margin-left:12px;">🛡️</span>
        <span id="arcane-protection-count" class="keys-count">0</span>
    </div>
    <div id="arcane-level-counter" style="display:none;">NIVEAU <span id="arcane-level-num">1</span> / 100</div>
    
    <!-- ═══ CONTENEUR PRINCIPAL DU JEU ═══ -->
    <div id="game-container" class="arcana-game-content">
        <div class="title-vault">THE ARCANA VAULT</div>
        <div id="class-selection" class="glass-panel" style="display:none; text-align:center;">
            <div class="label-gold">Rite d'Engagement / Étape 1</div>
            <h2 style="letter-spacing: 2px;">CHOISISSEZ VOTRE DESTIN</h2>
            <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                <div class="class-card" onclick="selectClass('Scribe')">
                    <div class="class-icon">🔨</div>
                    <p>SCRIBE</p>
                </div>
                <div class="class-card" onclick="selectClass('Invocateur')">
                    <div class="class-icon">🔱</div>
                    <p>INVOCATEUR</p>
                </div>
                <div class="class-card" onclick="selectClass('Gardien')">
                    <div class="class-icon">🛡️</div>
                    <p>GARDIEN</p>
                </div>
            </div>
        </div>

        <div id="level-2-panel" class="glass-panel" data-room="1">
            <div class="arcane-light-object" id="light-1" onclick="collectLight(1)" style="top:15px;right:20px;" title="Allumer la lumière">💡</div>
            <div class="label-gold">Guide Poche / Niveau 2</div>
            <div class="oracle-mirror">
                <span id="temp">—</span>
            </div>
            <div id="oracle-warning-message" class="oracle-temp-warning" style="display:none;"></div>
            <p style="text-align:center; font-size:0.8em; opacity:0.8;">Saisissez le sceau de l'alignement pour le Niveau 3</p>
            <input type="text" id="sealCodeInput" class="input-arcana" placeholder="CODE DE 6 CARACTÈRES">
            <button class="btn-connect arcane-door locked" id="btnSeal" onclick="onSealClick()" style="width:100%; margin-top:15px;">SCELLER LE DESTIN</button>
            <div class="label-gold" style="margin-top:12px;">Autel des Clés</div>
            <button class="btn-connect" onclick="openAltar()" style="width:100%; margin-top:8px; background:linear-gradient(45deg,#5c3d1e,#8b5a2b);">⚗️ Miser 1 Clé pour 3</button>
            <div class="label-gold" style="margin-top:16px;">Les 100 Niveaux</div>
            <button class="btn-connect" onclick="enterLevelMode()" style="width:100%; margin-top:8px; background:linear-gradient(45deg,#2d1f5c,#4a2d8b);">🏛️ ENTRER AUX 100 NIVEAUX</button>
            <div class="token-select-group">
                <input id="amountInput" type="number" min="0" step="any" class="input-arcana" placeholder="Montant" style="width: 110px;">
                <select id="tokenSelect" class="input-arcana" style="width: 120px; margin-top: 0;">
                    <option value="ARCANA" class="arcana-token-option">ARCANA</option>
                    <option value="USDT">USDT</option>
                    <option value="USDC">USDC</option>
                    <option value="MATIC">MATIC</option>
                </select>
            </div>
            <button id="btnDeposit" onclick="payStake()" class="btn-connect" style="width:100%; margin-top:15px; background:linear-gradient(45deg,#0d6b0d,#1a9c1a);">DÉPOSER</button>
            <small style="color:var(--gold); opacity:0.85; display:block; margin-top:7px;">Dépôt possible en ARCANA, USDT, USDC, MATIC sur le réseau Polygon.</small>
        </div>

        <div id="chat-temple" class="glass-panel">
            <div class="label-gold">Chat du Temple</div>
            <div style="margin-top:10px; height:80px; overflow-y:auto; border-bottom:1px solid var(--glass-border);">
                <p style="margin:5px 0;"><em>Système : Les trois classes sont réunies.</em></p>
                <p style="margin:5px 0;"><b style="color:var(--gold)">Scribe :</b> J'ai les deux premiers chiffres !</p>
            </div>
            <input type="text" class="input-arcana" style="font-size:0.8em; padding:5px;" placeholder="Message aux initiés...">
        </div>

        <span class="admin-trigger" onclick="toggleAdmin()" title="L'Œil d'Arcana (Ctrl+Shift+A)">🔮 Admin</span>
        <button id="grimoire-btn" onclick="toggleGrimoire()" title="Grimoire d'Arcana" style="display:none;">📖</button>

        <div id="admin-dashboard" class="glass-panel" style="display:none;">
            <button class="admin-close" onclick="hideAdmin()" title="Fermer">×</button>
            <div class="label-gold" style="color: rgba(220, 100, 100);">L'ŒIL D'ARCANA</div>
            <h3 style="letter-spacing: 2px; font-size: 1em;">Tableau de bord administrateur</h3>
            <div class="admin-stat"><span class="label-gold">Joueurs Connectés :</span> <span id="admin-players">0</span></div>
            <div class="admin-stat"><span class="label-gold">MATIC (natif) :</span> <span id="admin-balance">—</span></div>
            <div class="admin-stat"><span class="label-gold">ARCANA (jeton) :</span> <span id="admin-arcana-balance">—</span></div>
            <div class="admin-stat"><span class="label-gold">Statut Oracle (Température) :</span> <span id="admin-oracle">—</span></div>
            <button id="force-open" onclick="forceOpenAdmin()" class="btn-connect" style="width:100%; margin-top:15px; background:linear-gradient(45deg,#8b2222,#c03030);">FORCE OUVERTURE</button>
            <div class="label-gold" style="margin-top:15px;">Message aux Initiés</div>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <input type="text" id="broadcast-input" class="input-arcana" placeholder="Message aux Initiés" style="flex:1; margin-top:0;">
                <button onclick="emitBroadcast()" class="btn-connect" style="margin-top:0;">ÉMETTRE</button>
            </div>
            <div class="label-gold" style="margin-top:15px;">Log en temps réel</div>
            <div id="admin-log"></div>
        </div>
        
        <!-- Panel 100 niveaux : portes aléatoires -->
        <div id="arcane-level-panel" class="glass-panel" style="display:none; position:relative;">
            <div id="arcane-corner-clues-container" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>
            <div class="label-gold">Salle Niveau <span id="arcane-panel-level-num">1</span></div>
            <p style="color:rgba(255,255,255,0.85); font-size:0.85em; margin:12px 0;">Choisissez une porte. Pièges ou propulseurs ?</p>
            <div id="arcane-doors-container"></div>
            <div id="arcane-scrolls-container" style="position:relative; min-height:50px; margin-top:12px;"></div>
            <button class="btn-connect" onclick="useNavKey()" style="margin-top:12px; font-size:0.85em;">🗝️ Clé de Navigation (+5 / -5)</button>
        </div>
        
        <!-- Carte Pyramide -->
        <div id="arcane-pyramid-map">
            <div class="label-gold" style="font-size:0.65em; margin-bottom:4px;">Carte</div>
            <div id="pyramid-grid"></div>
        </div>
        
        <!-- L'Écho du Sanctuaire — Bandeau défilant -->
        <div id="arcane-echo-journal" style="display:none;">
            <div class="echo-title">L'ÉCHO DU SANCTUAIRE</div>
            <div id="arcane-echo-ticker"><span class="echo-scroll" id="arcane-echo-scroll"></span></div>
        </div>
        
        <!-- Panneau Clé de Navigation — Utiliser une Clé -->
        <div id="arcane-nav-key-panel">
            <div class="label-gold">Utiliser une Clé</div>
            <p style="margin:12px 0; font-size:0.9em;">Choisissez votre pouvoir :</p>
            <button class="btn-connect" onclick="navKeyPropulsion()" style="margin:4px;">⬆️ Propulsion : Saut +1 à +10</button>
            <button class="btn-connect" onclick="navKeyRappel()" style="margin:4px;">⬇️ Rappel : Ramasser un butin</button>
            <button class="btn-connect" onclick="closeNavKeyPanel()" style="margin-top:12px; background:transparent; border:1px solid #666;">Annuler</button>
        </div>
        
        <!-- Grimoire d'Arcana (Guide de Poche) -->
        <div id="grimoire-panel">
            <button class="grimoire-close" onclick="closeGrimoire()" title="Fermer">×</button>
            <div class="grimoire-paper">
                <h2 class="grimoire-tome-title">Tome I : Le Secret de l'Ascension Interdite</h2>
                <div class="grimoire-tome-text">
                    Au fond des couloirs scellés de la Pyramide, là où l'obscurité avale les pas des initiés, repose un savoir trop ancien pour les mortels. Ce grimoire renferme les runes oubliées de l'ascension — des chemins que les Sages ont tracés à travers cent portes, cent épreuves. Celui qui débloque ces pages verra ses clés se multiplier et ses yeux percer le voile des mirages.
                </div>
                <button class="grimoire-unlock-btn" onclick="unlockSavoir2POL()">DÉBLOQUER LE SAVOIR — 2 POL</button>
                <div class="label-gold" style="color:#5c4a2a; font-size:0.8em; margin-top:16px;">Inventaire de poche</div>
                <div class="grimoire-inv-grid">
                    <div class="grimoire-inv-item">
                        <span class="grimoire-inv-icon">⬆️</span>
                        <span>Clés Propulsion</span>
                        <span id="grimoire-propulsion" class="grimoire-inv-num">0</span>
                    </div>
                    <div class="grimoire-inv-item">
                        <span class="grimoire-inv-icon">⬇️</span>
                        <span>Clés Rappel</span>
                        <span id="grimoire-rappel" class="grimoire-inv-num">0</span>
                    </div>
                    <div class="grimoire-inv-item">
                        <span class="grimoire-inv-icon">💎</span>
                        <span>Butins Récupérés</span>
                        <span id="grimoire-butins" class="grimoire-inv-num">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Autel des Clés : pari 1→3 -->
        <div id="arcane-altar-panel">
            <div class="label-gold">Autel des Clés</div>
            <p style="color:rgba(255,255,255,0.9); margin:12px 0; font-size:0.9em;">Misez 1 clé pour tenter d'en gagner 3.</p>
            <div id="arcane-altar-cards" style="display:flex; gap:12px; justify-content:center; margin:16px 0;">
                <button class="btn-connect" style="width:70px; height:70px; font-size:1.5em;" onclick="pickAltarCard(0)">🂠</button>
                <button class="btn-connect" style="width:70px; height:70px; font-size:1.5em;" onclick="pickAltarCard(1)">🂠</button>
                <button class="btn-connect" style="width:70px; height:70px; font-size:1.5em;" onclick="pickAltarCard(2)">🂠</button>
            </div>
            <p id="arcane-altar-result" style="color:var(--gold); font-weight:bold; min-height:24px;"></p>
            <button class="btn-connect" onclick="closeAltar()" style="margin-top:12px;">Fermer</button>
        </div>
        
        <!-- ═══ VICTOIRE JACKPOT : Pluie d'or ═══ -->
        <div id="victory-jackpot">
            <div class="victory-text">✨ JACKPOT DÉVERROUILLÉ<br><span style="font-size:0.62em;color:#fff;letter-spacing:0.09em;">Le Destin, scellé dans l'or éternel</span></div>
            <div class="gold-rain"></div>
        </div>
    </div>
    <!-- ═══ FIN CONTENEUR PRINCIPAL (#game-container) ═══ -->
    
    <!-- ═══ EFFETS SONORES - Chargement optimisé ═══ -->
    <audio id="heartbeat-audio" preload="metadata" src="https://cdn.pixabay.com/audio/2022/08/20/audio_12c959d8f4.mp3"></audio>
    <audio id="triumph-audio" preload="metadata" src="https://cdn.pixabay.com/audio/2022/01/18/audio_8f0bc6dc2b.mp3"></audio>
    <audio id="ice-crackle-audio" preload="metadata" src="https://assets.mixkit.co/active_storage/sfx/2571-ice-break-2571.mp3"></audio>

    <div class="arcana-mention">Arcana Game - Écosystème Décentralisé</div>

    <!-- ═══ MODAL PAPYRUS ANCIEN ═══ -->
    <div id="papyrus-modal" onclick="fermerPapyrusOverlay(event)">
        <div class="papyrus-scroll" onclick="event.stopPropagation()">
            <div class="papyrus-content papyrus-scroll-bar">
                <div class="papyrus-title" id="papyrus-titre">Papyrus Ancien</div>
                <div class="papyrus-hieroglyph">⏀ ⏃ ⏇ ⎈</div>
                <div class="papyrus-text" id="papyrus-texte">
                    Sous la pierre froide, là où le givre se dépose en silence,
                    un secret millénaire attend celui qui sait regarder au-delà des apparences.
                    Les anciens Gardiens ont scellé ici un fragment de la Grande Connaissance,
                    écrit dans une langue que seul le cœur pur peut déchiffrer.
                </div>
                <div class="papyrus-hieroglyph">⏍ ⏎ ⏏</div>
                <div class="papyrus-text" id="papyrus-indice" style="text-align: center; font-weight: bold; font-size: 1.1em; text-indent: 0; color: #8b4513;">
                    « Le trésor se cache là où le givre rencontre l'or »
                </div>
            </div>
            <button class="papyrus-close-btn" onclick="fermerPapyrus()">✖ ROULER LE PAPYRUS</button>
        </div>
    </div>

    <!-- ═══ BRUME ANIMÉE - Derrière l'inventaire ═══ -->
    <div class="mist-layer" aria-hidden="true"></div>
    
    <!-- ═══ BOUTON SACOCHE - Flotte au-dessus du sanctuaire ═══ -->
    <button id="btn-sacoche" onclick="toggleSacInventaire()" title="Ouvrir l'inventaire" style="position:fixed;bottom:25px;left:50%;transform:translateX(-50%) rotateX(2deg);z-index:9999;display:block!important;">
        <span style="filter: sepia(0.3) contrast(1.1);">💼</span>
        <span id="btn-sacoche-badge">0</span>
    </button>

    <!-- ═══ OVERLAY DRAWER ═══ -->
    <div id="sac-overlay" onclick="fermerSacInventaire()"></div>

    <!-- ═══ DRAWER INVENTAIRE ═══ -->
    <div id="sac-inventaire">
        <div id="sac-alerte-surcharge">⚠️ SAC TROP LOURD - RISQUE DE PERTE</div>
        
        <div id="sac-inventaire-header">
            <div id="sac-inventaire-titre">📦 Inventaire</div>
            <button id="sac-btn-fermer" onclick="fermerSacInventaire()" title="Fermer">×</button>
        </div>

        <div class="sac-balances">
            <div class="sac-balance-card">
                <div class="sac-balance-label">Arcana</div>
                <div id="sac-solde-arcana" class="sac-balance-value">—</div>
            </div>
            <div class="sac-balance-card">
                <div class="sac-balance-label">Profits</div>
                <div id="sac-solde-profits" class="sac-balance-value">—</div>
            </div>
        </div>

        <div class="sac-body">
            <div class="sac-panel">
                <div class="sac-panel-title">Clés</div>
                <div id="sac-slots-container">
                    <div class="sac-slot" data-slot="0"></div>
                    <div class="sac-slot" data-slot="1"></div>
                    <div class="sac-slot" data-slot="2"></div>
                    <div class="sac-slot" data-slot="3"></div>
                    <div class="sac-slot" data-slot="4"></div>
                    <div class="sac-slot" data-slot="5"></div>
                    <div class="sac-slot" data-slot="6"></div>
                    <div class="sac-slot" data-slot="7"></div>
                    <div class="sac-slot" data-slot="8"></div>
                    <div class="sac-slot" data-slot="9"></div>
                </div>
            </div>

            <div class="sac-panel">
                <div class="sac-panel-title">Quêtes</div>
                <div id="sac-objets-quete">
                    <div id="sac-objets-quete-vide">Aucun objet de quête</div>
                </div>
            </div>
        </div>

        <div class="sac-actions">
            <button type="button" class="sac-action-btn sac-action-withdraw" onclick="arcanaWithdrawUI()">FONCTION RETRAIT</button>
            <button type="button" class="sac-action-btn sac-action-disconnect" onclick="arcanaDisconnectUI()">DISCONNECT</button>
        </div>
    </div>

<script type="module">
    (async function() {
      let wagmiConfig = null
      try {
        const { createWeb3Modal, defaultWagmiConfig } = await import('https://esm.sh/@web3modal/wagmi@5.1.11')
        const { mainnet, polygon } = await import('https://esm.sh/viem/chains')
        const { watchAccount, getWalletClient } = await import('https://esm.sh/@wagmi/core@2.13.4')
        const projectId = '7004f981f33f063167f1395567798132'
        const metadata = {
          name: 'Arcana',
          description: 'Arcana Game - Écosystème Décentralisé sur Polygon',
          url: 'https://arcana-ezl.pages.dev',
          icons: ['https://arcana-ezl.pages.dev/favicon.ico']
        }
        const chains = [mainnet, polygon]
        wagmiConfig = defaultWagmiConfig({ chains, projectId, metadata })
        createWeb3Modal({
          wagmiConfig,
          projectId,
          chains,
          defaultChain: polygon,
          enableAnalytics: false,
          enableOnramp: false,
          featuredWalletIds: ['c57ca95b47569778a828d19178114f4db188b89b763c899ba0be274e97267d96']
        })
        watchAccount(wagmiConfig, {
          onChange: async (account) => {
            if (account.address && window.arcanaOnW3mConnect) {
              try {
                const client = await getWalletClient(wagmiConfig)
                if (!client) return
                const eip1193 = (typeof client.request === 'function') ? client : (client.transport?.value ?? client.transport ?? client)
                const prov = new ethers.providers.Web3Provider(eip1193, 'any')
                const sgn = prov.getSigner()
                const acc = await sgn.getAddress()
                window.arcanaOnW3mConnect(prov, sgn, acc)
              } catch (err) { console.warn('wagmi provider:', err) }
            }
          }
        })
      } catch (e) {
        console.warn('Web3Modal wagmi init:', e);
        const { createAppKit } = await import('https://esm.sh/@reown/appkit@1.8.18');
        const { polygon } = await import('https://esm.sh/@reown/appkit@1.8.18/networks');
        const { Ethers5Adapter } = await import('https://esm.sh/@reown/appkit-adapter-ethers5@0.2.6');
        const modal = createAppKit({
          adapters: [new Ethers5Adapter()],
          networks: [polygon],
          defaultNetwork: polygon,
          metadata: {
            name: 'Arcana',
            description: 'Arcana Game - Écosystème Décentralisé sur Polygon',
            url: 'https://arcana-ezl.pages.dev',
            icons: ['https://arcana-ezl.pages.dev/favicon.ico']
          },
          projectId: '7004f981f33f063167f1395567798132',
          features: {
            analytics: false,
            onramp: false,
            email: false,
            socials: [],
            connectMethodsOrder: ['wallet']
          },
          featuredWalletIds: ['c57ca95b47569778a828d19178114f4db188b89b763c899ba0be274e97267d96'],
          themeMode: 'dark',
          themeVariables: { '--w3m-accent': '#d4af37' }
        });
        modal.subscribeProvider(async (state) => {
          if (state.isConnected && state.provider && window.arcanaOnW3mConnect) {
            const prov = new ethers.providers.Web3Provider(state.provider, 'any');
            const sgn = prov.getSigner();
            const acc = await sgn.getAddress();
            window.arcanaOnW3mConnect(prov, sgn, acc);
          } else if (!state.isConnected && window.arcanaOnW3mDisconnect) window.arcanaOnW3mDisconnect();
        });
      }
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', async (accounts) => {
          if (accounts?.[0] && window.arcanaOnW3mConnect) {
            const prov = new ethers.providers.Web3Provider(window.ethereum, 'any');
            const sgn = prov.getSigner();
            const acc = await sgn.getAddress();
            window.arcanaOnW3mConnect(prov, sgn, acc);
          }
        });
        window.ethereum.on('chainChanged', () => location.reload());
      }
    })();
  </script>

<!-- Lien stylisé d'ajout de token ARCANA à MetaMask juste après le bouton de dépôt -->
<style>
.arcana-add-metamask-link {
  display: inline-block;
  margin-top: 6px;
  color: #ffd700;
  font-size: 0.92em;
  font-family: inherit;
  cursor: pointer;
  text-decoration: underline dotted;
  transition: color 0.18s;
  background: transparent;
  border: none;
  padding: 0;
}
.arcana-add-metamask-link:hover {
  color: #fff2b8;
  text-decoration: underline;
}
</style>
<script>
  // --- CONFIGURATION OFFICIELLE ARCANA GAME ---
  const ARCANA_PROJECT_ID = "7004f981f33f063167f1395567798132";
  const ARCANA_GAME_CONTRACT = "0xFABF1FcFB7dA0Aa861A61747E1e5a2F2F8E9E337";
  const ADMIN_ADDRESS = ""; // À REMPLIR : adresse 0x... du wallet autorisé pour Force Ouverture
  const ARCANA_TOKEN_ADDRESS = "0x1990fd46a1ad0344751be45d6779b8c1f827076d";
  const USDT_TOKEN_ADDRESS   = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";
  const USDC_TOKEN_ADDRESS   = "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174";
  
  // ═════════════════════════════════════════════════════════════════════
  // 🔧 VARIABLE DE TEST : Bypass Oracle Météo
  // ═════════════════════════════════════════════════════════════════════
  let bypassOracle = true; // Mettez à true pour forcer l'accès en développement
  // ═════════════════════════════════════════════════════════════════════
  // Pour MATIC natif, pas besoin d'adresse.
  // Ajouter l'adresse du contrat d'Arcana Game pour la température si c'est un autre contrat
  const ARCANA_GAME_ORACLE_ABI = [
      "function currentTemp() view returns (int256)",
      "function updateOracle(int256 _temp) external"
  ];
  // Contrat de sauvegarde progression (mapping address => level). Sauvegarde persistante sur Polygon.
  const ARCANA_PROGRESSION_CONTRACT = ARCANA_GAME_CONTRACT; // ou "0x1...876d" pour reprendre où l'on s'est arrêté
  const ARCANA_PROGRESSION_ABI = [
      "function playerLevel(address) view returns (uint256)",
      "function setLevel(uint256 _level) external"
  ];

  // ERC20 ABI minimum pour approve/allowance/transferFrom/balanceOf (lecture+Transfert)
  const ERC20_ABI = [
      "function approve(address,uint256) public returns (bool)",
      "function allowance(address,address) public view returns (uint256)",
      "function balanceOf(address) public view returns (uint256)",
      "function decimals() public view returns (uint8)",
      "function transfer(address,uint256) public returns (bool)"
  ];

  // Polygon chainId
  const POLYGON_CHAIN_ID = "0x89"; // 137

  var provider, signer, account;

  var gameContainer = function() { return document.getElementById('game-container') || document.getElementById('arcana-game-content'); };

  // === Système d'obscurité, Lumière, Clés, Autel ===
  var arcaneKeys = 0;
  var arcaneLitRooms = {}; // roomId -> true
  var arcaneAltarWinIndex = -1;

  function updateArcaneInventory() {
      var el = document.getElementById('arcane-keys-count');
      if (el) el.textContent = arcaneKeys;
      var nav = document.getElementById('arcane-navkeys-count');
      if (nav) nav.textContent = arcaneNavKeys;
      var prot = document.getElementById('arcane-protection-count');
      if (prot) prot.textContent = arcaneProtectionKeys;
      var inv = document.getElementById('arcane-inventory');
      if (inv && gameContainer() && gameContainer().classList.contains('visible')) inv.style.display = 'flex';
      updateGrimoireInventory();
  }
  function updateGrimoireInventory() {
      var el = function(id, val) { var e = document.getElementById(id); if (e) e.textContent = (val !== undefined ? val : 0); };
      el('grimoire-propulsion', arcaneNavKeys);
      el('grimoire-rappel', arcaneNavKeys);
      el('grimoire-butins', arcaneButinsRecuperes + arcaneLootNFTs);
  }
  function toggleGrimoire() {
      var panel = document.getElementById('grimoire-panel');
      if (panel.style.display === 'block') { closeGrimoire(); return; }
      panel.style.display = 'block';
      updateGrimoireInventory();
      requestAnimationFrame(function() { panel.classList.add('grimoire-open'); });
  }
  function closeGrimoire() {
      var panel = document.getElementById('grimoire-panel');
      panel.classList.remove('grimoire-open');
      setTimeout(function() { panel.style.display = 'none'; }, 350);
  }
  async function unlockSavoir2POL() {
      var seller = GRIMOIRE_SELLER_WALLET || (isVipWallet(account) ? account : '');
      if (!seller || seller.length < 40) { addOracleChatMessage('Définissez GRIMOIRE_SELLER_WALLET (0x1...876d) pour recevoir les 2 POL.'); return; }
      if (!signer || !account) { addOracleChatMessage('Connectez votre wallet pour débloquer le savoir.'); return; }
      try {
          var wei = ethers.utils.parseEther('2');
          var tx = await signer.sendTransaction({ to: seller, value: wei, gasLimit: 21000 });
          await tx.wait();
          addOracleChatMessage('Le savoir est débloqué. 2 POL transmis.');
          echoAddMessage('Un Initié a débloqué le Tome I.');
      } catch (e) { addOracleChatMessage('Transaction échouée : ' + (e.message || e)); }
  }
  function grimoireUsePropulsion() {
      closeGrimoire();
      if (arcaneNavKeys < 1) { addOracleChatMessage('Pas de Clé de Propulsion.'); return; }
      navKeyPropulsion();
  }
  function grimoireUseRappel() {
      closeGrimoire();
      if (arcaneNavKeys < 1) { addOracleChatMessage('Pas de Clé de Rappel.'); return; }
      navKeyRappel();
  }
  function grimoireLightRoom(roomId) {
      if (arcaneKeys < 1) { addOracleChatMessage('Pas assez de clés pour éclairer.'); return; }
      if (arcaneLitRooms[roomId]) { addOracleChatMessage('Cette salle est déjà éclairée.'); return; }
      arcaneKeys--;
      arcaneLitRooms[roomId] = true;
      updateArcaneDoors();
      updateGrimoireInventory();
      updateArcaneInventory();
      applyLevelDarkness();
      addOracleChatMessage('La Salle ' + roomId + ' est désormais éclairée.');
      echoAddMessage('Un Initié a éclairé la Salle ' + roomId + '.');
  }
  async function buyBooklet(level) {
      var seller = GRIMOIRE_SELLER_WALLET || (isVipWallet(account) ? account : '');
      if (!seller || seller.length < 40) { addOracleChatMessage('Marché indisponible. Définissez GRIMOIRE_SELLER_WALLET avec l\'adresse du vendeur (0x1...876d).'); return; }
      if (!signer || !account) { addOracleChatMessage('Connectez votre wallet pour acheter.'); return; }
      var prices = { 5: 0.01, 15: 0.02, 25: 0.03, 50: 0.05, 100: 0.1 };
      var price = prices[level] || 0.01;
      var wei = ethers.utils.parseEther(price.toString());
      try {
          var tx = await signer.sendTransaction({ to: seller, value: wei, gasLimit: 21000 });
          await tx.wait();
          arcaneLootNFTs++;
          updateGrimoireInventory();
          addOracleChatMessage('Livret du Niveau ' + level + ' acheté ! +1 NFT de Butin.');
          echoAddMessage('Un Initié a acquis le Livret du Niveau ' + level + '.');
          closeGrimoire();
      } catch (e) { addOracleChatMessage('Achat échoué : ' + (e.message || e)); }
  }
  function updateArcaneFog() {
      var lit = Object.keys(arcaneLitRooms).length;
      var fog = document.getElementById('arcane-dark-fog');
      if (fog) fog.style.setProperty('--fog-opacity', Math.max(0, 0.85 - lit * 0.35).toString());
  }
  function updateArcaneDoors() {
      var btnSeal = document.getElementById('btnSeal');
      if (btnSeal) {
          if (arcaneLitRooms[1]) btnSeal.classList.remove('locked'); else btnSeal.classList.add('locked');
      }
  }

document.addEventListener('mousemove', function(e) {
    var overlay = document.getElementById('arcane-darkness-overlay');
    if (!overlay) return;
    var x = (e.clientX / window.innerWidth * 100).toFixed(2);
    var y = (e.clientY / window.innerHeight * 100).toFixed(2);
    overlay.style.setProperty('--cursor-x', x + '%');
    overlay.style.setProperty('--cursor-y', y + '%');
    var r = 120 + (arcaneLitRooms[1] ? 80 : 0) + (arcaneLitRooms[2] ? 80 : 0);
    var shrink = Math.max(0.08, 0.35 * Math.pow(0.95, arcaneCurrentLevel - 1));
    overlay.style.background = 'radial-gradient(circle ' + r + 'px at ' + x + '% ' + y + '%, transparent 0%, transparent ' + (shrink * 100) + '%, rgba(0,0,0,0.97) 100%)';
});
document.addEventListener('touchmove', function(e) {
    if (e.touches && e.touches[0]) {
        var t = e.touches[0];
        var overlay = document.getElementById('arcane-darkness-overlay');
        if (!overlay) return;
        var x = (t.clientX / window.innerWidth * 100).toFixed(2);
        var y = (t.clientY / window.innerHeight * 100).toFixed(2);
        overlay.style.setProperty('--cursor-x', x + '%');
        overlay.style.setProperty('--cursor-y', y + '%');
        var r = 120 + (arcaneLitRooms[1] ? 80 : 0) + (arcaneLitRooms[2] ? 80 : 0);
        var shrink = Math.max(0.08, 0.35 * Math.pow(0.95, arcaneCurrentLevel - 1));
        overlay.style.background = 'radial-gradient(circle ' + r + 'px at ' + x + '% ' + y + '%, transparent 0%, transparent ' + (shrink * 100) + '%, rgba(0,0,0,0.97) 100%)';
    }
}, { passive: true });

function collectLight(roomId) {
    if (arcaneLitRooms[roomId]) return;
    var lightEl = document.getElementById('light-' + roomId);
    if (lightEl) { lightEl.classList.add('collected'); }
    arcaneLitRooms[roomId] = true;
    arcaneKeys++;
    updateArcaneInventory();
    updateArcaneFog();
    updateArcaneDoors();
    
    // Ajouter une clé numérotée correspondante dans le sac
    var cleNum = roomId; // Clé 1 pour room 1, clé 2 pour room 2, etc.
    ajouterCleDansSac(cleNum);
    
    addOracleChatMessage('🔑 Lumière collectée ! Clé ' + cleNum + ' ajoutée à votre inventaire.');
    
    console.log('%c🔑 Lumière ' + roomId + ' collectée → Clé ' + cleNum + ' obtenue', 'color:#d4af37;');
}

function openAltar() {
    if (arcaneKeys < 1) { addOracleChatMessage('Vous n\'avez pas assez de clés.'); return; }
    arcaneAltarWinIndex = Math.floor(Math.random() * 3);
    document.getElementById('arcane-altar-panel').style.display = 'block';
    document.getElementById('arcane-altar-result').textContent = '';
    var cards = document.querySelectorAll('#arcane-altar-cards button');
    cards.forEach(function(b,i){ b.textContent = '❓'; b.disabled = false; });
}

function pickAltarCard(idx) {
    var cards = document.querySelectorAll('#arcane-altar-cards button');
    cards.forEach(function(b){ b.disabled = true; });
    var win = (idx === arcaneAltarWinIndex);
    cards[0].textContent = arcaneAltarWinIndex === 0 ? '🏆' : '💀';
    cards[1].textContent = arcaneAltarWinIndex === 1 ? '🏆' : '💀';
    cards[2].textContent = arcaneAltarWinIndex === 2 ? '🏆' : '💀';
    arcaneKeys--;
    if (win) { arcaneKeys += 3; addOracleChatMessage('Victoire ! +3 Clés.'); }
    else { addOracleChatMessage('Le destin n\'a pas souri.'); }
    updateArcaneInventory();
    document.getElementById('arcane-altar-result').textContent = win ? '✨ +3 Clés !' : 'La clé est perdue.';
}

function closeAltar() {
    document.getElementById('arcane-altar-panel').style.display = 'none';
}

// === VIP Bernard : 0x1...876d + Mode Test Oracle ===
var ARCANA_VIP_WALLET = ''; // Mettez l'adresse complète ou laissez vide
var ARCANA_TEST_WALLET = ''; // Wallet de test qui bypass l'Oracle (votre adresse complète ici)
var GRIMOIRE_SELLER_WALLET = ''; // Adresse complète du vendeur (0x1...876d) pour recevoir les ventes de livrets

function isVipWallet(addr) {
    if (!addr) return false;
    var a = (addr + '').toLowerCase();
    return (a.startsWith('0x1') && a.endsWith('876d') && a.length === 42) || (ARCANA_VIP_WALLET && a === ARCANA_VIP_WALLET.toLowerCase());
}

function isTestWallet(addr) {
    if (!addr) return false;
    var a = (addr + '').toLowerCase();
    return (ARCANA_TEST_WALLET && a === ARCANA_TEST_WALLET.toLowerCase());
}

// === Système 100 niveaux : progression, portes, difficulté, Web3 ===
const ARCANA_MAX_LEVEL = 100;
var arcaneCurrentLevel = 1;
var arcaneDoorDeltas = [];
var arcaneDoorRevealed = [];
var arcaneInLevelMode = false;
var arcaneNavKeys = 0;
var arcaneProtectionKeys = 0;
var arcaneLootLevels = [];
var arcaneTotalLootSpawned = 0;
var arcaneLootNFTs = 0;
var arcaneButinsRecuperes = 0;

function getDoorDestination(type) {
    if (type === 'trap') return -(1 + Math.floor(Math.random() * 5));
    if (type === 'propeller') return 2 + Math.floor(Math.random() * 7);
    return 1;
}

var arcaneEchoQueue = [];

function echoAddMessage(msg) {
    arcaneEchoQueue.push(msg);
    if (arcaneEchoQueue.length > 20) arcaneEchoQueue.shift();
    var scroll = document.getElementById('arcane-echo-scroll');
    if (scroll) {
        var txt = arcaneEchoQueue.join('  ◆  ');
        scroll.textContent = txt + (txt ? '  ◆  ' : '');
        scroll.style.animation = 'none';
        scroll.offsetHeight;
        scroll.style.animation = 'echo-scroll 40s linear infinite';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    try {
    } catch (e) {
    }
});

function ouvrirPorte(idx) {
    var delta = arcaneDoorDeltas[idx] !== undefined ? arcaneDoorDeltas[idx] : 1;
    var newLevel = Math.max(1, Math.min(ARCANA_MAX_LEVEL, arcaneCurrentLevel + delta));
    var doors = document.querySelectorAll('.arcane-level-door');
    doors.forEach(function(d){ d.disabled = true; });
    if (delta < 0) {
        var lostLevel = arcaneCurrentLevel;
        if (arcaneLootLevels.indexOf(lostLevel) === -1) {
            arcaneLootLevels.push(lostLevel);
            arcaneTotalLootSpawned++;
            echoAddMessage('Un trésor est apparu au Niveau ' + lostLevel + ' !');
        }
        addOracleChatMessage('Piège ! Retour au niveau ' + newLevel + '.');
    } else {
        if (delta > 1) echoAddMessage('Un Initié a sauté ' + delta + ' niveaux !');
        if (delta > 1) addOracleChatMessage('Propulseur ! Saut au niveau ' + newLevel + ' !');
        else addOracleChatMessage('Niveau ' + newLevel + ' atteint.');
    }
    goToLevel(newLevel);
}

function goToLevel(level, fromRappel) {
    var targetLevel = Math.max(1, Math.min(ARCANA_MAX_LEVEL, level));
    var lootLevel = targetLevel;
    if (fromRappel && arcaneLootLevels.indexOf(lootLevel) !== -1) {
        var isMirage = Math.random() < 0.10;
        if (isMirage && arcaneProtectionKeys < 1) {
            targetLevel = Math.max(1, lootLevel - 5);
            echoAddMessage('Le Mirage ! Un piège vous renvoie 5 niveaux en arrière.');
            addOracleChatMessage('Mirage : piège ! -5 niveaux.');
        } else if (isMirage && arcaneProtectionKeys >= 1) {
            arcaneProtectionKeys--;
            updateArcaneInventory();
            echoAddMessage('Clé de Protection : le Mirage est neutralisé.');
        }
        arcaneLootLevels = arcaneLootLevels.filter(function(l){ return l !== lootLevel; });
        if (!isMirage) { arcaneProtectionKeys++; arcaneButinsRecuperes++; updateArcaneInventory(); }
    }
    arcaneCurrentLevel = targetLevel;
    updateLevelDisplay();
    updatePyramidMap();
    generateLevelDoors();
    if (isVipWallet(account)) {
        console.log('%c[Omniscience] Butin pyramide — Total accumulé: ' + arcaneTotalLootSpawned + ' | Non ramassés: ' + arcaneLootLevels.length + ' | Niveaux: ' + (arcaneLootLevels.slice(0).sort(function(a,b){return a-b;}).join(', ') || '—') + ' | Niveau actuel: ' + arcaneCurrentLevel, 'color:#d4af37; font-weight:bold;');
    }
    spawnScrolls();
    spawnCornerClues();
    saveLevelWeb3(arcaneCurrentLevel);
}

function updateLevelDisplay() {
    var num = document.getElementById('arcane-level-num');
    var panelNum = document.getElementById('arcane-panel-level-num');
    var headerNum = document.getElementById('header-level-num');
    if (num) num.textContent = arcaneCurrentLevel;
    if (panelNum) panelNum.textContent = arcaneCurrentLevel;
    if (headerNum) headerNum.textContent = arcaneCurrentLevel;
    applyLevelDarkness();
}

function applyLevelDarkness() {
    var overlay = document.getElementById('arcane-darkness-overlay');
    if (overlay) {
        var r = 120 + (arcaneLitRooms[1] ? 80 : 0) + (arcaneLitRooms[2] ? 80 : 0);
        var shrink = Math.max(0.08, 0.35 * Math.pow(0.95, arcaneCurrentLevel - 1));
        overlay.style.background = 'radial-gradient(circle ' + r + 'px at var(--cursor-x, 50%) var(--cursor-y, 50%), transparent 0%, transparent ' + (shrink * 100) + '%, rgba(0,0,0,0.97) 100%)';
    }
}

function generateLevelDoors() {
    var count = 2 + Math.floor(Math.random() * 3);
    arcaneDoorDeltas = [];
    arcaneDoorRevealed = [];
    var types = ['normal','normal','trap','propeller'];
    var container = document.getElementById('arcane-doors-container');
    if (!container) return;
    container.innerHTML = '';
    for (var i = 0; i < count; i++) {
        var type = types[Math.floor(Math.random() * types.length)];
        var delta = getDoorDestination(type);
        arcaneDoorDeltas.push(delta);
        arcaneDoorRevealed.push(false);
        var btn = document.createElement('button');
        btn.className = 'arcane-level-door btn-connect' + (isVipWallet(account) ? (delta < 0 ? ' vip-trap' : ' vip-shortcut') : '');
        btn.textContent = '🚪 Porte ' + (i + 1);
        btn.dataset.index = i;
        btn.dataset.delta = delta;
        btn.onclick = function() { ouvrirPorte(parseInt(this.dataset.index, 10)); };
        container.appendChild(btn);
    }
}

function revealDoorWithScroll(doorIdx) {
    if (doorIdx < 0 || doorIdx >= arcaneDoorRevealed.length) return;
    arcaneDoorRevealed[doorIdx] = true;
    var doors = document.querySelectorAll('.arcane-level-door');
    var delta = arcaneDoorDeltas[doorIdx];
    var dest = arcaneCurrentLevel + delta;
    var lbl = delta < 0 ? '⬇ Niv.' + dest : (delta > 1 ? '⬆ Niv.' + dest : '→ +1');
    if (doors[doorIdx]) {
        doors[doorIdx].textContent = '🚪 ' + lbl;
        doors[doorIdx].title = 'Destination : niveau ' + dest;
    }
}

function spawnCornerClues() {
    var container = document.getElementById('arcane-corner-clues-container');
    if (!container || !arcaneDoorDeltas.length) return;
    container.innerHTML = '';
    var corners = [
        { pos: 'top:8px;left:8px;', label: '🔍' },
        { pos: 'top:8px;right:8px;left:auto;', label: '🔍' },
        { pos: 'bottom:8px;left:8px;', label: '🔍' },
        { pos: 'bottom:8px;right:8px;left:auto;', label: '🔍' }
    ];
    var n = 1 + Math.floor(Math.random() * 2);
    var used = [];
    for (var c = 0; c < n; c++) {
        var idx = Math.floor(Math.random() * corners.length);
        while (used.indexOf(idx) !== -1) idx = (idx + 1) % corners.length;
        used.push(idx);
        var el = document.createElement('div');
        el.className = 'arcane-corner-clue';
        el.style.cssText = corners[idx].pos + 'position:absolute;';
        el.textContent = corners[idx].label;
        el.title = 'Indice caché...';
        el.onclick = (function(clueEl) {
            return function() {
                if (clueEl.classList.contains('used')) return;
                var unrevealed = [];
                for (var i = 0; i < arcaneDoorRevealed.length; i++) { if (!arcaneDoorRevealed[i]) unrevealed.push(i); }
                if (unrevealed.length === 0) return;
                var doorIdx = unrevealed[Math.floor(Math.random() * unrevealed.length)];
                var delta = arcaneDoorDeltas[doorIdx];
                var typ = delta < 0 ? 'Piège' : 'Raccourci';
                var doors = document.querySelectorAll('.arcane-level-door');
                if (doors[doorIdx]) {
                    var lbl = typ + (delta < 0 ? ' ⬇' + (arcaneCurrentLevel + delta) : ' ⬆');
                    doors[doorIdx].textContent = '🚪 ' + lbl;
                    doors[doorIdx].title = typ + (delta < 0 ? ' -' + Math.abs(delta) + ' niveaux' : ' vers l\'avant');
                }
                arcaneDoorRevealed[doorIdx] = true;
                clueEl.classList.add('used');
                echoAddMessage('Indice : La Porte ' + (doorIdx + 1) + ' est un ' + typ + '.');
                addOracleChatMessage('Indice révélé : Porte ' + (doorIdx + 1) + ' = ' + typ + '.');
            };
        })(el);
        container.appendChild(el);
    }
}

function spawnScrolls() {
    var container = document.getElementById('arcane-scrolls-container');
    if (!container) return;
    container.innerHTML = '';
    var n = 1 + Math.floor(Math.random() * 2);
    for (var i = 0; i < n; i++) {
        var s = document.createElement('div');
        s.className = 'arcane-scroll-object';
        s.textContent = '📜';
        s.style.left = (15 + Math.random() * 70) + '%';
        s.style.top = (5 + Math.random() * 20) + 'px';
        s.onclick = (function() { return function() {
            if (this.classList.contains('revealed')) return;
            if (arcaneDoorDeltas.length) {
                var doorIdx = Math.floor(Math.random() * arcaneDoorDeltas.length);
                var useProbability = Math.random() < 0.5;
                if (useProbability) {
                    var pct = [20, 30, 40, 50, 60][Math.floor(Math.random() * 5)];
                    var targetLvl = Math.min(ARCANA_MAX_LEVEL, arcaneCurrentLevel + 5 + Math.floor(Math.random() * 45));
                    var msg = 'Parchemin : La Porte ' + (doorIdx+1) + ' a ' + pct + '% de chance d\'être un raccourci vers le Niveau ' + targetLvl + '.';
                    addOracleChatMessage(msg);
                    echoAddMessage(msg);
                    var doors = document.querySelectorAll('.arcane-level-door');
                    if (doors[doorIdx]) doors[doorIdx].title = pct + '% raccourci vers Niv.' + targetLvl;
                } else {
                    revealDoorWithScroll(doorIdx);
                    addOracleChatMessage('Parchemin : la Porte ' + (doorIdx+1) + ' mène au niveau ' + (arcaneCurrentLevel + arcaneDoorDeltas[doorIdx]) + '. +1 Clé Nav.');
                }
                this.classList.add('revealed');
                arcaneNavKeys++;
                updateArcaneInventory();
            }
        }; })();
        container.appendChild(s);
    }
}

function useNavKey() {
    if (arcaneNavKeys < 1) { addOracleChatMessage('Pas de Clé de Navigation.'); return; }
    document.getElementById('arcane-nav-key-panel').style.display = 'block';
}

function navKeyPropulsion() {
    if (arcaneNavKeys < 1) return;
    arcaneNavKeys--;
    updateArcaneInventory();
    closeNavKeyPanel();
    var jump = 1 + Math.floor(Math.random() * 10);
    goToLevel(arcaneCurrentLevel + jump);
    echoAddMessage('Propulsion activée : saut de ' + jump + ' niveaux !');
    addOracleChatMessage('Propulsion : +' + jump + ' niveaux.');
}

function navKeyRappel() {
    if (arcaneNavKeys < 1) return;
    arcaneNavKeys--;
    updateArcaneInventory();
    closeNavKeyPanel();
    var target = 0;
    if (arcaneLootLevels.length > 0) {
        target = arcaneLootLevels[Math.floor(Math.random() * arcaneLootLevels.length)];
    } else {
        target = Math.max(1, arcaneCurrentLevel - (5 + Math.floor(Math.random() * 10)));
    }
    goToLevel(target, true);
    echoAddMessage('Rappel : retour au Niveau ' + target + ' pour ramasser un butin.');
    addOracleChatMessage('Rappel vers le niveau ' + target + '.');
}

function closeNavKeyPanel() {
    document.getElementById('arcane-nav-key-panel').style.display = 'none';
}

function updatePyramidMap() {
    var grid = document.getElementById('pyramid-grid');
    var map = document.getElementById('arcane-pyramid-map');
    if (!grid || !map) return;
    grid.innerHTML = '';
    var rows = 10;
    var perRow = ARCANA_MAX_LEVEL / rows;
    for (var r = 0; r < rows; r++) {
        var rowDiv = document.createElement('div');
        rowDiv.className = 'pyramid-row';
        var start = Math.floor(r * perRow) + 1;
        var end = Math.min(ARCANA_MAX_LEVEL, Math.floor((r + 1) * perRow));
        for (var l = start; l <= end; l++) {
            var cell = document.createElement('div');
            var isPlayer = l === arcaneCurrentLevel;
            var hasLoot = arcaneLootLevels.indexOf(l) !== -1;
            cell.className = 'pyramid-cell' + (isPlayer ? ' player' : '') + (hasLoot ? ' loot' : '');
            cell.textContent = l;
            rowDiv.appendChild(cell);
        }
        grid.appendChild(rowDiv);
    }
    map.style.display = arcaneInLevelMode ? 'block' : 'none';
}

async function loadLevelWeb3() {
    if (!provider || !account) return;
    try {
        var c = new ethers.Contract(ARCANA_PROGRESSION_CONTRACT, ARCANA_PROGRESSION_ABI, provider);
        var lvl = await c.playerLevel(account);
        var n = lvl ? (typeof lvl === 'number' ? lvl : parseInt(lvl.toString(), 10)) : 0;
        if (n > 0 && n <= ARCANA_MAX_LEVEL) arcaneCurrentLevel = n;
    } catch (e) { console.warn('Load level:', e); }
}

async function saveLevelWeb3(level) {
    if (!signer || !account) return;
    try {
        var c = new ethers.Contract(ARCANA_PROGRESSION_CONTRACT, ARCANA_PROGRESSION_ABI, signer);
        var tx = await c.setLevel(level);
        await tx.wait();
    } catch (e) { console.warn('Save level:', e); }
}

function enterLevelMode() {
    arcaneInLevelMode = true;
    arcaneNavKeys = (arcaneNavKeys || 0) + 1;
    updateArcaneInventory();
    document.getElementById('arcane-level-counter').style.display = 'block';
    document.getElementById('arcane-level-panel').style.display = 'block';
    document.getElementById('arcane-pyramid-map').style.display = 'block';
    var journal = document.getElementById('arcane-echo-journal');
    if (journal) { journal.style.display = 'block'; echoAddMessage('Le Sanctuaire s\'éveille. Les 100 niveaux vous attendent.'); }
    updateLevelDisplay();
    generateLevelDoors();
    spawnScrolls();
    spawnCornerClues();
    updatePyramidMap();
    if (isVipWallet(account)) {
        console.log('%c[Omniscience] Entrée aux 100 niveaux — Butin total accumulé: ' + arcaneTotalLootSpawned + ' | Trésors en attente: ' + arcaneLootLevels.length, 'color:#d4af37; font-weight:bold;');
    }
    if (Math.random() < 0.3) {
        var rumourLvl = 1 + Math.floor(Math.random() * ARCANA_MAX_LEVEL);
        echoAddMessage('Rumeur : un butin a été signalé au Niveau ' + rumourLvl + '.');
    }
}

function gameContainer() {
    return document.getElementById('game-container') || document.getElementById('arcana-game-content');
}

function hideGameContent() {
    var gate = document.getElementById('arcana-connect-gate');
    var content = gameContainer();
    if (content) content.classList.remove('visible');
    if (gate) gate.classList.remove('hidden');
}

function showGameContent() {
    var gate = document.getElementById('arcana-connect-gate');
    var content = gameContainer();
    if (gate) gate.classList.add('hidden');
    if (content) content.classList.add('visible');
}

function triggerTransitionToSanctuary(prov, sgn, acc) {
    provider = prov; signer = sgn; account = acc;
    showGameContent();
    if (typeof updateWalletAddressDisplay === 'function') updateWalletAddressDisplay(acc);
}

window.arcanaOnW3mConnect = function(prov, sgn, acc) {
    provider = prov; signer = sgn; account = (typeof acc === 'string' ? acc : (acc && acc.address ? acc.address : acc));
    showGameContent();
    if (typeof updateWalletAddressDisplay === 'function') updateWalletAddressDisplay(account);
};
window.arcanaOnW3mDisconnect = hideGameContent;

function showOracleNetworkAlert() {
    if (document.getElementById('oracle-network-overlay')) return;
    var overlay = document.createElement('div');
    overlay.id = 'oracle-network-overlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9998;';
    var box = document.createElement('div');
    box.className = 'oracle-network-alert';
    box.innerHTML = '<p>L\'Oracle ne reconnaît que le réseau Polygon.</p><button class="btn-connect" onclick="switchToPolygon()">Passer sur Polygon</button><br><button class="btn-connect" style="margin-top:8px;background:transparent;border:1px solid #888;color:#888;" onclick="document.getElementById(\'oracle-network-overlay\').remove()">Fermer</button>';
    overlay.appendChild(box);
    document.body.appendChild(overlay);
}

function showStyledAlert(htmlMessage) {
    try {
        var existing = document.getElementById('arcana-styled-alert-overlay');
        if (existing) existing.remove();

        var overlay = document.createElement('div');
        overlay.id = 'arcana-styled-alert-overlay';
        overlay.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.72);z-index:10000;padding:20px;';

        var box = document.createElement('div');
        box.style.cssText = 'max-width:420px;width:100%;border-radius:16px;padding:18px 18px 14px 18px;background:linear-gradient(145deg, rgba(12,14,18,0.98), rgba(26,20,14,0.92));border:1px solid rgba(0,242,255,0.35);box-shadow:0 0 26px rgba(0,242,255,0.18), 0 0 80px rgba(0,0,0,0.85);color:rgba(255,255,255,0.92);font-family:\'Cinzel\', serif;letter-spacing:0.03em;';

        var content = document.createElement('div');
        content.style.cssText = 'font-size:14px;line-height:1.55;';
        content.innerHTML = (htmlMessage === undefined || htmlMessage === null) ? '' : String(htmlMessage);

        var actions = document.createElement('div');
        actions.style.cssText = 'display:flex;justify-content:center;margin-top:14px;';

        var btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = 'FERMER';
        btn.style.cssText = 'padding:10px 16px;border-radius:10px;border:1px solid rgba(212,175,55,0.35);background:rgba(212,175,55,0.12);color:rgba(245,252,255,0.95);font-family:\'Cinzel\', serif;letter-spacing:0.12em;cursor:pointer;';
        btn.onclick = function() {
            try { overlay.remove(); } catch (e) {}
        };

        overlay.onclick = function(e) {
            if (e && e.target === overlay) {
                try { overlay.remove(); } catch (err) {}
            }
        };

        actions.appendChild(btn);
        box.appendChild(content);
        box.appendChild(actions);
        overlay.appendChild(box);
        document.body.appendChild(overlay);
    } catch (e) {
        try { alert(String(htmlMessage || '')); } catch (err) {}
    }
}

async function switchToPolygon() {
    try {
        if (window.ethereum && provider) {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] });
            var overlay = document.getElementById('oracle-network-overlay');
            if (overlay) overlay.remove();
            if (provider && account) {
                window._arcanaTransitionDone = false;
                var sgn = provider.getSigner ? provider.getSigner() : null;
                if (sgn) triggerTransitionToSanctuary(provider, sgn, account);
            }
        }
    } catch (e) {
        if (e.code === 4902) {
            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x89', chainName: 'Polygon Mainnet', rpcUrls: ['https://polygon-rpc.com'], nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 }, blockExplorerUrls: ['https://polygonscan.com'] }] });
            var ov = document.getElementById('oracle-network-overlay');
            if (ov) ov.remove();
            if (provider && account) {
                window._arcanaTransitionDone = false;
                var s = provider.getSigner ? provider.getSigner() : null;
                if (s) triggerTransitionToSanctuary(provider, s, account);
            }
        }
    }
}

function updateWalletAddressDisplay(addr) {
    var existing = document.getElementById('wallet-address-badge');
    if (existing) existing.remove();
    var existingTest = document.getElementById('test-mode-badge');
    if (existingTest) existingTest.remove();
    
    if (!addr || addr.length < 10) return;
    
    var short = addr.slice(0, 6) + '…' + addr.slice(-4);
    var badge = document.createElement('div');
    badge.id = 'wallet-address-badge';
    badge.className = 'wallet-address-badge';
    badge.textContent = short;
    document.body.appendChild(badge);
    
    // Ajouter badge de mode test si applicable
    if (isTestWallet(addr)) {
        var testBadge = document.createElement('div');
        testBadge.id = 'test-mode-badge';
        testBadge.className = 'test-mode-badge';
        testBadge.innerHTML = '🧪 MODE TEST';
        testBadge.title = 'Oracle Bypass Activé : Toutes les fonctions sont débloquées';
        document.body.appendChild(testBadge);
    }
}

function addOracleChatMessage(msg) {
    var chatContainer = document.querySelector('#chat-temple div[style*="overflow-y"]') || document.querySelector('#chat-temple > div:nth-child(2)');
    if (chatContainer) {
        var p = document.createElement('p');
        p.style.cssText = 'margin:5px 0; color:var(--gold); font-weight:bold;';
        p.textContent = msg;
        chatContainer.appendChild(p);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

async function fetchAndDisplayTemperature() {
    var fallback = { city: 'Montréal', latitude: 45.5017, longitude: -73.5673 };

    function getPosition() {
        return new Promise(function(resolve, reject) {
            if (!navigator.geolocation) return reject(new Error('geolocation_unavailable'));
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 8000,
                maximumAge: 60000
            });
        });
    }

    function roundTemp(n) {
        return (typeof n === 'number' && isFinite(n)) ? Math.round(n) : n;
    }

    try {
        var warningInit = document.getElementById('oracle-warning-message');
        if (warningInit) {
            warningInit.textContent = "Initialisation de l'Oracle...";
            warningInit.style.display = 'block';
        }

        var lat = fallback.latitude;
        var lon = fallback.longitude;
        var city = fallback.city;

        try {
            var pos = await getPosition();
            if (pos && pos.coords) {
                lat = pos.coords.latitude;
                lon = pos.coords.longitude;
            }
        } catch (geoErr) {
            lat = fallback.latitude;
            lon = fallback.longitude;
            city = fallback.city;
        }

        try {
            var reverseUrl = 'https://geocoding-api.open-meteo.com/v1/reverse?latitude=' + encodeURIComponent(lat) + '&longitude=' + encodeURIComponent(lon) + '&language=fr&limit=1';
            var reverseResp = await fetch(reverseUrl);
            var reverseData = await reverseResp.json();
            if (reverseData && reverseData.results && reverseData.results[0] && reverseData.results[0].name) {
                city = reverseData.results[0].name;
            }
        } catch (e) {
            city = city || fallback.city;
        }

        var weatherUrl = 'https://api.open-meteo.com/v1/forecast?latitude=' + encodeURIComponent(lat) + '&longitude=' + encodeURIComponent(lon) + '&current=temperature_2m&temperature_unit=celsius';
        var weatherResp = await fetch(weatherUrl);
        var weatherData = await weatherResp.json();
        var tempC = weatherData && weatherData.current ? weatherData.current.temperature_2m : null;
        tempC = (typeof tempC === 'number') ? tempC : (tempC !== null ? Number(tempC) : null);
        var displayTemp = roundTemp(tempC);

        window.oracleTemperature = (displayTemp !== null && isFinite(displayTemp)) ? displayTemp : null;

        const tempDisplay = document.getElementById('temp');
        const depositBtn = document.getElementById('btnDeposit');
        const amountInput = document.getElementById('amountInput');
        const tokenSelect = document.getElementById('tokenSelect');
        const warningMsg = document.getElementById('oracle-warning-message');
        const oracleMirror = document.querySelector('.oracle-mirror');

        if (tempDisplay) {
            tempDisplay.textContent = (displayTemp !== null && isFinite(displayTemp)) ? (displayTemp + '°C') : '—';
        }

        if (warningMsg) {
            if (displayTemp !== null && isFinite(displayTemp)) {
                warningMsg.textContent = 'Ah, je vois... Il fait actuellement ' + displayTemp + '°C à ' + city + '.';
            } else {
                warningMsg.textContent = 'Ah, je vois... Je ne parviens pas à lire la température pour le moment.';
            }
            warningMsg.style.display = 'block';
        }

        if (oracleMirror) {
            if (displayTemp !== null && isFinite(displayTemp) && displayTemp <= -10) oracleMirror.classList.add('frozen');
            else oracleMirror.classList.remove('frozen');
        }

        if (depositBtn) {
            depositBtn.disabled = false;
            depositBtn.classList.remove('disabled');
        }

        if (amountInput) amountInput.disabled = false;
        if (tokenSelect) tokenSelect.disabled = false;
    } catch (e) {
        const warningMsg = document.getElementById('oracle-warning-message');
        const depositBtn = document.getElementById('btnDeposit');
        const amountInput = document.getElementById('amountInput');
        const tokenSelect = document.getElementById('tokenSelect');
        if (warningMsg) {
            warningMsg.textContent = 'Ah, je vois... Je ne parviens pas à lire la température pour le moment.';
            warningMsg.style.display = 'block';
        }
        if (depositBtn) {
            depositBtn.disabled = false;
            depositBtn.classList.remove('disabled');
        }

        if (amountInput) amountInput.disabled = false;
        if (tokenSelect) tokenSelect.disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    try {
        fetchAndDisplayTemperature();
        setInterval(fetchAndDisplayTemperature, 180000);
    } catch (e) {
    }
});

    // === ADMINISTRATION ET STATISTIQUES ===
    async function refreshAdminStats() {
        const balanceEl = document.getElementById('admin-balance');
        const arcanaBalanceEl = document.getElementById('admin-arcana-balance');
        const oracleEl = document.getElementById('admin-oracle');
        try {
            if (!provider) provider = new ethers.providers.Web3Provider(window.ethereum);
            const contractAddr = ARCANA_GAME_CONTRACT;
            
            if (balanceEl) {
                const maticBalance = await provider.getBalance(contractAddr);
                balanceEl.textContent = parseFloat(ethers.utils.formatEther(maticBalance)).toFixed(2) + ' MATIC';
            }
            if (arcanaBalanceEl) {
                const arcanaToken = new ethers.Contract(ARCANA_TOKEN_ADDRESS, ERC20_ABI, provider);
                const arcanaBalance = await arcanaToken.balanceOf(contractAddr);
                arcanaBalanceEl.textContent = parseFloat(ethers.utils.formatUnits(arcanaBalance, 18)).toFixed(2) + ' ARCANA';
            }
            if (oracleEl) {
                const oracle = new ethers.Contract(ARCANA_GAME_ORACLE_CONTRACT, ARCANA_GAME_ORACLE_ABI, provider);
                const tempRaw = await oracle.currentTemp();
                oracleEl.textContent = tempRaw.toString() + '°C';
            }
        } catch (e) {
            console.error("Admin stats error:", e);
        }
    }

    async function forceOpenAdmin() {
        const btn = document.getElementById('force-open');
        const logEl = document.getElementById('admin-log');
        if (btn) { btn.disabled = true; btn.textContent = '❄️ GIVRAGE EN COURS...'; }
        try {
            if (!signer) await connectWallet();
            const contract = new ethers.Contract(ARCANA_GAME_CONTRACT, ARCANA_GAME_ORACLE_ABI, signer);
            if (logEl) logEl.innerHTML += '<p>⏳ Envoi température -20°C au contrat...</p>';
            const tx = await contract.updateOracle(-20);
            await tx.wait();
            if (logEl) logEl.innerHTML += '<p>✅ Oracle forcé à -20°C. Sanctuaire débloqué !</p>';
            fetchAndDisplayTemperature();
        } catch (e) {
            alert('Erreur: ' + e.message);
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'FORCE OUVERTURE'; }
        }
    }

    // === INITIALISATION DE LA QUÊTE (RUNE N°1) ===
    function initialiserQueteRune1() {
        if (!runesDecouvertes.rune1PremierClic) {
            var runes = Array.from(document.querySelectorAll('.runes-column .rune-btn'));
            if (runes[0]) {
                runes[0].classList.add('quete-active');
                console.log('%c✨ QUÊTE ACTIVE : LE PREMIER FRAGMENT', 'color:#d4af37; font-weight:bold; font-size:1.2em;');
                addOracleChatMessage('✨ Une quête vous attend... Observez la première rune (⏀).');
            }
        }
    }

    // === ÉVÉNEMENTS CLAVIER (CTRL+SHIFT+A) ===
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && (e.key === 'A' || e.key === 'a')) {
            e.preventDefault();
            toggleAdmin();
        }
    });

    // === CHARGEMENT FINAL ===
    window.addEventListener('load', function() {
        setTimeout(initialiserQueteRune1, 1500);
        
        const headerConnectBtn = document.getElementById('header-connect-wallet-btn');
        if (headerConnectBtn) {
            headerConnectBtn.addEventListener('click', function() {
                const w3mButton = document.querySelector('w3m-button');
                if (w3mButton && w3mButton.shadowRoot) {
                    const innerBtn = w3mButton.shadowRoot.querySelector('button');
                    if (innerBtn) innerBtn.click();
                }
            });
        }
    });

    // ===== Wallet connect & Polygon switch
    async function connectWallet() {
        if (!window.ethereum) {
            return;
        }
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        try {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            signer = provider.getSigner();
            if (!signer) throw new Error('Impossible d\'obtenir le signer');
            account = await signer.getAddress();

            // Switch to Polygon if needed
            const chainId = (await provider.getNetwork()).chainId;
            if (chainId !== 137) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: POLYGON_CHAIN_ID }]
                    });
                } catch(switchError) {
                    // If chain isn't added
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: POLYGON_CHAIN_ID,
                                chainName: "Polygon Mainnet",
                                rpcUrls: ["https://polygon-rpc.com"],
                                nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
                                blockExplorerUrls: ["https://polygonscan.com"]
                            }]
                        });
                    } else {
                        throw switchError;
                    }
                }
            }

            // Affichage du compte connecté + révéler le jeu (fallback si Web3Modal échoue)
            var btn = document.querySelector(".btn-connect, #web3modal-connect-wrap .btn-connect");
            if (btn) btn.innerText = "Connecté";
            if (window.arcanaOnW3mConnect) window.arcanaOnW3mConnect(provider, signer, account);

        } catch (err) {
            if (err.code === 4001 || (err?.message && err.message.toLowerCase().includes('reject'))) {
                alert("Connexion annulée. Veuillez déverrouiller MetaMask si nécessaire et réessayer.");
            } else {
                alert("Impossible de se connecter au wallet : " + (err.message || err));
            }
        }
    }

    // ============ FONCTION DE DÉPÔT MULTI-TOKEN POLYGON ==============
    async function payStake() {
        if (!window.ethereum) {
            showStyledAlert("Connectez votre wallet via le bouton de connexion pour effectuer un dépôt.");
            return;
        }
        if (!signer || !account) await connectWallet();
        if (!signer) {
            showStyledAlert("Connectez votre wallet pour effectuer un dépôt.");
            return;
        }

        // Récupérer valeur/jeton sélectionné
        const rawAmount = document.getElementById('amountInput').value;
        const tokenSelected = document.getElementById('tokenSelect').value;
        let amount = Number(rawAmount);

        if (isNaN(amount) || amount <= 0) {
            alert("Veuillez saisir un montant valide.");
            return;
        }

        try {
            let tokenAddress = null;
            let isNative = false, decimals = 18;

            // Détails par token
            if (tokenSelected === "USDT") {
                tokenAddress = USDT_TOKEN_ADDRESS;
            } else if (tokenSelected === "USDC") {
                tokenAddress = USDC_TOKEN_ADDRESS;
            } else if (tokenSelected === "ARCANA") {
                tokenAddress = ARCANA_TOKEN_ADDRESS;
            } else if (tokenSelected === "MATIC") {
                isNative = true;
            } else {
                throw new Error("Jeton non géré");
            }

            // Prepare amount in token's decimals
            let parsedAmount = null;
            if (!isNative) {
                const token = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                decimals = await token.decimals();
                parsedAmount = ethers.utils.parseUnits(amount.toString(), decimals);
            } else {
                parsedAmount = ethers.utils.parseEther(amount.toString());
            }

            if (isNative) {
                // ===== Dépôt en MATIC =====
                const tx = await signer.sendTransaction({
                    to: ARCANA_GAME_CONTRACT,
                    value: parsedAmount
                });
                await tx.wait();
                alert("Dépôt de " + amount + " MATIC envoyé!");
            } else {
                // ===== Dépôt ERC20 =====
                // Vérifier allowance
                const token = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                const allowance = await token.allowance(account, ARCANA_GAME_CONTRACT);

                if (allowance.lt(parsedAmount)) {
                    // Approval nécessaire
                    const tx1 = await token.approve(ARCANA_GAME_CONTRACT, parsedAmount);
                    await tx1.wait();
                }

                // Transférer le montant au contrat
                // (Le smart contract doit supporter receive/transferFrom)
                const tx2 = await token.transfer(ARCANA_GAME_CONTRACT, parsedAmount);
                await tx2.wait();
                alert(`Dépôt de ${amount} ${tokenSelected} envoyé !`);
            }
        } catch (error) {
            alert("Erreur lors du dépôt : " + (error.message || error));
        }
    }

    // Ajout ARCANA à MetaMask
    async function addArcanaToMetaMask() {
        if (!window.ethereum) {
            return;
        }
        try {
            const wasAdded = await window.ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                    type: 'ERC20',
                    options: {
                        address: '0x1990fd46a1ad0344751be45d6779b8c1f827076d',
                        symbol: 'ARCANA',
                        decimals: 18,
                        image: 'URL_DU_LOGO_ICI' // Remplacez par l'URL du logo ARCANA
                    }
                }
            });
            if (wasAdded) {
                // Le token ARCANA a été ajouté avec succès
            }
        } catch (error) {
            alert("Erreur lors de l'ajout du token : " + (error.message || error));
        }
    }

    // Ajoute dynamiquement le lien sous le bouton de dépôt au chargement DOM
    document.addEventListener('DOMContentLoaded', function() {
        // On cherche le bouton de dépôt (btn-stake ou btn-depot selon ton HTML)
        // Adaptation : on cherche le parent autour du bouton stake ou le select jeton
        let stakeBtn = document.querySelector('.btn-stake, .btn-depot, #stake-btn');
        let tokenSelect = document.getElementById('tokenSelect');
        let referenceNode = null;
        if (stakeBtn) {
            referenceNode = stakeBtn;
        } else if(tokenSelect) {
            // Fallback : on insère près du select
            referenceNode = tokenSelect;
        }
        if (referenceNode && !document.getElementById('arcana-metamask-link')) {
            let link = document.createElement('button');
            link.type = "button";
            link.className = "arcana-add-metamask-link";
            link.id = "arcana-metamask-link";
            link.tabIndex = 0;
            link.innerHTML = '+ Ajouter le jeton ARCANA à MetaMask';
            link.onclick = addArcanaToMetaMask;
            // On l'insère juste après le bouton de stake
            referenceNode.insertAdjacentElement('afterend', link);
        }
        // Insérer le style uniquement si non déjà présent
        if (!document.getElementById('arcana-metamask-link-style')) {
          var styleEl = document.createElement('style');
          styleEl.id = 'arcana-metamask-link-style';
          styleEl.innerHTML = `
            .arcana-add-metamask-link {
                display: inline-block;
                margin-top: 6px;
                color: #ffd700;
                font-size: 0.92em;
                font-family: inherit;
                cursor: pointer;
                text-decoration: underline dotted;
                transition: color 0.18s;
                background: transparent;
                border: none;
                padding: 0;
            }
            .arcana-add-metamask-link:hover {
                color: #fff2b8;
                text-decoration: underline;
            }
          `;
          document.head.appendChild(styleEl);
        }
    });

    // Fond étoilé dynamique : 200 étoiles avec animation de scintillement
    (function() {
        const container = document.getElementById('star-container');
        const starCount = 200;
        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            const size = Math.random() * 2 + 0.5;
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            const duration = 2 + Math.random() * 3;
            const delay = Math.random() * 5;
            star.style.width = size + 'px';
            star.style.height = size + 'px';
            star.style.left = x + '%';
            star.style.top = y + '%';
            star.style.animation = `twinkle ${duration}s ease-in-out ${delay}s infinite`;
            star.style.opacity = 0.3 + Math.random() * 0.5;
            container.appendChild(star);
        }
    })();

    // -- Suite du code originel inchangé pour le Sanctuaire & autres panneaux --
    // -------- Sanctuaire du Destin (Level 3) FINAL -----------
    const SANCTUARY_SEQUENCE = [2, 7, 5, 9, 0, 10];
    const runeSound = new Audio('https://www.soundjay.com/buttons/button-16.mp3');
    let sanctuaryProgress = 0;
    let sanctuaryLocked = false;
    let sanctuaryTimerInterval = null;
    let sanctuaryTimeLeft = 15 * 60;
    let heartbeatInterval = null;
    let heartbeatInitialRate = 950;
    let glitchActive = false;
    let oldGlitchPanel = null;

    function playHeartbeat(rateMs) {
        if (!window.arcanaHeartbeatTimer) window.arcanaHeartbeatTimer = null;
        const audio = document.getElementById('heartbeat-audio');
        if(window.arcanaHeartbeatTimer) clearTimeout(window.arcanaHeartbeatTimer);
        function beat() {
            audio.currentTime = 0;
            audio.volume = 0.27;
            audio.play();
            window.arcanaHeartbeatTimer = setTimeout(beat, rateMs);
        }
        beat();
        window.stopHeartbeat = function() {
            if(window.arcanaHeartbeatTimer) clearTimeout(window.arcanaHeartbeatTimer);
            window.arcanaHeartbeatTimer = null;
            audio.pause(); audio.currentTime = 0;
        }
    }
    function setSanctuaryProgress(newStep) {
        sanctuaryProgress = newStep;
        const fill = document.getElementById('alignement-fill');
        const percent = Math.round((sanctuaryProgress/SANCTUARY_SEQUENCE.length)*100);
        fill.style.width = percent+'%';
        document.getElementById('alignement-percent').textContent = percent + "%";
    }
    function broadcastVictory(walletAddress) {
        const addr = (walletAddress || account || 'Un Initié').toString();
        const shortAddr = addr.length > 14 ? addr.slice(0, 6) + '…' + addr.slice(-4) : addr;
        const msg = '✨ L\'ÉLU ' + shortAddr + ' vient de sceller le Destin ! La pluie d\'or tombe sur le Sanctuaire !';
        const chatContainer = document.querySelector('#chat-temple div[style*="overflow-y"]') || document.querySelector('#chat-temple').children[1];
        if (chatContainer) {
            const p = document.createElement('p');
            p.style.cssText = 'margin:5px 0; color:var(--gold); font-weight:bold;';
            p.textContent = msg;
            chatContainer.appendChild(p);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        return msg;
    }
    function triggerVictoryJackpot() {
        const vj = document.getElementById('victory-jackpot');
        vj.style.display = 'block';
        vj.style.pointerEvents = 'auto';
        makeGoldRainParticles();
        try {
            const ta = document.getElementById('triumph-audio');
            if (ta) { ta.currentTime = 0; ta.volume = 0.6; ta.play().catch(()=>{}); }
        } catch(e) {}
        const fog = document.getElementById('arcana-fog');
        if (fog) { fog.classList.add('sanctuary-active'); fog.classList.add('jackpot-golden'); }
        window.setTimeout(()=>{
            const f = document.getElementById('arcana-fog');
            if (f) f.classList.remove('jackpot-golden');
        }, 10000);
        window.setTimeout(()=>{ vj.style.pointerEvents = 'none'; }, 3500);
    }
    function showSanctuarySuccess() {
        document.getElementById('sanctuary-success').style.display = 'block';
        document.getElementById('sanctuary-success').innerText = "JACKPOT DÉVERROUILLÉ ! Le Destin est révélé...";
        Array.from(document.querySelectorAll('.runes-column .rune-btn')).forEach(b=>b.disabled=true);
        sanctuaryLocked = true;
        stopHeartbeat();
        broadcastVictory(account);
        triggerVictoryJackpot();
    }
    function resetSanctuaryRunes() {
        sanctuaryProgress = 0;
        setSanctuaryProgress(0);
        document.getElementById('sanctuary-success').style.display = 'none';
        Array.from(document.querySelectorAll('#runes-grid .rune-btn')).forEach(btn=>{
            btn.classList.remove('selected','good','bad');
            btn.disabled = false;
        });
        sanctuaryLocked = false;
    }
    function updateSanctuaryTimerDisplay() {
        const t = sanctuaryTimeLeft;
        let mins = Math.floor(t/60), secs = t%60;
        const timerElem = document.getElementById('sanctuary-timer');
        timerElem.textContent = (mins<10?"0":"")+mins+":"+(secs<10?"0":"")+secs;
        if(sanctuaryTimeLeft<=60){
            timerElem.classList.add('danger');
            enableGlitchPanel();
        } else {
            timerElem.classList.remove('danger');
            disableGlitchPanel();
        }
    }
    function enableGlitchPanel() {
        const panel = document.getElementById('level-3-sanctuary');
        if(glitchActive) return;
        panel.classList.add('glitch');
        glitchActive = true;
    }
    function disableGlitchPanel() {
        const panel = document.getElementById('level-3-sanctuary');
        if(glitchActive) {
            panel.classList.remove('glitch');
            glitchActive = false;
        }
    }
    function tickSanctuaryTimer() {
        if (--sanctuaryTimeLeft<0) {
            clearInterval(sanctuaryTimerInterval);
            sanctuaryTimerInterval = null;
            document.getElementById('sanctuary-timer').textContent = "ÉCHEC";
            sanctuaryLocked = true;
            stopHeartbeat();
            enableGlitchPanel();
            Array.from(document.querySelectorAll('.runes-column .rune-btn')).forEach(b=>b.disabled=true);
            document.getElementById('sanctuary-success').style.display = 'block';
            document.getElementById('sanctuary-success').innerText = "Temps écoulé. Le sceau s'efface...";
            return;
        }
        updateSanctuaryTimerDisplay();
        if(sanctuaryTimeLeft < 120){
            let x = 1 - Math.max(0, (sanctuaryTimeLeft-60)/60);
            let rate = Math.max(310, heartbeatInitialRate - x*650);
            playHeartbeat(rate);
        } else if(sanctuaryTimeLeft < 875 && sanctuaryTimeLeft % 7 === 0) {
            playHeartbeat(heartbeatInitialRate);
        }
        if(sanctuaryTimeLeft>=120){ stopHeartbeat();}
    }
    function startFinalLevel() {
        const fog = document.getElementById('arcana-fog');
        if (fog) fog.classList.add('sanctuary-active');
        resetSanctuaryRunes();
        sanctuaryTimeLeft = 15*60;
        updateSanctuaryTimerDisplay();
        document.getElementById('level-3-sanctuary').style.display = 'block';
        document.getElementById('level-3-sanctuary').style.opacity = '';
        requestAnimationFrame(()=>{
            let el = document.getElementById('level-3-sanctuary');
            el.style.opacity = 0;
            el.style.transform = 'translate(-50%, -46%) scale(0.96)';
            setTimeout(()=>{
                el.style.opacity = 1;
                el.style.transform = 'translate(-50%,-50%) scale(1)';
            }, 10);
        });
    }

        // =========================================================================
        // SYSTÈME DE RUNES - Configuration des 12 Runes
        // =========================================================================
        // Runes 1-4   : Les Chercheurs (fouillerZone)
        // Runes 5-8   : Les Verrous (ouvrirPorte)
        // Runes 9-10  : L'Atelier (assemblage papyrus)
        // Rune 11     : La Taverne (chat social)
        // Rune 12     : L'Œil de l'Oracle (météo + jackpot)
        // =========================================================================

        // État des énigmes et découvertes
        window.runesDecouvertes = window.runesDecouvertes || {
            rune1PremierClic: false,
            indicesTrouves: [],
            papyrusCollectes: [],
            portesOuvertes: []
        };
        var runesDecouvertes = window.runesDecouvertes;
    
        function onRuneClick(runeId) {
            console.log('Rune cliquée : ' + runeId);

            try {
                const depositBtn = document.getElementById('btnDeposit');
                const amountInput = document.getElementById('amountInput');
                const tokenSelect = document.getElementById('tokenSelect');
                if (depositBtn) {
                    depositBtn.disabled = false;
                    depositBtn.classList.remove('disabled');
                }
                if (amountInput) amountInput.disabled = false;
                if (tokenSelect) tokenSelect.disabled = false;
            } catch (e) {
            }

            // Son de la rune
            if (typeof runeSound !== 'undefined') {
                runeSound.currentTime = 0;
                runeSound.volume = 0.5;
                runeSound.play().catch(function(){});
            }

            const runes = Array.from(document.querySelectorAll('.runes-column .rune-btn'));
            const btn = runes[runeId];
            if (!btn) return;
            btn.blur();

            try {
                runes.forEach(function(r) {
                    if (r) r.classList.remove('selected');
                });
                btn.classList.add('selected');
            } catch (e) {
            }
            
            // Effet visuel doré au clic
            btn.classList.add('click-gold');
            setTimeout(function(){ btn.classList.remove('click-gold'); }, 350);
            
            // Dispatcher selon le numéro de rune (0 à 11)
            if (runeId >= 0 && runeId <= 3) {
                // Runes 1-4 : Les Chercheurs
                fouillerZone(runeId);
            } else if (runeId >= 4 && runeId <= 7) {
                // Runes 5-8 : Les Verrous
                ouvrirPorteRune(runeId);
            } else if (runeId === 8 || runeId === 9) {
                // Runes 9-10 : L'Atelier
                ouvrirAtelierPapyrus();
            } else if (runeId === 10) {
                // Rune 11 : La Taverne
                ouvrirTaverne();
            } else if (runeId === 11) {
                // Rune 12 : L'Œil de l'Oracle
                afficherOeilOracle();
            }
            
            // Animation de feedback "Good"
            btn.classList.add('good');
            setTimeout(function() {
                btn.classList.remove('good');
            }, 450);
        }

        window.onRuneClick = onRuneClick;

        document.addEventListener('DOMContentLoaded', function() {
            try {
                Array.from(document.querySelectorAll('.runes-column .rune-btn')).forEach(function(b) {
                    if (!b) return;
                    b.disabled = false;
                });
                const depositBtn = document.getElementById('btnDeposit');
                const amountInput = document.getElementById('amountInput');
                const tokenSelect = document.getElementById('tokenSelect');
                if (depositBtn) {
                    depositBtn.disabled = false;
                    depositBtn.classList.remove('disabled');
                }
                if (amountInput) amountInput.disabled = false;
                if (tokenSelect) tokenSelect.disabled = false;
            } catch (e) {
            }
        });
    
        // --- RUNES 1-4 : LES CHERCHEURS ---
        function fouillerZone(runeId) {
            console.log('%c🔍 Fouille de la zone - Rune ' + (runeId + 1), 'color:#d4af37; font-weight:bold;');
            
            // ÉNIGME #1 - Rune 1 (index 0)
            if (runeId === 0 && !runesDecouvertes.rune1PremierClic) {
                runesDecouvertes.rune1PremierClic = true;
                
                // Vibration mobile (Haptic)
                if (navigator.vibrate) navigator.vibrate(200);
                
                // Retirer l'état de quête active
                var runes = Array.from(document.querySelectorAll('.runes-column .rune-btn'));
                if (runes[0]) runes[0].classList.remove('quete-active');
                
                // Ajouter le premier papyrus
                ajouterObjetQuete('📜', 'Papyrus Ancien I', 'papyrus_ancien_1');
                runesDecouvertes.papyrusCollectes.push('papyrus_ancien_1');
                
                addOracleChatMessage('🗿 La Rune des Chercheurs révèle son premier secret...');
                
                // Ouvrir le papyrus après un délai
                setTimeout(function() {
                    ouvrirPapyrus('papyrus_ancien_1', 'Papyrus Ancien I');
                }, 500);
                
                console.log('%c✨ Énigme #1 résolue : Premier papyrus découvert !', 'color:#00ff88; font-weight:bold;');
                return;
            }
            
            // Logique pour les autres runes chercheurs (Indices et Loot)
            var indices = [
                { id: 'indice_1', texte: 'Une trace de givre mène vers le nord...', icone: '❄️' },
                { id: 'indice_2', texte: 'Des empreintes mystérieuses près du miroir...', icone: '👣', papyrus: 'papyrus_ancien_2' },
                { id: 'indice_3', texte: 'Un écho lointain résonne dans les profondeurs...', icone: '📢', papyrus: 'papyrus_ancien_3' },
                { id: 'indice_4', texte: 'Une lueur dorée perce l\'obscurité...', icone: '✨' }
            ];
            
            var indice = indices[runeId];
            if (indice && runesDecouvertes.indicesTrouves.indexOf(indice.id) === -1) {
                runesDecouvertes.indicesTrouves.push(indice.id);
                addOracleChatMessage(indice.icone + ' Indice découvert : ' + indice.texte);
                
                if (indice.papyrus) {
                    ajouterObjetQuete('📜', 'Papyrus Ancien', indice.papyrus);
                    runesDecouvertes.papyrusCollectes.push(indice.papyrus);
                    vibrerSac(2);
                    addOracleChatMessage('📜 Un nouveau papyrus ancien a été découvert !');
                } else {
                    // Chance de trouver un petit loot (30%)
                    if (Math.random() < 0.3) {
                        ajouterObjetQuete('💎', 'Fragment de Cristal', 'cristal_' + Date.now());
                        vibrerSac(1);
                    }
                }
            } else {
                addOracleChatMessage('🔍 Rien de nouveau ici pour le moment...');
            }
        }
    
        // --- RUNES 5-8 : LES VERROUS ---
        function ouvrirPorteRune(runeId) {
            var porteNum = runeId - 3; // Mappe les runes 4-7 vers Portes 1-4
            console.log('%c🚪 Tentative d\'ouverture - Porte ' + porteNum, 'color:#49cafa; font-weight:bold;');
            
            if (runesDecouvertes.portesOuvertes.indexOf(porteNum) !== -1) {
                addOracleChatMessage('🚪 Cette porte est déjà ouverte.');
                return;
            }
            
            // Vérification de la clé dans la sacoche (sacInventaire)
            var cleRequise = "cle_" + porteNum;
            var possedeCle = (typeof sacInventaire !== 'undefined' && sacInventaire.includes(cleRequise));
            
            if (possedeCle) {
                runesDecouvertes.portesOuvertes.push(porteNum);
                showStyledAlert('🔓 <strong>Porte ' + porteNum + ' Déverrouillée</strong><br><br>Le passage est ouvert !');
                vibrerSac(3);
                if (typeof updateArcaneInventory === 'function') updateArcaneInventory();
            } else {
                showStyledAlert('🔒 <strong>Porte Verrouillée</strong><br><br>Cette porte nécessite la <strong>Clé ' + porteNum + '</strong>');
                if (navigator.vibrate) navigator.vibrate([100, 100, 100]);
            }
        }
    
        function ouvrirAtelierPapyrus() {
            console.log('%c📜 Ouverture de l\'Atelier des Papyrus', 'color:#d4af37; font-weight:bold;');
            var nbPapyrus = runesDecouvertes.papyrusCollectes.length;
            
            if (nbPapyrus === 0) {
                showStyledAlert('📜 <strong>L\'Atelier</strong><br><br>Vous n\'avez encore aucun fragment...');
                return;
            }

            // Afficher l'interface d'assemblage
            var message = '📜 <strong>Atelier d\'Assemblage Égyptien</strong><br><br>';
            message += '<div style="font-size:1.5em; margin: 15px 0;">⏀ ⏃ ⏇</div>';
            message += 'Papyrus anciens collectés : <strong>' + nbPapyrus + '</strong>/3<br><br>';
            
            if (nbPapyrus >= 3) {
                message += '<em style="color:#00ff88;">✨ Les trois fragments s\'assemblent dans une lumière dorée !</em><br><br>';
                message += '<div style="font-size:1.3em; margin: 15px 0; color:#d4af37;">❶ ❷ ❸</div>';
                message += '🎯 <strong>Message Révélé :</strong><br><span style="font-size:1.1em; color:#8b4513; font-weight:bold;">"Le trésor se cache là où le givre rencontre l\'or éternel"</span>';
                
                // Récompense pour assemblage (éviter les doublons)
                if (!sacObjetsQuete.find(function(obj) { return obj.id === 'livre_secrets'; })) {
                    ajouterObjetQuete('📖', 'Livre des Secrets', 'livre_secrets');
                    vibrerSac(3);
                    addOracleChatMessage('📖 Assemblage réussi : Livre des Secrets obtenu !');
                }
            } else {
                message += '<em style="color:#ff6b6b;">Il vous faut les 3 fragments pour reconstituer le message complet...</em><br><br>';
                message += '<div style="margin: 10px 0;">│ Fragments manquants : <strong>' + (3 - nbPapyrus) + '</strong></div>';
                message += '<small style="color:#888;">💡 Continuez à explorer avec les Runes des Chercheurs.</small>';
            }
            
            showStyledAlert(message);
            addOracleChatMessage('📜 Atelier ouvert : ' + nbPapyrus + '/3 papyrus disponibles.');
        }

    // ═══════════════════════════════════════════════════════
    // RUNE 11 : LA TAVERNE (Chat Social)
    // ═══════════════════════════════════════════════════════
    
    function ouvrirTaverne() {
        console.log('%c🍺 Ouverture de la Taverne', 'color:#d4af37; font-weight:bold;');
        
        var chatPanel = document.getElementById('chat-temple');
        if (chatPanel) {
            chatPanel.style.display = 'block';
            chatPanel.style.position = 'fixed';
            chatPanel.style.top = '50%';
            chatPanel.style.left = '50%';
            chatPanel.style.transform = 'translate(-50%, -50%)';
            chatPanel.style.zIndex = '2000';
            chatPanel.style.maxWidth = '500px';
            chatPanel.style.width = '90vw';
            
            addOracleChatMessage('🍺 Bienvenue à la Taverne ! Partagez vos découvertes avec les autres Initiés...');
            
            // Ajouter un bouton de fermeture
            if (!document.getElementById('btn-fermer-taverne')) {
                var btnFermer = document.createElement('button');
                btnFermer.id = 'btn-fermer-taverne';
                btnFermer.className = 'btn-connect';
                btnFermer.textContent = '✓ Fermer';
                btnFermer.style.marginTop = '10px';
                btnFermer.style.width = '100%';
                btnFermer.onclick = function() {
                    chatPanel.style.display = 'none';
                    chatPanel.style.position = '';
                    chatPanel.style.transform = '';
                    chatPanel.style.zIndex = '';
                };
                chatPanel.appendChild(btnFermer);
            }
        } else {
            showStyledAlert('🍺 <strong>La Taverne</strong><br><br>Un lieu de rencontre pour les Initiés.<br><br><em>Le chat sera bientôt disponible...</em>');
        }
    }// =========================================================================
    // RUNE 12 : L'ŒIL DE L'ORACLE (STATISTIQUES & JACKPOT)
    // =========================================================================
    function afficherOeilOracle() {
        console.log('%c👁️ L\'Œil de l\'Oracle s\'ouvre', 'color:#d4af37; font-weight:bold;');
        
        var tempActuelle = (typeof oracleTemperature !== 'undefined' && oracleTemperature !== null) 
            ? oracleTemperature + '°C' 
            : 'En chargement...';
        
        // Calcul du jackpot (Base 1000 + bonus par progression)
        var jackpotBase = 1000;
        var portesOuvertes = runesDecouvertes.portesOuvertes.length;
        var papyrusCollectes = runesDecouvertes.papyrusCollectes.length;
        var jackpot = jackpotBase + (portesOuvertes * 250) + (papyrusCollectes * 100);
        
        var message = '👁️ <strong>L\'Œil de l\'Oracle</strong><br><br>';
        message += '🌡️ <strong>Température à Montréal :</strong> ' + tempActuelle + '<br>';
        message += '❄️ <strong>Seuil d\'activation :</strong> ≤ -2°C<br><br>';
        message += '💰 <strong>Jackpot Actuel :</strong><br>';
        message += '<span style="font-size:1.5em; color:#d4af37;">' + jackpot + ' ARCANA</span><br><br>';
        message += '📊 <strong>Progression :</strong><br>';
        message += '🚪 Portes ouvertes : ' + portesOuvertes + '/4<br>';
        message += '📜 Papyrus collectés : ' + papyrusCollectes + '<br>';
        message += '🔍 Indices trouvés : ' + runesDecouvertes.indicesTrouves.length + '<br>';
        
        showStyledAlert(message);
        addOracleChatMessage('👁️ L\'Oracle révèle l\'état du Sanctuaire...');
        vibrerSac(2);
    }

    // --- ANIMATIONS VISUELLES ---
    function makeGoldRainParticles() {
        const container = document.querySelector('#victory-jackpot .gold-rain');
        if (!container) return;
        container.innerHTML = '';
        const GoldN = 35 + Math.floor(Math.random() * 8);
        for(let i=0; i < GoldN; ++i) {
            let span = document.createElement('span');
            span.className = 'gold-drop';
            span.style.left = (5 + Math.random() * 90) + 'vw';
            span.style.animationDelay = Math.random() * 1.25 + 's';
            span.style.width = (7 + Math.random() * 5) + 'px';
            span.style.height = (21 + Math.random() * 18) + 'px';
            container.appendChild(span);
        }
        setTimeout(() => { container.innerHTML = ''; }, 4300);
    }

    // =========================================================================
    // SACOCHE INVENTAIRE - GESTION DES CLÉS ET OBJETS
    // =========================================================================
    var sacInventaire = [];
    var sacObjetsQuete = Array.isArray(sacObjetsQuete) ? sacObjetsQuete : [];
    var sacIsOpen = false;
    var sacResonanceActive = false;
    var sacResonanceObjetActif = null;

    function renderSacObjetsQuete() {
        var container = document.getElementById('sac-objets-quete');
        var emptyEl = document.getElementById('sac-objets-quete-vide');
        if (!container) return;

        var items = Array.isArray(sacObjetsQuete) ? sacObjetsQuete : [];
        if (items.length === 0) {
            if (emptyEl) emptyEl.style.display = 'block';
            Array.from(container.querySelectorAll('.objet-quete')).forEach(function(n) { n.remove(); });
            return;
        }

        if (emptyEl) emptyEl.style.display = 'none';
        Array.from(container.querySelectorAll('.objet-quete')).forEach(function(n) { n.remove(); });

        items.forEach(function(obj) {
            if (!obj || !obj.id) return;
            var el = document.createElement('div');
            el.className = 'objet-quete' + (String(obj.id).indexOf('papyrus_ancien_') === 0 ? ' papyrus-ancien' : '');
            el.setAttribute('data-id', obj.id);

            var icon = document.createElement('div');
            icon.style.cssText = 'font-size:1.7em;line-height:1;';
            icon.textContent = obj.icone || '✨';

            var name = document.createElement('div');
            name.className = 'objet-quete-nom';
            name.textContent = obj.nom || obj.id;

            el.appendChild(icon);
            el.appendChild(name);

            el.onclick = function() {
                try {
                    if (typeof ouvrirPapyrus === 'function' && window.papyrusTextes && window.papyrusTextes[obj.id]) {
                        ouvrirPapyrus(obj.id, obj.nom || 'Papyrus Ancien');
                        return;
                    }
                } catch (e) {}
            };

            container.appendChild(el);
        });
    }

    function ajouterObjetQuete(icone, nom, objetId) {
        if (!objetId) return false;
        if (!Array.isArray(sacObjetsQuete)) sacObjetsQuete = [];
        var exists = sacObjetsQuete.find(function(o) { return o && o.id === objetId; });
        if (exists) return false;
        sacObjetsQuete.push({ icone: icone, nom: nom, id: objetId });
        try { updateSacBadge(); } catch (e) {}
        try { renderSacObjetsQuete(); } catch (e) {}
        return true;
    }

    function retirerObjetQuete(objetId) {
        if (!Array.isArray(sacObjetsQuete) || !objetId) return false;
        var before = sacObjetsQuete.length;
        sacObjetsQuete = sacObjetsQuete.filter(function(o) { return !(o && o.id === objetId); });
        try { updateSacBadge(); } catch (e) {}
        try { renderSacObjetsQuete(); } catch (e) {}
        return sacObjetsQuete.length !== before;
    }

    function viderObjetsQuete() {
        sacObjetsQuete = [];
        try { updateSacBadge(); } catch (e) {}
        try { renderSacObjetsQuete(); } catch (e) {}
    }

    function toggleSacInventaire() {
        if (sacIsOpen) fermerSacInventaire();
        else ouvrirSacInventaire();
    }

    function ouvrirSacInventaire() {
        var drawer = document.getElementById('sac-inventaire');
        var overlay = document.getElementById('sac-overlay');
        var sanctuaire = document.getElementById('level-3-sanctuary');
        
        if (drawer) drawer.classList.add('open');
        if (overlay) overlay.classList.add('active');
        sacIsOpen = true;
        
        // Effet de repositionnement du sanctuaire vers le haut
        if (sanctuaire) {
            sanctuaire.classList.add('sac-ouvert');
        }

        try { updateSacBalances(); } catch (e) {}
        try { renderSacObjetsQuete(); } catch (e) {}
        
        document.body.style.overflow = 'hidden';
        console.log('%c👜 Inventaire ouvert - Sanctuaire repositionné', 'color:#d4af37; font-weight:bold;');
    }

    function fermerSacInventaire() {
        var drawer = document.getElementById('sac-inventaire');
        var overlay = document.getElementById('sac-overlay');
        var sanctuaire = document.getElementById('level-3-sanctuary');
        
        if (drawer) drawer.classList.remove('open');
        if (overlay) overlay.classList.remove('active');
        sacIsOpen = false;
        
        if (sanctuaire) sanctuaire.classList.remove('sac-ouvert');
        document.body.style.overflow = 'auto';
    }

    function arcanaWithdrawUI() {
        try {
            if (!account) {
                if (typeof connectWallet === 'function') return connectWallet();
            }
        } catch (e) {}
        try {
            if (typeof showStyledAlert === 'function') {
                showStyledAlert('🟡 <strong>Fonction Retrait</strong><br><span style="opacity:0.9;">Interface en cours d\'activation. Si votre contrat de retrait est prêt, indique-moi la fonction à appeler (withdraw/claim) et l\'adresse du vault.</span>');
                return;
            }
        } catch (e) {}
        alert('Fonction Retrait: en cours d\'activation.');
    }

    function arcanaDisconnectUI() {
        try {
            provider = null; signer = null; account = null;
        } catch (e) {}
        try { if (typeof window.arcanaOnW3mDisconnect === 'function') window.arcanaOnW3mDisconnect(); } catch (e) {}
        try {
            var b = document.getElementById('btnConnect') || document.querySelector('.btn-connect');
            if (b) b.textContent = 'CONNECT WALLET';
        } catch (e) {}
        try { fermerSacInventaire(); } catch (e) {}
    }

    function updateSacBadge() {
        var badge = document.getElementById('btn-sacoche-badge');
        var total = sacInventaire.length + sacObjetsQuete.length;
        if (badge) {
            badge.textContent = total;
            badge.style.display = total > 0 ? 'flex' : 'none';
        }
    }

    async function updateSacBalances() {
        var arcanaEl = document.getElementById('sac-solde-arcana');
        var profitsEl = document.getElementById('sac-solde-profits');
        if (!arcanaEl || !profitsEl) return;

        if (!provider || !account) {
            arcanaEl.textContent = '—';
            profitsEl.textContent = '—';
            return;
        }

        try {
            var token = new ethers.Contract(ARCANA_TOKEN_ADDRESS, ERC20_ABI, provider);
            var bal = await token.balanceOf(account);
            var arcana = parseFloat(ethers.utils.formatUnits(bal, 18));
            if (!isFinite(arcana)) arcana = 0;
            arcanaEl.textContent = arcana.toLocaleString('fr-FR', { maximumFractionDigits: 2 }) + ' ARCANA';

            var profits = arcana * 0.0026;
            profitsEl.textContent = (profits || 0).toLocaleString('fr-FR', { maximumFractionDigits: 2 }) + ' $';
        } catch (e) {
            arcanaEl.textContent = '—';
            profitsEl.textContent = '—';
        }
    }

    // --- RÉSONANCE HAPTIQUE (VIBRATION) ---
    function vibrerSac(intensite) {
        intensite = intensite || 1;
        var btnSacoche = document.getElementById('btn-sacoche');
        if (btnSacoche) btnSacoche.classList.add('resonance');
        
        if (navigator.vibrate) {
            var pattern = (intensite === 3) ? [200, 50, 200] : (intensite === 2) ? [150, 50, 150] : [100, 50, 100];
            navigator.vibrate(pattern);
        }
        
        setTimeout(() => { 
            if (btnSacoche) btnSacoche.classList.remove('resonance');
        }, 1000);
    }

    // --- SYNC ORACLE DEPUIS ADMIN ---
    async function updateOracleFromAdmin() {
        try {
            const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=45.5088&longitude=-73.5878&current_weather=true');
            const data = await response.json();
            const temp = Math.round(data.current_weather.temperature);
            
            if (!signer) await connectWallet();
            const contract = new ethers.Contract(ARCANA_GAME_CONTRACT, ["function updateOracle(int256 _temp) external"], signer);
            const tx = await contract.updateOracle(temp);
            
            addOracleChatMessage('⏳ Synchronisation Oracle : ' + temp + '°C...');
            await tx.wait();
            addOracleChatMessage('✅ Oracle scellé dans la Blockchain.');
            fetchAndDisplayTemperature();
        } catch (error) {
            console.error("Erreur Oracle:", error);
        }
    }

    function arreterVibrationSac() {
        var btnSacoche = document.getElementById('btn-sacoche');
        btnSacoche.classList.remove('resonance');
        
        // Arrêter la vibration haptique
        if (navigator.vibrate) {
            navigator.vibrate(0);
        }
        
        sacResonanceActive = false;
        
        console.log('%c✨ Résonance magique désactivée', 'color:#888;');
    }

    function activerResonanceObjet(objetId, typeObjet) {
        // typeObjet: 'cle' ou 'quete'
        typeObjet = typeObjet || 'quete';
        
        // Retirer l'ancienne résonance
        if (sacResonanceObjetActif) {
            desactiverResonanceObjet();
        }
        
        var element;
        if (typeObjet === 'cle') {
            // Trouver le slot de clé
            var slots = document.querySelectorAll('.sac-slot');
            var index = sacInventaire.indexOf(objetId);
            if (index !== -1 && slots[index]) {
                element = slots[index];
            }
        } else {
            // Trouver l'objet de quête
            element = document.querySelector('.objet-quete[data-id="' + objetId + '"]');
        }
        
        if (element) {
            element.classList.add('objet-actif');
            sacResonanceObjetActif = { id: objetId, type: typeObjet, element: element };
            
            console.log('%c✨ Objet en résonance:', 'color:#d4af37; font-weight:bold;', objetId);
            return true;
        }
        
        return false;
    }

    function desactiverResonanceObjet() {
        if (sacResonanceObjetActif && sacResonanceObjetActif.element) {
            sacResonanceObjetActif.element.classList.remove('objet-actif');
            console.log('%c✨ Résonance d\'objet désactivée:', 'color:#888;', sacResonanceObjetActif.id);
            sacResonanceObjetActif = null;
        }
    }

    function declencherResonanceMagique(objetId, typeObjet, intensite) {
        // Fonction principale pour activer la résonance complète
        intensite = intensite || 1;
        
        // Vibrer le bouton sacoche
        vibrerSac(intensite);
        
        // Activer la résonance de l'objet dans l'inventaire
        var objetTrouve = activerResonanceObjet(objetId, typeObjet);
        
        if (objetTrouve) {
            // Message dans le chat Oracle
            addOracleChatMessage('✨ Résonance magique détectée ! Un objet de votre inventaire réagit à la zone...');
            
            // Auto-désactiver après 5 secondes
            setTimeout(function() {
                arreterResonanceMagique();
            }, 5000);
            
            return true;
        }
        
        return false;
    }

    function arreterResonanceMagique() {
        arreterVibrationSac();
        desactiverResonanceObjet();
    }

    function verifierResonanceZone(zoneId, objetRequis) {
        // Vérifier si le joueur possède l'objet requis
        var objetPresent = false;
        var typeObjet = 'quete';
        
        // Vérifier dans les objets de quête
        var objet = sacObjetsQuete.find(function(obj) { return obj.id === objetRequis; });
        if (objet) {
            objetPresent = true;
            typeObjet = 'quete';
        } else {
            // Vérifier dans les clés
            var index = sacInventaire.indexOf(objetRequis);
            if (index !== -1) {
                objetPresent = true;
                typeObjet = 'cle';
            }
        }
        
        if (objetPresent) {
            console.log('%c🔑 Zone ' + zoneId + ' : Objet requis détecté (' + objetRequis + ')', 'color:#d4af37; font-weight:bold;');
            declencherResonanceMagique(objetRequis, typeObjet, 2);
            return true;
        } else {
            console.log('%c🔒 Zone ' + zoneId + ' : Objet requis manquant (' + objetRequis + ')', 'color:#888;');
            return false;
        }
    }

    // ═══════════════════════════════════════════════════════
    // PAPYRUS ANCIEN - Système de Déroulement
    // ═══════════════════════════════════════════════════════
    
    var papyrusTextes = {
        'papyrus_ancien_1': {
            titre: 'Papyrus Ancien I - Le Fragment du Givre',
            hieroglyphes: '⏀ ⏃ ⏇ ⎈',
            texte: 'Sous la pierre froide, là où le givre se dépose en silence, repose le premier secret des Gardiens de l\'Ancien Temps. Celui qui lit ces mots a franchi le premier seuil.',
            indice: '« Premier fragment gelé dans la neige »',
            messageRusse: 'Первый шаг замерз в снегу'
        },
        'papyrus_ancien_2': {
            titre: 'Papyrus Ancien II - Le Fragment des Ombres',
            hieroglyphes: '⏍ ⏎ ⏏ ⏐',
            texte: 'Dans les profondeurs où l\'obscurité règne et où les miroirs reflètent plus que la lumière, le deuxième fragment attend. Les étoiles du Sanctuaire tracent un chemin invisible aux yeux des mortels ordinaires. Seuls ceux qui ont allumé les flammes sacrées pourront déchiffrer ce message écrit dans l\'encre du temps.',
            indice: '« Fragment II : ...SE CACHE... »'
        },
        'papyrus_ancien_3': {
            titre: 'Papyrus Ancien III - Le Fragment de l\'Aurore',
            hieroglyphes: '⏑ ⏒ ⏓ ⏔',
            texte: 'Le dernier fragment repose à la croisée des mondes, là où le givre éternel rencontre l\'or qui ne ternit jamais. Trois fragments réunis forment la Clé Suprême. Le trésor n\'est pas un objet matériel, mais la Connaissance Pure des Anciens. Celui qui dévoile ce secret devient Gardien à son tour, protecteur du Sanctuaire pour les générations futures.',
            indice: '« Fragment III : ...LÀ OÙ LE GIVRE RENCONTRE L\'OR ÉTERNEL »'
        }
    };

    function ouvrirPapyrus(papyrusId, papyrusNom) {
        var modal = document.getElementById('papyrus-modal');
        var titre = document.getElementById('papyrus-titre');
        var texte = document.getElementById('papyrus-texte');
        var indice = document.getElementById('papyrus-indice');
        var hieroglyphes = document.querySelectorAll('.papyrus-hieroglyph');
        
        // Récupérer les données du papyrus
        var data = papyrusTextes[papyrusId] || {
            titre: papyrusNom || 'Papyrus Ancien',
            hieroglyphes: '⏀ ⏃ ⏇',
            texte: 'Un texte ancien écrit dans une langue oubliée...',
            indice: '« Les secrets se révèlent aux patients »'
        };
        
        // Remplir le contenu
        if (titre) titre.textContent = data.titre;
        if (texte) texte.textContent = data.texte;
        
        // Si un message russe est présent, l'afficher avec un style spécial
        if (data.messageRusse && indice) {
            indice.innerHTML = '<div class="papyrus-text-russe">' + data.messageRusse + '</div>';
            indice.style.textAlign = 'center';
        } else if (indice) {
            indice.textContent = data.indice;
        }
        
        if (hieroglyphes[0]) hieroglyphes[0].textContent = data.hieroglyphes;
        
        // Afficher la modal avec animation
        modal.classList.add('active');
        
        // Son de déroulement (optionnel)
        if (navigator.vibrate) {
            navigator.vibrate([50, 30, 50, 30, 100]);
        }
        
        // Réinitialiser l'animation
        var scroll = modal.querySelector('.papyrus-scroll');
        if (scroll) {
            scroll.style.animation = 'none';
            scroll.offsetHeight; // Force reflow
            scroll.style.animation = 'papyrus-unroll 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
        }
        
        console.log('%c📜 Papyrus déroulé:', 'color:#8b7355; font-weight:bold;', data.titre);
        addOracleChatMessage('📜 Vous lisez le ' + data.titre + '...');
    }

    function fermerPapyrus() {
        var modal = document.getElementById('papyrus-modal');
        var scroll = modal.querySelector('.papyrus-scroll');
        
        // Animation de fermeture (enroulement)
        if (scroll) {
            scroll.style.animation = 'papyrus-roll-up 0.6s cubic-bezier(0.6, -0.28, 0.74, 0.05) forwards';
        }
        
        // Masquer la modal après l'animation
        setTimeout(function() {
            modal.classList.remove('active');
        }, 600);
        
        console.log('%c📜 Papyrus enroulé', 'color:#888;');
    }

    function fermerPapyrusOverlay(event) {
        // Fermer uniquement si on clique sur l'overlay, pas sur le papyrus
        if (event.target.id === 'papyrus-modal') {
            fermerPapyrus();
        }
    }

    // ═══════════════════════════════════════════════════════
    // CONTRÔLES CLAVIER - Fermer l'inventaire avec Échap
    // ═══════════════════════════════════════════════════════
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (sacIsOpen) {
                fermerSacInventaire();
            }
            // Fermer aussi le papyrus si ouvert
            var papyrusModal = document.getElementById('papyrus-modal');
            if (papyrusModal && papyrusModal.classList.contains('active')) {
                fermerPapyrus();
            }
        }
    });

    // ═══════════════════════════════════════════════════════
    // FONCTIONS DE TEST - Console
    // ═══════════════════════════════════════════════════════
    
    window.testSac = function() {
        console.log('%c=== TEST DU SAC À DOS ===', 'color:#d4af37; font-size:1.2em; font-weight:bold;');
        viderSac();
        viderObjetsQuete();
        ouvrirSacInventaire();
        
        // Test ajout de clés
        for (var i = 1; i <= 12; i++) {
            setTimeout(function(num) {
                return function() {
                    ajouterCleDansSac(num);
                };
            }(i), i * 400);
        }
        
        // Test ajout d'objets de quête
        setTimeout(function() {
            ajouterObjetQuete('📜', 'Parchemin Ancien', 'parchemin_1');
        }, 5000);
        setTimeout(function() {
            ajouterObjetQuete('💎', 'Cristal de Givre', 'cristal_1');
        }, 5500);
        setTimeout(function() {
            ajouterObjetQuete('🔮', 'Orbe Mystique', 'orbe_1');
        }, 6000);
    };

    window.testObjetsQuete = function() {
        console.log('%c=== TEST OBJETS DE QUÊTE ===', 'color:#49cafa; font-size:1.2em; font-weight:bold;');
        ouvrirSacInventaire();
        ajouterObjetQuete('📜', 'Papyrus Ancien I', 'papyrus_ancien_1');
        ajouterObjetQuete('📜', 'Papyrus Ancien II', 'papyrus_ancien_2');
        ajouterObjetQuete('💎', 'Cristal de Givre', 'cristal_1');
        ajouterObjetQuete('🔮', 'Orbe Mystique', 'orbe_1');
        ajouterObjetQuete('🧪', 'Fiole Magique', 'fiole_1');
        ajouterObjetQuete('⚔', 'Lame Enchantée', 'lame_1');
    };

    window.testPapyrus = function() {
        console.log('%c=== TEST PAPYRUS ANCIEN ===', 'color:#8b7355; font-size:1.3em; font-weight:bold;');
        
        // Ajouter des papyrus de test
        viderSac();
        viderObjetsQuete();
        ajouterObjetQuete('📜', 'Papyrus Ancien I', 'papyrus_ancien_1');
        ajouterObjetQuete('📜', 'Papyrus Ancien II', 'papyrus_ancien_2');
        ajouterObjetQuete('📜', 'Papyrus Ancien III', 'papyrus_ancien_3');
        
        // Ouvrir l'inventaire
        ouvrirSacInventaire();
        
        console.log('%c📜 3 Papyrus ajoutés à l\'inventaire', 'color:#8b7355;');
        console.log('%c💡 Cliquez sur un papyrus dans l\'inventaire pour le dérouler !', 'color:#d4af37; font-weight:bold;');
        console.log('%c   → Animation de déroulement 3D fluide', 'color:#888;');
        console.log('%c   → Texte en encre ancienne avec hiéroglyphes', 'color:#888;');
        console.log('%c   → Vibration haptique au déroulement', 'color:#888;');
        console.log('%c   → Fermer avec Échap ou le bouton "ROULER"', 'color:#888;');
        
        // Auto-ouvrir le premier papyrus après 2 secondes
        setTimeout(function() {
            console.log('%c\n📜 Ouverture automatique du Papyrus I...', 'color:#8b7355; font-weight:bold;');
            ouvrirPapyrus('papyrus_ancien_1', 'Papyrus Ancien I');
        }, 2000);
    };

    window.testQueteRune1 = function() {
        console.log('%c=== TEST QUÊTE RUNE N°1 ===', 'color:#00ff88; font-size:1.3em; font-weight:bold;');
        
        // Réinitialiser l'état de la quête
        runesDecouvertes.rune1PremierClic = false;
        viderSac();
        viderObjetsQuete();
        
        // Activer le clignotement de la Rune n°1
        initialiserQueteRune1();
        
        console.log('%c✨ La Rune n°1 clignote doucement en doré', 'color:#d4af37;');
        console.log('%c💡 Cliquez sur la première rune (⏀) pour découvrir le papyrus !', 'color:#49cafa; font-weight:bold;');
        console.log('%c   → Vibration de 200ms sur mobile', 'color:#888;');
        console.log('%c   → Animation de déroulement automatique', 'color:#888;');
        console.log('%c   → Texte russe : "Первый шаг замерз в снегу"', 'color:#888;');
        console.log('%c   → Papyrus ajouté dans le sac automatiquement', 'color:#888;');
    };

    window.testResonance = function() {
        console.log('%c=== TEST RÉSONANCE MAGIQUE ===', 'color:#d4af37; font-size:1.2em; font-weight:bold;');
        
        // Ajouter des objets de test
        viderSac();
        viderObjetsQuete();
        ajouterCleDansSac(42);
        ajouterObjetQuete('💎', 'Cristal de Givre', 'cristal_1');
        ajouterObjetQuete('🔮', 'Orbe Mystique', 'orbe_1');
        ajouterObjetQuete('📜', 'Parchemin Ancien', 'parchemin_1');
        
        // Ouvrir l'inventaire
        ouvrirSacInventaire();
        
        // Test 1 : Vibration simple du bouton
        console.log('%cTest 1: Vibration simple du bouton', 'color:#49cafa;');
        setTimeout(function() {
            vibrerSac(1);
        }, 1000);
        
        // Test 2 : Résonance d'un objet de quête
        console.log('%cTest 2: Résonance objet de quête (Cristal)', 'color:#49cafa;');
        setTimeout(function() {
            arreterVibrationSac();
            declencherResonanceMagique('cristal_1', 'quete', 2);
        }, 3000);
        
        // Test 3 : Changement d'objet actif
        console.log('%cTest 3: Changement vers Orbe Mystique', 'color:#49cafa;');
        setTimeout(function() {
            arreterResonanceMagique();
            declencherResonanceMagique('orbe_1', 'quete', 1);
        }, 8000);
        
        // Test 4 : Résonance d'une clé
        console.log('%cTest 4: Résonance clé numéro 42', 'color:#49cafa;');
        setTimeout(function() {
            arreterResonanceMagique();
            declencherResonanceMagique(42, 'cle', 3);
        }, 13000);
        
        // Test 5 : Arrêt complet
        setTimeout(function() {
            arreterResonanceMagique();
            console.log('%c✔ Test de résonance terminé', 'color:#00ff88; font-weight:bold;');
        }, 18000);
    };

    window.testZoneInteractive = function() {
        console.log('%c=== TEST ZONE INTERACTIVE ===', 'color:#d4af37; font-size:1.2em; font-weight:bold;');
        
        // Préparer l'inventaire
        viderSac();
        viderObjetsQuete();
        ajouterObjetQuete('🔮', 'Orbe Mystique', 'orbe_mystique');
        ajouterObjetQuete('💎', 'Cristal de Givre', 'cristal_givre');
        ajouterCleDansSac(7);
        
        ouvrirSacInventaire();
        
        // Simuler l'approche d'une zone qui requiert l'Orbe
        console.log('%c🚪 Approche de la Porte du Mystère...', 'color:#49cafa;');
        setTimeout(function() {
            var result = verifierResonanceZone('porte_mystere', 'orbe_mystique');
            if (result) {
                console.log('%c✔ La porte reconnaît votre objet !', 'color:#00ff88;');
            }
        }, 1500);
        
        // Arrêt après 6 secondes
        setTimeout(function() {
            arreterResonanceMagique();
            console.log('%c✔ Test de zone terminé', 'color:#00ff88; font-weight:bold;');
        }, 7500);
    };

    window.testRunesSysteme = function() {
        console.log('%c=== TEST SYSTÈME DES 12 RUNES ===', 'color:#d4af37; font-size:1.3em; font-weight:bold; text-shadow: 0 0 10px rgba(212,175,55,0.5);');
        
        // Préparer le terrain
        viderSac();
        viderObjetsQuete();
        window.runesDecouvertes = {
            rune1PremierClic: false,
            indicesTrouves: [],
            papyrusCollectes: [],
            portesOuvertes: []
        };
        var runesDecouvertes = window.runesDecouvertes;
        
        console.log('%c\n📖 GUIDE DES RUNES :', 'color:#49cafa; font-size:1.1em; font-weight:bold;');
        console.log('%c  Runes 1-4  : Les Chercheurs (fouillerZone)', 'color:#888;');
        console.log('%c  Runes 5-8  : Les Verrous (ouvrirPorte)', 'color:#888;');
        console.log('%c  Runes 9-10 : L\'Atelier (papyrus russes)', 'color:#888;');
        console.log('%c  Rune 11    : La Taverne (chat social)', 'color:#888;');
        console.log('%c  Rune 12    : L\'Œil de l\'Oracle (météo + jackpot)', 'color:#888;');
        
        console.log('%c\n📋 SCÉNARIO DE TEST :', 'color:#00ff88; font-weight:bold;');
        
        // Étape 1 : Cliquer sur la Rune 1 (Énigme #1)
        setTimeout(function() {
            console.log('%c\n1. Clic sur Rune 1 (Première fois) - Énigme #1', 'color:#d4af37; font-weight:bold;');
            console.log('%c   → Devrait afficher le message mystique', 'color:#888;');
            console.log('%c   → Devrait ajouter le premier papyrus', 'color:#888;');
            console.log('%c   → Devrait vibrer le sac', 'color:#888;');
        }, 500);
        
        // Étape 2 : Ajouter des clés pour tester les portes
        setTimeout(function() {
            console.log('%c\n2. Ajout de clés dans le sac', 'color:#d4af37; font-weight:bold;');
            ajouterCleDansSac(1);
            ajouterCleDansSac(2);
            console.log('%c   → Clés 1 et 2 ajoutées', 'color:#00ff88;');
        }, 1500);
        
        // Étape 3 : Tester une porte (Rune 5 = Porte 1)
        setTimeout(function() {
            console.log('%c\n3. Vous pouvez maintenant tester :', 'color:#d4af37; font-weight:bold;');
            console.log('%c   • Rune 1 (0)  : Énigme + papyrus', 'color:#49cafa;');
            console.log('%c   • Rune 2-4    : Fouiller zones', 'color:#49cafa;');
            console.log('%c   • Rune 5 (4)  : Porte 1 (clé 1 requise)', 'color:#49cafa;');
            console.log('%c   • Rune 6 (5)  : Porte 2 (clé 2 requise)', 'color:#49cafa;');
            console.log('%c   • Rune 9-10   : Atelier papyrus', 'color:#49cafa;');
            console.log('%c   • Rune 11 (10): Taverne', 'color:#49cafa;');
            console.log('%c   • Rune 12 (11): Œil Oracle', 'color:#49cafa;');
            console.log('%c\n💡 Cliquez sur les runes pour tester leurs fonctions !', 'color:#00ff88; font-size:1.1em; font-weight:bold;');
        }, 2500);
    };

    window.testInteractionSanctuaire = function() {
        console.log('%c=== TEST INTERACTION INVENTAIRE ↔ SANCTUAIRE ===', 'color:#d4af37; font-size:1.3em; font-weight:bold;');
        
        // Préparer l'inventaire avec quelques objets
        viderSac();
        viderObjetsQuete();
        ajouterCleDansSac(1);
        ajouterCleDansSac(5);
        ajouterCleDansSac(7);
        ajouterObjetQuete('💎', 'Cristal', 'cristal_1');
        ajouterObjetQuete('🔮', 'Orbe', 'orbe_1');
        
        console.log('%c👜 Ouverture de l\'inventaire...', 'color:#49cafa;');
        console.log('%c   → Le sanctuaire va se déplacer vers le haut et se réduire', 'color:#888;');
        console.log('%c   → Les runes restent CLIQUABLES', 'color:#00ff88; font-weight:bold;');
        ouvrirSacInventaire();
        
        setTimeout(function() {
            console.log('%c✨ L\'inventaire est ouvert !', 'color:#d4af37;');
            console.log('%c   → Essayez de cliquer sur les runes du sanctuaire', 'color:#49cafa;');
            console.log('%c   → Vous pouvez voir le sanctuaire à travers le fond semi-transparent', 'color:#49cafa;');
        }, 600);
        
        setTimeout(function() {
            console.log('%c👜 Fermeture de l\'inventaire...', 'color:#888;');
            console.log('%c   → Le sanctuaire reprend sa position centrale', 'color:#888;');
            fermerSacInventaire();
        }, 4000);
        
        setTimeout(function() {
            console.log('%c✔ Test terminé - Interaction fluide confirmée !', 'color:#00ff88; font-size:1.1em; font-weight:bold;');
            console.log('%c💡 Astuce : Appuyez sur Échap pour fermer l\'inventaire rapidement', 'color:#d4af37;');
        }, 4700);
    };

    window.testScenarioComplet = function() {
        console.log('%c=== SCÉNARIO COMPLET : QUÊTE DU SANCTUAIRE ===', 'color:#d4af37; font-size:1.3em; font-weight:bold; text-shadow: 0 0 10px rgba(212,175,55,0.5);');
        
        // Préparer l'inventaire
        viderSac();
        viderObjetsQuete();
        
        // Étape 1 : Le joueur reçoit des objets
        console.log('%c👜 Étape 1/5 : Collecte d\'objets...', 'color:#49cafa; font-weight:bold;');
        ajouterCleDansSac(1);
        ajouterCleDansSac(5);
        ajouterObjetQuete('🔑', 'Clé Antique', 'cle_antique');
        ajouterObjetQuete('💎', 'Cristal de Givre', 'cristal_givre');
        ajouterObjetQuete('🔮', 'Orbe de Vision', 'orbe_vision');
        
        // Ouvrir l'inventaire
        setTimeout(function() {
            ouvrirSacInventaire();
        }, 500);
        
        // Étape 2 : Approche d'une première porte (nécessite cristal)
        setTimeout(function() {
            console.log('%c✦ Étape 2/5 : Approche de la Porte de Glace...', 'color:#49cafa; font-weight:bold;');
            enregistrerZoneResonance('porte_glace', 'cristal_givre', function() {
                console.log('%c🎉 La Porte de Glace s\'ouvre !', 'color:#00ff88;');
                retirerObjetQuete('cristal_givre');
            });
            declencherZoneResonance('porte_glace');
        }, 3000);
        
        // Étape 3 : Le cristal disparaît, résonance s'arrête
        setTimeout(function() {
            arreterResonanceMagique();
            console.log('%c✨ Le Cristal de Givre se dissout dans un éclat de lumière...', 'color:#888; font-style:italic;');
        }, 8000);
        
        // Étape 4 : Nouvelle zone nécessitant l'Orbe
        setTimeout(function() {
            console.log('%c🔮 Étape 3/5 : Salle des Miroirs...', 'color:#49cafa; font-weight:bold;');
            enregistrerZoneResonance('salle_miroirs', 'orbe_vision', function() {
                console.log('%c👁 L\'Orbe révèle le chemin caché !', 'color:#00ff88;');
            });
            declencherZoneResonance('salle_miroirs');
        }, 10000);
        
        // Étape 5 : Arrêt et nouvelle clé découverte
        setTimeout(function() {
            arreterResonanceMagique();
            console.log('%c🔑 Étape 4/5 : Une nouvelle clé apparaît !', 'color:#49cafa; font-weight:bold;');
            ajouterCleDansSac(13);
        }, 15000);
        
        // Étape 6 : Porte finale nécessitant clé 13
        setTimeout(function() {
            console.log('%c🚪 Étape 5/5 : Porte du Sanctuaire Final...', 'color:#d4af37; font-weight:bold;');
            verifierResonanceRune(12); // Rune 12 nécessite clé 13
            console.log('%c✨ La clé 13 vibre intensément !', 'color:#d4af37;');
        }, 17000);
        
        // Fin du scénario
        setTimeout(function() {
            arreterResonanceMagique();
            fermerSacInventaire();
            console.log('%c🎊 QUÊTE TERMINÉE ! Le Sanctuaire s\'ouvre devant vous...', 'color:#00ff88; font-size:1.2em; font-weight:bold; text-shadow: 0 0 20px rgba(0,255,136,0.8);');
        }, 22000);
    };


    // Fonction utilitaire : Déclencher résonance simple (pour intégration facile)
    window.resonner = function(objetId, type, intensite) {
        type = type || 'quete';
        intensite = intensite || 1;
        declencherResonanceMagique(objetId, type, intensite);
    };

    // ═══════════════════════════════════════════════════════
    // INTÉGRATION ZONES INTERACTIVES - Détection de proximité
    // ═══════════════════════════════════════════════════════
    
    // Exemple d'intégration avec les runes du Sanctuaire
    function verifierResonanceRune(runeId) {
        // Vérifier si une clé spéciale peut débloquer cette rune
        var cleSpeciale = runeId + 1; // Exemple : rune 0 nécessite clé 1
        
        if (sacInventaire.indexOf(cleSpeciale) !== -1) {
            console.log('%c🔑 Rune ' + runeId + ' : Clé spéciale détectée !', 'color:#d4af37;');
            declencherResonanceMagique(cleSpeciale, 'cle', 1);
            return true;
        }
        return false;
    }

    // Exemple d'intégration avec les portes des 100 niveaux
    function verifierResonancePorte(doorIndex) {
        // Vérifier si un objet de quête peut aider à identifier la bonne porte
        var objetsUtiles = ['orbe_vision', 'cristal_clarte', 'parchemin_sagesse'];
        
        for (var i = 0; i < objetsUtiles.length; i++) {
            var objet = sacObjetsQuete.find(function(obj) { return obj.id === objetsUtiles[i]; });
            if (objet) {
                console.log('%c🔮 Porte ' + doorIndex + ' : Objet de guidance détecté !', 'color:#49cafa;');
                declencherResonanceMagique(objet.id, 'quete', 2);
                
                // Révéler la destination de la porte
                if (typeof revealDoorWithScroll === 'function') {
                    revealDoorWithScroll(doorIndex);
                }
                return true;
            }
        }
        return false;
    }

    // Hook global : Surveiller les événements de proximité
    var resonanceZonesActives = {};
    
    function enregistrerZoneResonance(zoneId, objetRequis, callback) {
        resonanceZonesActives[zoneId] = {
            objetRequis: objetRequis,
            callback: callback || function() {}
        };
        console.log('%c📍 Zone de résonance enregistrée:', 'color:#d4af37;', zoneId);
    }

    function declencherZoneResonance(zoneId) {
        var zone = resonanceZonesActives[zoneId];
        if (!zone) {
            console.warn('Zone de résonance inconnue:', zoneId);
            return false;
        }
        
        var result = verifierResonanceZone(zoneId, zone.objetRequis);
        if (result && zone.callback) {
            zone.callback();
        }
        return result;
    }
</script></body></html>
