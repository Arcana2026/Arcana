<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCANA - Écosystème Web3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --arcana-blue: #00f2ff;
            --arcana-dark: #050a10;
            --glass: rgba(0, 242, 255, 0.05);
            --border: rgba(0, 242, 255, 0.3);
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--arcana-dark);
            color: white;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        #corridor-layer {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: var(--arcana-dark) url('arcana-corridor.jpg') no-repeat center center;
            background-size: cover;
            transform: scale(1);
            opacity: 1;
            transition: transform 300ms ease, opacity 300ms ease;
            will-change: transform, opacity;
        }

        #corridor-layer.dive {
            transform: scale(1.08);
            opacity: 0.86;
        }

        .data-fragment {
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.85), rgba(0, 242, 255, 0.35) 35%, rgba(0, 242, 255, 0.08) 60%, rgba(0,0,0,0) 70%);
            border: 1px solid rgba(0, 242, 255, 0.65);
            box-shadow: 0 0 18px rgba(0, 242, 255, 0.65), 0 0 34px rgba(0, 242, 255, 0.22);
            cursor: pointer;
            z-index: 20;
            transform: translate(-50%, -50%) scale(1);
            animation: fragmentPulse 1.8s ease-in-out infinite;
        }

        .data-fragment.implode {
            animation: fragmentImplode 220ms ease forwards;
        }

        @keyframes fragmentPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.95; }
            50% { transform: translate(-50%, -50%) scale(1.12); opacity: 1; }
        }

        @keyframes fragmentImplode {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.1); opacity: 0; }
        }

        body.oracle-frost::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 900;
            pointer-events: none;
            background:
                radial-gradient(120% 140% at 50% 20%, rgba(255,255,255,0.10), rgba(255,255,255,0.02) 42%, rgba(0,0,0,0) 70%),
                repeating-linear-gradient(135deg, rgba(180, 245, 255, 0.07) 0, rgba(180, 245, 255, 0.07) 2px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 9px);
            backdrop-filter: blur(3px) saturate(0.9);
            -webkit-backdrop-filter: blur(3px) saturate(0.9);
            opacity: 1;
            transition: opacity 300ms ease;
        }

        /* Header Moderne */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .keys-counter {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.72rem;
            letter-spacing: 2px;
            color: rgba(0, 242, 255, 0.95);
            border: 1px solid rgba(0, 242, 255, 0.45);
            background: rgba(0, 242, 255, 0.06);
            padding: 8px 10px;
            border-radius: 8px;
            box-shadow: 0 0 16px rgba(0, 242, 255, 0.14);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            user-select: none;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 3px;
            color: var(--arcana-blue);
        }

        /* Boutons Ghost Style */
        .btn-arcana {
            background: transparent;
            border: 1px solid var(--arcana-blue);
            color: var(--arcana-blue);
            padding: 10px 25px;
            border-radius: 4px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-arcana:hover {
            background: rgba(0, 242, 255, 0.1);
            box-shadow: 0 0 15px var(--arcana-blue);
        }

        /* Zone de dialogue (Style IA) */
        #dialogue-box {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 800px;
            background: rgba(5, 10, 16, 0.85);
            border-left: 4px solid var(--arcana-blue);
            padding: 20px;
            font-size: 0.95rem;
            line-height: 1.6;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* La Valise (Point Central) */
        #main-chest-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-align: center;
        }

        #chest-image {
            width: 300px;
            cursor: pointer;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 0 20px rgba(0, 242, 255, 0.4));
        }

        #chest-image:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 40px rgba(0, 242, 255, 0.8));
        }

        /* Inventaire / Sacoche */
        #sacoche-trigger {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 1px solid var(--arcana-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: var(--arcana-dark);
            z-index: 1000;
        }

        .key-icon {
            width: 30px;
            height: 30px;
            background: url('a-key-icon.png') no-repeat center;
            background-size: contain;
        }

        #back-to-hub {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 120;
            padding: 10px 18px;
            border-radius: 8px;
            border: 1px solid rgba(0, 242, 255, 0.75);
            background: rgba(0, 242, 255, 0.08);
            color: rgba(0, 242, 255, 0.95);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.78rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 0 16px rgba(0, 242, 255, 0.18);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            white-space: nowrap;
            max-width: 70vw;
        }

        #back-to-hub:hover {
            background: rgba(0, 242, 255, 0.14);
            box-shadow: 0 0 22px rgba(0, 242, 255, 0.28);
        }
    </style>
</head>
<body>

<div id="corridor-layer" aria-hidden="true"></div>

<header>
    <div class="logo-area">
        <img src="logo.png" alt="Arcana" style="height: 40px;">
        <span>ARCANA</span>
    </div>
    <div class="nav-actions">
        <div id="levelCounter" class="keys-counter">[ SECTEUR : 1 / 100 ]</div>
        <div id="keysCounter" class="keys-counter">[ KEYS : 0 / 3 ]</div>
        <button class="btn-arcana" id="connect-wallet">Initialiser Connexion</button>
    </div>
</header>

<button id="back-to-hub" type="button">[ RETOUR AU HUB ]</button>

<div id="main-chest-container">
    <img src="v-arcana-c.png" id="chest-image" alt="Valise Arcana">
    <p style="margin-top: 20px; font-family: 'Orbitron'; color: var(--arcana-blue); letter-spacing: 2px;">VAULT SÉCURISÉ</p>
</div>

<div id="oracle-inline-answer" aria-hidden="true">
    <div class="oracle-inline-panel">
        <input id="oracleInlineInput" type="text" autocomplete="off" placeholder="Réponse Oracle...">
        <button id="oracleInlineSubmit" type="button">Valider</button>
    </div>
</div>

<div id="dialogue-box">
    <span id="dialogue-text">Initialisation des protocoles...</span>
</div>

<div id="matrixOverlay" style="display:none; position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,0.92);">
    <pre id="matrixCode" style="margin:0; height:100%; padding:20px; overflow:hidden; color:rgba(0,242,255,0.8); font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; line-height:1.2;"></pre>
</div>

<div id="chatPanel" style="position:fixed; left:20px; bottom:20px; width:360px; max-width:92vw; z-index:140; border:1px solid rgba(0,242,255,0.25); background:rgba(5,10,16,0.72); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius:12px; overflow:hidden;">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid rgba(0,242,255,0.18);">
        <div style="font-family:'Orbitron',sans-serif; letter-spacing:2px; font-size:0.72rem; color:rgba(0,242,255,0.95);">MARCHÉ SOCIAL</div>
        <button id="toggleChat" class="btn-arcana" style="padding:6px 10px; font-size:0.7rem;">CHAT</button>
    </div>
    <div id="chatBody" style="display:none;">
        <div id="chatMessages" style="height:210px; overflow:auto; padding:10px 12px; font-size:0.84rem;"></div>
        <div id="auctionList" style="max-height:160px; overflow:auto; padding:0 12px 10px;"></div>
        <div id="shopPanel" style="padding:0 12px 10px;">
            <div style="margin-top:10px; padding:10px; border:1px solid rgba(0,242,255,0.18); border-radius:10px; background:rgba(0,242,255,0.04);">
                <div style="font-family:Orbitron,sans-serif; letter-spacing:1px; font-size:0.72rem; color:rgba(0,242,255,0.95);">BOUTIQUE</div>
                <div style="margin-top:6px; font-size:0.78rem; color:rgba(255,255,255,0.75);">Guide de l'Initié — 50 USDC</div>
                <button id="buyGuideBtn" class="btn-arcana" style="margin-top:8px; width:100%; padding:10px 12px;">ACHETER LE GUIDE</button>
            </div>
        </div>
        <div style="display:flex; gap:8px; padding:10px 12px; border-top:1px solid rgba(0,242,255,0.18);">
            <input id="chatInput" type="text" placeholder="Message... /enchere Fragment 12 USDC" style="flex:1; padding:10px 10px; border-radius:8px; border:1px solid rgba(0,242,255,0.25); background:rgba(0,0,0,0.25); color:#fff; outline:none;" />
            <button id="chatSend" class="btn-arcana" style="padding:10px 14px;">ENVOYER</button>
        </div>
    </div>
</div>

<div id="sacoche-trigger" onclick="toggleInventory()">
    <div class="key-icon"></div>
</div>

<script>
    const dialogueText = document.getElementById('dialogue-text');
    const chest = document.getElementById('chest-image');
    let hasKey = false; // Simule la possession de a-key-icon.png

    let currentLevel = 1;
    let dataKeys = 0;
    let chestState = { opened: false, contents: [] };
    let corridorState = { sector: 1, x: 0.5, y: 0.5 };
    let hasGuide = false;
    let hasSocialTrade = false;

    let provider;
    let signer;
    let account;

    // Mélange des textes 2 et 3
    const welcomeMessage = "Connexion établie. Vous pénétrez dans le couloir de données d'Arcana. Ici, le silence du réseau cache le bourdonnement des serveurs et chaque porte est un code. Utilisez vos Data-Keys pour déverrouiller les coffres du Vault. La sécurité Web3 veille sur vos actifs, Bernard.";

    const errorNoKey = "[ALERTE SÉCURITÉ ARCANA] ERREUR : Clé de décryptage absente ou corrompue. Action : Accès au Vault verrouillé via arcana-safe.nft.";

    const successOpen = "Déchiffrement réussi. Accès au contenu du Vault autorisé. Type d'actif : Fragment d'écosystème Arcana sécurisé sur arcana-safe.nft.";

    // Effet machine à écrire
    function typeWriter(text, i = 0) {
        if (i < text.length) {
            dialogueText.innerHTML = text.substring(0, i + 1);
            setTimeout(() => typeWriter(text, i + 1), 30);
        }
    }

    function getArcanaCloudKey() {
        if (!account) return null;
        return `arcana-cloud:${String(account).toLowerCase()}`;
    }

    function getProgressSnapshot() {
        return {
            level: currentLevel,
            keys: dataKeys,
            chest: {
                opened: !!chestState.opened,
                contents: Array.isArray(chestState.contents) ? chestState.contents : []
            },
            guide: !!hasGuide,
            socialTrade: !!hasSocialTrade,
            corridor: {
                sector: corridorState && typeof corridorState.sector === 'number' ? corridorState.sector : currentLevel,
                x: corridorState && typeof corridorState.x === 'number' ? corridorState.x : 0.5,
                y: corridorState && typeof corridorState.y === 'number' ? corridorState.y : 0.5
            },
            updatedAt: Date.now()
        };
    }

    function applyProgressSnapshot(snapshot) {
        if (!snapshot || typeof snapshot !== 'object') return;

        if (typeof snapshot.level === 'number' && snapshot.level >= 1) {
            currentLevel = snapshot.level;
        }
        if (typeof snapshot.keys === 'number' && snapshot.keys >= 0) {
            dataKeys = snapshot.keys;
        }
        if (snapshot.chest && typeof snapshot.chest === 'object') {
            chestState = {
                opened: !!snapshot.chest.opened,
                contents: Array.isArray(snapshot.chest.contents) ? snapshot.chest.contents : []
            };
        }
        hasGuide = !!snapshot.guide;
        hasSocialTrade = !!snapshot.socialTrade;

        if (snapshot.corridor && typeof snapshot.corridor === 'object') {
            corridorState = {
                sector: (typeof snapshot.corridor.sector === 'number' && snapshot.corridor.sector >= 1) ? snapshot.corridor.sector : currentLevel,
                x: (typeof snapshot.corridor.x === 'number') ? snapshot.corridor.x : 0.5,
                y: (typeof snapshot.corridor.y === 'number') ? snapshot.corridor.y : 0.5
            };
        }

        const keysCounterEl = document.getElementById('keysCounter');
        if (keysCounterEl) keysCounterEl.textContent = `[ KEYS : ${dataKeys} / 3 ]`;

        const levelCounterEl = document.getElementById('levelCounter');
        if (levelCounterEl) levelCounterEl.textContent = `[ SECTEUR : ${currentLevel} / 100 ]`;

        hasKey = dataKeys > 0;

        if (chest && chestState && chestState.opened) {
            chest.src = 'v-arcana.png';
        }

        const buyBtn = document.getElementById('buyGuideBtn');
        if (buyBtn) {
            buyBtn.disabled = !!hasGuide;
            buyBtn.textContent = hasGuide ? 'GUIDE ACTIF' : 'ACHETER LE GUIDE';
        }
    }

    function saveProgress() {
        try {
            const storageKey = getArcanaCloudKey();
            if (!storageKey) return;
            const snapshot = getProgressSnapshot();
            localStorage.setItem(storageKey, JSON.stringify(snapshot));
        } catch (e) {
            return;
        }
    }

    function loadProgress() {
        try {
            const storageKey = getArcanaCloudKey();
            if (!storageKey) return null;
            const raw = localStorage.getItem(storageKey);
            if (!raw) return null;
            const snapshot = JSON.parse(raw);
            applyProgressSnapshot(snapshot);
            return snapshot;
        } catch (e) {
            return null;
        }
    }

    function initLevel1() {
        currentLevel = 1;
        dataKeys = 0;
        chestState = { opened: false, contents: [] };
        corridorState = { sector: 1, x: 0.5, y: 0.5 };
        hasGuide = false;
        hasSocialTrade = false;
        if (chest) chest.src = 'v-arcana-c.png';
        const keysCounterEl = document.getElementById('keysCounter');
        if (keysCounterEl) keysCounterEl.textContent = '[ KEYS : 0 / 3 ]';
        const levelCounterEl = document.getElementById('levelCounter');
        if (levelCounterEl) levelCounterEl.textContent = '[ SECTEUR : 1 / 100 ]';
        hasKey = false;
        saveProgress();
    }

    const ADMIN_ADDRESS = '0x1990fd46a1ad0344751be45d6779b8c1f827076d';
    const ARCANA_TOKEN_ADDRESS = '0x1990fd46a1ad0344751be45d6779b8c1f827076d';
    const USDC_TOKEN_ADDRESS = '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174';
    const ARCANA_API_BASE = window.ARCANA_API_BASE || window.location.origin;

    const ARCANA_USDC_RATE = 0.10;
    const GUIDE_PRICE_USDC = 50;

    const TOKEN_DECIMALS = { ARCANA: 18, USDC: 6 };
    const ERC20_ABI = [
        'function transfer(address to, uint256 amount) returns (bool)'
    ];

    const MYSTERY_OBJECTS = [
        { id: 'ANOMALIE', label: 'Anomalie', utility: 'Altère une porte (réduit les exigences).', estimate: '0.2 ARCANA' },
        { id: 'ECLAT', label: 'Éclat', utility: 'Stabilise un passage (ouvre un palier).', estimate: '1.6 USDC' },
        { id: 'FRAGMENT', label: 'Fragment', utility: 'Clé sociale (nécessaire pour progresser).', estimate: '3.2 USDC' },
        { id: 'LARME', label: 'Larme', utility: 'Double la récompense d’un niveau.', estimate: '0.008 POL' },
        { id: 'CODE_DORE', label: 'Code Doré', utility: 'Accès direct à un secteur (+5 niveaux).', estimate: '0.9 ARCANA' }
    ];

    function renderCounters() {
        const keysCounterEl = document.getElementById('keysCounter');
        if (keysCounterEl) keysCounterEl.textContent = `[ KEYS : ${dataKeys} / 3 ]`;
        const levelCounterEl = document.getElementById('levelCounter');
        if (levelCounterEl) levelCounterEl.textContent = `[ SECTEUR : ${currentLevel} / 100 ]`;
    }

    function countItem(label) {
        const list = Array.isArray(chestState.contents) ? chestState.contents : [];
        return list.filter(x => String(x).toLowerCase() === String(label).toLowerCase()).length;
    }

    function removeItem(label, qty) {
        const q = Math.max(0, Number(qty) || 0);
        if (q <= 0) return;
        const list = Array.isArray(chestState.contents) ? chestState.contents.slice() : [];
        let left = q;
        const next = [];
        for (const it of list) {
            if (left > 0 && String(it).toLowerCase() === String(label).toLowerCase()) {
                left -= 1;
            } else {
                next.push(it);
            }
        }
        chestState.contents = next;
    }

    function getDoorRequirement(level) {
        const l = Math.max(1, Math.min(100, Number(level) || 1));
        if (l <= 2) return { items: {}, requiresSocial: false };
        if (l === 3) return { items: { Fragment: 1 }, requiresSocial: true };
        if (l === 5) return { items: { 'Éclat': 1 }, requiresSocial: true };
        if (l % 10 === 0) return { items: { Fragment: 2 }, requiresSocial: true };
        if (l % 7 === 0) return { items: { Anomalie: 1 }, requiresSocial: true };
        return { items: { Fragment: 1 }, requiresSocial: true };
    }

    function canOpenDoor(level) {
        const req = getDoorRequirement(level);
        if (req.requiresSocial && !hasSocialTrade && level >= 3) return { ok: false, reason: 'social' };
        const items = req.items || {};
        for (const k of Object.keys(items)) {
            const need = Number(items[k]) || 0;
            if (need > 0 && countItem(k) < need) return { ok: false, reason: 'items', missing: k, need };
        }
        return { ok: true };
    }

    function consumeDoorRequirement(level) {
        const req = getDoorRequirement(level);
        const items = req.items || {};
        for (const k of Object.keys(items)) {
            removeItem(k, Number(items[k]) || 0);
        }
    }

    function rewardForLevel(level) {
        const l = Math.max(1, Math.min(100, Number(level) || 1));
        const roll = Math.random();
        if (roll < 0.7) {
            const idx = Math.floor(Math.random() * MYSTERY_OBJECTS.length);
            return { type: 'object', item: MYSTERY_OBJECTS[idx].label };
        }
        const arc = Math.max(0.01, Math.floor((l * 0.03) * 1000) / 1000);
        return { type: 'crypto', currency: 'ARCANA', amount: arc };
    }

    function showDoorStatus(msg) {
        typeWriter(msg);
    }

    function openNextDoor() {
        if (currentLevel >= 100) {
            showDoorStatus('Fin de protocole atteinte. Niveau 100 sécurisé.');
            return;
        }

        const check = canOpenDoor(currentLevel + 1);
        if (!check.ok) {
            if (check.reason === 'social') {
                showDoorStatus('Verrou social actif. Impossible de finir seul. Utilisez le chat : achetez ou échangez des Fragments.');
                return;
            }
            if (check.reason === 'items') {
                showDoorStatus(`Porte verrouillée. Exigence : ${check.need} x ${check.missing}. Demandez-le dans le chat.`);
                return;
            }
            showDoorStatus('Porte verrouillée.');
            return;
        }

        consumeDoorRequirement(currentLevel + 1);
        currentLevel = Math.min(100, currentLevel + 1);
        corridorState.sector = currentLevel;

        const reward = rewardForLevel(currentLevel);
        if (reward.type === 'object') {
            chestState.contents = Array.isArray(chestState.contents) ? chestState.contents : [];
            chestState.contents.push(reward.item);
            showDoorStatus(`Porte ouverte. Prix généré : ${reward.item}.`);
        } else {
            showDoorStatus(`Porte ouverte. Gain cryptographique détecté : ${reward.amount} ${reward.currency}.`);
        }

        renderCounters();
        saveProgress();
    }

    function ensureWalletReady() {
        if (!signer || !account) {
            typeWriter('Connexion wallet requise.');
            return false;
        }
        return true;
    }

    async function ensurePolygon137() {
        try {
            if (!provider) return false;
            const net = await provider.getNetwork();
            return net && Number(net.chainId) === 137;
        } catch (_) {
            return false;
        }
    }

    function getTaxRate(currency) {
        const c = String(currency || '').toUpperCase();
        if (c === 'ARCANA') return 0.01;
        if (c === 'POL' || c === 'USDC') return 0.02;
        return 0;
    }

    async function buyGuide() {
        if (hasGuide) {
            typeWriter("Le Guide de l'Initié est déjà actif.");
            return;
        }
        if (!ensureWalletReady()) return;

        const okNet = await ensurePolygon137();
        if (!okNet) {
            typeWriter('Réseau requis: Polygon (137).');
            return;
        }

        const btn = document.getElementById('buyGuideBtn');
        const prev = btn ? btn.textContent : '';
        try {
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'PAIEMENT USDC...';
            }

            const token = new ethers.Contract(USDC_TOKEN_ADDRESS, ERC20_ABI, signer);
            const dec = TOKEN_DECIMALS.USDC;
            const tx = await token.transfer(ADMIN_ADDRESS, ethers.utils.parseUnits(String(GUIDE_PRICE_USDC), dec));
            await tx.wait();

            hasGuide = true;
            saveProgress();

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'GUIDE ACTIF';
            }

            typeWriter("Félicitations Bernard. Le Guide de l'Initié est activé. Les secrets du code source vous sont révélés.");
        } catch (e) {
            typeWriter('Transaction échouée.');
        } finally {
            if (btn && !hasGuide) {
                btn.disabled = false;
                btn.textContent = prev || 'ACHETER LE GUIDE';
            }
        }
    }

    async function payAuction(auction) {
        if (!ensureWalletReady()) return null;
        const okNet = await ensurePolygon137();
        if (!okNet) {
            typeWriter('Réseau requis: Polygon (137).');
            return null;
        }

        const currency = String(auction.currency || '').toUpperCase();
        const price = Number(auction.price);
        if (!Number.isFinite(price) || price <= 0) return null;
        const seller = auction.seller;
        if (!seller || !ethers.utils.isAddress(seller)) {
            typeWriter('Enchère invalide (vendeur).');
            return null;
        }

        const taxRate = getTaxRate(currency);
        const tax = Math.max(0, price * taxRate);
        const sellerAmount = Math.max(0, price - tax);

        if (currency === 'POL') {
            const tx1 = await signer.sendTransaction({ to: seller, value: ethers.utils.parseEther(String(sellerAmount)) });
            await tx1.wait();
            const tx2 = await signer.sendTransaction({ to: ADMIN_ADDRESS, value: ethers.utils.parseEther(String(tax)) });
            await tx2.wait();
            return { txHash: tx2.hash, taxCurrency: 'POL', tax };
        }

        if (currency === 'ARCANA') {
            const token = new ethers.Contract(ARCANA_TOKEN_ADDRESS, ERC20_ABI, signer);
            const dec = TOKEN_DECIMALS.ARCANA;
            const tx1 = await token.transfer(seller, ethers.utils.parseUnits(String(sellerAmount), dec));
            await tx1.wait();
            const tx2 = await token.transfer(ADMIN_ADDRESS, ethers.utils.parseUnits(String(tax), dec));
            await tx2.wait();
            return { txHash: tx2.hash, taxCurrency: 'ARCANA', tax };
        }

        if (currency === 'USDC') {
            const token = new ethers.Contract(USDC_TOKEN_ADDRESS, ERC20_ABI, signer);
            const dec = TOKEN_DECIMALS.USDC;
            const tx1 = await token.transfer(seller, ethers.utils.parseUnits(String(sellerAmount), dec));
            await tx1.wait();
            const tx2 = await token.transfer(ADMIN_ADDRESS, ethers.utils.parseUnits(String(tax), dec));
            await tx2.wait();
            return { txHash: tx2.hash, taxCurrency: 'USDC', tax };
        }

        typeWriter('Monnaie non supportée.');
        return null;
    }

    let chatOpen = false;
    let chatSince = 0;
    let chatTimer = null;
    let auctionsTimer = null;

    function formatAddr(a) {
        if (!a) return '—';
        const s = String(a);
        return s.length > 10 ? `${s.slice(0, 6)}…${s.slice(-4)}` : s;
    }

    function appendChatLine(line) {
        const box = document.getElementById('chatMessages');
        if (!box) return;
        const p = document.createElement('div');
        p.style.margin = '6px 0';
        if (line.type === 'auction') {
            p.style.color = 'rgba(0, 242, 255, 0.95)';
            p.style.fontWeight = '600';
            p.textContent = line.message;
        } else if (line.type === 'system') {
            p.style.color = 'rgba(0, 255, 140, 0.9)';
            p.textContent = line.message;
        } else {
            const who = line.address ? formatAddr(line.address) : 'ORACLE';
            p.textContent = `${who}: ${line.message}`;
        }
        box.appendChild(p);
        box.scrollTop = box.scrollHeight;
    }

    async function refreshChat() {
        if (!chatOpen) return;
        try {
            const r = await fetch(`${ARCANA_API_BASE}/api/chat/messages?since=${encodeURIComponent(String(chatSince || 0))}`, { cache: 'no-store' });
            const data = await r.json();
            const list = data && Array.isArray(data.messages) ? data.messages : [];
            for (const m of list) {
                chatSince = Math.max(chatSince, Number(m.ts) || 0);
                appendChatLine(m);
            }
        } catch (_) {}
    }

    function renderAuctions(list) {
        const box = document.getElementById('auctionList');
        if (!box) return;
        box.innerHTML = '';
        for (const a of list) {
            const wrap = document.createElement('div');
            wrap.style.cssText = 'margin-top:8px; padding:10px; border:1px solid rgba(0,242,255,0.18); border-radius:10px; background:rgba(0,242,255,0.04);';
            const title = document.createElement('div');
            title.style.cssText = 'font-family:Orbitron,sans-serif; letter-spacing:1px; font-size:0.72rem; color:rgba(0,242,255,0.95);';
            title.textContent = `${a.item} — ${a.price} ${a.currency}`;
            const meta = document.createElement('div');
            meta.style.cssText = 'margin-top:6px; font-size:0.78rem; color:rgba(255,255,255,0.75);';
            meta.textContent = `Vendeur: ${formatAddr(a.seller)}`;
            const btn = document.createElement('button');
            btn.className = 'btn-arcana';
            btn.style.cssText = 'margin-top:8px; width:100%; padding:10px 12px;';
            btn.textContent = 'ACHETER';
            btn.addEventListener('click', async () => {
                try {
                    btn.disabled = true;
                    btn.textContent = 'TRANSACTION...';
                    const pay = await payAuction(a);
                    if (!pay) {
                        btn.textContent = 'ERREUR';
                        return;
                    }
                    await fetch(`${ARCANA_API_BASE}/api/auctions/${encodeURIComponent(a.id)}/mark-sold`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ buyer: account, txHash: pay.txHash, taxCurrency: pay.taxCurrency, tax: pay.tax })
                    });

                    hasSocialTrade = true;
                    chestState.contents = Array.isArray(chestState.contents) ? chestState.contents : [];
                    chestState.contents.push(a.item);
                    saveProgress();
                    typeWriter('Achat validé. Objet réinjecté dans la valise.');
                } catch (e) {
                    typeWriter('Transaction échouée.');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'ACHETER';
                }
            });
            wrap.appendChild(title);
            wrap.appendChild(meta);
            wrap.appendChild(btn);
            box.appendChild(wrap);
        }
    }

    async function refreshAuctions() {
        if (!chatOpen) return;
        try {
            const r = await fetch(`${ARCANA_API_BASE}/api/auctions`, { cache: 'no-store' });
            const data = await r.json();
            const list = data && Array.isArray(data.auctions) ? data.auctions : [];
            renderAuctions(list);
        } catch (_) {}
    }

    function startChatPolling() {
        if (chatTimer) window.clearInterval(chatTimer);
        if (auctionsTimer) window.clearInterval(auctionsTimer);
        refreshChat();
        refreshAuctions();
        chatTimer = window.setInterval(refreshChat, 2500);
        auctionsTimer = window.setInterval(refreshAuctions, 3500);
    }

    function stopChatPolling() {
        if (chatTimer) window.clearInterval(chatTimer);
        if (auctionsTimer) window.clearInterval(auctionsTimer);
        chatTimer = null;
        auctionsTimer = null;
    }

    async function sendChat() {
        const input = document.getElementById('chatInput');
        if (!input) return;
        const message = String(input.value || '').trim();
        if (!message) return;
        input.value = '';
        try {
            await fetch(`${ARCANA_API_BASE}/api/chat/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: account || null, message })
            });
            refreshChat();
            refreshAuctions();
        } catch (_) {}
    }

    function matrixLine() {
        const alphabet = '01ARCANA$#@%*';
        let s = '';
        const len = 110;
        for (let i = 0; i < len; i++) s += alphabet[Math.floor(Math.random() * alphabet.length)];
        return s;
    }

    async function showMatrixReport() {
        const overlay = document.getElementById('matrixOverlay');
        const codeEl = document.getElementById('matrixCode');
        if (!overlay || !codeEl) return;
        overlay.style.display = 'block';
        let lines = [];
        const push = (t) => {
            lines.push(t);
            if (lines.length > 55) lines = lines.slice(lines.length - 55);
            codeEl.textContent = lines.join('\n');
        };

        const startedAt = Date.now();
        const timer = window.setInterval(() => push(matrixLine()), 55);

        let report = null;
        try {
            const r = await fetch(`${ARCANA_API_BASE}/api/matrix-report`, { cache: 'no-store' });
            report = await r.json();
        } catch (_) { report = null; }

        let tempC = null;
        try {
            tempC = await fetchMontrealTemperatureC();
        } catch (_) { tempC = null; }

        while (Date.now() - startedAt < 1200) {
            await new Promise(res => setTimeout(res, 50));
        }

        window.clearInterval(timer);
        push('');
        push(`RAPPORT MATRIX — ${formatAddr(account)}`);
        push(`SECTEUR: ${currentLevel}/100`);
        push(`VALISE: ${Array.isArray(chestState.contents) ? chestState.contents.length : 0} objet(s)`);
        push(`GUIDE: ${hasGuide ? 'ACTIF' : 'INACTIF'}`);
        push(`MONTREAL: ${tempC === null ? '??' : String(tempC) + '°C'}`);
        if (report && report.taxes) {
            push(`TAXES PROJET — ARCANA: ${Number(report.taxes.ARCANA || 0)} / POL: ${Number(report.taxes.POL || 0)} / USDC: ${Number(report.taxes.USDC || 0)}`);
        }
        if (report && Array.isArray(report.sold)) {
            push('VENTES RÉCENTES:');
            for (const s of report.sold.slice(-8)) {
                push(`- ${s.item} — ${s.price} ${s.currency}`);
            }
        }

        await new Promise(res => setTimeout(res, 1500));
        overlay.style.display = 'none';
    }

    function playArcanaSound(type) {
        try {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) return;

            const ctx = playArcanaSound._ctx || (playArcanaSound._ctx = new AudioCtx());
            if (ctx.state === 'suspended') {
                ctx.resume().catch(() => {});
            }

            const now = ctx.currentTime;
            const master = ctx.createGain();
            master.gain.setValueAtTime(0.0001, now);
            master.connect(ctx.destination);

            const beep = (start, duration, f0, f1, gain, wave) => {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.type = wave || 'sine';
                osc.frequency.setValueAtTime(f0, start);
                if (typeof f1 === 'number') osc.frequency.exponentialRampToValueAtTime(Math.max(1, f1), start + duration);
                g.gain.setValueAtTime(0.0001, start);
                g.gain.exponentialRampToValueAtTime(Math.max(0.0001, gain), start + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, start + duration);
                osc.connect(g);
                g.connect(master);
                osc.start(start);
                osc.stop(start + duration + 0.02);
            };

            if (String(type).toUpperCase() === 'VALIDATION') {
                master.gain.exponentialRampToValueAtTime(0.16, now + 0.02);
                beep(now + 0.00, 0.11, 880, 1320, 0.18, 'triangle');
                beep(now + 0.14, 0.14, 990, 1760, 0.20, 'triangle');
                master.gain.exponentialRampToValueAtTime(0.0001, now + 0.40);
            } else if (String(type).toUpperCase() === 'REFUS') {
                master.gain.exponentialRampToValueAtTime(0.20, now + 0.01);
                beep(now + 0.00, 0.10, 180, 120, 0.22, 'sawtooth');
                master.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
            }
        } catch (e) {
            return;
        }
    }

    function toggleInventory() {
        // Logique de votre sacoche ici
        alert("Accès à l'inventaire arcana-safe.nft...");
    }

    async function connectWallet() {

        const btn = document.getElementById('connect-wallet');
        if (!btn) return;

        if (!window.ethereum || !window.ethereum.request) {
            typeWriter("Wallet introuvable. Installez MetaMask pour authentifier l'accès.");
            return;
        }

        try {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            account = await signer.getAddress();

            const shortAddr = account ? `${account.slice(0, 4)}...${account.slice(-4)}` : '';
            btn.textContent = `STATION : ${shortAddr}`;
            btn.style.border = '1px solid rgba(0, 255, 140, 0.95)';
            btn.style.color = 'rgba(0, 255, 140, 0.95)';
            btn.style.boxShadow = '0 0 18px rgba(0, 255, 140, 0.35), 0 0 34px rgba(0, 255, 140, 0.18)';

            const progress = loadProgress();
            if (progress) {
                const sector = (progress.corridor && typeof progress.corridor.sector === 'number') ? progress.corridor.sector : currentLevel;
                typeWriter(`Bernard, synchronisation réussie. Réinsertion au Secteur [${sector}]. Vos actifs sont sécurisés dans la valise.`);
                await showMatrixReport();
            } else {
                initLevel1();
                typeWriter('Initiation confirmée. Démarrage au Niveau 1.');
                await showMatrixReport();
            }

            const toggle = document.getElementById('toggleChat');
            const body = document.getElementById('chatBody');
            const sendBtn = document.getElementById('chatSend');
            const input = document.getElementById('chatInput');
            const guideBtn = document.getElementById('buyGuideBtn');

            if (toggle && body) {
                toggle.addEventListener('click', () => {
                    chatOpen = !chatOpen;
                    body.style.display = chatOpen ? 'block' : 'none';
                    if (chatOpen) startChatPolling(); else stopChatPolling();
                });
            }
            if (sendBtn) sendBtn.addEventListener('click', sendChat);
            if (input) input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendChat(); });
            if (guideBtn) {
                guideBtn.disabled = !!hasGuide;
                guideBtn.textContent = hasGuide ? 'GUIDE ACTIF' : 'ACHETER LE GUIDE';
                guideBtn.addEventListener('click', buyGuide);
            }
        } catch (e) {
            typeWriter("Connexion refusée. Autorisation Web3 non accordée.");
        }
    }

    const connectBtn = document.getElementById('connect-wallet');
    if (connectBtn) connectBtn.addEventListener('click', connectWallet);

    const ARCANA_ORACLE_THRESHOLD = -2;
    const ORACLE_ADMIN_ADDRESS = "";
    let oracleResolved = false;
    let oracleTempC = null;
    let oraclePlayerCity = "";
    let oracleExpectedAnswer = "";
    let oracleAnswerValidator = null;
    let oracleCapitalFirstWord = "";

    function isAdmin() {
        if (!ORACLE_ADMIN_ADDRESS) return false;
        if (!account) return false;
        return account.toLowerCase() === ORACLE_ADMIN_ADDRESS.toLowerCase();
    }

    function normalizeAnswer(s) {
        return (s || '').trim().toLowerCase();
    }

    function setFrost(active) {
        if (active) document.body.classList.add('oracle-frost');
        else document.body.classList.remove('oracle-frost');
    }

    function showOracleInlineInput() {
        const box = document.getElementById('oracle-inline-answer');
        const input = document.getElementById('oracleInlineInput');
        if (!box || !input) return;
        box.style.display = 'block';
        box.setAttribute('aria-hidden', 'false');
        window.setTimeout(() => input.focus(), 0);
    }

    function hideOracleInlineInput() {
        const box = document.getElementById('oracle-inline-answer');
        const input = document.getElementById('oracleInlineInput');
        if (!box || !input) return;
        input.value = '';
        box.style.display = 'none';
        box.setAttribute('aria-hidden', 'true');
    }

    async function getGeolocationCoords() {
        if (!navigator.geolocation) return null;
        return await new Promise((resolve) => {
            navigator.geolocation.getCurrentPosition(
                (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
                () => resolve(null),
                { enableHighAccuracy: false, timeout: 7000, maximumAge: 5 * 60 * 1000 }
            );
        });
    }

    async function reverseGeocode(lat, lon) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
        const r = await fetch(url, {
            cache: 'no-store',
            headers: { 'Accept': 'application/json' }
        });
        if (!r.ok) throw new Error('oracle-geocode');
        const data = await r.json();
        const addr = data && data.address ? data.address : {};
        const city = addr.city || addr.town || addr.village || addr.municipality || addr.state || addr.county || addr.country || '';
        const country = addr.country || '';
        const countryCode = addr.country_code ? String(addr.country_code).toUpperCase() : '';
        return { city, country, countryCode };
    }

    async function getCountryCapital(countryCode) {
        if (!countryCode) return '';
        const url = `https://restcountries.com/v3.1/alpha/${encodeURIComponent(countryCode)}`;
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) return '';
        const data = await r.json();
        const item = Array.isArray(data) ? data[0] : null;
        const cap = item && Array.isArray(item.capital) ? item.capital[0] : '';
        return cap ? String(cap) : '';
    }

    async function getPlayerGeoProfile() {
        try {
            const coords = await getGeolocationCoords();
            if (!coords) return { city: '', country: '', countryCode: '' };
            return await reverseGeocode(coords.lat, coords.lon);
        } catch (e) {
            return { city: '', country: '', countryCode: '' };
        }
    }

    async function fetchMontrealTemperatureC() {
        const url = 'https://api.open-meteo.com/v1/forecast?latitude=45.5017&longitude=-73.5673&current_weather=true';
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error('oracle-weather');
        const data = await r.json();
        const t = data && data.current_weather ? data.current_weather.temperature : null;
        const n = Number(t);
        if (Number.isNaN(n)) throw new Error('oracle-weather');
        return n;
    }

    function askLocalQuestion(city, country) {
        const safeCity = (city || '').trim();
        const safeCountry = (country || '').trim();

        const candidates = [];

        candidates.push({
            q: "Complétez le domaine : arcana-safe.____",
            validate: (val) => normalizeAnswer(val) === 'nft'
        });

        if (safeCity) {
            candidates.push({
                q: `Écrivez le nom de la ville détectée en MAJUSCULES : ${safeCity}`,
                validate: (val) => (val || '').trim() === safeCity.toUpperCase()
            });
        }

        if (oracleCapitalFirstWord) {
            candidates.push({
                q: `Donnez le premier mot de la capitale de ${safeCountry || 'votre pays'} :`,
                validate: (val) => normalizeAnswer(val) === normalizeAnswer(oracleCapitalFirstWord)
            });
        }

        return candidates[Math.floor(Math.random() * candidates.length)];
    }

    async function requireOracleProof() {
        oracleResolved = false;
        hasKey = false;
        setFrost(true);

        const profile = await getPlayerGeoProfile();
        oraclePlayerCity = (profile && profile.city) ? profile.city : 'votre secteur';

        oracleCapitalFirstWord = '';
        if (profile && profile.countryCode) {
            const cap = await getCountryCapital(profile.countryCode);
            oracleCapitalFirstWord = cap ? String(cap).trim().split(/\s+/)[0] : '';
        }

        const q = askLocalQuestion(oraclePlayerCity, profile ? profile.country : '');
        oracleAnswerValidator = q.validate;

        showOracleInlineInput();
        typeWriter(`Accès Géo-Verrouillé. Prouvez votre présence à ${oraclePlayerCity}. ${q.q}`);

        const submitBtn = document.getElementById('oracleInlineSubmit');
        const answerEl = document.getElementById('oracleInlineInput');
        if (!submitBtn || !answerEl) return;

        const handler = () => {
            const ok = oracleAnswerValidator ? oracleAnswerValidator(answerEl.value) : false;
            if (!ok) {
                playArcanaSound('REFUS');
                typeWriter("Réponse invalide. L'Oracle maintient le givre.");
                answerEl.value = '';
                answerEl.focus();
                return;
            }

            oracleResolved = true;
            hasKey = true;
            dataKeys = Math.max(1, dataKeys + 1);
            const keysCounterEl = document.getElementById('keysCounter');
            if (keysCounterEl) keysCounterEl.textContent = `[ KEYS : ${dataKeys} / 3 ]`;
            playArcanaSound('VALIDATION');
            setFrost(false);
            hideOracleInlineInput();
            typeWriter(`Validation réussie depuis ${oraclePlayerCity}. Protocole validé, Bernard. Accès au réseau Arcana-Safe ouvert depuis votre position actuelle.`);
            saveProgress();
        };

        const onKeyDown = (e) => {
            if (e.key === 'Enter') handler();
        };

        submitBtn.addEventListener('click', handler);
        answerEl.addEventListener('keydown', onKeyDown);
    }

    async function initOracleChallenge() {
        try {
            oracleTempC = await fetchMontrealTemperatureC();
        } catch (e) {
            oracleTempC = null;
        }

        if (isAdmin()) {
            oracleResolved = true;
            hasKey = true;
            setFrost(false);
            hideOracleInlineInput();
            return;
        }

        if (oracleTempC !== null && oracleTempC > ARCANA_ORACLE_THRESHOLD) {
            await requireOracleProof();
        } else {
            oracleResolved = true;
            hasKey = true;
            setFrost(false);
            hideOracleInlineInput();
        }
    }

    window.addEventListener('load', function() {
        initOracleChallenge();
    });

    const backBtn = document.getElementById('back-to-hub');
    if (backBtn) {
        backBtn.addEventListener('click', function() {
            typeWriter('Déconnexion du secteur sécurisé... Redirection vers le hub Arcana-Safe.');
            window.setTimeout(function() {
                window.location.href = 'index.html';
            }, 700);
        });
    }

    const corridorLayer = document.getElementById('corridor-layer');
    if (corridorLayer) {
        corridorLayer.addEventListener('click', function(e) {
            if (e && e.target && (e.target.closest && e.target.closest('#chatPanel'))) return;
            const r = corridorLayer.getBoundingClientRect();
            const x = r.width ? (e.clientX - r.left) / r.width : 0.5;
            const y = r.height ? (e.clientY - r.top) / r.height : 0.5;
            corridorState.x = Math.min(1, Math.max(0, x));
            corridorState.y = Math.min(1, Math.max(0, y));
            corridorState.sector = currentLevel;
            saveProgress();

            corridorLayer.classList.add('dive');
            window.setTimeout(() => corridorLayer.classList.remove('dive'), 300);
            openNextDoor();
        });
    }

    window.addEventListener('beforeunload', function() {
        saveProgress();
    });
</script>

</body>
</html>